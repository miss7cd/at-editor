import e from"markdown-it";import{colord as t}from"colord";import n,{isHotkey as r}from"is-hotkey";export{default as isHotkey}from"is-hotkey";import i from"copy-to-clipboard";import s,{EventEmitter2 as o}from"eventemitter2";import{diff_match_patch as a,DIFF_DELETE as l,DIFF_INSERT as c,DIFF_EQUAL as d}from"diff-match-patch";import h from"dom-align";var u="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function f(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var g=function(){this.__data__=[],this.size=0};var p=function(e,t){return e===t||e!=e&&t!=t},m=p;var b=function(e,t){for(var n=e.length;n--;)if(m(e[n][0],t))return n;return-1},v=b,y=Array.prototype.splice;var w=b;var N=b;var x=b;var E=g,C=function(e){var t=this.__data__,n=v(t,e);return!(n<0)&&(n==t.length-1?t.pop():y.call(t,n,1),--this.size,!0)},k=function(e){var t=this.__data__,n=w(t,e);return n<0?void 0:t[n][1]},T=function(e){return N(this.__data__,e)>-1},O=function(e,t){var n=this.__data__,r=x(n,e);return r<0?(++this.size,n.push([e,t])):n[r][1]=t,this};function S(e){var t=-1,n=null==e?0:e.length;for(this.clear();++t<n;){var r=e[t];this.set(r[0],r[1])}}S.prototype.clear=E,S.prototype.delete=C,S.prototype.get=k,S.prototype.has=T,S.prototype.set=O;var A=S,M=A;var _=function(){this.__data__=new M,this.size=0};var B=function(e){var t=this.__data__,n=t.delete(e);return this.size=t.size,n};var R=function(e){return this.__data__.get(e)};var I=function(e){return this.__data__.has(e)},L="object"==typeof u&&u&&u.Object===Object&&u,D=L,z="object"==typeof self&&self&&self.Object===Object&&self,P=D||z||Function("return this")(),$=P.Symbol,j=$,q=Object.prototype,W=q.hasOwnProperty,V=q.toString,H=j?j.toStringTag:void 0;var F=function(e){var t=W.call(e,H),n=e[H];try{e[H]=void 0;var r=!0}catch(e){}var i=V.call(e);return r&&(t?e[H]=n:delete e[H]),i},X=Object.prototype.toString;var U=F,Y=function(e){return X.call(e)},K=$?$.toStringTag:void 0;var Z=function(e){return null==e?void 0===e?"[object Undefined]":"[object Null]":K&&K in Object(e)?U(e):Y(e)};var G=function(e){var t=typeof e;return null!=e&&("object"==t||"function"==t)},J=Z,Q=G;var ee,te=function(e){if(!Q(e))return!1;var t=J(e);return"[object Function]"==t||"[object GeneratorFunction]"==t||"[object AsyncFunction]"==t||"[object Proxy]"==t},ne=P["__core-js_shared__"],re=(ee=/[^.]+$/.exec(ne&&ne.keys&&ne.keys.IE_PROTO||""))?"Symbol(src)_1."+ee:"";var ie=function(e){return!!re&&re in e},se=Function.prototype.toString;var oe=function(e){if(null!=e){try{return se.call(e)}catch(e){}try{return e+""}catch(e){}}return""},ae=te,le=ie,ce=G,de=oe,he=/^\[object .+?Constructor\]$/,ue=Function.prototype,fe=Object.prototype,ge=ue.toString,pe=fe.hasOwnProperty,me=RegExp("^"+ge.call(pe).replace(/[\\^$.*+?()[\]{}|]/g,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$");var be=function(e){return!(!ce(e)||le(e))&&(ae(e)?me:he).test(de(e))},ve=function(e,t){return null==e?void 0:e[t]};var ye=function(e,t){var n=ve(e,t);return be(n)?n:void 0},we=ye(P,"Map"),Ne=ye(Object,"create"),xe=Ne;var Ee=function(){this.__data__=xe?xe(null):{},this.size=0};var Ce=function(e){var t=this.has(e)&&delete this.__data__[e];return this.size-=t?1:0,t},ke=Ne,Te=Object.prototype.hasOwnProperty;var Oe=function(e){var t=this.__data__;if(ke){var n=t[e];return"__lodash_hash_undefined__"===n?void 0:n}return Te.call(t,e)?t[e]:void 0},Se=Ne,Ae=Object.prototype.hasOwnProperty;var Me=Ne;var _e=Ee,Be=Ce,Re=Oe,Ie=function(e){var t=this.__data__;return Se?void 0!==t[e]:Ae.call(t,e)},Le=function(e,t){var n=this.__data__;return this.size+=this.has(e)?0:1,n[e]=Me&&void 0===t?"__lodash_hash_undefined__":t,this};function De(e){var t=-1,n=null==e?0:e.length;for(this.clear();++t<n;){var r=e[t];this.set(r[0],r[1])}}De.prototype.clear=_e,De.prototype.delete=Be,De.prototype.get=Re,De.prototype.has=Ie,De.prototype.set=Le;var ze=De,Pe=A,$e=we;var je=function(e){var t=typeof e;return"string"==t||"number"==t||"symbol"==t||"boolean"==t?"__proto__"!==e:null===e};var qe=function(e,t){var n=e.__data__;return je(t)?n["string"==typeof t?"string":"hash"]:n.map},We=qe;var Ve=qe;var He=qe;var Fe=qe;var Xe=function(){this.size=0,this.__data__={hash:new ze,map:new($e||Pe),string:new ze}},Ue=function(e){var t=We(this,e).delete(e);return this.size-=t?1:0,t},Ye=function(e){return Ve(this,e).get(e)},Ke=function(e){return He(this,e).has(e)},Ze=function(e,t){var n=Fe(this,e),r=n.size;return n.set(e,t),this.size+=n.size==r?0:1,this};function Ge(e){var t=-1,n=null==e?0:e.length;for(this.clear();++t<n;){var r=e[t];this.set(r[0],r[1])}}Ge.prototype.clear=Xe,Ge.prototype.delete=Ue,Ge.prototype.get=Ye,Ge.prototype.has=Ke,Ge.prototype.set=Ze;var Je=Ge,Qe=A,et=we,tt=Je;var nt=A,rt=_,it=B,st=R,ot=I,at=function(e,t){var n=this.__data__;if(n instanceof Qe){var r=n.__data__;if(!et||r.length<199)return r.push([e,t]),this.size=++n.size,this;n=this.__data__=new tt(r)}return n.set(e,t),this.size=n.size,this};function lt(e){var t=this.__data__=new nt(e);this.size=t.size}lt.prototype.clear=rt,lt.prototype.delete=it,lt.prototype.get=st,lt.prototype.has=ot,lt.prototype.set=at;var ct=lt,dt=ye,ht=function(){try{var e=dt(Object,"defineProperty");return e({},"",{}),e}catch(e){}}(),ut=ht;var ft=function(e,t,n){"__proto__"==t&&ut?ut(e,t,{configurable:!0,enumerable:!0,value:n,writable:!0}):e[t]=n},gt=ft,pt=p;var mt=function(e,t,n){(void 0!==n&&!pt(e[t],n)||void 0===n&&!(t in e))&&gt(e,t,n)};var bt=function(e){return function(t,n,r){for(var i=-1,s=Object(t),o=r(t),a=o.length;a--;){var l=o[e?a:++i];if(!1===n(s[l],l,s))break}return t}}(),vt={exports:{}};!function(e,t){var n=P,r=t&&!t.nodeType&&t,i=r&&e&&!e.nodeType&&e,s=i&&i.exports===r?n.Buffer:void 0,o=s?s.allocUnsafe:void 0;e.exports=function(e,t){if(t)return e.slice();var n=e.length,r=o?o(n):new e.constructor(n);return e.copy(r),r}}(vt,vt.exports);var yt=vt.exports,wt=P.Uint8Array,Nt=wt;var xt=function(e){var t=new e.constructor(e.byteLength);return new Nt(t).set(new Nt(e)),t},Et=xt;var Ct=function(e,t){var n=t?Et(e.buffer):e.buffer;return new e.constructor(n,e.byteOffset,e.length)};var kt=function(e,t){var n=-1,r=e.length;for(t||(t=Array(r));++n<r;)t[n]=e[n];return t},Tt=G,Ot=Object.create,St=function(){function e(){}return function(t){if(!Tt(t))return{};if(Ot)return Ot(t);e.prototype=t;var n=new e;return e.prototype=void 0,n}}();var At=function(e,t){return function(n){return e(t(n))}},Mt=At(Object.getPrototypeOf,Object),_t=Object.prototype;var Bt=function(e){var t=e&&e.constructor;return e===("function"==typeof t&&t.prototype||_t)},Rt=St,It=Mt,Lt=Bt;var Dt=function(e){return"function"!=typeof e.constructor||Lt(e)?{}:Rt(It(e))};var zt=function(e){return null!=e&&"object"==typeof e},Pt=Z,$t=zt;var jt=function(e){return $t(e)&&"[object Arguments]"==Pt(e)},qt=zt,Wt=Object.prototype,Vt=Wt.hasOwnProperty,Ht=Wt.propertyIsEnumerable,Ft=jt(function(){return arguments}())?jt:function(e){return qt(e)&&Vt.call(e,"callee")&&!Ht.call(e,"callee")},Xt=Array.isArray;var Ut=function(e){return"number"==typeof e&&e>-1&&e%1==0&&e<=9007199254740991},Yt=te,Kt=Ut;var Zt=function(e){return null!=e&&Kt(e.length)&&!Yt(e)},Gt=Zt,Jt=zt;var Qt=function(e){return Jt(e)&&Gt(e)},en={exports:{}};var tn=function(){return!1};!function(e,t){var n=P,r=tn,i=t&&!t.nodeType&&t,s=i&&e&&!e.nodeType&&e,o=s&&s.exports===i?n.Buffer:void 0,a=(o?o.isBuffer:void 0)||r;e.exports=a}(en,en.exports);var nn=en.exports,rn=Z,sn=Mt,on=zt,an=Function.prototype,ln=Object.prototype,cn=an.toString,dn=ln.hasOwnProperty,hn=cn.call(Object);var un=function(e){if(!on(e)||"[object Object]"!=rn(e))return!1;var t=sn(e);if(null===t)return!0;var n=dn.call(t,"constructor")&&t.constructor;return"function"==typeof n&&n instanceof n&&cn.call(n)==hn},fn=Z,gn=Ut,pn=zt,mn={};mn["[object Float32Array]"]=mn["[object Float64Array]"]=mn["[object Int8Array]"]=mn["[object Int16Array]"]=mn["[object Int32Array]"]=mn["[object Uint8Array]"]=mn["[object Uint8ClampedArray]"]=mn["[object Uint16Array]"]=mn["[object Uint32Array]"]=!0,mn["[object Arguments]"]=mn["[object Array]"]=mn["[object ArrayBuffer]"]=mn["[object Boolean]"]=mn["[object DataView]"]=mn["[object Date]"]=mn["[object Error]"]=mn["[object Function]"]=mn["[object Map]"]=mn["[object Number]"]=mn["[object Object]"]=mn["[object RegExp]"]=mn["[object Set]"]=mn["[object String]"]=mn["[object WeakMap]"]=!1;var bn=function(e){return pn(e)&&gn(e.length)&&!!mn[fn(e)]};var vn=function(e){return function(t){return e(t)}},yn={exports:{}};!function(e,t){var n=L,r=t&&!t.nodeType&&t,i=r&&e&&!e.nodeType&&e,s=i&&i.exports===r&&n.process,o=function(){try{var e=i&&i.require&&i.require("util").types;return e||s&&s.binding&&s.binding("util")}catch(e){}}();e.exports=o}(yn,yn.exports);var wn=yn.exports,Nn=bn,xn=vn,En=wn&&wn.isTypedArray,Cn=En?xn(En):Nn;var kn=function(e,t){if(("constructor"!==t||"function"!=typeof e[t])&&"__proto__"!=t)return e[t]},Tn=ft,On=p,Sn=Object.prototype.hasOwnProperty;var An=function(e,t,n){var r=e[t];Sn.call(e,t)&&On(r,n)&&(void 0!==n||t in e)||Tn(e,t,n)},Mn=An,_n=ft;var Bn=function(e,t,n,r){var i=!n;n||(n={});for(var s=-1,o=t.length;++s<o;){var a=t[s],l=r?r(n[a],e[a],a,n,e):void 0;void 0===l&&(l=e[a]),i?_n(n,a,l):Mn(n,a,l)}return n};var Rn=/^(?:0|[1-9]\d*)$/;var In=function(e,t){var n=typeof e;return!!(t=null==t?9007199254740991:t)&&("number"==n||"symbol"!=n&&Rn.test(e))&&e>-1&&e%1==0&&e<t},Ln=function(e,t){for(var n=-1,r=Array(e);++n<e;)r[n]=t(n);return r},Dn=Ft,zn=Xt,Pn=nn,$n=In,jn=Cn,qn=Object.prototype.hasOwnProperty;var Wn=function(e,t){var n=zn(e),r=!n&&Dn(e),i=!n&&!r&&Pn(e),s=!n&&!r&&!i&&jn(e),o=n||r||i||s,a=o?Ln(e.length,String):[],l=a.length;for(var c in e)!t&&!qn.call(e,c)||o&&("length"==c||i&&("offset"==c||"parent"==c)||s&&("buffer"==c||"byteLength"==c||"byteOffset"==c)||$n(c,l))||a.push(c);return a};var Vn=G,Hn=Bt,Fn=function(e){var t=[];if(null!=e)for(var n in Object(e))t.push(n);return t},Xn=Object.prototype.hasOwnProperty;var Un=Wn,Yn=function(e){if(!Vn(e))return Fn(e);var t=Hn(e),n=[];for(var r in e)("constructor"!=r||!t&&Xn.call(e,r))&&n.push(r);return n},Kn=Zt;var Zn=function(e){return Kn(e)?Un(e,!0):Yn(e)},Gn=Bn,Jn=Zn;var Qn=mt,er=yt,tr=Ct,nr=kt,rr=Dt,ir=Ft,sr=Xt,or=Qt,ar=nn,lr=te,cr=G,dr=un,hr=Cn,ur=kn,fr=function(e){return Gn(e,Jn(e))};var gr=ct,pr=mt,mr=bt,br=function(e,t,n,r,i,s,o){var a=ur(e,n),l=ur(t,n),c=o.get(l);if(c)Qn(e,n,c);else{var d=s?s(a,l,n+"",e,t,o):void 0,h=void 0===d;if(h){var u=sr(l),f=!u&&ar(l),g=!u&&!f&&hr(l);d=l,u||f||g?sr(a)?d=a:or(a)?d=nr(a):f?(h=!1,d=er(l,!0)):g?(h=!1,d=tr(l,!0)):d=[]:dr(l)||ir(l)?(d=a,ir(a)?d=fr(a):cr(a)&&!lr(a)||(d=rr(l))):h=!1}h&&(o.set(l,d),i(d,l,r,s,o),o.delete(l)),Qn(e,n,d)}},vr=G,yr=Zn,wr=kn;var Nr=function e(t,n,r,i,s){t!==n&&mr(n,function(o,a){if(s||(s=new gr),vr(o))br(t,n,a,r,e,i,s);else{var l=i?i(wr(t,a),o,a+"",t,n,s):void 0;void 0===l&&(l=o),pr(t,a,l)}},yr)};var xr=function(e){return e};var Er=function(e,t,n){switch(n.length){case 0:return e.call(t);case 1:return e.call(t,n[0]);case 2:return e.call(t,n[0],n[1]);case 3:return e.call(t,n[0],n[1],n[2])}return e.apply(t,n)},Cr=Math.max;var kr=function(e,t,n){return t=Cr(void 0===t?e.length-1:t,0),function(){for(var r=arguments,i=-1,s=Cr(r.length-t,0),o=Array(s);++i<s;)o[i]=r[t+i];i=-1;for(var a=Array(t+1);++i<t;)a[i]=r[i];return a[t]=n(o),Er(e,this,a)}};var Tr=function(e){return function(){return e}},Or=ht,Sr=Or?function(e,t){return Or(e,"toString",{configurable:!0,enumerable:!1,value:Tr(t),writable:!0})}:xr,Ar=Date.now;var Mr=function(e){var t=0,n=0;return function(){var r=Ar(),i=16-(r-n);if(n=r,i>0){if(++t>=800)return arguments[0]}else t=0;return e.apply(void 0,arguments)}}(Sr),_r=xr,Br=kr,Rr=Mr;var Ir=p,Lr=Zt,Dr=In,zr=G;var Pr=function(e,t){return Rr(Br(e,t,_r),e+"")},$r=function(e,t,n){if(!zr(n))return!1;var r=typeof t;return!!("number"==r?Lr(n)&&Dr(t,n.length):"string"==r&&t in n)&&Ir(n[t],e)};var jr=Nr,qr=f(function(e){return Pr(function(t,n){var r=-1,i=n.length,s=i>1?n[i-1]:void 0,o=i>2?n[2]:void 0;for(s=e.length>3&&"function"==typeof s?(i--,s):void 0,o&&$r(n[0],n[1],o)&&(s=i<3?void 0:s,i=1),t=Object(t);++r<i;){var a=n[r];a&&e(t,a,r,s)}return t})}(function(e,t,n){jr(e,t,n)}));class Wr{constructor(e,t={}){this.data={},this.locale="zh-CN",this.locale=e,this.data=t}add(e){this.data=qr(this.data,e)}get(...e){const t=(n=0,r)=>{for(let i=n;i<e.length;i++){const n=r[e[i]];return"object"==typeof n?t(i+1,n):n||""}return r};return t(0,this.data[this.locale])}}var Vr={"en-US":{dnd:{title:"Drag to reposition"},copy:{title:"Copy",success:"Copied successfully",error:"Copy error"},delete:{title:"Delete"},copyAnchor:{title:"Copy anchor link"},link:{placeholder:"Please enter a link or anchor and press Enter to confirm",save:"Apply",edit:"Change",delete:"Remove link",open:"Open link",text:"link"},copyContent:{title:"copy content"},maximize:{title:"Maximize",back:"Back to document"},expand:{title:"Embedded preview"},collapse:{title:"Compact display"},card:{lockAlert:"Please wait for the other user to finish editing"},preferences:{title:"Preferences"},download:{title:"Download"},more:{title:"More"},checkMarkdown:{title:"It is detected that the paste content conforms to the Markdown syntax. Do you need to do style conversion?"},searchEmtpy:{title:"No matching card"}},"zh-CN":{dnd:{title:"拖动调整位置"},copy:{title:"复制",success:"复制成功",error:"复制失败"},delete:{title:"删除"},copyAnchor:{title:"复制锚点链接"},link:{placeholder:"请输入链接或锚点，回车确认",save:"保存",edit:"编辑",delete:"取消链接",open:"打开链接",text:"链接"},copyContent:{title:"复制内容"},maximize:{title:"最大化",back:"返回文档"},expand:{title:"嵌入预览"},collapse:{title:"紧凑展示"},card:{lockAlert:"请等待对方编辑完毕后，再进入编辑"},preferences:{title:"设置"},download:{title:"下载"},more:{title:"更多"},checkMarkdown:{title:"检测到粘贴内容符合 Markdown 语法，是否需要转换？"},searchEmtpy:{title:"无匹配卡片"}}};const Hr="data-element",Fr="data-id",Xr="root",Ur=`[${Hr}="${Xr}"]`,Yr="ui",Kr=`[${Hr}="${Yr}"]`,Zr="editable",Gr=`[${Hr}="${Zr}"]`,Jr="data-transient-attributes",Qr="data-transient-element",ei="am-engine",ti="am-engine-mobile",ni="am-engine-view";let ri=class{constructor(){this.listeners={}}on(e,t,n){this.listeners[e]||(this.listeners[e]=[]),"object"==typeof n&&n.once||this.listeners[e].push(t)}off(e,t){const n=this.listeners[e];if(n)for(let e=0;e<n.length;e++)if(n[e]===t){n.splice(e,1);break}}trigger(e,...t){const n=this.listeners[e];if(n){let e;return n.every(n=>(e=n(...t),"boolean"!=typeof e||!1!==e)),e}}destroy(){Object.keys(this.listeners).forEach(e=>{this.listeners[e].forEach(t=>{this.off(e,t)})})}};const ii=e=>{if("undefined"==typeof document&&void 0===global.__amWindow)throw new Error("document is not defined,If you are using ssr, you can assign a value to the `__amWindow` global variable.");return e?e.ownerDocument||e.document||e:"undefined"==typeof document?global.__amWindow.document:document},si=e=>{e instanceof Node||(e=e[0]),e.normalize()},oi=(e,t)=>{let n=[];if(t&&!t(e))return n;const r=e.childNodes;for(let e=0;e<r.length;e++){const i=r[e],s=i.nodeType;3===s?n.push(i):1!==s&&9!==s&&11!==s||(n=n.concat(oi(i,t)))}return n},ai=e=>e.nodeType===ii().ELEMENT_NODE&&e.getAttribute(Hr)===Xr?void 0:(e.parentElement??e.parentNode)||void 0,li="card",ci="data-card-key",di="data-ready-card",hi="data-card-type",ui="data-card-value",fi="data-card-element",gi="data-card-loading",pi="data-card-editable",mi="div[".concat(ci,"],span[").concat(ci,"]"),bi="div[".concat(di,"],span[").concat(di,"]"),vi="span[".concat(fi,"=left]"),yi="div[".concat(fi,"=center],span[").concat(fi,"=center]"),wi="span[".concat(fi,"=right]"),Ni="trigger-card-id",xi="anchor",Ei="focus",Ci="cursor",ki="span[".concat(Hr,"=").concat(xi,"],anchor"),Ti="span[".concat(Hr,"=").concat(Ei,"],focus"),Oi="span[".concat(Hr,"=").concat(Ci,"],cursor"),Si=e=>!!e&&void 0!==e.get,Ai=e=>!!e&&void 0!==e.entries,Mi=e=>!!e&&void 0!==e.nodeType,_i=(e,t)=>{if(e.nodeType!==Node.ELEMENT_NODE||!t)return!1;const n=e.matches||e.webkitMatchesSelector||e.mozMatchesSelector||e.msMatchesSelector||e.oMatchesSelector||e.matchesSelector||((e,t)=>{const n=ii(e)?.querySelectorAll(t);return(n?n.length:0)>-1});return n.call(e,t)},Bi=e=>e.nodeName===li||!!e.getAttribute(hi),Ri=e=>"block"===e.getAttribute(hi),Ii=e=>"inline"===e.getAttribute(hi),Li=e=>e.getAttribute(Hr)===Zr||"true"===e.getAttribute(pi)||!!e?.querySelector(Gr),Di=(e,t)=>e.getAttribute(Hr)===Xr&&(!t||e===t),zi=e=>Di(e)||e.getAttribute(Hr)===Zr,Pi=(e,t)=>{if(e.nodeType===Node.ELEMENT_NODE&&Di(e,t))return!1;const n=ji(e,Ur);return!(!n||t&&n!==t)},$i=e=>{const t=e.getAttribute(Hr);return!!t&&[xi,Ei,Ci].indexOf(t)>-1},ji=(e,t,n=e=>e.parentElement||void 0)=>{let r=e||void 0;for(;r;){if(_i(r,t))return r;r=n(r)}return r},qi=new Map;function Wi(e,t){if(!e)return[];if("string"==typeof e){let n=!1;if(!t||(n=/<[^>]+>/g.test(e))){const t=0===e.indexOf("<tr"),r=0===e.indexOf("<td");e=(n?e.trim():e).replace(/<!--[^>]*-->/g,"");const i=qi.get(e);if(i){if(t){const e=i.querySelector("tbody");return e?e.cloneNode(!0).childNodes:[]}if(r){const e=i.querySelector("tr");return e?e.cloneNode(!0).childNodes:[]}return i.cloneNode(!0).childNodes}t&&(e="<table><tbody>".concat(e,"</tbody></table>")),r&&(e="<table><tbody><tr>".concat(e,"</tr></tbody></table>"));const s=ii().createElement("div");if(s.innerHTML=e,qi.set(e,s.cloneNode(!0)),t){const e=s.querySelector("tbody");return e?e.childNodes:[]}if(r){const e=s.querySelector("tr");return e?e.childNodes:[]}return s.childNodes}return t.querySelectorAll(e)}if(Ai(e)||Array.isArray(e))return e;if(Si(e)){const t=[];return e.each(e=>{t.push(e)}),t}if(Mi(e)&&e.nodeType===Node.DOCUMENT_FRAGMENT_NODE){const t=[];for(const n of e.childNodes)t.push(n);return t}return[e]}class Vi{constructor(e){if(this.options={limitHeight:5e3,canvasCache:[],canvasCount:0},this.width=0,this.height=0,this.handleClear=e=>{const{context:t,x:n,y:r,width:i,height:s}=e;t?.clearRect(n,r,i,s)},!e.container)throw new Error("need a cantainer!");this.options={...this.options,...e},e.container.style.lineHeight="0px"}removeCanvas(){const{canvasCache:e}=this.options;e?.forEach(e=>{e?.parentElement?.removeChild(e)}),this.options.canvasCache=[],this.options.canvasCount=0}getCanvas(e){const{canvasCache:t}=this.options;return e=e>0?e-1:e,t?t[e]:void 0}resize(e,t){if(this.width===e&&this.height===t)return;this.width=e,this.height=t;const{limitHeight:n,canvasCount:r,container:i}=this.options;let{canvasCache:s}=this.options;const o=Math.ceil(t/(n||0));if(o!==r){this.removeCanvas(),s=[];for(let r=0;r<o;r++){const a=document.createElement("canvas");a.style.verticalAlign="bottom",a.setAttribute("width",e.toString()),r===o-1?a.setAttribute("height",(t%(n||0)).toString()):a.setAttribute("height",(n||0).toString()),i?.appendChild(a),s.push(a)}this.options.canvasCache=s,this.options.canvasCount=s.length}else{const r=this.getCanvas(o);if(s?.forEach(t=>{const n=t.getAttribute("width");n&&parseInt(n)===e||t.setAttribute("width",e.toString())}),r){const e=r.getAttribute("height"),i=t%(n||0);e&&parseInt(e)===i||r.setAttribute("height",i.toString())}}}handleSingleRect(e){const{x:t,y:n,index:r,width:i,height:s,callback:o}=e,{limitHeight:a}=this.options,l=this.getCanvas(r);if(l){const e=l.getContext("2d"),c=new DOMRect(t,n-(a||0)*(r-1),i,s);o(Object.assign({},c.toJSON(),{context:e}))}}handleFillRect(e){const{context:t,x:n,y:r,width:i,height:s,fill:o,stroke:a}=e;t&&(t.fillStyle=void 0===o?"#FFEC3D":o,t.strokeStyle=void 0===a?"#FFEC3D":a,t.fillRect(n,r,i,s))}drawRect(e){const{x:t,y:n,width:r,height:i,fill:s,stroke:o}=e,a=new DOMRect(t,n,r,i);this.handleRect(Object.assign({},a.toJSON(),{callback:e=>{this.handleFillRect(Object.assign({},e,{fill:s,stroke:o}))}}))}handleRect(e){const{x:t,y:n,width:r,height:i,callback:s}=e,{limitHeight:o}=this.options,a=n+i,l=Math.ceil(n/(o||0)),c=Math.ceil(a/(o||0)),d=new DOMRect(t,n,r,i).toJSON();this.handleSingleRect(Object.assign({},d,{index:l,callback:s})),l!==c&&this.handleSingleRect(Object.assign({},d,{index:c,callback:s}))}getImageData(e){const{x:t,y:n,width:r,height:i}=e,{limitHeight:s}=this.options,o=Math.ceil(n/(s||0)),a=this.getCanvas(o),l=a?.getContext("2d");return l?.getImageData(t,n,r,i)}clearRect(e){const{x:t,y:n,width:r,height:i}=e,s=new DOMRect(t,n,r,i);this.handleRect(Object.assign({},s.toJSON(),{callback:this.handleClear}))}clear(){const{canvasCache:e}=this.options;e?.forEach(e=>{const t=e.getContext("2d"),n=Number(e.getAttribute("width")),r=Number(e.getAttribute("height"));t?.clearRect(0,0,n,r)})}destroy(){this.removeCanvas()}}const Hi=("undefined"!=typeof navigator?navigator:window.navigator).userAgent.toLowerCase(),Fi="undefined"==typeof navigator,Xi=/edge/i.test(Hi),Ui=!Xi&&/chrome/i.test(Hi),Yi=/firefox/i.test(Hi),Ki=!Xi&&!Ui&&/safari/i.test(Hi),Zi=/mobile/i.test(Hi),Gi=/os [._\d]+ like mac os/i.test(Hi),Ji=/android/i.test(Hi),Qi=!Gi&&/mac os x/i.test(Hi),es=/windows\s*(?:nt)?\s*[._\d]+/i.test(Hi),ts=(e=5)=>{e<5&&(e=5);const t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";let n="";for(let r=0;r<e;r++)n+=t.charAt(Math.floor(62*Math.random()));return n};var ns;!function(e){e.UPPER="upper",e.LOWER="lower"}(ns||(ns={}));const rs=(e,t=ns.LOWER)=>~e.indexOf("-")?e.split("-").map((e,n)=>"upper"===t||n>0?e.charAt(0).toUpperCase()+e.substr(1):"lower"===t&&0===n?e.charAt(0).toLowerCase()+e.substr(1):e).join(""):e,is=e=>{const t=e=>{const t=parseInt(e,10).toString(16).toUpperCase();return t.length>1?t:"0"+t};return e.replace(/rgb\s*\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*\)/gi,(e,n,r,i)=>"#"+t(n)+t(r)+t(i))},ss=e=>{const t={},n=/\s+(?:([\w\-:]+)|(?:([\w\-:]+)=([^\s"'<>]+))|(?:([\w\-:"]+)="([^"]*)")|(?:([\w\-:"]+)='([^']*)'))(?=(?:\s|\/|>)+)/g;let r;for(;r=n.exec(e);){const e=(r[1]||r[2]||r[4]||r[6]).toLowerCase(),n=(r[2]?r[3]:r[4]?r[5]:r[7])||"";t[e]=n}return t},os=new Map,as=e=>{const t=e.replace(/\s+/g,""),n={};if(!t)return n;const r=os.get(t);if(r)return Object.assign({},r);const i=/\s*([\w-]+)\s*:([^;]*)(;|$)/g;let s;for(e=e.toLowerCase();s=i.exec(e);){let[e,t,r]=s;(t.endsWith("color")||r.includes("rgb"))&&(r=is(r)),n[t.trim()]=r.trim()}return os.set(t,n),Object.assign({},n)},ls=(e,t)=>{const n=rs(t),r=window.getComputedStyle(e,null);return r?r[n]:""},cs=e=>(e||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;"),ds=e=>(e||"").replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&quot;/g,'"').replace(/&amp;/g,"&"),hs=e=>e.replace(/\./g,"&dot;"),us=e=>e.replace(/&dot;/g,"."),fs=(e,t="px")=>e&&/^-?\d+(?:\.\d+)?$/.test(e.toString())?e+t:e,gs=e=>{let t;return e&&(t=/^((-?\d+)(\.\d+)?)/.exec(e))?Math.floor(1e4*parseFloat(t[1]))/1e4:0},ps=e=>{let t="";try{t=encodeURIComponent(JSON.stringify(e||""))}catch(e){}return"data:".concat(t)},ms=e=>{try{return e=e.substr(5),JSON.parse(decodeURIComponent(e))}catch(e){return{}}},bs=e=>e.replace(/<anchor\s*\/>/gi,"<span ".concat(Hr,'="').concat(xi,'"></span>')).replace(/<focus\s*\/>/gi,"<span ".concat(Hr,'="').concat(Ei,'"></span>')).replace(/<cursor\s*\/>/gi,"<span ".concat(Hr,'="').concat(Ci,'"></span>')).replace(/(<card\s+[^>]+>).*?<\/card>/gi,(e,t)=>{const n=ss(t),{type:r,name:i,value:s,editable:o}=n,a="inline"===r?"span":"div",l=["<".concat(a)];return l.push(" ".concat(hi,'="').concat(r||"",'"')),l.push(" ".concat(di,'="').concat(i||"",'"')),""!==o&&l.push(" ".concat(pi,'="').concat(o||"false",'"')),Object.keys(n).forEach(e=>{0===e.indexOf("data-")&&0!==e.indexOf("data-card")&&l.push(" ".concat(e,'="').concat(n[e]||"",'"'))}),void 0!==s&&l.push(" ".concat(ui,'="').concat(s,'"')),l.push("></".concat(a,">")),l.join("")}),vs=e=>"string"==typeof e&&(!(e=e.toLowerCase()).startsWith("data:text/html")&&(!!e.match(/^\S*$/)&&(!!["http:","https:","data:","ftp:"].some(t=>e.startsWith(t))||(!(!e.startsWith("./")&&!e.startsWith("/"))||e.indexOf(":")<0)))),ys=e=>vs(e)?e:"",ws=e=>{if(!e)return e;const t=e.replace(/<(anchor|focus|cursor)[^>]*?\/>/gi,"");return/^<p(\s[^>]*?)><br \/><\/p>$/i.test(t)?e.replace(RegExp.$1,""):e},Ns=e=>{let t=e.toLowerCase().split("+");return t=t.map(e=>"mod"===e?Qi?"⌘":"Ctrl":"opt"===e?Qi?"Option":"Alt":e.length>1?e.substr(0,1).toUpperCase()+e.substr(1).toLowerCase():e.toUpperCase()),t.join("+")},xs=(e,t=0)=>{if(!(t=+t))return"•";const n=e?.toLowerCase();return"disc"===n?"•":"circle"===n?"◦":"square"===n?"◼":"lower-alpha"===n?String.fromCharCode("a".charCodeAt(0)+t):"lower-roman"===n?String.fromCharCode(8559+t):t},Es=e=>"engine"===e.kind,Cs=e=>"view"===e.kind,ks=(t,n="default")=>{const r=new e(n,{html:!0,typographer:!0,linkify:!0});return t.trigger("markdown-it",r),r},Ts=(e,t,n,r=!0)=>{const{renderer:i,options:s}=t;let o=!1;const a=e.schema.getTags("blocks");let l="",c=[];return n.forEach((d,h)=>{const{type:u,tag:f,children:g,nesting:p}=d;if(!1===e.trigger("markdown-it-token",{token:d,markdown:t,callback:e=>{l+=e}}))return void(o=!0);let m="";"inline"===u&&g?(m=i.renderInline(g,s,{})??"",r&&g.find(e=>"image"===e.type||e.type.endsWith("_inline")||e.type.endsWith("_open"))&&(o=!0)):m=void 0!==i.rules[u]?i.rules[u](n,h,s,{},i)??"":i.renderToken(n,h,s)??"",1===p?(c.push(""),l+=m):0===p?0===c.length?(l+=m,f&&!o&&(o=!0)):m&&(c[c.length-1]+=m):-1===p&&(c.length>0&&!c[c.length-1]&&a.includes(f)&&(c[c.length-1]+="<br />"),l+=c[c.length-1]??"",c.pop(),c.every(e=>!e)&&(c=[]),l+=m,o||"p"===f||(o=!0))}),o&&l?l:null};class Os{get length(){for(let e=0;;e++)if(!this[e])return e}constructor(e,t){this.events=[],this.document=null,this.name="",this.window=null,Mi(e)&&(e.nodeType===Node.DOCUMENT_FRAGMENT_NODE&&(this.fragment=e),e=[e]),e.forEach((e,t)=>{this[t]=e,this.events[t]=new ri});const n=this[0];if(n){this.document=ii(t),this.context=t;const{nodeName:e,nodeType:r}=n;this.name=e.toLowerCase(),this.type=r,this.window=this.document.defaultView||window}}each(e){let t,n=0;for(;(t=this[n])&&!1!==e(t,n);)n++;return this}toArray(){const e=[];return this.each(t=>{e.push(new Os(t))}),e}isElement(){return this.type===Node.ELEMENT_NODE}isText(){return this.type===Node.TEXT_NODE}isCard(){const e=this.get();return e?.nodeType===Node.ELEMENT_NODE&&Bi(e)}isBlockCard(){const e=this.get();return e?.nodeType===Node.ELEMENT_NODE&&Ri(e)}isInlineCard(){const e=this.get();return e?.nodeType===Node.ELEMENT_NODE&&Ii(e)}isEditableCard(){const e=this.get();return e?.nodeType===Node.ELEMENT_NODE&&Li(e)}isRoot(e){const t=this.get();return t?.nodeType===Node.ELEMENT_NODE&&Di(t,e?e[0]??e:void 0)}isEditable(){const e=this.get();return e?.nodeType===Node.ELEMENT_NODE&&zi(e)}inEditor(e){const t=this.get();return!!t&&Pi(t,e?e[0]??e:void 0)}isCursor(){const e=this.get();return e?.nodeType===Node.ELEMENT_NODE&&$i(e)}get(e=0){return 0===this.length?null:this[e]}eq(e){return e>-1&&e<this.length?new Os(this[e]):void 0}index(){let e=this.get()?.previousSibling,t=0;for(;e&&e.nodeType===Node.ELEMENT_NODE;)t++,e=e.previousSibling;return t}parent(){const e=this.get(),t=e?.parentElement??e?.parentNode;return t?new Os(t):void 0}children(e){if(0===this.length)return new Os([]);const t=this.get().childNodes;if(e){const n=[];for(let r=0;r<t.length;r++){const i=t[r];_i(i,e)&&n.push(i)}return new Os(n)}return new Os(t)}first(){if(this.fragment)return this.eq(0)||null;const e=0===this.length?null:this.get()?.firstChild;return e?new Os(e):null}last(){if(this.fragment)return this.eq(this.length-1)||null;const e=0===this.length?null:this.get()?.lastChild;return e?new Os(e):null}prev(){const e=0===this.length?null:this.get()?.previousSibling;return e?new Os(e):null}next(){const e=0===this.length?null:this.get()?.nextSibling;return e?new Os(e):null}prevElement(){const e=0===this.length?null:this.get().previousElementSibling;return e?new Os(e):null}nextElement(){const e=0===this.length?null:this.get().nextElementSibling;return e?new Os(e):null}getPath(e,t,n){e=e||document.body;let r=[];if(this.length>0){const e=this.getIndex(t);if(n){const t=n(e,r,this);t&&(r=t)}else r.unshift(e)}if(this.equal(e))return r;let i=this.parent();for(;i&&!i.equal(e);){const e=i.getIndex(t);if(n){const t=n(e,r,i);t&&(r=t)}else r.unshift(e);i=i.parent()}return r}contains(e){let t=Mi(e)?e:e.get();if(0===this.length)return!1;if(this.get().nodeType===Node.DOCUMENT_NODE&&t?.nodeType!==Node.DOCUMENT_NODE)return!0;if(t===this[0])return!0;for(;t=(t?.parentElement??t?.parentNode)||null;)if(t===this[0])return!0;return!1}find(e){if(this.length>0&&(this.isElement()||this.fragment)){const t=(this.fragment?this.fragment:this.get())?.querySelectorAll(e);return new Os(t||[])}return new Os([])}closest(e,t=e=>e.parentElement??(e.parentNode||void 0)){const n=[];let r=this.get()||void 0;for(;r;){if(_i(r,e))return n.push(r),new Os(n);r=t(r)}return new Os(n)}on(e,t,n){return this.each((r,i)=>{r.addEventListener(e,t,n),this.events[i]&&this.events[i].on(e,t,n)}),this}off(e,t,n){return this.each((r,i)=>{r.removeEventListener(e,t,n),this.events[i]&&this.events[i].off(e,t,n)}),this}getBoundingClientRect(e){if(0!==this.length){try{const e=this.get().getBoundingClientRect(),t=document.documentElement.clientTop,n=document.documentElement.clientLeft;return{top:e.top-t,bottom:e.bottom-t,left:e.left-n,right:e.right-n}}catch(e){console.error(e)}return e}}removeAllEvents(){return this.each((e,t)=>{this.events[t]&&Object.keys(this.events[t].listeners).forEach(n=>{const r=this.events[t].listeners[n];for(let i=0;i<r.length;i++)this.off(n,r[i]),this.events[t].off(n,r[i]),e.removeEventListener(n,r[i],!1)})}),this}attributes(e,t){if(void 0===e){const e=this.get();if(!e)return{};const t={},n=e.attributes;for(let e=n.length;e--;){const r=n[e];t[r.name]=r.value}return t}if("object"==typeof e){for(const t in e){const n=e[t];this.attributes(t,n)}return this}if(void 0===t){const t=this.get();return this.length>0&&this.isElement()&&t?.getAttribute(e)||""}const n="style"===e&&""===t;return this.each(r=>{r instanceof Element&&(n?r.removeAttribute("style"):r.setAttribute(e,t.toString()))}),this}removeAttributes(e){return this.each(t=>{t instanceof Element&&t.removeAttribute(e)}),this}hasClass(e){if(0===this.length)return!1;const t=this.get();if(!t)return!1;let n=0,r=null;const i=t.classList||{};for(;r=i[n];){if(r===e)return!0;n++}return!1}addClass(e){return this.each(t=>{t instanceof Element&&t.classList.add(e)}),this}removeClass(e){return this.each(t=>{t instanceof Element&&t.classList.remove(e)}),this}css(e,t){if(void 0===e)return as(this.attributes("style")||"");if("object"==typeof e){for(const t in e){const n=e[t];this.css(t,n)}return this}if(void 0===t){if(0===this.length||this.isText())return"";const t=this.get();return t&&(t.style[rs(e)]||ls(this[0],e))||""}return this.each(n=>{const r=n;r.style[rs(e)]=t.toString(),0===r.style.length&&r.removeAttribute("style")}),this}width(){let e=this.css("width");if("auto"===e){e=this.get().offsetWidth.toString()}return e&&gs(e)||0}height(){let e=this.css("height");if("auto"===e){e=this.get().offsetHeight.toString()}return e&&parseFloat(e)||0}html(e){if(void 0!==e){const t=Wi(e);return this.each(e=>{if(e.nodeType!==Node.ELEMENT_NODE)return;let n=e.firstChild;for(;n;){const t=n.nextSibling;e.removeChild(n),n=t}t.forEach(t=>{e.appendChild(t.cloneNode(!0))})}),this}return this.length>0&&this[0]instanceof Element?this[0].innerHTML:""}text(e){return void 0!==e?(this.each(t=>{t.textContent=e}),this):0===this.length?"":this.get()?.textContent||""}show(e){return void 0===e&&(e=this.display||""),"none"===e&&(e=""),"none"!==this.css("display")?this:this.css("display",e)}hide(){return 0===this.length?this:(this.display=this.get()?.style.display,this.css("display","none"))}remove(){return this.each((e,t)=>{const n=e.parentElement??e.parentNode;n&&(n.removeChild(e),delete this[t])}),this}empty(){return this.each(e=>{let t=e.firstChild;for(;t;){const n=t.nextSibling;e.removeChild(t),t=n}}),this}equal(e){return Mi(e)?this.get()===e:!!Si(e)&&this.get()===e.get()}clone(e){const t=[];return this.each(n=>{t.push(n.cloneNode(e))}),new Os(t)}prepend(e){const t=Wi(e,this.context),n="string"==typeof e&&/<.+>/.test(e);return this.each(e=>{for(let r=t.length-1;r>=0;r--){const i=n?t[r].cloneNode(!0):t[r];e.firstChild?e.insertBefore(i,e.firstChild):e.appendChild(i)}}),this}append(e){const t=Wi(e,this.context),n="string"==typeof e&&/<.+>/.test(e);return this.each(r=>{for(let i=0;i<t.length;i++){const s=n?t[i].cloneNode(!0):t[i];"string"==typeof e?r instanceof Element&&r.append(s):r.appendChild(s)}}),this}before(e){const t=Wi(e,this.context),n="string"==typeof e&&/<.+>/.test(e);return this.each(e=>{const r=e.parentElement??e.parentNode;r&&t.forEach(t=>{n&&(t=t.cloneNode(!0)),r.insertBefore(t,e),e=t})}),this}after(e){const t=Wi(e,this.context),n="string"==typeof e&&/<.+>/.test(e);return this.each(e=>{const r=e.parentElement??e.parentNode;r&&t.forEach(t=>{n&&(t=t.cloneNode(!0)),e.nextSibling?(r.insertBefore(t,e.nextSibling),e=t):r.appendChild(t)})}),this}replaceWith(e){const t=[],n=Wi(e,this.context),r="string"==typeof e&&/<.+>/.test(e);return this.each(e=>{const i=e.parentElement??e.parentNode;if(!i)return;const s=r?n[0].cloneNode(!0):n[0];try{i.replaceChild(s,e),t.push(s)}catch(e){}}),new Os(t)}getRoot(){return this.closest(Ur)}traverse(e,t=!0,n=!1,r,i){const s=o=>{let a=o.isCard();if(a&&(!o.fragment||1===o.fragment.childNodes.length)&&(!n||"editable"===n&&!o.isEditableCard()))return;let l=t?o.first():o.last();for(;l;){const o=t?l.next():l.prev();r&&r(l);const c=e(l);if(!1===c)return void(i&&i(l,o));if(!0!==c){const t=c&&"boolean"!=typeof c;if(t&&(i&&i(l,c),l=c),a=l.isCard(),a){if(!0===n)t&&e(l),s(l);else if("editable"===n&&l.isEditableCard()){const e=l.find(Gr);e.each((t,n)=>{const r=e.eq(n);r&&s(r)})}}else t&&e(l),s(l)}i&&i(l,o),l=o}};e(this),s(this)}getChildByPath(e,t){let n=this.get();if(0===e.length)return n;const r=e=>{let r=0;for(const i of n.childNodes)if(!t||t(i)){if(r===e)return i;r++}};for(let t=0;void 0!==e[t];){const i=r(e[t]);if(!i)break;n=i,t++}return n}getIndex(e){const t=this[0],n=t.parentElement??t.parentNode;if(!n)return 0;let r=0;for(const t of n.childNodes)if(!e||e(t)){if(t===this[0])return r;r++}return-1}findParent(e=this.closest(Ur)){const t=e[0]??e;let n=t.parentElement??t.parentNode;if(0===this.length||!n)return null;let r=this[0];for(;(n=r.parentElement??r.parentNode)&&n!==t;)r=n;return n?new Os(r):null}allChildren(e=!1){const t=[];return this.traverse(e=>{t.push(e)},void 0,e),t.shift(),t}getViewport(){const{innerHeight:e,innerWidth:t}=this.window||{innerHeight:0,innerWidth:0},n=this.isText()?this.parent()?.get():this.get();if(!n)return{top:0,left:0,bottom:0,right:0};const r=n.getBoundingClientRect(),{top:i,left:s,bottom:o,right:a}=r;return{top:i,left:s,bottom:Math.min(o,e),right:Math.min(a,t)}}inViewport(e,t=!1){let n=null;if(e.type!==Node.ELEMENT_NODE){if(!e.document)return!1;n=e.document.createElement("span");const t=e[0].parentElement??e[0].parentNode;e.next()?t?.insertBefore(n,e[0].nextSibling):t?.appendChild(n),e=new Os(n)}const r=e.get();if(!r)return!0;const{top:i,left:s,right:o,bottom:a}=r.getBoundingClientRect(),l=this.getViewport();return n&&(n.parentElement??n.parentNode)?.removeChild(n),t?i>0&&i<=l.bottom||a>0&&a<=l.bottom:i>0&&i>=l.top&&s>0&&s>=l.left&&a<=l.bottom&&o<=l.right}scrollIntoView(e,t="nearest"){if("function"==typeof e.document?.body.scrollIntoView){let n=null;e.type===Node.ELEMENT_NODE&&"br"!==e.name.toLowerCase()||(n=e.document.createElement("span"),n.innerHTML="&nbsp;",(e[0].parentElement??e[0].parentNode)?.insertBefore(n,e[0]),e=new Os(n)),this.inViewport(e)||e.get()?.scrollIntoView({block:t,inline:t}),n&&(n.parentElement??n.parentNode)?.removeChild(n)}}}var Ss=(e,t,n)=>{void 0===t&&(t=ii());const r=Wi(e,t),i=new(n||Os)(r,t||void 0);return Mi(e)&&e.nodeType===window.Node.DOCUMENT_FRAGMENT_NODE&&(i.fragment=e),i};const As=[{from:(e,t,n)=>!!n[ci]||!!n[di],to:(e,t,n)=>{const r=n[ui],i={...n};n={type:n[hi],name:(n[ci]||n[di]).toLowerCase(),editable:n[pi],[Fr]:n[Fr]};for(const e in i)e!==di&&0===e.indexOf("data-")&&0!==e.indexOf("data-card")&&(n[e]=i[e]);void 0!==r&&(n.value=r);const s=Ss("<card />");for(const e in n)s.attributes(e,n[e]);return s}},{from:(e,t,n)=>!("div"!==e&&"section"!==e||n[ci]&&n[di]||n[Hr]===Xr),to:(e,t,n)=>{const r=Ss("<p />");r.css(t);for(const e in n)r.attributes(e,n[e]);return r}},{from:e=>[Ci,xi,Ei].includes(e),to:e=>({node:Ss(`<${e} />`),replace:!0})}],Ms=[{type:"block",attributes:{[Fr]:"*"}},{name:"p",type:"block",allowIn:["$root"]},{name:"br",type:"inline",isVoid:!0},{name:xi,type:"inline",isVoid:!0},{name:Ei,type:"inline",isVoid:!0},{name:Ci,type:"inline",isVoid:!0},{name:"span",type:"mark",attributes:{[Hr]:{required:!0,value:["anchor","cursor","focus"]}}},{name:"card",type:"inline",attributes:{name:{required:!0,value:/\w+/},type:{required:!0,value:"inline"},editable:"*",value:"*"}},{name:"span",type:"inline",attributes:{[ci]:{required:!0,value:/\w+/},[hi]:{required:!0,value:"inline"},[ui]:"*",[pi]:"*",class:"*",contenteditable:"*"}},{name:"span",type:"inline",attributes:{[di]:{required:!0,value:/\w+/},[hi]:{required:!0,value:"inline"},[ui]:"*",[pi]:"*",class:"*",contenteditable:"*"}},{name:"card",type:"block",attributes:{name:{required:!0,value:/\w+/},type:{required:!0,value:"block"},editable:"*",value:"*"}},{name:"div",type:"block",attributes:{[ci]:{required:!0,value:/\w+/},[hi]:{required:!0,value:"block"},[ui]:"*",[pi]:"*",class:"*",contenteditable:"*"}},{name:"div",type:"block",attributes:{[di]:{required:!0,value:/\w+/},[hi]:{required:!0,value:"block"},[ui]:"*",[pi]:"*",class:"*",contenteditable:"*"}}],_s="data-uuid",Bs="data-color",Rs="contenteditable";let Is=0;const Ls=(e=0)=>Number(Math.random().toString().substring(2,7)+e+Date.now()).toString(36),Ds=new Map;var zs=(e,t=!0)=>{let n="";if("string"!=typeof e){const t=e[0]??e;if(t.nodeType===Node.ELEMENT_NODE){const r=t,i=r.localName;n=i.substring(0,1),e=i;const s=r.attributes;for(let t=s.length;t--;){const n=s[t];~~[Fr,"id"].indexOf(n.name)&&(e+=`${n.name}="${n.value}"`)}}else e=t.textContent??""}const r=Ds.get(e);if(r)n=r;else{const t=window.btoa(encodeURIComponent(e)).replace(/=/g,""),r=[];["a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z"].forEach((e,n)=>{const i=t.indexOf(e);r.push(~i?i:t.length%n?0:1)});const i=Number(r.join("")).toString(36).replace(/0/g,"");n=n+i.substr(0,4)+i.substr(-4),Ds.set(e,n)}const i=n;if(t){const e=`${i}-${Ls(Is)}`;return Is++,e}return i};class Ps{constructor(e){this.addBrForBlock=e=>{if(e.isText())return;const t=e.get().childNodes;let n=0,r=!0,i=!1;const s="p"===e.name;for(const e of t)if(r&&e.nodeType===Node.TEXT_NODE?r=!1:s||i||e.nodeType!==Node.ELEMENT_NODE||!this.isBlock(e)||(i=!0),e.nodeType===Node.ELEMENT_NODE&&[xi,Ei,Ci].indexOf(e.getAttribute(Hr)||"")<1&&n++,!r&&n>1)break;if(s&&0===n){const t=document.createElement("br");e.each(e=>{e.appendChild(t.cloneNode())})}!i&&r&&this.isBlock(e)&&(1!==t.length||"BR"!==t[0].nodeName)&&this.isEmptyWithTrim(e)&&(e.empty(),e.append(document.createElement("br")))},this.editor=e}isVoid(e,t=this.editor.schema){let n="string"==typeof e?e:"";return Mi(e)?n=e.nodeName.toLowerCase():Si(e)&&(n=e.name),t.find(e=>e.name===n&&!0===e.isVoid).length>0}isMark(e,t=this.editor.schema){return t.getTags("marks").includes((e.nodeName?.toLowerCase()??e.name).toLowerCase())&&"mark"===t.getType(e)}isInline(e,t=this.editor.schema){return t.getTags("inlines").includes(e.nodeName?.toLowerCase()??e.name)&&"inline"===t.getType(e)}isBlock(e,t=this.editor.schema){return t.getTags("blocks").includes((e.nodeName?.toLowerCase()??e.name).toLowerCase())&&"block"===t.getType(e)}isNestedBlock(e){if(!this.isBlock(e))return!1;const t=e.length?e[0]:e;if(!t)return!1;let n=t.firstChild;for(;n;){if(this.isBlock(n))return!1;n=n.nextSibling}return!0}isRootBlock(e,t){return!!e.parent()?.isEditable()&&(!!this.isNestedBlock(e)&&(t||this.editor.schema).find(t=>t.name===e.name).every(e=>{if("block"!==e.type)return!1;const t=e.allowIn;return!t||t.indexOf("$root")>-1}))}isEmpty(e,t){if(e.length>0&&e.isElement()){const t=e.attributes(),n=e.fragment??e.get(),r=Array.from(n.querySelectorAll(`${mi},${bi},${Gr},br`));if(t[ci]||t[di]||r.some(e=>e.hasAttribute(ci)||e.hasAttribute(di))&&!r.some(e=>e.getAttribute(Hr)===Zr))return!1;if("br"!==e.name&&this.isVoid(e))return!1;if(r.filter(e=>"br"===e.localName).length>1)return!1}let n=e.isText()?e[0].nodeValue||"":e.text();return n=n?.replace(/\u200B/g,""),n=n?.replace(/\r\n|\n|\t/,""),n&&t&&(n=n.trim()),""===n}isEmptyWithTrim(e){return this.isEmpty(e,!0)}isEmptyWidthChild(e){if(0===e.length)return!0;if(e.isCard())return!1;if(e.isText())return this.isEmpty(e);const{childNodes:t}=e[0];if(0===t.length)return!0;for(let e=0;e<t.length;e++){const n=t[e];if(n.nodeType===Node.TEXT_NODE){if(""!==n.data.replace(/\u200b/g,""))return!1}else if(n.nodeType===Node.ELEMENT_NODE){if("li"===n.nodeName.toLowerCase()&&!this.editor.list.isEmptyItem(Ss(n)))return!1;if(n.hasAttribute(ci))return!1;if(!this.isEmptyWidthChild(Ss(n)))return!1}}return!0}isList(e){let t="string"==typeof e?e:"";return Mi(e)?t=e.nodeName.toLowerCase():Si(e)&&(t=e.name),["ul","ol"].indexOf(t)>-1}isCustomize(e){const{list:t}=this.editor;switch(e.name){case"li":return e.hasClass(t.CUSTOMZIE_LI_CLASS);case"ul":return e.hasClass(t.CUSTOMZIE_UL_CLASS);default:return!1}}unwrap(e){let t=e.first();const n=[];for(;t;){const r=t.next();e.before(t),n.push(t),t=r}return e.remove(),n}wrap(e,t,n=!1){const{mark:r}=this.editor;if(Mi(e)&&(e=Ss(e)),t=this.clone(t,!1),e.isText())return t.append(this.clone(e,!1)),e.replaceWith(t);if(n&&this.isMark(t)){const n=this.clone(t,!1,!1);if(e.name===t.name){const n=e.attributes();delete n.style,delete n[Fr],Object.keys(n).forEach(e=>{if(t.attributes(e)){const n=t.attributes(e).split(",");void 0!==n[e]&&n.indexOf(n[e])<0&&n.push(n[e]),t.attributes(e,n.join(","))}else t.attributes(e,n[e])});const r=e.css();Object.keys(r).forEach(e=>{t.css(e)||t.css(e,r[e])}),t.append(this.clone(e,!0,!1).children())}else t.append(this.clone(e,!0,!1));return t.allChildren().forEach(e=>{!e.isText()&&this.isMark(e)&&r.compare(e,n)&&this.unwrap(e)}),e.replaceWith(t)}const i=e.parent(),s=this.clone(e,!1,!1);return e.after(s),t.append(e),i?s.replaceWith(t):t}merge(e,t,n=!0){if(e.equal(t))return;if(t.isText())return e.append(t),void this.removeSide(e);const{block:r,mark:i,list:s}=this.editor;let o=t;const a=this.isList(e),l=this.isList(t.name);if(a&&!l){const t=e.find("li");if(0===t.length)return;e=Ss(t[t.length-1])}if(!a&&l){const e=t.find("li");e.length>0&&(t=Ss(e[0])),e[1]&&(o=Ss(e[0]))}if(this.isCustomize(e)){let n=e.first();if(!n?.isCard()){const t=s.getPlugins(),r=s.getPluginNameByNode(e),i=t.find(e=>e.constructor.pluginName===r);i?.cardName&&(s.addCardToCustomize(e,i.cardName),n=e.first())}if(this.isCustomize(t)&&!n?.equal(t)){const e=t.first();e?.isCard()&&n.attributes(ci)===e.attributes(ci)&&e.remove()}}const c=e.last();let d=t.first();const h=r.findPlugin(e);for(;d;){const t=d.next(),n=i.findPlugin(d);if(h&&n&&h.disableMark&&h.disableMark.indexOf(n.constructor.pluginName)>-1){this.unwrap(d).forEach(t=>{e.append(t)})}else if(d.isText()&&/\u200b/.test(d.text())){const e=d.parent(),t=d.prev(),n=d.next();if(!e||!this.isMark(e)&&(t&&!this.isInline(t)||n&&!this.isInline(n))){d.remove(),d=n;continue}}else if(n&&1===d.get()?.childNodes.length){const e=d.prev();e&&!e.isText()||d.allChildren().forEach(e=>{const t=e.text();e.type===ii().TEXT_NODE&&t&&!e.next()?.isCursor()&&e.text(t.replace(/\u200b/,""))})}d.length>0&&!d.equal(e)&&!d.parent()?.equal(e)&&e.append(d),d=t}if(n&&o.remove(),c&&"br"===c.name){let e=c.next();for(;e;){if(e.isCursor()){c.remove();break}e=e.next()}}this.removeSide(e)}replace(e,t,n=!1){const r=this.clone(t,!1,n);let i=this.isCustomize(e)&&"li"===e.name&&e.first()?.isCard()?e.first()?.next():e.first();for(;i;){const e=i.next();r.append(i),i=e}return e.isText()&&r.append(e.clone()),e.replaceWith(r)}insertText(e,t){const n=this.editor;if(!Es(n))return;const{change:r}=n,i=t||r.range.toTrusty(),s=ii(i.startContainer);i.collapsed||r.delete(t);const o=s.createTextNode(e);return this.insert(o,i)?.handleBr(),t||r.apply(i),i}insert(e,t,n=!1){if(Si(e)){if(0===e.length)throw new Error("Not found node");e=e[0]}const r=this.editor;if(!Es(r))return;const{change:i,block:s,schema:o,mark:a}=r;t=t||i.range.get();const{startNode:l,startOffset:c}=t.cloneRange().shrinkToTextNode(),d=l.prev(),h=l.parent(),u=l.text()||"",f=u.substr(0,c);if(l.isText()&&/\u200b$/.test(f)&&u.length>1&&(d&&!this.isInline(d)||!d&&h&&!this.isInline(h))){const e=l.get().splitText(c-1),t=e.textContent;t&&t.length>0&&e.splitText(1),e.remove()}const g=h?.attributes(fi);if(!g&&l.isCard()&&t.setStartAfter(l),g&&h&&["left","right"].includes(g)){const e=r.card.find(h);e&&("left"===g?t.setStartBefore(e.root):t.setStartAfter(e.root))}if(this.isBlock(e)){let{commonAncestorNode:i}=t;i.isText()&&(i=r.block.closest(i));let a=null;if(this.isBlock(i)&&this.isEmpty(i))a=n?i:void 0;else{let e=!1;s.isFirstOffset(t,"start")&&(e=!0),a=s.split(t),e&&(a=a?.prev())}let l=s.closest(t.startNode.isEditable()?t.cloneRange().shrinkToElementNode().shrinkToTextNode().startNode:t.startNode);if(l.isRoot()&&!t.startNode.next())l.append(e);else if(!l.isCard()&&o.isAllowIn(l.name,e.nodeName.toLowerCase()))l.find("br").remove(),l.append(e);else{let n=l.parent();for(;n&&this.isBlock(n)&&!l.isEditable()&&(!n.isEditable()||n.isCard())&&!o.isAllowIn(n.name,e.nodeName.toLowerCase());)l=n,n=l.parent();const r=o.getCanMergeTags(),i=e.nodeName.toLowerCase();let c=null;if(a&&l.name===i&&r.includes(l.name)){l=a;const t=document.createDocumentFragment(),n=[],r=l.get()?.nextSibling;e.childNodes.forEach(e=>{r?n.push(e):n.unshift(e)}),t.append(...n),e=t,c=t.lastChild}l.isEditable()&&0===l.get()?.childNodes.length?l.append(e):(this.isEmptyWidthChild(l)||s.isLastOffset(t,"start")?(l.after(e),this.isEmptyWidthChild(l)&&a&&l.remove()):(l.before(e),a&&this.isEmptyWidthChild(a)&&a.remove()),c&&(e=c))}(e instanceof Element||e instanceof DocumentFragment)&&r.nodeId.generate(e)}else{const n=s.closest(t.startNode.isEditable()?t.cloneRange().shrinkToElementNode().shrinkToTextNode().startNode:t.startNode),r=n?s.findPlugin(n):void 0;if(r){const n=Ss(e),i=e=>{if(this.isMark(e)){const t=a.findPlugin(e);if(!t)return;if(r.disableMark&&r.disableMark.indexOf(t.constructor.pluginName)>-1)return!0}return!1};if(n.allChildren().forEach(e=>{i(e)&&this.unwrap(e)}),i(n)){const r=n.document.createDocumentFragment();n.children().each(e=>{r.appendChild(e)}),n.remove(),e=r.childNodes[r.childNodes.length-1],t.insertNode(r)}else t.insertNode(e);if(0===n.length)return t}else t.insertNode(e)}return e.nodeType===Node.ELEMENT_NODE&&(e.hasAttribute(di)||e.hasAttribute(ci))?t.collapse(!1):t.select(e,!(this.isVoid(e)||e.nodeType===Node.TEXT_NODE)).shrinkToElementNode().collapse(!1)}setAttributes(e,t){let n=t.style;for(const n in t)if("style"!==n)if("className"===n){const r=t[n];Array.isArray(r)?r.forEach(t=>e.addClass(t)):e.addClass(r)}else e.attributes(n,t[n].toString());"number"==typeof n?n={}:"string"==typeof n&&(n=as(n)),n=n||{};const r=Object.keys(n);for(const t in n){let r=n[t];/^0(px|em)?$/.test(r.toString())&&(r=""),e.css(t,r.toString())}return 0!==r.length&&0!==Object.keys(e.attributes("style")).length||e.removeAttributes("style"),e}removeMinusStyle(e,t){if(e.isElement()){const n=e.css();if(n[t]){(parseInt(n[t]||"0",10)||0)<0&&e.css(t,"")}}}mergeChild(e){const{schema:t,list:n}=this.editor,r=t.getAllowInTags();let i=e.first();for(;i;){let e=i.next();for(;e&&i.name===e.name&&(r.indexOf(i.name)>-1&&!this.isList(i)||this.isList(i)&&n.isSame(i,e));){const t=e.next();let n=e.first();for(;n;){const e=n.next();i.append(n),n=e}e.remove(),this.mergeChild(i),e=t}i=e}}removeSide(e,t="br"){const n=e.first();n?.name===t&&e.children().toArray().filter(e=>!e.isCursor()).length>1&&n.remove();const r=e.last();r?.name===t&&e.children().toArray().filter(e=>!e.isCursor()).length>1&&r.remove()}flat(e,t=e){const{block:n}=this.editor;let r=e.first();const i=e.fragment?Ss("<p />"):this.clone(e,!1);for(;r;){let e=r.next();if(r.isBlockCard()||this.isNestedBlock(r))n.flat(r,t);else if(this.isBlock(r))r=this.flat(r,t);else{const s=this.clone(i,!1),o="li"===s.name;for(r.before(s);r;){e=r.next();const t="br"===r.name&&!o;if(t&&r.parent()?.isRoot()&&s.append(r),r.isText()){let e=r.text(),t=/^((\n|\r)+)/.exec(e),n=!1;if(t&&(e=e.substring(t[1].length),n=!0,0===e.length&&r.remove()),t=/((\n|\r)+)$/.exec(e),t){r.text(e.substr(0,t.index)),s.append(r);break}n&&r.length>0&&r.text(e)}if(r.length>0&&s.append(r),e){const t=e.text();if(/^(\n|\r)+/.exec(t))break}if(t||!e||this.isBlock(e)||e.isBlockCard())break;r=e}this.removeSide(s),n.flat(s,t),this.addBrForBlock(s)}this.addBrForBlock(r),this.removeSide(r),r=e}return e.fragment&&(e=Ss(e.fragment)),r=e.first(),r||e.remove(),e}normalize(e){return e=this.flat(e),this.mergeChild(e),e}html(e,t){return void 0===t?e.length>0&&e.get()?.innerHTML||"":(e.each(e=>{e instanceof Element&&(e.innerHTML=t,this.editor.nodeId.generateAll(e))}),e)}clone(e,t,n=!0){const{nodeId:r}=this.editor,i=[];return e.each(e=>{const s=e.cloneNode(t),o=Ss(s);n||(r.generateAll(o,!0),r.isNeed(o)&&r.generate(o,!0)),i.push(s)}),Ss(i)}getBatchAppendHTML(e,t){if(0===e.length)return t;let n=t.startsWith("\\u")||t.startsWith("&#")?Ss(t,null):Ss(t);return e.forEach(e=>{(e=e.clone(!1)).append(n),n=e}),n.get()?.outerHTML||""}removeZeroWidthSpace(e){e.traverse(e=>{const t=e[0];if(t.nodeType!==Node.TEXT_NODE)return;const n=t.nodeValue;if(2!==n?.length)return;const r=t.nextSibling,i=t.previousSibling;if(8203===n.charCodeAt(1)&&r&&r instanceof Element&&[xi,Ei,Ci].indexOf(r.getAttribute(Hr)||"")>=0)return;const s=e.parent();if(!(8203===n.charCodeAt(1)&&(!r&&s&&this.isInline(s)||r&&this.isInline(r))||8203===n.charCodeAt(0)&&(!i&&s&&this.isInline(s)||i&&this.isInline(i))||8203!==n.charCodeAt(0))){const e=t.splitText(1);e.previousSibling&&(e.parentElement??e.parentNode)?.removeChild(e.previousSibling)}})}}class $s{constructor(e,t){this.kind="plugin",this.name=this.constructor.pluginName,this.editor=e,this.options=t||{};const{disabled:n}=this.options;this.disabled=n}}class js extends $s{constructor(){super(...arguments),this.kind="element"}init(){const{schema:e,conversion:t}=this.editor;e.add(this.schema()),this.conversion&&this.conversion().forEach(({from:e,to:n})=>{t.add(e,n)})}setStyle(e,...t){Mi(e)&&(e=Ss(e)),this.style&&Object.keys(this.style).forEach(n=>{let r=this.style[n];"object"==typeof r&&(r=r.value),r.match(/@var\d/g)?.forEach(e=>{const n=parseInt(e.replace("@var",""),10);r=r.replace(new RegExp(e,"gm"),t[n]||"")}),e.css(n,r)})}setAttributes(e,...t){Mi(e)&&(e=Ss(e)),this.attributes&&Object.keys(this.attributes).forEach(n=>{let r=this.attributes[n];"object"==typeof r&&(r=r.value),r.match(/@var\d/g)?.forEach(e=>{const n=parseInt(e.replace("@var",""),10);r=r.replace(new RegExp(e,"gm"),t[n]||"")}),e.attributes(n,r)})}getStyle(e){Mi(e)&&(e=Ss(e));const n={};return this.style&&this.isSelf(e)&&Object.keys(this.style).forEach(r=>{let i=r.toLowerCase().indexOf("color")>-1?t(e.css(r)||"").toHex():e.css(r);const s=this.style[r];"object"==typeof s&&(i=s.format(i)),i&&(n[r]=i)}),n}getAttributes(e){Mi(e)&&(e=Ss(e));const t={};return this.attributes&&this.isSelf(e)&&Object.keys(this.attributes).forEach(n=>{let r=e.attributes(n);const i=this.attributes[n];"object"==typeof i&&(r=i.format(r)),r&&(t[n]=r)}),t}isSelf(e){Mi(e)&&(e=Ss(e));let t=this.schema();return Array.isArray(t)&&(t=t.find(({name:t})=>t===e.name)),!!t&&((Array.isArray(this.tagName)?this.tagName.indexOf(e.name)>-1:e.name===this.tagName)&&this.editor.schema.checkNode(e,t.attributes))}schema(){if(this.sechamCache)return this.sechamCache;let e={};if(this.attributes&&Object.keys(this.attributes).forEach(t=>{let n=this.attributes[t];"object"==typeof n&&(n=n.value),e[t]=n,n.match(/@var\d/g)?.forEach(n=>{if(!this.variable)throw new Error("Please specify the variable type");e[t]=this.variable[n]})}),this.style){const t={};Object.keys(this.style).forEach(e=>{let n=this.style[e];"object"==typeof n&&(n=n.value),n.match(/@var\d/g)?.forEach(n=>{if(!this.variable)throw new Error("Please specify the variable type");t[e]=this.variable[n]})}),e={...e,style:t}}if(this.sechamCache={type:this.kind,attributes:e},"string"==typeof this.tagName)this.sechamCache.name=this.tagName.toLowerCase();else if(Array.isArray(this.tagName)){const e=[];this.tagName.forEach(t=>{e.push({...this.sechamCache,name:t})}),this.sechamCache=e}return this.sechamCache}createElement(...e){const t=Ss(`<${this.tagName} />`);return this.setStyle(t,...e),this.setAttributes(t,...e),t}}class qs extends js{constructor(){super(...arguments),this.kind="block"}schema(){const e=super.schema();return Array.isArray(e)?e.map(e=>({...e,allowIn:this.allowIn})):{...e,allowIn:this.allowIn,canMerge:this.canMerge}}}const Ws=e=>"block"===e.kind;class Vs extends js{constructor(){super(...arguments),this.kind="inline"}execute(...e){const t=this.editor;if(!Es(t))return;const n=Ss(`<${this.tagName} />`);this.setStyle(n,...e),this.setAttributes(n,...e);const{inline:r}=t;(this.isTrigger?this.isTrigger(...e):!this.queryState())?r.wrap(n):r.unwrap()}queryState(){const e=this.editor;if(!Es(e))return;const{change:t}=e;if(!this.style&&!this.attributes)return t.inlines.some(e=>e.name===this.tagName);const n=[];return t.inlines.forEach(e=>{n.push(...Object.values(this.getStyle(e))),n.push(...Object.values(this.getAttributes(e)))}),0===n.length?void 0:n}}const Hs=e=>"inline"===e.kind;function Fs(e,t){void 0===t&&(t={});var n=t.insertAt;if(e&&"undefined"!=typeof document){var r=document.head||document.getElementsByTagName("head")[0],i=document.createElement("style");i.type="text/css","top"===n&&r.firstChild?r.insertBefore(i,r.firstChild):r.appendChild(i),i.styleSheet?i.styleSheet.cssText=e:i.appendChild(document.createTextNode(e))}}Fs('.am-engine ol, .am-engine-view ol, .am-engine ul, .am-engine-view ul {\r\n    margin: 0 0 0 3px;\r\n    padding: 0;\r\n    list-style: none;\r\n}\r\n\r\n.am-engine ol ul, .am-engine-view ol ul, .am-engine ul ul, .am-engine-view ul ul, .am-engine ol ol, .am-engine-view ol ol, .am-engine ul ol, .am-engine-view ul ol {\r\n    margin-left: 0;\r\n}\r\n\r\n.am-engine ol ul li, .am-engine-view ol ul li, .am-engine ul ul li, .am-engine-view ul ul li, .am-engine ol ol li, .am-engine-view ol ol li, .am-engine ul ol li, .am-engine-view ul ol li {\r\n    margin-left: 2em;\r\n}\r\n\r\n.am-engine ol ol[data-indent-new="0"], .am-engine-view ol ol[data-indent-new="0"], .am-engine ul ol[data-indent-new="0"], .am-engine-view ul ol[data-indent-new="0"], .am-engine ol ol[data-indent-new="3"], .am-engine-view ol ol[data-indent-new="3"], .am-engine ul ol[data-indent-new="3"], .am-engine-view ul ol[data-indent-new="3"], .am-engine ol ol[data-indent-new="6"], .am-engine-view ol ol[data-indent-new="6"], .am-engine ul ol[data-indent-new="6"], .am-engine-view ul ol[data-indent-new="6"], .am-engine ol ol[data-indent-new="6"], .am-engine ol ol[data-indent-new="9"], .am-engine-view ol ol[data-indent-new="9"], .am-engine ul ol[data-indent-new="9"], .am-engine-view ul ol[data-indent-new="9"], .am-engine ol ol[data-indent-new="12"], .am-engine-view ol ol[data-indent-new="12"], .am-engine ul ol[data-indent-new="12"], .am-engine-view ul ol[data-indent-new="12"], .am-engine ol ol[data-indent-new="15"], .am-engine-view ol ol[data-indent-new="15"], .am-engine ul ol[data-indent-new="15"], .am-engine-view ul ol[data-indent-new="15"], .am-engine ol ol[data-indent-new="18"], .am-engine-view ol ol[data-indent-new="18"], .am-engine ul ol[data-indent-new="18"], .am-engine-view ul ol[data-indent-new="18"] {\r\n    list-style-type: decimal;\r\n}\r\n\r\n.am-engine ol ol[data-indent-new="1"], .am-engine-view ol ol[data-indent-new="1"], .am-engine ul ol[data-indent-new="1"], .am-engine-view ul ol[data-indent-new="1"], .am-engine ol ol[data-indent-new="4"], .am-engine-view ol ol[data-indent-new="4"], .am-engine ul ol[data-indent-new="4"], .am-engine-view ul ol[data-indent-new="4"], .am-engine ol ol[data-indent-new="7"], .am-engine-view ol ol[data-indent-new="7"], .am-engine ul ol[data-indent-new="7"], .am-engine-view ul ol[data-indent-new="7"], .am-engine ol ol[data-indent-new="10"], .am-engine-view ol ol[data-indent-new="10"], .am-engine ul ol[data-indent-new="10"], .am-engine-view ul ol[data-indent-new="10"], .am-engine ol ol[data-indent-new="13"], .am-engine-view ol ol[data-indent-new="13"], .am-engine ul ol[data-indent-new="13"], .am-engine-view ul ol[data-indent-new="13"], .am-engine ol ol[data-indent-new="16"], .am-engine-view ol ol[data-indent-new="16"], .am-engine ul ol[data-indent-new="16"], .am-engine-view ul ol[data-indent-new="16"], .am-engine ol ol[data-indent-new="19"], .am-engine-view ol ol[data-indent-new="19"], .am-engine ul ol[data-indent-new="19"], .am-engine-view ul ol[data-indent-new="19"] {\r\n    list-style-type: lower-alpha;\r\n}\r\n\r\n.am-engine ol ol[data-indent-new="2"], .am-engine-view ol ol[data-indent-new="2"], .am-engine ul ol[data-indent-new="2"], .am-engine-view ul ol[data-indent-new="2"], .am-engine ol ol[data-indent-new="5"], .am-engine-view ol ol[data-indent-new="5"], .am-engine ul ol[data-indent-new="5"], .am-engine-view ul ol[data-indent-new="5"], .am-engine ol ol[data-indent-new="8"], .am-engine-view ol ol[data-indent-new="8"], .am-engine ul ol[data-indent-new="8"], .am-engine-view ul ol[data-indent-new="8"], .am-engine ol ol[data-indent-new="11"], .am-engine-view ol ol[data-indent-new="11"], .am-engine ul ol[data-indent-new="11"], .am-engine-view ul ol[data-indent-new="11"], .am-engine ol ol[data-indent-new="14"], .am-engine-view ol ol[data-indent-new="14"], .am-engine ul ol[data-indent-new="14"], .am-engine-view ul ol[data-indent-new="14"], .am-engine ol ol[data-indent-new="17"], .am-engine-view ol ol[data-indent-new="17"], .am-engine ul ol[data-indent-new="17"], .am-engine-view ul ol[data-indent-new="17"], .am-engine ol ol[data-indent-new="20"], .am-engine-view ol ol[data-indent-new="20"], .am-engine ul ol[data-indent-new="20"], .am-engine-view ul ol[data-indent-new="20"] {\r\n    list-style-type: lower-roman;\r\n}\r\n\r\n.am-engine ol ul[data-indent-new="3"], .am-engine-view ol ul[data-indent-new="3"], .am-engine ul ul[data-indent-new="3"], .am-engine-view ul ul[data-indent-new="3"], .am-engine ol ul[data-indent-new="6"], .am-engine-view ol ul[data-indent-new="6"], .am-engine ul ul[data-indent-new="6"], .am-engine-view ul ul[data-indent-new="6"], .am-engine ol ul[data-indent-new="9"], .am-engine-view ol ul[data-indent-new="9"], .am-engine ul ul[data-indent-new="9"], .am-engine-view ul ul[data-indent-new="9"], .am-engine ol ul[data-indent-new="12"], .am-engine-view ol ul[data-indent-new="12"], .am-engine ul ul[data-indent-new="12"], .am-engine-view ul ul[data-indent-new="12"], .am-engine ol ul[data-indent-new="15"], .am-engine-view ol ul[data-indent-new="15"], .am-engine ul ul[data-indent-new="15"], .am-engine-view ul ul[data-indent-new="15"], .am-engine ol ul[data-indent-new="18"], .am-engine-view ol ul[data-indent-new="18"], .am-engine ul ul[data-indent-new="18"], .am-engine-view ul ul[data-indent-new="18"] {\r\n    list-style-type: disc;\r\n}\r\n\r\n.am-engine ol ul[data-indent-new="1"], .am-engine-view ol ul[data-indent-new="1"], .am-engine ul ul[data-indent-new="1"], .am-engine-view ul ul[data-indent-new="1"], .am-engine ol ul[data-indent-new="4"], .am-engine-view ol ul[data-indent-new="4"], .am-engine ul ul[data-indent-new="4"], .am-engine-view ul ul[data-indent-new="4"], .am-engine ol ul[data-indent-new="7"], .am-engine-view ol ul[data-indent-new="7"], .am-engine ul ul[data-indent-new="7"], .am-engine-view ul ul[data-indent-new="7"], .am-engine ol ul[data-indent-new="10"], .am-engine-view ol ul[data-indent-new="10"], .am-engine ul ul[data-indent-new="10"], .am-engine-view ul ul[data-indent-new="10"], .am-engine ol ul[data-indent-new="13"], .am-engine-view ol ul[data-indent-new="13"], .am-engine ul ul[data-indent-new="13"], .am-engine-view ul ul[data-indent-new="13"], .am-engine ol ul[data-indent-new="16"], .am-engine-view ol ul[data-indent-new="16"], .am-engine ul ul[data-indent-new="16"], .am-engine-view ul ul[data-indent-new="16"], .am-engine ol ul[data-indent-new="19"], .am-engine-view ol ul[data-indent-new="19"], .am-engine ul ul[data-indent-new="19"], .am-engine-view ul ul[data-indent-new="19"] {\r\n    list-style-type: circle;\r\n}\r\n\r\n.am-engine ol ul[data-indent-new="2"], .am-engine-view ol ul[data-indent-new="2"], .am-engine ul ul[data-indent-new="2"], .am-engine-view ul ul[data-indent-new="2"], .am-engine ol ul[data-indent-new="5"], .am-engine-view ol ul[data-indent-new="5"], .am-engine ul ul[data-indent-new="5"], .am-engine-view ul ul[data-indent-new="5"], .am-engine ol ul[data-indent-new="8"], .am-engine-view ol ul[data-indent-new="8"], .am-engine ul ul[data-indent-new="8"], .am-engine-view ul ul[data-indent-new="8"], .am-engine ol ul[data-indent-new="11"], .am-engine-view ol ul[data-indent-new="11"], .am-engine ul ul[data-indent-new="11"], .am-engine-view ul ul[data-indent-new="11"], .am-engine ol ul[data-indent-new="14"], .am-engine-view ol ul[data-indent-new="14"], .am-engine ul ul[data-indent-new="14"], .am-engine-view ul ul[data-indent-new="14"], .am-engine ol ul[data-indent-new="17"], .am-engine-view ol ul[data-indent-new="17"], .am-engine ul ul[data-indent-new="17"], .am-engine-view ul ul[data-indent-new="17"], .am-engine ol ul[data-indent-new="20"], .am-engine-view ol ul[data-indent-new="20"], .am-engine ul ul[data-indent-new="20"], .am-engine-view ul ul[data-indent-new="20"] {\r\n    list-style-type: square;\r\n}\r\n\r\n.am-engine li, .am-engine-view li {\r\n    margin-left: 23px;\r\n    position: relative;\r\n}\r\n\r\n.am-engine ol, .am-engine-view ol, .am-engine ol[data-indent="3"], .am-engine-view ol[data-indent="3"], .am-engine ol[data-indent="6"], .am-engine-view ol[data-indent="6"], .am-engine ol[data-indent="9"], .am-engine-view ol[data-indent="9"], .am-engine ol[data-indent="12"], .am-engine-view ol[data-indent="12"], .am-engine ol[data-indent="15"], .am-engine-view ol[data-indent="15"], .am-engine ol[data-indent="18"], .am-engine-view ol[data-indent="18"] {\r\n    list-style-type: decimal;\r\n}\r\n\r\n.am-engine ol[data-indent="1"], .am-engine-view ol[data-indent="1"], .am-engine ol[data-indent="4"], .am-engine-view ol[data-indent="4"], .am-engine ol[data-indent="7"], .am-engine-view ol[data-indent="7"], .am-engine ol[data-indent="10"], .am-engine-view ol[data-indent="10"], .am-engine ol[data-indent="13"], .am-engine-view ol[data-indent="13"], .am-engine ol[data-indent="16"], .am-engine-view ol[data-indent="16"], .am-engine ol[data-indent="19"], .am-engine-view ol[data-indent="19"] {\r\n    list-style-type: lower-alpha;\r\n}\r\n\r\n.am-engine ol[data-indent="2"], .am-engine-view ol[data-indent="2"], .am-engine ol[data-indent="5"], .am-engine-view ol[data-indent="5"], .am-engine ol[data-indent="8"], .am-engine-view ol[data-indent="8"], .am-engine ol[data-indent="11"], .am-engine-view ol[data-indent="11"], .am-engine ol[data-indent="14"], .am-engine-view ol[data-indent="14"], .am-engine ol[data-indent="17"], .am-engine-view ol[data-indent="17"], .am-engine ol[data-indent="20"], .am-engine-view ol[data-indent="20"] {\r\n    list-style-type: lower-roman;\r\n}\r\n\r\n.am-engine ul, .am-engine-view ul, .am-engine ul[data-indent="3"], .am-engine-view ul[data-indent="3"], .am-engine ul[data-indent="6"], .am-engine-view ul[data-indent="6"], .am-engine ul[data-indent="9"], .am-engine-view ul[data-indent="9"], .am-engine ul[data-indent="12"], .am-engine-view ul[data-indent="12"], .am-engine ul[data-indent="15"], .am-engine-view ul[data-indent="15"], .am-engine ul[data-indent="18"], .am-engine-view ul[data-indent="18"] {\r\n    list-style-type: disc;\r\n}\r\n\r\n.am-engine ul[data-indent="1"], .am-engine-view ul[data-indent="1"], .am-engine ul[data-indent="4"], .am-engine-view ul[data-indent="4"], .am-engine ul[data-indent="7"], .am-engine-view ul[data-indent="7"], .am-engine ul[data-indent="10"], .am-engine-view ul[data-indent="10"], .am-engine ul[data-indent="13"], .am-engine-view ul[data-indent="13"], .am-engine ul[data-indent="16"], .am-engine-view ul[data-indent="19"], .am-engine ul[data-indent="19"], .am-engine-view ul[data-indent="19"] {\r\n    list-style-type: circle;\r\n}\r\n\r\n.am-engine ul[data-indent="2"], .am-engine-view ul[data-indent="2"], .am-engine ul[data-indent="5"], .am-engine-view ul[data-indent="5"], .am-engine ul[data-indent="8"], .am-engine-view ul[data-indent="8"], .am-engine ul[data-indent="11"], .am-engine-view ul[data-indent="11"], .am-engine ul[data-indent="14"], .am-engine-view ul[data-indent="14"], .am-engine ul[data-indent="17"], .am-engine-view ul[data-indent="17"], .am-engine ul[data-indent="20"], .am-engine-view ul[data-indent="20"] {\r\n    list-style-type: square;\r\n}\r\n\r\n.am-engine ol[data-indent="1"], .am-engine-view ol[data-indent="1"], .am-engine ul[data-indent="1"], .am-engine-view ul[data-indent="1"] {\r\n    padding-left: 2em;\r\n}\r\n\r\n.am-engine ol[data-indent="2"], .am-engine-view ol[data-indent="2"], .am-engine ul[data-indent="2"], .am-engine-view ul[data-indent="2"] {\r\n    padding-left: 4em;\r\n}\r\n\r\n.am-engine ol[data-indent="3"], .am-engine-view ol[data-indent="3"], .am-engine ul[data-indent="3"], .am-engine-view ul[data-indent="3"] {\r\n    padding-left: 6em;\r\n}\r\n\r\n.am-engine ol[data-indent="4"], .am-engine-view ol[data-indent="4"], .am-engine ul[data-indent="4"], .am-engine-view ul[data-indent="4"] {\r\n    padding-left: 8em;\r\n}\r\n\r\n.am-engine ol[data-indent="5"], .am-engine-view ol[data-indent="5"], .am-engine ul[data-indent="5"], .am-engine-view ul[data-indent="5"] {\r\n    padding-left: 10em;\r\n}\r\n\r\n.am-engine ol[data-indent="6"], .am-engine-view ol[data-indent="6"], .am-engine ul[data-indent="6"], .am-engine-view ul[data-indent="6"] {\r\n    padding-left: 12em;\r\n}\r\n\r\n.am-engine ol[data-indent="7"], .am-engine-view ol[data-indent="7"], .am-engine ul[data-indent="7"], .am-engine-view ul[data-indent="7"] {\r\n    padding-left: 14em;\r\n}\r\n\r\n.am-engine ol[data-indent="8"], .am-engine-view ol[data-indent="8"], .am-engine ul[data-indent="8"], .am-engine-view ul[data-indent="8"] {\r\n    padding-left: 16em;\r\n}\r\n\r\n.am-engine ol[data-indent="8"], .am-engine-view ol[data-indent="8"], .am-engine ul[data-indent="8"], .am-engine-view ul[data-indent="8"] {\r\n    padding-left: 16em;\r\n}\r\n\r\n.am-engine ol[data-indent="9"], .am-engine-view ol[data-indent="9"], .am-engine ul[data-indent="9"], .am-engine-view ul[data-indent="9"] {\r\n    padding-left: 18em;\r\n}\r\n\r\n.am-engine ol[data-indent="10"], .am-engine-view ol[data-indent="10"], .am-engine ul[data-indent="10"], .am-engine-view ul[data-indent="10"] {\r\n    padding-left: 20em;\r\n}\r\n\r\n.am-engine ol[data-indent="11"], .am-engine-view ol[data-indent="11"], .am-engine ul[data-indent="11"], .am-engine-view ul[data-indent="11"] {\r\n    padding-left: 22em;\r\n}\r\n\r\n.am-engine ol[data-indent="12"], .am-engine-view ol[data-indent="12"], .am-engine ul[data-indent="8"], .am-engine-view ul[data-indent="12"] {\r\n    padding-left: 24em;\r\n}\r\n\r\n.am-engine ol[data-indent="13"], .am-engine-view ol[data-indent="13"], .am-engine ul[data-indent="13"], .am-engine-view ul[data-indent="13"] {\r\n    padding-left: 26em;\r\n}\r\n\r\n.am-engine ol[data-indent="14"], .am-engine-view ol[data-indent="14"], .am-engine ul[data-indent="14"], .am-engine-view ul[data-indent="14"] {\r\n    padding-left: 28em;\r\n}\r\n\r\n.am-engine ol[data-indent="15"], .am-engine-view ol[data-indent="15"], .am-engine ul[data-indent="15"], .am-engine-view ul[data-indent="15"] {\r\n    padding-left: 30em;\r\n}\r\n\r\n.am-engine ol[data-indent="16"], .am-engine-view ol[data-indent="16"], .am-engine ul[data-indent="16"], .am-engine-view ul[data-indent="16"] {\r\n    padding-left: 32em;\r\n}\r\n\r\n.am-engine ol[data-indent="17"], .am-engine-view ol[data-indent="17"], .am-engine ul[data-indent="17"], .am-engine-view ul[data-indent="17"] {\r\n    padding-left: 34em;\r\n}\r\n\r\n.am-engine ol[data-indent="18"], .am-engine-view ol[data-indent="18"], .am-engine ul[data-indent="18"], .am-engine-view ul[data-indent="18"] {\r\n    padding-left: 36em;\r\n}\r\n\r\n.am-engine ol[data-indent="19"], .am-engine-view ol[data-indent="19"], .am-engine ul[data-indent="19"], .am-engine-view ul[data-indent="19"] {\r\n    padding-left: 38em;\r\n}\r\n\r\n.am-engine ol[data-indent="20"], .am-engine-view ol[data-indent="20"], .am-engine ul[data-indent="20"], .am-engine-view ul[data-indent="20"] {\r\n    padding-left: 40em;\r\n}\r\n\r\n.am-engine .data-list, .am-engine-view .data-list {\r\n    color: #262626;\r\n    text-indent: 0;\r\n}\r\n\r\n.am-engine .data-list-item, .am-engine-view .data-list-item {\r\n    line-height: inherit;\r\n    position: relative;\r\n    list-style: none;\r\n    text-indent: 0;\r\n}\r\n');class Xs extends qs{constructor(){super(...arguments),this.isPasteList=!1,this.canMerge=!0,this.pasteBefore=e=>{const t=this.editor;if(!this.cardName||!t)return;const{list:n}=t,r=Ss(e).allChildren();r.forEach(e=>{"li"===e.name&&e.hasClass(n.CUSTOMZIE_LI_CLASS)&&(e.first()?.isCard()?e.closest("ul").addClass(n.CUSTOMZIE_UL_CLASS):(e.removeClass(n.CUSTOMZIE_LI_CLASS),e.closest("ul").removeClass(n.CUSTOMZIE_UL_CLASS)))}),this.isPasteList=r.some(e=>"li"===e.name)},this.pasteInsert=()=>{const e=this.editor;if(!this.cardName||!Es(e))return;const{change:t,list:n}=e,r=t.range.get().getRootBlock(),i=r?.next(),s=i?.find(`li.${n.CUSTOMZIE_LI_CLASS}`);s&&s.length>0&&s.each(e=>{const t=Ss(e);0===t.find(`[${ci}=${this.cardName}],[${di}=${this.cardName}]`).length&&n.addReadyCardToCustomize(t,this.cardName)})},this.pasteAfter=()=>{this.isPasteList&&this.editor?.list.merge()}}init(){super.init();const e=this.editor;Es(e)&&(e.on("paste:before",this.pasteBefore),e.on("paste:insert",this.pasteInsert),e.on("paste:after",this.pasteAfter))}queryState(){const e=this.editor;return!!Es(e)&&e.list.getPluginNameByNodes(e.change.blocks)===this.constructor.pluginName}destroy(){const e=this.editor;Es(e)&&(e.off("paste:before",this.pasteBefore),e.off("paste:insert",this.pasteInsert),e.off("paste:after",this.pasteAfter))}}class Us extends js{constructor(){super(...arguments),this.kind="mark",this.followStyle=!0,this.combineValueByWrap=!1,this.mergeLeval=1}execute(...e){const t=this.editor;if(!Es(t))return;const{change:n,mark:r}=t,i=this.createElement(...e);if(this.isTrigger?this.isTrigger(...e):!this.queryState()){if(!this.followStyle&&n.range.get().collapsed)return;r.wrap(i)}else r.unwrap(i)}queryState(){const e=this.editor;if(!Es(e))return;const{change:t}=e;if(!this.style&&!this.attributes)return t.marks.some(e=>e.name===this.tagName);const n=[];return t.marks.forEach(e=>{n.push(...Object.values(this.getStyle(e))),n.push(...Object.values(this.getAttributes(e)))}),0===n.length?void 0:n}schema(){const e=super.schema();return Array.isArray(e)?e.map(e=>({...e})):{...e}}}const Ys=e=>"mark"===e.kind;class Ks{constructor(e){this.data={},this.components={},this.editor=e}init(e,t){e.forEach(e=>{this.data[e.pluginName]=e;const n=new e(this.editor,t[e.pluginName]);this.components[e.pluginName]=n,n.init&&n.init()})}add(e,t){this.data[e.pluginName]=e,t={...t};const n=this.editor;if(Es(n)){const r=new e(n,t);r.init&&r.init(),this.components[e.pluginName]=r}}findPlugin(e){const t=this.components[e];if(t)return t}findElementPlugin(e){const t=this.findPlugin(e);if(t)return(e=>"element"===e.kind)(t)?t:void 0}findMarkPlugin(e){const t=this.findPlugin(e);if(t)return Ys(t)?t:void 0}findInlinePlugin(e){const t=this.findPlugin(e);if(t)return Hs(t)?t:void 0}findBlockPlugin(e){const t=this.findPlugin(e);if(t)return Ws(t)?t:void 0}each(e){Object.keys(this.data).forEach((t,n)=>{e&&!1===e(t,this.data[t],n)&&console.log(t,n)})}destroy(){Object.keys(this.components).forEach(e=>{const t=this.components[e];t.destroy&&t.destroy()})}}class Zs{constructor(e){this.editor=e}queryEnabled(e){const t=this.editor,n=t.plugin.components[e];if(!n||n.disabled)return!1;if((!Es(t)||t.readonly)&&!1!==n.disabled)return!1;const r=t.card;return!r.active||(!(!Ys(n)&&"plugin"!==n.kind||!r.active.executeMark)||r.active.isEditable)}queryState(e,...t){const n=this.editor,r=n.plugin.components[e];if(r&&r.queryState)try{return r.queryState(t)}catch(e){n.messageError("command-query",e)}}handleExecuteBefore(){let e;const t=this.editor;if(Es(t)){e=t.change;const n=e.range.get();if(!n.commonAncestorNode.isRoot()&&!n.commonAncestorNode.inEditor()){const e=n.commonAncestorNode.closest(Kr);let r;if(e.length>0){const n=e.attributes(Ni);if(n){const{card:e}=t;r=e.find(n),r&&e.select(r)}}r||t.focus()}e.cacheRangeBeforeCommand()}return e}execute(e,...t){const n=this.editor,r=n.plugin.components[e];if(r&&r.execute){const i=this.handleExecuteBefore();n.trigger("beforeCommandExecute",e,...t);try{const s=r.execute(...t);return i?.combinText(),i?.onSelect(),n.trigger("afterCommandExecute",e,...t),s}catch(e){n.messageError("command-execute",e)}}}executeMethod(e,t,...n){const r=this.editor,i=r.plugin.components[e];if(i&&i[t])try{return i[t](...n)}catch(e){r.messageError("command-excute-method",e)}}}var Gs=function(e,t){for(var n=-1,r=null==e?0:e.length;++n<r&&!1!==t(e[n],n,e););return e},Js=At(Object.keys,Object),Qs=Bt,eo=Js,to=Object.prototype.hasOwnProperty;var no=Wn,ro=function(e){if(!Qs(e))return eo(e);var t=[];for(var n in Object(e))to.call(e,n)&&"constructor"!=n&&t.push(n);return t},io=Zt;var so=function(e){return io(e)?no(e):ro(e)},oo=Bn,ao=so;var lo=function(e,t){return e&&oo(t,ao(t),e)},co=Bn,ho=Zn;var uo=function(e,t){return e&&co(t,ho(t),e)};var fo=function(){return[]},go=function(e,t){for(var n=-1,r=null==e?0:e.length,i=0,s=[];++n<r;){var o=e[n];t(o,n,e)&&(s[i++]=o)}return s},po=fo,mo=Object.prototype.propertyIsEnumerable,bo=Object.getOwnPropertySymbols,vo=bo?function(e){return null==e?[]:(e=Object(e),go(bo(e),function(t){return mo.call(e,t)}))}:po,yo=Bn,wo=vo;var No=function(e,t){return yo(e,wo(e),t)};var xo=function(e,t){for(var n=-1,r=t.length,i=e.length;++n<r;)e[i+n]=t[n];return e},Eo=xo,Co=Mt,ko=vo,To=fo,Oo=Object.getOwnPropertySymbols?function(e){for(var t=[];e;)Eo(t,ko(e)),e=Co(e);return t}:To,So=Bn,Ao=Oo;var Mo=function(e,t){return So(e,Ao(e),t)},_o=xo,Bo=Xt;var Ro=function(e,t,n){var r=t(e);return Bo(e)?r:_o(r,n(e))},Io=Ro,Lo=vo,Do=so;var zo=function(e){return Io(e,Do,Lo)},Po=Ro,$o=Oo,jo=Zn;var qo=function(e){return Po(e,jo,$o)},Wo=ye(P,"DataView"),Vo=we,Ho=ye(P,"Promise"),Fo=ye(P,"Set"),Xo=ye(P,"WeakMap"),Uo=Z,Yo=oe,Ko="[object Map]",Zo="[object Promise]",Go="[object Set]",Jo="[object WeakMap]",Qo="[object DataView]",ea=Yo(Wo),ta=Yo(Vo),na=Yo(Ho),ra=Yo(Fo),ia=Yo(Xo),sa=Uo;(Wo&&sa(new Wo(new ArrayBuffer(1)))!=Qo||Vo&&sa(new Vo)!=Ko||Ho&&sa(Ho.resolve())!=Zo||Fo&&sa(new Fo)!=Go||Xo&&sa(new Xo)!=Jo)&&(sa=function(e){var t=Uo(e),n="[object Object]"==t?e.constructor:void 0,r=n?Yo(n):"";if(r)switch(r){case ea:return Qo;case ta:return Ko;case na:return Zo;case ra:return Go;case ia:return Jo}return t});var oa=sa,aa=Object.prototype.hasOwnProperty;var la=function(e){var t=e.length,n=new e.constructor(t);return t&&"string"==typeof e[0]&&aa.call(e,"index")&&(n.index=e.index,n.input=e.input),n},ca=xt;var da=function(e,t){var n=t?ca(e.buffer):e.buffer;return new e.constructor(n,e.byteOffset,e.byteLength)},ha=/\w*$/;var ua=function(e){var t=new e.constructor(e.source,ha.exec(e));return t.lastIndex=e.lastIndex,t},fa=$?$.prototype:void 0,ga=fa?fa.valueOf:void 0;var pa=xt,ma=da,ba=ua,va=function(e){return ga?Object(ga.call(e)):{}},ya=Ct;var wa=function(e,t,n){var r=e.constructor;switch(t){case"[object ArrayBuffer]":return pa(e);case"[object Boolean]":case"[object Date]":return new r(+e);case"[object DataView]":return ma(e,n);case"[object Float32Array]":case"[object Float64Array]":case"[object Int8Array]":case"[object Int16Array]":case"[object Int32Array]":case"[object Uint8Array]":case"[object Uint8ClampedArray]":case"[object Uint16Array]":case"[object Uint32Array]":return ya(e,n);case"[object Map]":case"[object Set]":return new r;case"[object Number]":case"[object String]":return new r(e);case"[object RegExp]":return ba(e);case"[object Symbol]":return va(e)}},Na=oa,xa=zt;var Ea=function(e){return xa(e)&&"[object Map]"==Na(e)},Ca=vn,ka=wn&&wn.isMap,Ta=ka?Ca(ka):Ea,Oa=oa,Sa=zt;var Aa=function(e){return Sa(e)&&"[object Set]"==Oa(e)},Ma=vn,_a=wn&&wn.isSet,Ba=_a?Ma(_a):Aa,Ra=ct,Ia=Gs,La=An,Da=lo,za=uo,Pa=yt,$a=kt,ja=No,qa=Mo,Wa=zo,Va=qo,Ha=oa,Fa=la,Xa=wa,Ua=Dt,Ya=Xt,Ka=nn,Za=Ta,Ga=G,Ja=Ba,Qa=so,el=Zn,tl="[object Arguments]",nl="[object Function]",rl="[object Object]",il={};il[tl]=il["[object Array]"]=il["[object ArrayBuffer]"]=il["[object DataView]"]=il["[object Boolean]"]=il["[object Date]"]=il["[object Float32Array]"]=il["[object Float64Array]"]=il["[object Int8Array]"]=il["[object Int16Array]"]=il["[object Int32Array]"]=il["[object Map]"]=il["[object Number]"]=il[rl]=il["[object RegExp]"]=il["[object Set]"]=il["[object String]"]=il["[object Symbol]"]=il["[object Uint8Array]"]=il["[object Uint8ClampedArray]"]=il["[object Uint16Array]"]=il["[object Uint32Array]"]=!0,il["[object Error]"]=il[nl]=il["[object WeakMap]"]=!1;var sl=function e(t,n,r,i,s,o){var a,l=1&n,c=2&n,d=4&n;if(r&&(a=s?r(t,i,s,o):r(t)),void 0!==a)return a;if(!Ga(t))return t;var h=Ya(t);if(h){if(a=Fa(t),!l)return $a(t,a)}else{var u=Ha(t),f=u==nl||"[object GeneratorFunction]"==u;if(Ka(t))return Pa(t,l);if(u==rl||u==tl||f&&!s){if(a=c||f?{}:Ua(t),!l)return c?qa(t,za(a,t)):ja(t,Da(a,t))}else{if(!il[u])return s?t:{};a=Xa(t,u,l)}}o||(o=new Ra);var g=o.get(t);if(g)return g;o.set(t,a),Ja(t)?t.forEach(function(i){a.add(e(i,n,r,i,t,o))}):Za(t)&&t.forEach(function(i,s){a.set(s,e(i,n,r,s,t,o))});var p=h?void 0:(d?c?Va:Wa:c?el:Qa)(t);return Ia(p||t,function(i,s){p&&(i=t[s=i]),La(a,s,e(i,n,r,s,t,o))}),a},ol=sl;var al=f(function(e){return ol(e,5)});var ll=Je,cl=function(e){return this.__data__.set(e,"__lodash_hash_undefined__"),this},dl=function(e){return this.__data__.has(e)};function hl(e){var t=-1,n=null==e?0:e.length;for(this.__data__=new ll;++t<n;)this.add(e[t])}hl.prototype.add=hl.prototype.push=cl,hl.prototype.has=dl;var ul=hl,fl=function(e,t){for(var n=-1,r=null==e?0:e.length;++n<r;)if(t(e[n],n,e))return!0;return!1},gl=function(e,t){return e.has(t)};var pl=function(e,t,n,r,i,s){var o=1&n,a=e.length,l=t.length;if(a!=l&&!(o&&l>a))return!1;var c=s.get(e),d=s.get(t);if(c&&d)return c==t&&d==e;var h=-1,u=!0,f=2&n?new ul:void 0;for(s.set(e,t),s.set(t,e);++h<a;){var g=e[h],p=t[h];if(r)var m=o?r(p,g,h,t,e,s):r(g,p,h,e,t,s);if(void 0!==m){if(m)continue;u=!1;break}if(f){if(!fl(t,function(e,t){if(!gl(f,t)&&(g===e||i(g,e,n,r,s)))return f.push(t)})){u=!1;break}}else if(g!==p&&!i(g,p,n,r,s)){u=!1;break}}return s.delete(e),s.delete(t),u};var ml=wt,bl=p,vl=pl,yl=function(e){var t=-1,n=Array(e.size);return e.forEach(function(e,r){n[++t]=[r,e]}),n},wl=function(e){var t=-1,n=Array(e.size);return e.forEach(function(e){n[++t]=e}),n},Nl=$?$.prototype:void 0,xl=Nl?Nl.valueOf:void 0;var El=function(e,t,n,r,i,s,o){switch(n){case"[object DataView]":if(e.byteLength!=t.byteLength||e.byteOffset!=t.byteOffset)return!1;e=e.buffer,t=t.buffer;case"[object ArrayBuffer]":return!(e.byteLength!=t.byteLength||!s(new ml(e),new ml(t)));case"[object Boolean]":case"[object Date]":case"[object Number]":return bl(+e,+t);case"[object Error]":return e.name==t.name&&e.message==t.message;case"[object RegExp]":case"[object String]":return e==t+"";case"[object Map]":var a=yl;case"[object Set]":var l=1&r;if(a||(a=wl),e.size!=t.size&&!l)return!1;var c=o.get(e);if(c)return c==t;r|=2,o.set(e,t);var d=vl(a(e),a(t),r,i,s,o);return o.delete(e),d;case"[object Symbol]":if(xl)return xl.call(e)==xl.call(t)}return!1},Cl=zo,kl=Object.prototype.hasOwnProperty;var Tl=ct,Ol=pl,Sl=El,Al=function(e,t,n,r,i,s){var o=1&n,a=Cl(e),l=a.length;if(l!=Cl(t).length&&!o)return!1;for(var c=l;c--;){var d=a[c];if(!(o?d in t:kl.call(t,d)))return!1}var h=s.get(e),u=s.get(t);if(h&&u)return h==t&&u==e;var f=!0;s.set(e,t),s.set(t,e);for(var g=o;++c<l;){var p=e[d=a[c]],m=t[d];if(r)var b=o?r(m,p,d,t,e,s):r(p,m,d,e,t,s);if(!(void 0===b?p===m||i(p,m,n,r,s):b)){f=!1;break}g||(g="constructor"==d)}if(f&&!g){var v=e.constructor,y=t.constructor;v==y||!("constructor"in e)||!("constructor"in t)||"function"==typeof v&&v instanceof v&&"function"==typeof y&&y instanceof y||(f=!1)}return s.delete(e),s.delete(t),f},Ml=oa,_l=Xt,Bl=nn,Rl=Cn,Il="[object Arguments]",Ll="[object Array]",Dl="[object Object]",zl=Object.prototype.hasOwnProperty;var Pl=function(e,t,n,r,i,s){var o=_l(e),a=_l(t),l=o?Ll:Ml(e),c=a?Ll:Ml(t),d=(l=l==Il?Dl:l)==Dl,h=(c=c==Il?Dl:c)==Dl,u=l==c;if(u&&Bl(e)){if(!Bl(t))return!1;o=!0,d=!1}if(u&&!d)return s||(s=new Tl),o||Rl(e)?Ol(e,t,n,r,i,s):Sl(e,t,l,n,r,i,s);if(!(1&n)){var f=d&&zl.call(e,"__wrapped__"),g=h&&zl.call(t,"__wrapped__");if(f||g){var p=f?e.value():e,m=g?t.value():t;return s||(s=new Tl),i(p,m,n,r,s)}}return!!u&&(s||(s=new Tl),Al(e,t,n,r,i,s))},$l=zt;var jl=function e(t,n,r,i,s){return t===n||(null==t||null==n||!$l(t)&&!$l(n)?t!=t&&n!=n:Pl(t,n,r,i,e,s))},ql=jl;var Wl=f(function(e,t){return ql(e,t)});const Vl=["blocks","inlines","marks","globals"];class Hl{constructor(){this._all=[],this._typeMap={},this._invalidKeys=[],this._tagMap={blocks:[],inlines:[],marks:[]},this.data={blocks:[],inlines:[],marks:[],globals:{}}}add(e,t=!1){e=al(e),Array.isArray(e)||(e=[e]),e.forEach(e=>{const n=this.data[`${e.type}s`];Xl(e)?(e.attributes&&Object.keys(e.attributes).forEach(t=>{this.data.globals[e.type]&&("style"===t?Object.keys(e.attributes.style).forEach(n=>{this.data.globals[e.type][t]&&this.data.globals[e.type][t][n]===e.attributes.style[n]&&delete e.attributes.style[n]}):this.data.globals[e.type][t]===e.attributes?.[t]&&delete e.attributes[t])}),n&&(t?this.data[`${e.type}s`]=n.map(t=>(t.name===e.name&&(t.attributes=qr(Object.assign({},t.attributes),e.attributes)),t)):n.push(e))):n&&(this.data.globals[e.type]=qr(Object.assign({},this.data.globals[e.type]),e.attributes))}),this.updateTagMap();const n=e=>{const t=e.attributes||{},n=t.style||{};let r=0,i=0;return Object.keys(t).forEach(e=>{const n=t[e];Fl(n)&&n.required&&r++}),Object.keys(n).forEach(e=>{const t=n[e];Fl(t)&&t.required&&i++}),[r,i]},{blocks:r,marks:i,inlines:s}=this.data;this._all=[...r,...i,...s].sort((e,t)=>{const[r,i]=n(e),[s,o]=n(t);return r>s?-1:r===s?i===o?0:i>o?-1:1:1})}updateTagMap(){this._tagMap.marks=[],this.data.marks.forEach(e=>{~~this._tagMap.marks.indexOf(e.name)&&this._tagMap.marks.push(e.name)}),this._tagMap.blocks=[],this.data.blocks.forEach(e=>{~~this._tagMap.blocks.indexOf(e.name)&&this._tagMap.blocks.push(e.name)}),this._tagMap.inlines=[],this.data.inlines.forEach(e=>{~~this._tagMap.inlines.indexOf(e.name)&&this._tagMap.inlines.push(e.name)})}getTags(e){return this._tagMap[e]}remove(e){let t=this._all.findIndex(t=>Wl(t,e));t>-1&&this._all.splice(t,1);const n=this.data[`${e.type}s`];n&&(t=n.findIndex(t=>Wl(t,e)),t>-1&&n.splice(t,1)),this._typeMap={},this.updateTagMap()}clone(){const e=new Hl;return e._all=al(this._all),e._typeMap=al(this._typeMap),e._tagMap=al(this._tagMap),e.data=al(this.data),e}find(e){const t=[];return Vl.forEach(n=>{if("globals"!==n){const r=this.data[n].filter(e);t.push(...r)}}),t}getType(e,t){const n=Mi(e)?e:e[0];if(!n||n.nodeType!==Node.ELEMENT_NODE)return;let r=n.getAttribute(Fr);if(r=r?r.split("-")[0]:zs(n,!1),"CARD"!==n.nodeName&&~this._invalidKeys.indexOf(r))return;const i=this._typeMap[r];if(i&&(!t||t(i)))return i.type;const s=this.getRule(n,t);return s?this._typeMap[r]=s:this._invalidKeys.push(r),s?.type}getRule(e,t){const n=Mi(e)?e:e[0];return t=t||(e=>e.name===n.localName),this._all.find(e=>t(e)&&this.checkNode(n,e.attributes))}checkNode(e,t={}){const n=Mi(e)?e:e[0];for(const e in t){if("style"===e)continue;const r=t;if(!r[e])return!1;if(!this.checkValue(r,e,n.getAttribute(e)??void 0))return!1}const r=as(n.getAttribute("style")||""),i=t.style||{};for(const e in i){if(!i[e])return!1;if(!this.checkValue(i,e,r[e]))return!1}return!0}checkValue(e,t,n,r){if(!e[t])return!1;let i=e[t];if(Fl(i)){if(void 0===n)return!i.required;i=i.value}else if(!r||void 0===n)return!0;if("string"==typeof i&&"@"===i.charAt(0))switch(i){case"@number":i=/^-?\d+(\.\d+)?$/;break;case"@length":i=/^-?\d+(\.\d+)?(\w*|%)$/;break;case"@color":i=/^(rgb(.+?)|#\w{3,8}|\w+)$/i;break;case"@url":i=vs}return"string"==typeof i?"*"===i||("class"===t?(n||"").split(/\s+/).some(e=>e.trim()===i):i===n):Array.isArray(i)?"class"===t?(n||(n="*"),n.split(/\s+/).every(e=>""===e.trim()||~i.indexOf(e.trim()))):i.indexOf(n)>-1:"object"==typeof i&&"function"==typeof i.test?"class"===t?(n||"").split(/\s+/).every(e=>""===e.trim()||i.test(e.trim())):i.test(n||""):"function"!=typeof i||i(n)}filterStyles(e,t,n){Object.keys(e).forEach(r=>{t.attributes?.style&&this.checkValue(t.attributes.style,r,e[r],!0)||(n&&n(r,e[r]),delete e[r])})}filterAttributes(e,t,n){Object.keys(e).forEach(r=>{t.attributes&&this.checkValue(t.attributes,r,e[r],!0)||(n&&n(r,e[r]),delete e[r])})}filter(e,t,n,r=!1){const i=this.getRule(e);if(!i)return;const{globals:s}=this.data,o=s[i.type]?i.type:void 0,a=Object.assign({},i,{attributes:qr({},i.attributes,o?s[o]:{})});this.filterAttributes(t,a,r?t=>e.removeAttributes(t):void 0),this.filterStyles(n,a,r?t=>e.css(t,""):void 0)}closest(e){let t=e;return this.data.blocks.forEach(n=>{if(n.name!==e)return;const r=n;r.allowIn&&(r.allowIn.forEach(e=>{this.isAllowIn(e,t)&&(t=e)}),t=this.closest(t))}),t}isAllowIn(e,t){return"p"!==e&&this.data.blocks.some(n=>{if(n.name!==t)return!1;const r=n;return!!(r.allowIn&&r.allowIn.indexOf(e)>-1)})}addAllowIn(e,t="p"){const n=this.data.blocks.find(e=>e.name===t);n.allowIn||(n.allowIn=[]),~~n.allowIn.indexOf(e)&&n.allowIn.push(e)}getAllowInTags(){const e=[];return this.data.blocks.forEach(t=>{const n=t;n.allowIn&&n.allowIn.forEach(t=>{e.indexOf(t)<0&&e.push(t)})}),e}getCanMergeTags(){const e=[];return this.data.blocks.forEach(t=>{const n=t;!0===n.canMerge&&e.indexOf(n.name)<0&&e.push(n.name)}),e}}const Fl=e=>void 0!==e.required,Xl=e=>!!e.name;class Ul{constructor(e){this.data=[],this.editor=e}getData(){return this.data}clone(){const e=al(this.data),t=new Ul(this.editor);return t.data=e,t}add(e,t){this.data.push({from:e,to:t})}transform(e,t){let n=e.name,r=e.attributes(),i=as(r.style||""),s=!1;delete r.style,e.isCursor()&&(n=r[Hr].toLowerCase(),r={},i={});const o=this.data.find(e=>{if(t&&!t(e))return!1;const{from:o,to:a}=e;let l=!1;if("string"==typeof o)l=o===n;else if("function"==typeof o)l=o(n,i,r);else{const e=Object.keys(o);l=e.indexOf(n)>=0&&e.some(e=>{const t=o[e];return Object.keys(t.style||{}).every(e=>{const n=t.style[e];return i[e]&&Array.isArray(n)?n.indexOf(i[e])>-1:n===i[e]})&&Object.keys(t.attributes||{}).every(e=>{const n=t.attributes[e];return i[e]&&Array.isArray(n)?n.indexOf(i[e])>-1:n===i[e]})})}if(l)if("string"==typeof a)n=a,i={},r={};else{const e="function"==typeof a?a(n,i,r):a;let t=e;if(e.hasOwnProperty("replace")){const n=e;t=n.node,s=n.replace}n=t.name,i=t.css(),r=t.attributes()}return l});return o?{rule:o,node:{name:n,style:i,attributes:r},replace:s}:void 0}}var Yl,Kl,Zl;!function(e){e.INLINE="inline",e.BLOCK="block"}(Yl||(Yl={})),function(e){e.CARD_CHANGE="card_change",e.CLICK="click",e.MOUSE_DOWN="mouse_down"}(Kl||(Kl={})),function(e){e.NONE="none",e.BACKGROUND="background",e.BORDER="border"}(Zl||(Zl={}));let Gl=class{constructor(e){this.engine=e}insertNewline(e,t,n){const{change:r}=this.engine,i=Ss("<p><br /></p>");this.engine.nodeId.generate(i),n?t.root.before(i):t.root.after(i),e.select(i,!0),e.collapse(!1),r.range.select(e)}trigger(e){const{change:t,card:n}=this.engine,r=t.range.get(),i=n.find(r.startNode);if(!i)return!0;if(i.type===Yl.INLINE){r.startNode.closest(vi).length>0&&(r.select(i.root),r.collapse(!0),t.range.select(r));r.startNode.closest(wi).length>0&&(r.select(i.root),r.collapse(!1),t.range.select(r))}else{if(r.startNode.closest(vi).length>0){e.preventDefault();const s=i.root.prev();return!s||s.isCard()?(n.focusPrevBlock(i,r,!0),t.range.select(r)):this.insertNewline(r,i,!0),!1}if(r.startNode.closest(wi).length>0){e.preventDefault();const s=i.root.next();return!s||s.isCard()?(n.focusNextBlock(i,r,!0),t.range.select(r)):this.insertNewline(r,i,!1),!1}}return!0}},Jl=class{constructor(e){this.engine=e}focusPrevBlock(e,t=!1){const{change:n}=this.engine,r=n.range.get();let i=(e=e||this.engine.block.closest(r.startNode)).prev();if(i){if(i.isCard()){const e=this.engine.card.find(i);return void(e&&e.focus(r))}this.engine.node.isList(i)&&(i=i.last()),i&&(t&&this.engine.node.isEmptyWithTrim(i)?i.remove():(r.select(i,!0),r.collapse(!1),n.range.select(r.shrinkToTextNode())))}}trigger(e){const{change:t}=this.engine,n=t.range.get().cloneRange().shrinkToElementNode().shrinkToTextNode();if(!n.collapsed)return;const r=this.engine.card.find(n.startNode);if(!r){const r=n.getPrevNode(),i=r?.parent();if(!e.isDelete&&r&&r.isCard()&&(!i||!this.engine.node.isCustomize(i))){e.preventDefault();const i=n.cloneRange();return i.setStartBefore(r),i.collapse(!0),this.engine.card.remove(r),t.range.select(i.shrinkToTextNode()),i.handleBr(),!1}return!0}if(e.isDelete)return!0;if(r.type===Yl.INLINE){if(n.startNode.closest(vi).length>0){const i=r.root.prev();if(!i)return e.preventDefault(),t.mergeAfterDelete(),!1;{const e=this.engine.card.find(i);if(e)return this.engine.card.remove(e.id),n.handleBr(),!1;n.select(r.root).collapse(!0)}t.range.select(n)}if(n.startNode.closest(wi).length>0){e.preventDefault();const i=n.cloneRange();return i.setStartBefore(r.root),i.collapse(!0),this.engine.card.remove(r.id),t.range.select(i.shrinkToTextNode()),i.handleBr(),!1}}else{if(n.startNode.closest(vi).length>0)return e.preventDefault(),r.root.parent()?.inEditor()?t.unwrap(r.root.parent()):this.focusPrevBlock(r.root,!0),!1;if(n.startNode.closest(wi).length>0)return e.preventDefault(),this.focusPrevBlock(r.root),this.engine.card.remove(r.id,!1),t.isEmpty()&&t.initValue(),!1}return!1!==this.engine.trigger("keydown:backspace",e)}},Ql=class{constructor(e){this.engine=e}inline(e,t){const{change:n}=this.engine,r=n.range.get().cloneRange(),{singleSelectable:i}=e.constructor,s=r.commonAncestorNode.closest(vi);if(s.length>0){return e.root.prev()?(r.setStartBefore(e.root[0]),r.collapse(!0)):e.focus(r,!0),n.range.select(r),!0}const o=r.commonAncestorNode.closest(wi),a=0===s.length&&0===o.length;if(o.length>0||a){if(t.preventDefault(),a)e.select(!1),e.toolbarModel?.hide(),e.activate(!1);else if(r.collapsed){const e=this.engine.card.find(r.startNode);if(e&&e.onSelectLeft)return e.onSelectLeft(t)}return a||!1===i?(e.focus(r,!0),e.select(!1),e.toolbarModel?.hide(),n.range.select(r)):this.engine.card.select(e,t),!1}return!0}block(e,t){const{change:n,card:r}=this.engine,i=n.range.get(),s=i.commonAncestorNode.closest(vi);if(s.length>0){return e.root.prev()?(t.preventDefault(),r.focusPrevBlock(e,i,!1),n.range.select(i),!1):void 0}const o=i.commonAncestorNode.closest(wi);if(0===s.length&&0===o.length&&(e.select(!1),e.toolbarModel?.hide(),e.activate(!1)),o.length>0){if(i.collapsed){const e=r.find(i.startNode);if(e&&e.onSelectLeft)return e.onSelectLeft(t)}return t.preventDefault(),r.select(e,t),!1}return!r.getSingleSelectedCard(i)||(t.preventDefault(),e.focus(i,!0),e.select(!1),e.toolbarModel?.hide(),n.range.select(i),!1)}fincPrevCard(e){if(!e.collapsed)return null;const{startNode:t,startOffset:n}=e;if(t.isText()&&0===n){const e=t.prevElement();if(e&&e.isCard())return this.engine.card.find(e)}return null}trigger(e){const{change:t}=this.engine,r=t.range.get(),i=this.engine.card.getSingleCard(r);if(!i){const n=this.fincPrevCard(r);return!n||(e.preventDefault(),n.focus(r,!1),t.range.select(r),!1)}return!n("shift+left",e)&&(i.type===Yl.INLINE?this.inline(i,e):this.block(i,e))}},ec=class{constructor(e){this.engine=e}inline(e,t){const{change:n}=this.engine,r=n.range.get(),{singleSelectable:i}=e.constructor,s=r.commonAncestorNode.closest(vi),o=r.commonAncestorNode.closest(wi),a=0===s.length&&0===o.length;if(s.length>0||a){if(t.preventDefault(),a)e.select(!1),e.activate(!1),e.toolbarModel?.hide();else if(r.collapsed){const e=this.engine.card.find(r.startNode);if(e&&e.onSelectRight)return e.onSelectRight(t)}return a||!1===i?(e.focus(r,!1),e.select(!1),e.toolbarModel?.hide(),n.range.select(r)):this.engine.card.select(e,t),!1}if(o.length>0){e.root.next()?(r.setEndAfter(e.root[0]),r.collapse(!1)):e.focus(r,!1),n.range.select(r)}return!0}block(e,t){const{change:n,card:r}=this.engine,i=n.range.get(),s=i.commonAncestorNode.closest(vi);if(s.length>0){if(i.collapsed){const e=this.engine.card.find(i.startNode);if(e&&e.onSelectRight)return e.onSelectRight(t)}return t.preventDefault(),r.select(e,t),!1}const o=i.commonAncestorNode.closest(wi);if(0===s.length&&0===o.length&&(e.select(!1),e.toolbarModel?.hide(),e.activate(!1)),o.length>0){return e.root.next()?(t.preventDefault(),r.focusNextBlock(e,i,!1),n.range.select(i),!1):void 0}return!this.engine.card.getSingleSelectedCard(i)||(t.preventDefault(),e.focus(i,!1),e.select(!1),e.toolbarModel?.hide(),n.range.select(i),!1)}fincNextCard(e){if(!e.collapsed)return null;const{startNode:t,startOffset:n}=e;if(t.isText()){if(t.text().length===n){const e=t.nextElement();if(e&&e.isCard())return this.engine.card.find(e)}}return null}trigger(e){const{change:t}=this.engine,r=t.range.get(),i=this.engine.card.getSingleCard(r);if(!i){const n=this.fincNextCard(r);return!n||(e.preventDefault(),n.focus(r,!0),t.range.select(r),!1)}if(!n("shift+right",e))return i.type===Yl.INLINE?this.inline(i,e):this.block(i,e)}};const tc=(e,t)=>{const{change:n}=e,r=n.range.get(),i=r.commonAncestorNode.closest(vi),s=r.commonAncestorNode.closest(wi);return!(0!==i.length||0!==s.length)&&(t.select(!1),t.activate(!1),t.toolbarModel?.hide(),!0)};let nc=class{constructor(e){this.engine=e}common(e,t){const{change:n,card:r}=this.engine,i=n.range.get();tc(this.engine,e);if(e.root.prev())return t.preventDefault(),r.focusPrevBlock(e,i,!1),n.range.select(i),!1}inline(e,t){return this.common(e,t)}block(e,t){return this.common(e,t)}trigger(e){const{change:t,card:r,block:i}=this.engine,s=t.range.get();if(s.collapsed){const t=i.closest(s.startNode).prev();if(t?.isCard()){const n=r.find(t);if(n&&n.onSelectUp)return n.onSelectUp(e)}}const o=r.getSingleCard(s);return!o||(n("shift+up",e)?void 0:o.type===Yl.INLINE?this.inline(o,e):this.block(o,e))}},rc=class{constructor(e){this.engine=e}common(e,t){const{change:n,card:r}=this.engine,i=n.range.get();tc(this.engine,e);if(e.root.next())return t.preventDefault(),r.focusNextBlock(e,i,!1),n.range.select(i),!1}inline(e,t){return this.common(e,t)}block(e,t){return this.common(e,t)}trigger(e){const{change:t,block:r,card:i}=this.engine,s=t.range.get(),o=i.getSingleCard(s);if(s.collapsed){const t=r.closest(s.startNode).next();if(t?.isCard()){const n=i.find(t);if(n&&n.onSelectDown)return n.onSelectDown(e)}}return!o||(!!n("shift+down",e)||(o.type===Yl.INLINE?this.inline(o,e):this.block(o,e)))}};class ic{constructor(e){this.engine=e}block(e,t){const{change:n,card:r}=this.engine,i=n.range.get();if(i.commonAncestorNode.closest(vi).length>0)return t.metaKey||t.ctrlKey||(r.focusPrevBlock(e,i,!0),n.range.select(i)),!0;return i.commonAncestorNode.closest(wi).length>0&&(t.metaKey||t.ctrlKey||(r.focusNextBlock(e,i,!0),n.range.select(i))),!0}trigger(e){const{change:t}=this.engine,n=t.range.get(),r=this.engine.card.getSingleCard(n);return!r||(r.type!==Yl.BLOCK||this.block(r,e))}}Fs('.am-engine .card-selected [data-card-element="center"].data-card-background-selected {\r\n    background: rgba(27, 162, 227, 0.2);\r\n}\r\n\r\n.am-engine .card-selected [data-card-element="center"].data-card-border-selected {\r\n    outline: 2px solid #1890FF;\r\n    border-radius: 2px;\r\n}\r\n\r\n.am-engine .card-selected [data-card-element="center"].data-card-border-selected::selection {\r\n    background: transparent;\r\n}\r\n\r\n.am-engine-view [data-card-element="center"] .data-card-loading, .am-engine [data-card-element="center"] .data-card-loading {\r\n    display: inline-block;\r\n    font-style: normal;\r\n    vertical-align: -0.125em;\r\n    text-align: center;\r\n    text-transform: none;\r\n    line-height: 0;\r\n    text-rendering: optimizeLegibility;\r\n    -webkit-font-smoothing: antialiased;\r\n    margin-right: 5px;\r\n    padding: 16px;\r\n    width: 100%;\r\n}\r\n\r\n.am-engine-view [data-card-element="center"] .data-card-loading .data-card-spin, .am-engine [data-card-element="center"] .data-card-loading .data-card-spin {\r\n    display: inline-block;\r\n    -webkit-animation: loadingCircle 1s infinite linear;\r\n    animation: loadingCircle 1s infinite linear;\r\n}\r\n');class sc{constructor(e,t=!0){this.asyncComponents=[],this.renderAsyncComponents=async()=>{this.renderTimeout&&clearTimeout(this.renderTimeout);const e=this.editor;this.renderTimeout=setTimeout(()=>{this.asyncComponents.concat().forEach(async t=>{(0===t.root.length||e.root.inViewport(t.root,!0)&&!1!==e.trigger("card:async-render-component",t))&&(this.asyncComponents.splice(this.asyncComponents.findIndex(e=>e===t),1),t.root.length>0&&t.loading&&(t.destroy&&t.destroy(),t.getCenter().empty(),this.renderComponent(t)))})},50)},this.classes={},this.components=[],this.editor=e,this.lazyRender=t}get active(){return this.components.find(e=>e.activated)}get length(){return this.components.length}init(e){const t=this.editor;if(Es(t)){const{typing:e}=t,n=new Gl(t);e.getHandleListener("enter","keydown")?.on(e=>n.trigger(e));const r=new Jl(t);e.getHandleListener("backspace","keydown")?.on(e=>r.trigger(e));const i=new Ql(t);e.getHandleListener("left","keydown")?.on(e=>i.trigger(e));const s=new ec(t);e.getHandleListener("right","keydown")?.on(e=>s.trigger(e));const o=new nc(t);e.getHandleListener("up","keydown")?.on(e=>o.trigger(e));const a=new rc(t);e.getHandleListener("down","keydown")?.on(e=>a.trigger(e));const l=new ic(t);e.getHandleListener("default","keydown")?.on(e=>l.trigger(e))}e.forEach(e=>{this.classes[e.cardName]=e}),this.lazyRender&&(window.addEventListener("resize",this.renderAsyncComponents,{passive:!0}),t.scrollNode?.get()?.addEventListener("scroll",this.renderAsyncComponents,{passive:!0}),window.addEventListener("scroll",this.renderAsyncComponents,{passive:!0}),t.on("card:async-render",this.renderAsyncComponents))}add(e){this.classes[e.cardName]=e}each(e){this.components.every((t,n)=>!e||!1!==e(t,n))}closest(e,t){if(Mi(e)&&(e=Ss(e)),!e.isCard()){const n=e.closest(mi,e=>{if(!(e&&t?Ss(e).isRoot():Ss(e).isEditable()))return(e.parentElement??e.parentNode)||void 0});if(!n||0===n.length)return;e=n}return e}find(e,t){if("string"!=typeof e){const n=this.closest(e,t);if(!n)return;e=n}const n=this.components.filter(t=>"string"==typeof e?t.id===e:t.root.name===(Mi(e)?e.nodeName.toString().toLowerCase():e.name)&&(t.root.equal(e)||t.id===(e=>{Mi(e)&&(e=Ss(e));const t=e.attributes(ui);return ms(t)})(e).id));if(0!==n.length)return n[0]}findBlock(e){if(Mi(e)&&(e=Ss(e)),!e.get())return;const t=e.parent();if(!t)return;const n=this.find(t);return n?n.type===Yl.BLOCK?n:this.findBlock(n.root):void 0}getSingleCard(e){let t=this.find(e.commonAncestorNode);return t||(t=this.getSingleSelectedCard(e)),t}getSingleSelectedCard(e){const t=e.findElements(),n=t[0];if(1===t.length&&n){const e=Ss(n);if(e.isCard())return this.find(e)}}insertNode(e,t,...n){const r="inline"===t.type,i=this.editor;!e.collapsed&&Es(i)&&i.change.delete(e),this.gc();const{inline:s,block:o,node:a}=i;let l=[];if(r){if(Es(i)&&t.executeMark){l=i.change.marks.map(e=>e.clone());const t=i.card.find(e.startNode);t?.queryMarks&&l.push(...t.queryMarks())}s.insert(t.root,e)}else o.insert(t.root,e,e=>{let t=e.parent();for(;t&&!t.isEditable();){e=t;const n=t.parent();if(!n||!a.isBlock(n))break;t=n}return e},!0);this.components.push(t);const c=t.root.parent();return!r&&c&&c.inEditor()&&a.isBlock(c)&&o.unwrap(c,e),this.renderComponent(t,...n),t.focus(e,!1),t.didInsert&&t.didInsert(),l.forEach(e=>{t.executeMark(e,!0)}),t}removeNode(e){e.destroy&&e.destroy(),this.removeComponent(e),e.root.remove()}updateNode(e,t,...n){e.destroy&&e.destroy();const r=e.getCenter();r?.empty(),e.setValue(t),this.renderComponent(e,...n),e.didUpdate&&e.didUpdate()}replaceNode(e,t,n){const r=this.classes[t];if(!r)throw"".concat(t,": This card does not exist");const i=n?.type||r.cardType,s=e.attributes(Fr),o=bs(`<card ${s??`${Fr}="${s}"`} type="${i}" name="${t}" value="${ps(n)}"></card>`),a=Ss(o);return e.before(a),a.append(e),a}activate(e,t,n){const r=this.editor;if(!Es(r)||r.readonly)return;const i=e.getRoot(),s=this.active;if(!i.get()||r.container.equal(i)){let i=this.find(e);const o=e.closest(Gr);if(!i&&o.length>0){const e=o.parent();i=e?this.find(e):void 0}const a=i?this.findBlock(i.root):void 0;if(a&&(i=a),i&&i.isCursor(e))if(o.length>0){const e=o.parent();i=e?this.find(e):void 0}else i=void 0;const l=i&&s&&s.root.equal(i.root);if(s&&!l&&(s.toolbarModel?.hide(),s.select(!1),s.activate(!1)),i){if(i.activatedByOther)return;l?i.isEditable?i.select(!1):t===Kl.MOUSE_DOWN&&"input"!==e.name&&0===i.root.find(".data-drag-image").length&&n?.preventDefault():(!1===i.constructor.singleSelectable||t===Kl.CLICK&&!Es(r)||this.select(i,n),i.isEditable||!1===i.constructor.autoSelected||i.select(!i.isEditable),i.activate(!0),i.toolbarModel?.show(n)),r.change.onSelect()}}else s&&(s.toolbarModel?.hide(),s.select(!1),s.activate(!1))}select(e,t){const n=this.editor;if(Es(n)&&!1!==e.constructor.singleSelectable&&(e.type!==Yl.BLOCK||!e.activated)){const r=n.change.range.get().cloneRange();if(r.startNode.closest(Gr).length>0&&(!t||t instanceof MouseEvent&&(!t.target||!this.closest(t.target,!1)))||e.isEditable||e.isMaximize)return;t?.preventDefault();const i=e.root,s=i.parent(),o=s.children().toArray().findIndex(e=>e.equal(i));r.setStart(s,o),r.setEnd(s,o+1),n.change.range.select(r)}}focus(e,t=!1){const n=this.editor;if(!Es(n))return;const{change:r,container:i,scrollNode:s}=n,o=r.range.get();e.focus(o,t),r.range.select(o),this.activate(o.startNode,Kl.MOUSE_DOWN),r.onSelect(),s&&o.scrollIntoViewIfNeeded(i,s)}insert(e,t,...n){const r=this.editor;if(!Es(r))throw new Error("Engine not found");const i=this.create(e,{value:t}),s=r.change,o=s.range.toTrusty(),a=this.insertNode(o,i,...n);return s.change(),a}update(e,t,...n){const r=this.editor;if(!Es(r))return;const i=r.change,s=this.find(e);if(s){this.updateNode(s,t,...n);const e=i.range.get();s.focus(e,!1),i.change()}}replace(e,t,n,...r){return this.remove(e.root),this.insert(t,n,...r)}remove(e,t=!0){const n=this.editor;if(!Es(n))return;const{change:r,list:i,node:s}=n,o=r.range.get(),a=this.find(e);if(!a)return;a.type===Yl.INLINE?(o.setEndAfter(a.root[0]),o.collapse(!1)):this.focusPrevBlock(a,o,t);const l=a.root.parent();this.removeNode(a),i.addBr(o.startNode),l&&s.isEmpty(l)&&!n.model.mutation.isStopped&&(l.isEditable()?(s.html(l,"<p><br /></p>"),o.select(l,!0),o.shrinkToElementNode(),o.collapse(!1)):(s.html(l,"<br />"),o.select(l,!0),o.collapse(!1))),t?r.apply(o):(r.range.select(o),r.change())}removeRemote(e){const t=this.editor;if(!Es(t))return;const{node:n}=t,r=this.find(e);if(!r)return;const i=r.root.parent();this.removeNode(r),i&&n.isEmpty(i)&&!t.model.mutation.isStopped&&(i.isEditable()?n.html(i,"<p><br /></p>"):n.html(i,"<br />"))}create(e,t){const n=this.classes[e];if(!n)throw"".concat(e,": This card does not exist");const r=t?.value?.type||n.cardType;if(["inline","block"].indexOf(r)<0)throw"".concat(e,': the type of card must be "inline", "block"');t?.root&&t.root.empty();const i=this.editor,s=new n({editor:i,value:t?.value,root:t?.root}),o=s.root;o.attributes(hi,r),o.attributes(ci,e),o.attributes(gi,"true");const a=r===Yl.INLINE?"span":"div",l=Ss(`<${a} ${s.isEditable?Jr+"='*'":""}/>`);l.attributes(fi,"center");const c=Ss("<".concat(a," ").concat(fi,'="body" />'));return c.append(l),o.append(c),this.createCursor(s),r===Yl.BLOCK&&i.nodeId.generate(s.root),s.init(),s}createCursor(e){const t=this.editor,n=e.constructor,r=void 0!==n.focus?n.focus:Es(t)&&!t.readonly,i=e.getCenter();i.removeAttributes(Rs);const s=e.root;s.removeAttributes(Rs);const o=e.findByKey("left"),a=e.findByKey("right");r?(i.attributes(Rs,"false"),o||i.before(Ss(`<span ${fi}="left" ${Qr}="true">&#8203;</span>`)),a||i.after(Ss(`<span ${fi}="right" ${Qr}="true">&#8203;</span>`))):(o?.remove(),a?.remove(),s.attributes(Rs,"false"))}reRender(...e){0===e.length&&(e=this.components),e.forEach(e=>{e.destroy&&e.destroy(),this.createCursor(e),e.init(),this.renderComponent(e)})}render(e,t,n=this.lazyRender){const r=e?e.isCard()?e:e.find(`${bi}`):this.editor.container.find(bi);this.gc();const i=[],s=[];r.toArray().forEach(e=>{s.find(t=>t.equal(e))||s.push(e);e.find(`${mi},${bi}`).toArray().forEach(t=>{if(t.equal(e))return;const n=s.findIndex(e=>e.equal(t));n>-1&&s.splice(n,1)})}),s.forEach(e=>{const t=e.attributes(),n=t[di],r=t[ci],s=n||r;if(this.classes[s]){const o=t[ui];let a;r&&(a=this.find(e),a&&a.root.equal(e)&&(a.destroy&&a.destroy(),this.removeComponent(a)),e.attributes(gi,"true"),t[gi]="true",e.empty()),a=this.create(s,{value:ms(o),root:r?e:void 0}),Object.keys(t).forEach(e=>{(0===e.indexOf("data-")&&0!==e.indexOf("data-card")||e===gi)&&a.root.attributes(e,t[e])}),n&&(e.replaceWith(a.root),e.remove()),this.components.push(a),i.push(a),n&&a.root.removeAttributes(di)}});let o=!1;i.forEach(e=>{if(n&&e.constructor.lazyRender&&!e.isEditable){if(e.beforeRender){const t=e.beforeRender(),n=e.getCenter();void 0!==t&&n.append("string"==typeof t?Ss(t):t)}o=!0,this.asyncComponents.push(e)}else this.renderComponent(e)}),t&&t(i.length),o&&this.renderAsyncComponents()}renderComponent(e,...t){const n=this.editor,r=e.getCenter(),i=e.render(...t);if(void 0!==i&&r.append("string"==typeof i?Ss(i):i),e.contenteditable.length>0){const t=!Es(n)||n.readonly?"false":"true";r.find(e.contenteditable.join(",")).each(e=>{const r=Ss(e);r.attributes(Rs)!==t&&r.attributes(Rs,t),r.attributes(Hr)!==Zr&&r.attributes(Hr,Zr),Es(n)&&n.normalize(r)}),this.render(r)}e.didRender()}removeComponent(e){this.each((t,n)=>{if(t.root.equal(e.root))return this.components.splice(n,1),!1})}gc(){for(let e=0;e<this.components.length;e++){const t=this.components[e];t.root[0]&&0!==t.root.closest("body").length||(t.destroy&&t.destroy(),this.components.splice(e,1),e--)}}destroy(){this.gc();const e=this.editor;window.removeEventListener("resize",this.renderAsyncComponents),e.scrollNode?.get()?.removeEventListener("scroll",this.renderAsyncComponents),window.removeEventListener("scroll",this.renderAsyncComponents),e.off("card:async-render",this.renderAsyncComponents)}focusPrevBlock(e,t,n){const r=this.editor;if(!Es(r))throw new Error("Engine not initialized");let i;if("inline"===e.type){const t=r.block.closest(e.root);i=t.isEditable()?e.root.prevElement():t.prevElement()}else i=e.root.prevElement();if(n){if(!i||i.attributes(ci)){const n=Ss("<p><br /></p>");return e.root.before(n),t.select(n,!0),t.collapse(!1),void r.nodeId.generate(n)}}else{if(!i)return;if(i.attributes(ci))return void r.card.find(i)?.focus(t,!1)}t.select(i,!0).shrinkToElementNode().shrinkToTextNode().collapse(!1)}focusNextBlock(e,t,n){const r=this.editor;if(!Es(r))throw new Error("Engine not initialized");let i;if("inline"===e.type){const t=r.block.closest(e.root);i=t.isEditable()?e.root.nextElement():t.nextElement()}else i=e.root.nextElement();if(n){if(!i||i.attributes(ci)){const n=Ss("<p><br /></p>");return e.root.after(n),t.select(n,!0),t.collapse(!1),void r.nodeId.generate(n)}}else{if(!i)return;if(i.attributes(ci))return void r.card.find(i)?.focus(t,!0)}t.select(i,!0).shrinkToElementNode().shrinkToTextNode().collapse(!0)}}class oc{constructor(e){this.rules={},this.schema=e}init(){this.rules=this.getRules()}getRules(){const e={};return this.schema.data.blocks.forEach(t=>{e[t.name]||(e[t.name]=[]),e[t.name].push(t)}),e}create(e){Mi(e)&&(e=Ss(e));const t=zs(e);return e.attributes(Fr,t),t}generateAll(e,t=!1){const n=this.rules,r=Object.keys(n).join(",");Si(e)&&e.fragment&&(e=e.fragment);const i=Mi(e)?e:e.get();if(!i||i.nodeType===Node.TEXT_NODE)return;const s=Mi(e)?e:e.get(),o=s?.querySelectorAll(r),a=e=>{!t&&e.getAttribute(Fr)||this.generate(e,t)};s instanceof Element&&r.includes(s.nodeName.toLowerCase())&&a(s),o?.forEach(a)}generate(e,t=!1){if(Mi(e)&&(e=Ss(e)),e.isText())return;const n=this.rules[e.name];if(!n||0===n.length||!n.some(t=>this.schema.checkNode(e,t.attributes)))return;const r=e.closest(`${mi},${Kr}`,ai);if(!(r.length>0&&r.attributes(Hr)===Yr)&&(!(!e.isCard()&&r.length>0&&r.isCard())||r.isEditableCard())){if(!t){const t=e.attributes(Fr);if(t)return t}return this.create(e)}}isNeed(e){const t=this.rules[e.name];return!(!t||0===t.length||!t.some(t=>this.schema.checkNode(e,t.attributes)))}}class ac{constructor(e,t,n=""){this.anchor=null,this.focus=null,this.editor=e,this.range=t,this.key=n}has(){return!!this.focus&&!!this.anchor}create(){const{commonAncestorNode:e,startNode:t,endNode:n}=this.range;if(!e.isEditable()&&!e.inEditor())return;const{document:r}=e;if(!r)return;const i=e.closest(Ur);if(this.key)i.find(`[data-anchor-id="${this.key}"]`).remove(),i.find(`[data-focus-id="${this.key}"]`).remove(),i.find(`[data-cursor-id="${this.key}"]`).remove();else{const e=i.find(ki);e.each((t,n)=>{const r=e.eq(n);r&&!r.attributes("data-anchor-id")&&r.remove()});const t=i.find(Ti);t.each((e,n)=>{const r=t.eq(n);r&&!r.attributes("data-focus-id")&&r.remove()});const n=i.find(Oi);n.each((e,t)=>{const r=n.eq(t);r&&!r.attributes("data-cursor-id")&&r.remove()})}const s=t.closest(mi);if(s.length>0){t.closest(vi).length>0&&this.range.setStartBefore(s);t.closest(wi).length>0&&this.range.setStartAfter(s)}if(!t.equal(n)){const e=n.closest(mi);if(e.length>0){n.closest(vi).length>0&&this.range.setEndBefore(e);n.closest(wi).length>0&&this.range.setEndAfter(e)}}if(this.range.collapsed){const e=Ss(r.createElement("span"));return e.attributes(Hr,Ci),this.key&&e.attributes("data-cursor-id",this.key),this.range.insertNode(e),this.anchor=e,void(this.focus=e)}const o=this.range.cloneRange();o.collapse(!0);const a=Ss(r.createElement("span"));a.attributes(Hr,xi),this.key&&a.attributes("data-anchor-id",this.key),o.insertNode(a),this.range.setStartAfter(a);const l=this.range.cloneRange();l.collapse(!1);const c=Ss(r.createElement("span"));c.attributes(Hr,Ei),this.key&&c.attributes("data-focus-id",this.key),l.insertNode(c),this.anchor=a,this.focus=c}move(){if(!this.focus||!this.anchor)return;if(this.key){const{commonAncestorNode:e}=this.range,t=e.closest(Ur);this.focus.inEditor()&&this.focus.get()?.isConnected||(this.focus=t.find(`[data-${this.focus.attributes(Hr)}-id="${this.key}"]`)),this.anchor.inEditor()&&this.anchor.get()?.isConnected||(this.anchor=t.find(`[data-${this.anchor.attributes(Hr)}-id="${this.key}"]`))}const{node:e}=this.editor;if(this.anchor.get()?.isConnected||(this.anchor=this.range.commonAncestorNode.find(`[${Hr}="anchor"]`)),this.focus.get()?.isConnected||(this.focus=this.range.commonAncestorNode.find(`[${Hr}="focus"]`)),this.anchor.equal(this.focus)){const t=this.anchor,n=t.parent();if(!n)return;e.removeZeroWidthSpace(n),n[0].normalize();let r=!1;const i=t.prev(),s=t.next();if(i&&i.isCard()){const e=i.find(wi);e.length>0&&(this.range.select(e,!0),this.range.collapse(!1),r=!0)}else if(s&&s.isCard()){const e=s.find(vi);e.length>0&&(this.range.select(e,!0),this.range.collapse(!1),r=!0)}return r||(this.range.setStartBefore(t[0]),this.range.collapse(!0)),Xi?(n[0].normalize(),t.remove()):(t.remove(),n[0].normalize()),void("p"===n.name&&0===n.get()?.childNodes.length&&n.append(Ss("<br />")))}let t=this.anchor.parent();if(t&&(e.removeZeroWidthSpace(t),this.anchor.length>0&&this.range.setStartBefore(this.anchor),this.anchor.remove(),t[0].normalize()),t=this.focus.parent(),t&&(e.removeZeroWidthSpace(t),this.focus.length>0&&this.range.setEndBefore(this.focus),this.focus.remove(),t[0].normalize(),"p"===t.name&&0===t.get()?.childNodes.length&&t.append(Ss("<br />")),Ki)){const e=window.getSelection();e?.removeAllRanges(),e?.addRange(this.range.base)}}getNode(e,t="center",n=!0,r=()=>!0){const i=n?e.clone(!0):e;if(!this.focus||!this.anchor)return i;if("left"===t||"center"===t){const e="center"!==t?this.anchor:this.focus;let n=Ss(this.key?`[data-${e.attributes(Hr)}-id="${this.key}"]`:`[${Hr}=${e.attributes(Hr)}]`,i.get());this.key||(n=n.toArray().find(t=>!t.attributes(`data-${e.attributes(Hr)}-id`)));let s=!1;i.traverse(t=>{if(n&&t.equal(n)){const e=t.parent();return n.remove(),"p"===e?.name&&0===e.get()?.childNodes.length&&e.append(Ss("<br />")),void(s=!0)}s&&r(t)&&(t.attributes(Hr)!==e.attributes(Hr)||"cursor"===e.attributes(Hr))&&t.remove()},!0)}if("right"===t||"center"===t){const e="center"!==t?this.focus:this.anchor;let n=Ss(this.key?`[data-${e.attributes(Hr)}-id="${this.key}"]`:`[${Hr}=${e.attributes(Hr)}]`,i.get());this.key||(n=n.toArray().find(t=>!t.attributes(`data-${e.attributes(Hr)}-id`)));let s=!1;i.traverse(t=>{if(n&&t.equal(n)){const e=t.parent();return n.remove(),"p"===e?.name&&0===e.get()?.childNodes.length&&e.append(Ss("<br />")),void(s=!0)}s&&r(t)&&(t.attributes(Hr)!==e.attributes(Hr)||"cursor"===e.attributes(Hr))&&t.remove()},!1)}return i}}function lc(e){return"[object Object]"===Object.prototype.toString.call(e)}function cc(e){if(!lc(e))return!1;const t=e.constructor;if(void 0===t)return!0;const n=t.prototype;return!1!==lc(n)&&!!n.hasOwnProperty("isPrototypeOf")}ac.removeTags=e=>e.replace(/<anchor\s*\/>/gi,"").replace(/<focus\s*\/>/gi,"").replace(/<cursor\s*\/>/gi,"");const dc=new WeakMap,hc=(e,t,n)=>{const r=Mi(e)?e:e[0];let i=dc.get(r);return void 0!==i||(i=uc(r,t,n),dc.set(r,i)),i},uc=(e,t,n)=>{const r=Mi(e)?e:e[0];if(r.nodeType===Node.ELEMENT_NODE){const i=r.getAttribute(Hr)||"";if([Ci,xi,Ei].indexOf(i)>-1)return!0;if(r.getAttribute(Qr)||i===Yr)return!0;const s=r.parentElement,o=s?.getAttribute(Hr)||"";if(i===Xr||o===Xr)return!1;const a=Bi(r),l=s?.getAttribute(gi);if(l&&s&&n?.push(Ss(s)),!a&&s&&Bi(s)&&!Li(s))return!0;if(t){if(a)return!1;const r=t.find(t=>t===e[0]);if(r)return r.__card_root&&n?.push(r.__card_root),!0}const c=ji(r,`${mi},${Kr}`,ai);if(!(c&&c instanceof Element))return!1;if(c.getAttribute(Hr)===Yr)return!0;if(c.getAttribute(gi)&&n?.push(Ss(c)),!a&&Bi(c)&&!Li(c))return!0;if(!a||Li(r)||!s)return!1;const d=ji(s,mi,ai);if(!(d&&d instanceof Element))return!1;if(d.getAttribute(gi)&&d&&n?.push(Ss(d)),d&&Bi(d)&&!Li(d))return!0}else if(r.nodeType===Node.TEXT_NODE){const e=r.parentElement;return!!e&&hc(e)}return!1},fc=(e,t)=>{const n=Mi(e)?e:e[0];if(Di(n))return!0;if(Bi(n)&&["id","class","style",gi].includes(t))return!0;const r=n.getAttribute(Jr);return!!("*"===r||r&&r.split(",").some(e=>e.trim().toLowerCase()===t.toLowerCase()))};class gc{get collapsed(){return this.base.collapsed}get endOffset(){return this.base.endOffset}get startOffset(){return this.base.startOffset}get startContainer(){return this.base.startContainer}get endContainer(){return this.base.endContainer}get commonAncestorContainer(){return this.base.commonAncestorContainer}constructor(e,t){this.toRange=()=>this.base,this.collapse=e=>(this.base.collapse(e),this),this.cloneRange=()=>gc.from(this.editor,this.base.cloneRange()),this.select=(e,t)=>(t?this.base.selectNodeContents(Si(e)?e[0]:e):this.base.selectNode(Si(e)?e[0]:e),this),this.getText=()=>this.cloneContents().textContent,this.getClientRect=()=>{let e=this.getClientRects().item(0);return e||(e=this.getBoundingClientRect()),e},this.enlargeFromTextNode=()=>{const e=(e,t,n)=>{if(e.nodeType===Node.TEXT_NODE)if(0===t)switch(n){case"start":this.setStartBefore(e);break;case"end":this.setEndBefore(e)}else if(t===e.nodeValue?.length)switch(n){case"start":this.setStartAfter(e);break;case"end":this.setEndAfter(e)}};return e(this.startContainer,this.startOffset,"start"),e(this.endContainer,this.endOffset,"end"),this},this.shrinkToTextNode=()=>{const e=(e,t,n)=>{if(e.nodeType!==Node.ELEMENT_NODE)return;const r=e.childNodes;if(0===r.length)return;let i,s,o;if(t>0&&(i=r[t-1]),t<r.length&&(s=r[t]),i&&i.nodeType===Node.TEXT_NODE&&(o=i,t=o.nodeValue?.length||0),s&&s.nodeType===Node.TEXT_NODE&&(o=s,t=0),o)switch(n){case"start":this.setStart(o,t);break;case"end":this.setEnd(o,t)}};return e(this.startContainer,this.startOffset,"start"),e(this.endContainer,this.endOffset,"end"),this},this.enlargeToElementNode=(e=!1,t=!0)=>{const n=this.enlargeFromTextNode(),r=this.editor.node,i=(i,s,o)=>{let a,l=Ss(i);if(!(l.type===Node.TEXT_NODE||!e&&r.isBlock(l)||l.isEditable()))if(0===s){for(;!l.prev()&&(a=l.parent(),a&&(e||!r.isBlock(a)))&&a.inEditor()&&!a.isEditable();){if(!t){if(!e&&a.isElement())break;if(e&&r.isBlock(a))break}l=a}o?n.setStartBefore(l[0]):n.setEndBefore(l[0])}else if(s===l.get()?.childNodes.length){for(;!l.next()&&(a=l.parent(),a&&(e||!r.isBlock(a)))&&a.inEditor()&&!a.isEditable();){if(!t){if(!e&&a.isElement())break;if(e&&r.isBlock(a))break}l=a}o?n.setStartAfter(l[0]):n.setEndAfter(l[0])}};return i(n.startContainer,n.startOffset,!0),i(n.endContainer,n.endOffset,!1),this},this.shrinkToElementNode=()=>{const{node:e}=this.editor;let t,n;for(;this.startContainer.nodeType===Node.ELEMENT_NODE&&(t=this.startContainer.childNodes[this.startOffset])&&(n=Ss(t))&&t.nodeType===Node.ELEMENT_NODE&&!n.isCursor()&&!e.isVoid(t)&&(!n.isCard()||n.isEditableCard()||n.find(vi).length>0);)this.setStart(t,0);for(;this.endContainer.nodeType===Node.ELEMENT_NODE&&this.endOffset>0&&(t=this.endContainer.childNodes[this.endOffset-1])&&(n=Ss(t))&&t.nodeType===Node.ELEMENT_NODE&&!e.isVoid(t)&&!n.isCursor()&&(!n.isCard()||n.isEditableCard()||n.find(wi).length>0);)this.setEnd(t,t.childNodes.length);return this},this.createSelection=(e="")=>{const t=new ac(this.editor,this,e);return t.create(),t},this.getSubRanges=(e=!1,t=!0)=>{const n=[];return this.commonAncestorNode.traverse(r=>{if(r.isText()){const e=0,t=r.get(),i=t.nodeValue?.length||0,s=this.comparePoint(t,e),o=this.comparePoint(t,i),a=gc.create(this.editor);if(s<0){if(o<0)return;0===o?a.setOffset(t,this.startOffset,i):a.setOffset(t,this.startOffset,this.endOffset)}else{if(0!==s)return;if(o<0)return;0===o?a.setOffset(t,e,i):a.setOffset(t,e,this.endOffset)}n.push(a)}else if(e&&r.isCard()&&!r.isEditableCard()){const e=this.editor.card.find(r);if(!e||t&&!1===e.constructor.singleSelectable)return;const i=e.getCenter(),s=i.get(),o=s?.parentElement??s?.parentNode;if(!o||!i.inEditor())return;const a=i.index(),l=r.get(),c=this.comparePoint(o,a),d=this.comparePoint(o,a+1),h=gc.create(this.editor);if(c<0){if(d<0)return;0===d?h.setOffset(l,this.startOffset,a+1):h.setOffset(l,this.startOffset,this.endOffset)}else{if(0!==c)return;if(d<0)return;0===d?h.setOffset(o,a,a+1):h.setOffset(o,a,this.endOffset)}n.push(h)}}),0===n.length&&n.push(this),n},this.setOffset=(e,t,n)=>(Si(e)&&(e=e[0]),this.setStart(e,t),this.setEnd(e,n),this),this.findElements=()=>{const{startContainer:e,endContainer:t,startOffset:n,endOffset:r,collapsed:i}=this,s=[];if(e!==t||!0===i||e.nodeType===Node.TEXT_NODE)return s;const{childNodes:o}=e;for(let e=n;e<r;e++)s.push(o[e]);return s},this.inCard=()=>{const e=this.startNode.closest(mi);return e&&e.length>0},this.getStartOffsetNode=()=>{const{startContainer:e,startOffset:t}=this;return(e.nodeType===Node.ELEMENT_NODE||e.nodeType===Node.DOCUMENT_FRAGMENT_NODE)&&(e.childNodes[t]||e.childNodes[t-1])||e},this.getEndOffsetNode=()=>{const{endContainer:e,endOffset:t}=this;return(e.nodeType===Node.ELEMENT_NODE||e.nodeType===Node.DOCUMENT_FRAGMENT_NODE)&&(e.childNodes[t]||e.childNodes[t-1])||e},this.scrollIntoView=()=>{const e=this.endNode.get();Zi&&e&&e.scrollIntoView&&e.scrollIntoView({behavior:"smooth",block:"center",inline:"center"})},this.scrollRangeIntoView=()=>{const e=this.getEndOffsetNode(),t=e.nodeType===Node.TEXT_NODE?e.parentElement??e.parentNode:e,n=this.collapsed?t.getBoundingClientRect():this.getClientRect(),r=window.innerHeight;(n.bottom>=r||n.bottom<=0)&&t.scrollIntoView({block:"center"})},this.scrollIntoViewIfNeeded=(e=this.editor.container,t)=>{if(this.collapsed)e.scrollIntoView(Ss(this.getEndOffsetNode()));else{const e=this.getStartOffsetNode(),n=this.getEndOffsetNode();Ss(e).scrollIntoView(t),Ss(n).scrollIntoView(t)}},this.containsCard=()=>{const{collapsed:e,commonAncestorNode:t}=this;return!e&&(3!==t.type&&t.find(mi).length>0||t.closest(mi).length>0)},this.handleBr=e=>{const t=this.editor,{list:n}=t,r=t.block.closest(this.commonAncestorNode);r.find("br").each(t=>{const r=Ss(t),i=r.prev(),s=r.next(),o=r.parent();if((!i||o?.hasClass(n.CUSTOMZIE_LI_CLASS)&&o?.first()?.equal(i))&&s&&"br"!==s.name&&!s.isCursor()||!s&&i&&"br"!==i.name){if(e&&i&&(!o?.hasClass(n.CUSTOMZIE_LI_CLASS)||!o?.first()?.equal(r.prev())))return;r.remove()}});const i=r.first(),s=r.children();return!i||1===s.length&&r.hasClass(n.CUSTOMZIE_LI_CLASS)&&i?.isCard()?(r.append(Ss("<br />")),this):1===s.length&&i.isText()&&0===i.text().replace(/\r\n|\n|\t|\u200b/g,"").length?(r.html("<br />"),this):(2===s.length&&r.hasClass(n.CUSTOMZIE_LI_CLASS)&&i?.isCard()&&["cursor","anchor","focus"].includes(r.last()?.attributes(Hr)||"")&&r.first()?.after("<br />"),this)},this.getPrevNode=()=>{this.enlargeFromTextNode();const{startNode:e,startOffset:t}=this;if(e.isText())return;const n=e.children();return 0!==n.length?n.eq(t-1):void 0},this.getNextNode=()=>{this.enlargeFromTextNode();const{endNode:e,endOffset:t}=this;if(e.isText())return;const n=e.children();return 0!==n.length?n.eq(t):void 0},this.editor=e,this.base=t}cloneContents(){return this.base.cloneContents()}deleteContents(){return this.base.deleteContents()}extractContents(){return this.base.extractContents()}getBoundingClientRect(){return this.base.getBoundingClientRect()}getClientRects(){return this.base.getClientRects()}insertNode(e){Si(e)&&(e=e[0]);const t=this.startNode;Ss(e).isCursor()||1!==t.get()?.childNodes.length||"br"!==t.first()?.name?"br"===t.name&&t.remove():t.first()?.remove(),e.nodeType!==Node.TEXT_NODE&&"BR"!==e.nodeName||!t.isEditable()||this.shrinkToElementNode().shrinkToTextNode(),(e instanceof Element||e instanceof DocumentFragment)&&this.editor.nodeId.generate(e),this.base.insertNode(e)}isPointInRange(e,t){return Si(e)&&(e=e[0]),this.base.isPointInRange(e,t)}comparePoint(e,t){return Si(e)&&(e=e[0]),this.base.comparePoint(e,t)}setEnd(e,t){return Si(e)&&(e=e[0]),this.base.setEnd(e,t)}setEndAfter(e){if(Si(e)&&(e=e[0]),e.parentNode)return this.base.setEndAfter(e)}setEndBefore(e){if(Si(e)&&(e=e[0]),e.parentNode)return this.base.setEndBefore(e)}setStart(e,t){return Si(e)&&(e=e[0]),this.base.setStart(e,t)}setStartAfter(e){if(Si(e)&&(e=e[0]),e.parentNode)return this.base.setStartAfter(e)}setStartBefore(e){if(Si(e)&&(e=e[0]),e.parentNode)return this.base.setStartBefore(e)}toString(){return this.base.toString()}get startNode(){return Ss(this.base.startContainer)}get endNode(){return Ss(this.base.endContainer)}get commonAncestorNode(){return Ss(this.base.commonAncestorContainer)}deepCut(){this.collapsed||this.extractContents();const{startNode:e}=this;if(!e.isEditable()){let t=e;if(t&&!t.isEditable()){let e=t.parent();for(;e&&!e.isEditable();)t=e,e=e.parent();this.setEndAfter(t[0]);const n=this.extractContents();this.insertNode(n),this.collapse(!0)}}}equal(e){return this.startContainer===e.startContainer&&this.startOffset===e.startOffset&&this.endContainer===e.endContainer&&this.endOffset===e.endOffset}getRootBlock(){if(this.startNode.isEditable())return this.startNode.children().eq(this.startOffset);let e=this.startNode;for(;e?.parent()&&!e.parent().isEditable();)e=e.parent();return e}filterPath(e=!1){const t=[];return n=>{const r=Ss(n);if(e&&n instanceof HTMLElement&&~["left","right","center","body"].indexOf(n.getAttribute(fi)||"")){const e=this.editor.card.closest(r);return e&&e.length>0&&t.push(e),!0}return!!(e&&r.isCard()&&t.includes(r))||!hc(r)}}toPath(e=!1,t=this.editor.container){const n=this.cloneRange(),r=n.commonAncestorNode;if(!r.isRoot()&&!r.inEditor())return;n.shrinkToElementNode().shrinkToTextNode();const i=(n,r)=>{let i=n.attributes(Fr),s=i?0:-1;const o=n.getPath(t,n.parent()?.isRoot()?void 0:this.filterPath(e),(e,t,n)=>{if(-1===e)return i="",s=-1,[];i||(i=n.attributes(Fr),s=t.length),t.unshift(e)});return s=o.length-s,o.push(r),{path:o,id:i,bi:s}};return{start:i(n.startNode,n.startOffset),end:i(n.endNode,n.endOffset)}}}gc.create=(e,t=document,n)=>{let r;return r=n?t.caretRangeFromPoint(n.x,n.y):t.createRange(),gc.from(e,r)},gc.from=(e,t=window)=>{if(!mc(t)){const e=pc(t)?t:t.getSelection();if(!(e&&e.rangeCount>0))return null;t=e.getRangeAt(0)}return new gc(e,t)},gc.fromPath=(e,t,n=!1,r=e.container)=>{const i=t.start.path.slice(),s=t.end.path.slice(),o=i.pop(),a=s.pop(),l=(e,t=r.get())=>{let i=t;for(let t=0;t<e.length;t++){let r,s=e[t];s<0&&(s=0);let o=i.firstChild,a=0;for(;o;)if(!(o instanceof Element)||!o.getAttribute(Qr)&&o.getAttribute(Hr)!==Yr||n&&["left","right"].includes(o.getAttribute(fi)||"")){if(a===s||!o.nextSibling){r=o;break}a++,o=o.nextSibling}else o=o.nextSibling;if(!r)break;i=r}return i},c=(e,t,n,r)=>{null!==n&&(r<0&&(r=0),n.nodeType===Node.ELEMENT_NODE&&r>n.childNodes.length&&(r=n.childNodes.length),n.nodeType===Node.TEXT_NODE&&r>(n.nodeValue?.length||0)&&(r=n.nodeValue?.length||0),t[e](n,r))},d=t.start.id?r.get()?.querySelector(`[${Fr}="${t.start.id}"]`):r.get(),h=l(t.start.bi>-1&&d instanceof Element?i.slice(t.start.bi):i,d instanceof Element?d:void 0),u=t.end.id?r.get()?.querySelector(`[${Fr}="${t.end.id}"]`):r,f=l(t.end.bi>-1&&u instanceof Element?s.slice(t.end.bi):s,u instanceof Element?u:void 0),g=gc.create(e,document);return c("setStart",g,h,void 0===o?0:o),c("setEnd",g,f,void 0===a?0:a),g};const pc=e=>void 0!==e.getRangeAt,mc=e=>void 0!==e.collapsed,bc=e=>!!e&&void 0!==e.base;class vc{constructor(e){this.source=e}toHTML(){let e=cs(this.source);return e=e.replace(/\n/g,"</p><p>").replace(/<p><\/p>/g,"<p><br /></p>").replace(/^\s/,"&nbsp;").replace(/\s$/,"&nbsp;").replace(/\s\s/g," &nbsp;"),e.indexOf("</p><p>")>=0&&(e="<p>".concat(e,"</p>")),e}}class yc{constructor(e,t,n,r=!0){if(this.isNormalize=!0,this.editor=t,this.isNormalize=r,"string"==typeof e){e=(e=e.replace(/<a\s{0,1000}\/>/gi,"<a></a>")).replace(/<a(\s[^>]+?)\/>/gi,(e,t)=>"<a".concat(t,"></a>")),e=e?.replace(/<img .*>/gi,e=>e.replace(/\son[a-zA-Z]{1,20}=/g,"notallow=")),e=e.replace(/<p(>|\s+[^>]*>)/gi,"<paragraph$1").replace(/<\/p(>|\s+[^>]*>)/gi,"</paragraph$1"),e=bs(e);const t=(new DOMParser).parseFromString(e,"text/html").body.innerHTML.replace(/<paragraph(>|\s+[^>]*>)/gi,"<p$1").replace(/<\/paragraph(>|\s+[^>]*>)/gi,"</p$1");this.root=Ss(`<div>${t}</div>`)}else Si(e)?this.root=e:this.root=Ss(e);n&&n(this.root)}convert(e,t,n){let r=e.transform(t);const i=[],s=this.editor.node;let o=null;for(;r;){const{rule:a}=r;i.push(a);const{name:l,attributes:c,style:d}=r.node;"card"!==l&&delete c[Fr],delete c.id;const h=Ss(`<${l} />`);if(s.setAttributes(h,{...c,style:d}),h.get()?.append(...t.get().childNodes),t.isCard())return t.replaceWith(h),h;(r.replace?(t.replaceWith(h),t=h):h.each(e=>{const n=t.get();n&&n instanceof Element&&n.append(e)}),o&&0!==o.length||(o=h),s.isBlock(h,n))?r=e.transform(h,e=>i.indexOf(e)<0):r=e.transform(t,e=>i.indexOf(e)<0)}return o}normalize(e,t,n){const r=this.editor,i=r.node,s=r.inline;if(!this.isNormalize){if(!n)return;const r=e.find(mi);r.each((e,i)=>{const s=r.eq(i);s&&this.convert(n,s,t)});const i=e.find(`${Oi},${ki},${Ti}`);return void i.each((e,r)=>{const s=i.eq(r);s&&this.convert(n,s,t)})}const o=(e,n="mark")=>{const r=e.attributes(),i=as(r.style||"");if(delete r.style,0===Object.keys(r).length&&0===Object.keys(i).length)return;const s=Object.keys(r).length,o=Object.keys(i).length,a=e.clone();t.filter(e,r,i,!0),a.removeAttributes(Fr);const l=Object.keys(r);let c=0;l.forEach(e=>{r[e]&&(c++,a.removeAttributes(e))});let d=0;if(Object.keys(i).forEach(e=>{i[e]&&(d++,a.css(e,""))}),(c===s&&d===o||0===c&&0===d)&&t.getType(a)===n){e.before(a);const t=e.children();return a.append(t.length>0?t:"block"===n?"<br />":Ss("​",null)),e.remove(),void(e=a)}return""===a.attributes("style").trim()&&a.removeAttributes("style"),a};e.traverse(a=>{if(a[0]!==e[0]&&!["style","script","meta"].includes(a.name))if(a.isElement()){const e=a.isCard();if(n&&(!t.getType(a)||e)){const r=this.convert(n,a,t);if(r)return!!e||r}if(e)return;if(i.isMark(a,t)){const e=[];let i=t.getRule(a);if(i){e.push(i),0===a.get()?.childNodes.length&&r.mark.repairCursor(a);let s=o(a);if(!s)return;let l=t.getType(s,t=>t.name===s.name&&"mark"===t.type&&e.indexOf(t)<0);if(!l&&n){const e=this.convert(n,s,t);if(e&&e.length>0){const t=a.children();return e.append(t.length>0?t:Ss("​",null)),void a.append(0===s.length?e:s.children())}}let c=a;for(;"mark"===l;){const r=c.children();let a=s;for(;;){const e=a.children();if(!(e.length>0))break;a=e}if(a.append(r.length>0?r:Ss("​",null)),c.append(s),c=s,s=o(s),!s)break;if(l=t.getType(s,t=>t.name===s.name&&"mark"===t.type&&e.indexOf(t)<0),!l){if(n){const e=this.convert(n,s,t);if(e&&e.length>0){s=s.length>0?s.children():e,l="mark";continue}}break}if(i=t.getRule(s),!i)break;e.push(i)}}}else if(i.isInline(a))return s.flat(a,t)}else if(a.isText()){const e=a.text();if(/^\n+$/.test(e)||/^\s+$/.test(e)){const e=a.get(),n=e.previousSibling,r=e.nextSibling,i=n?t.getType(n):void 0,s=r?t.getType(r):void 0;if(!n&&r&&(!s||"block"===s))return void a.remove();r||!n||i&&"block"!==i||a.remove()}}})}traverse(e,t=null,n,r,i){const s=this.editor.node;let o=e.first();for(;o;)if(["style","script","meta"].includes(o.name))o=o.next();else{if(o.isElement()){let e=o.name,a=o.attributes();if(a[Hr]===Yr){o=o.next();continue}let l=as(a.style||"");if(delete a.style,["left","right"].indexOf(a[fi])>=0){o=o.next();continue}let c,d=!0;if(t&&a[Hr]!==Zr)if(c=t.getType(o),void 0===c){d=!1;const n=o.parent();if(n&&s.isBlock(n,t)&&1===n.get()?.childNodes.length&&0===o.get()?.childNodes.length){const t=Ss("<br />");o.before(t),o.remove(),o=t,e=t.name,a={},l={},d=!0}}else t.filter(o,a,l);if("center"!==a[fi]&&r.onOpen&&d){if(!1===r.onOpen(o,e,a,l)){o=o.next();continue}}("card"===e||a[ci]&&"true"!==a[pi])&&!i||this.traverse(o,t,n,r,i),"center"!==a[fi]&&r.onClose&&d&&r.onClose(o,e,a,l)}else if(o.isText()){let e=o[0].nodeValue?cs(o[0].nodeValue):"";""===e&&s.isBlock(o.parent(),t||void 0)&&(o.prev()||(e=e.replace(/^[ \n]+/,"")),o.next()||(e=e.replace(/[ \n]+$/,"")));const n=o.prev(),i=o.next();n&&s.isBlock(n,t||void 0)&&i&&s.isBlock(i,t||void 0)&&""===e.trim()&&(e=e.trim()),r.onText&&r.onText(o,e)}o=o.next()}}toValue(e=null,n=null,r=!1,i=!1){const s=[],o=this.editor,a=o.node,l=this.root.clone(!0);e&&this.normalize(l,e,n),o.trigger("parse:value-before",l),this.traverse(l,e,n,{onOpen:(n,r,i,l)=>{if(!1===o.trigger("parse:value",n,i,l,s))return!1;if(s.push("<"),s.push(r),Object.keys(i).length>0&&s.push(" "+(e=>{let t="";for(const n in e){if("style"===n)continue;const r=cs(e[n]);t+=" ".concat(n,'="').concat(r,'"')}return t.trim()})(i)),Object.keys(l).length>0){const e=(e=>{let n="";for(let r in e){r=r.toLowerCase();let i=cs(e[r]);/^(padding|margin|text-indent)/.test(r)&&0===gs(i)||(r.endsWith("color")&&(i=t(i).toHex()),n+=" ".concat(r,": ").concat(i,";"))}return n.trim()})(l);""!==e&&(s.push(' style="'),s.push(e),s.push('"'))}return a.isVoid(r,e||void 0)&&0===n.get()?.childNodes.length?s.push(" />"):s.push(">"),!0},onText:(e,t)=>{r&&t.length>1&&(t=t.replace(/[\u00a0 ]+/g,e=>{const t=[];e=e.replace(/\u00a0/g," ");for(let n=0;n<e.length;n++)t[n]=n%2==0?e[n]:" ";return t.join("")})),s.push(t)},onClose:(t,n)=>{a.isVoid(n,e||void 0)||s.push("</".concat(n,">"))}}),o.trigger("parse:value-after",s),s.length>0&&/^\n+/g.test(s[0])&&(s[0]=s[0].replace(/^\n+/g,"")),s.length>0&&/\n+$/g.test(s[s.length-1])&&(s[s.length-1]=s[s.length-1].replace(/\n+$/g,""));const c=s.join("");return i?bs(c):c}toHTML(e,t){const n=Ss("<div />"),r=this.editor,i=r.container.css();return e&&t?(Ss(e).append(this.root).css(i),n.append(t)):n.append(this.root),r.trigger("parse:html-before",this.root),r.trigger("parse:html",n),r.trigger("parse:html-after",n),n.html().replace(/\u200b/g,"")}toDOM(e=null,t){const n=this.toValue(e,t,!1,!0),r=(new DOMParser).parseFromString(n,"text/html"),i=r.createDocumentFragment(),s=r.body.childNodes;for(;s.length>0;){const e=s[0];i.appendChild(e)}return i}toText(e=null,t,n=!0){const r=this.root.clone(!0),i=[],s=this.editor;return this.traverse(r,null,null,{onOpen:(e,t,r,o)=>{if(!1===s.trigger("parse:text",e,r,o,i))return!1;if("br"===t&&i.push("\n"),n&&"li"===e.name){if(e.hasClass(s.list.CUSTOMZIE_LI_CLASS))return;const t=e.parent(),n=t?.css("listStyleType");if("ol"===t?.name){const e=t[0].start||1;i.push(`${xs(n,e)}. `),t.attributes("start",e+1)}else"ul"===t?.name&&i.push(xs(n)+" ")}return!0},onText:(e,t)=>{t=(t=(t=ds(t)).replace(/\u00a0/g," ")).replace(/\u200b/g,""),i.push(t)},onClose:(t,n)=>{const r=s.node;if("p"===n||r.isBlock(t,e||s.schema)){const n=Array.from(t.get().childNodes);if(0===n.length||n.some(t=>{if(t instanceof Text)return!1;if("BR"===t.nodeName)return!0;const n=(e||s.schema).getType(t);return!n||"block"===n}))return;i.push("\n")}}},t),i.join("").trim()}}class wc{constructor(e){this.editor=e}getData(e){const t=(e=>!!e.dataTransfer)(e)?e.dataTransfer:e.clipboardData;let n=t?.getData("text/html"),r=t?.getData("text"),i=[];try{t?.items&&t.items.length>0?Array.from(t.items).forEach(e=>{let t="file"===e.kind?e.getAsFile():null;null!==t&&(t.type&&t.type.indexOf("image/png")>-1&&!t.lastModified&&(t=new File([t],"image.png",{type:t.type})),t.ext=r?.split(".").pop()),t&&i.push(t)}):t?.files&&t.files.length>0&&(i=Array.from(t.files))}catch(e){t?.files&&t.files.length>0&&(i=Array.from(t.files))}return""===n&&r&&/^.+\.\w+$/.test(r)&&i.length>0?r="":""===r&&n&&/^(<meta.+?>)?<img.+?>$/.test(n)&&i.length>0?n="":(n||r)&&i.length>0&&!n?.startsWith("<img")&&(n||!/^https(s)?:/.test(r||""))&&(i=[]),{html:n,text:r,files:i}}write(e,t){const n=this.editor.getSelectionData(t);if(!n)return;const{html:r,text:i}=n;return e?.preventDefault(),e?.clipboardData?.setData("text/html",'<meta name="source" content="aomao" />'+r.replace(/\u200b/g,"")),e?.clipboardData?.setData("text",i.replace(/\u200b/g,"")),n}copy(e,t=!1){if("string"==typeof e){const t=/<[^>]+>/g.test(e);return i(e,t?{format:"text/html",onCopy:t=>{t.setData("text/plain",new yc(e,this.editor).toText())}}:{format:"text/plain"}),!0}const n=this.editor,r=window.getSelection(),s=r&&gc.from(n,r)||gc.create(n),o=s.cloneRange(),a=Ss(`<div class="${ni}" ${Hr}="${Xr}">&#8203;</div>`);a.css({position:"fixed",top:0,clip:"rect(0, 0, 0, 0)"});const l=()=>{a.remove(),r?.removeAllRanges(),r?.addRange(o.toRange())};a.on("copy",e=>{e.stopPropagation(),this.write(e,s),l()}),Ss(document.body).append(a),a.append(n.node.clone(Ss(e),!0)),t&&a.traverse(e=>{e.equal(a)||n.trigger("copy",e)}),a.append(Ss("&#8203;",null));const c=a.first(),d=a.last();s.select(a,!0),s.setStartAfter(c),s.setEndBefore(d),r?.removeAllRanges(),r?.addRange(s.toRange());let h=!1;try{if(h=document.execCommand("copy"),!h)throw new Error("Copy failed")}catch(e){n.messageError("copy","The copy command was not executed successfully ",e),l()}return h}cut(){const e=this.editor,t=gc.from(e);if(!t||!Es(e))return;const n=t.commonAncestorNode,r=e.change;r.cacheRangeBeforeCommand(),r.delete(t);const i=e.node.isList(n)?n:n.find("ul,ol");for(let e=0;e<i.length;e++){const t=Ss(i[e]);t.find("li").each(e=>{(""===e.innerText||Ki&&"\n"===e.innerText)&&(e.parentElement??e.parentNode)?.removeChild(e)}),0===t.get()?.childNodes.length&&t.remove()}r.range.select(t)}}let Nc=class{constructor(e){this.engine=e}trigger(e,t){const{change:n,command:r,list:i,node:s}=this.engine,o=n.range.get(),a=this.engine.block;if(o.collapsed){const t=a.closest(o.startNode);if("li"===t.name&&i.isFirst(o))return e.isDelete||(e.preventDefault(),r.execute(i.getPluginNameByNode(t))),!1}else{const{startNode:r,endNode:l}=o,c=a.closest(r),d=a.closest(l);if("li"===c.name||"li"===d.name){e.preventDefault();const l=o.cloneRange(),h=r.first(),u=r.isCard()?r:h;if(u?.isCard()&&i.isEmptyItem(c)){const e=c.parent();c.remove(),e&&s.isCustomize(e)&&0===e.get()?.childNodes.length&&e.remove()}const f="li"===c.name?c.parent():null,g="li"===d.name?d.parent():null;if("li"===c.name&&i.isFirst(o)&&l.setStartBefore(c),"li"===d.name&&a.isLastOffset(o,"end")&&l.setEndAfter(d),n.delete(l,t),c.inEditor()&&!c.equal(d)&&d.inEditor()&&"li"===d.name){l.shrinkToElementNode().shrinkToTextNode();const e=l.createSelection();c.append(d.children()),d.remove(),e.move()}"li"===c.name&&s.isCustomize(c)&&0===c.get()?.childNodes.length&&c.remove();const p=e=>{if(s.isList(e)){const t=e.get()?.childNodes||[];if(0===t.length)e.remove();else if(1===t.length){const t=e.first();t?.isCursor()&&(e.after(t),e.remove())}}};return f&&f.length>0&&s.isList(f)&&p(f),g&&g.length>0&&s.isList(g)&&p(g),i.addBr(c),c.equal(d)||i.addBr(d),o.setStart(l.startContainer,l.startOffset),o.collapse(!0),i.merge(),n.isEmpty()&&n.initValue(o),n.apply(o),!1}}if(!a.isFirstOffset(o,"start"))return;let l=a.closest(o.startNode);if(s.isList(l)){const t=l.first();if(!t||t.isText())return e.preventDefault(),n.mergeAfterDelete(l),!1;l=t,o.setStart(l[0],0),o.collapse(!0),n.range.select(o)}if("li"===l.name){if(s.isCustomize(l))return;e.preventDefault();const t=l.closest("ul");return l.parent()?.isEditable()?(n.mergeAfterDelete(l),!1):(t.length>0?r.execute(i.getPluginNameByNode(t)):n.unwrap(l),!1)}return!0}},xc=class{constructor(e){this.engine=e,this.backspace=new Nc(e)}trigger(e){const{change:t,command:n,list:r}=this.engine;let i=t.range.get();i.shrinkToElementNode();const s=this.engine.block.closest(i.startNode),o=this.engine.block.closest(i.endNode);if("li"===s.name||"li"===o.name){i.collapsed||(this.backspace.trigger(e,s.name!==o.name),i=t.range.get()),e.preventDefault();const a=r.getPluginNameByNode(s);if(r.isLast(i)&&r.isFirst(i))n.execute(a);else{this.engine.block.split(),i=t.range.get();const e=this.engine.block.closest(i.endNode),n=r.getPlugins().find(e=>a===e.constructor.pluginName);if(!n)return;if(n.cardName){const t=e.prev();t&&(r.addCardToCustomize(t,n.cardName),r.addBr(t)),r.addCardToCustomize(e,n.cardName),r.addBr(e);const i=e.next();i&&(r.addCardToCustomize(i,n.cardName),r.addBr(i))}r.merge(void 0,i),r.addBr(i.startNode.closest("ul")),i.setStart(e,this.engine.node.isCustomize(e)?1:0),i.collapse(!0).shrinkToTextNode(),t.apply(i)}return i.scrollIntoView(),!1}return!0}};class Ec{constructor(e){this.CUSTOMZIE_UL_CLASS="data-list",this.CUSTOMZIE_LI_CLASS="data-list-item",this.INDENT_KEY="data-indent",this.STYLE_POSITION_NAME="list-style-position",this.STYLE_POSITION_VALUE="inside",this.editor=e}init(){const e=this.editor;if(Es(e)){const t=new xc(e);e.typing.getHandleListener("enter","keydown")?.on(e=>t.trigger(e)),this.backspaceEvent=new Nc(e),e.typing.getHandleListener("backspace","keydown")?.on(e=>this.backspaceEvent?.trigger(e))}}isEmptyItem(e){const t=e.children().toArray().filter(e=>e.isText()?""!==e.text().replace(/[\n\t]/g,""):!e.isCursor()),n=this.editor.node;return"li"===e.name&&(n.isEmpty(e)||0===t.length||(1===t.length?n.isCustomize(e)&&t[0].isCard()||"br"===t[0].name:2===t.length&&n.isCustomize(e)&&!!t[0].isCard()&&"br"===t[1].name))}isSame(e,t){if(e.name!==t.name)return!1;const{node:n}=this.editor;if(n.isCustomize(e)!==n.isCustomize(t))return!1;return(parseInt(e.attributes(this.INDENT_KEY),10)||0)===(parseInt(t.attributes(this.INDENT_KEY),10)||0)}isSpecifiedType(e,t="ul",n){const{node:r}=this.editor;let i=!0;return e.forEach(e=>{if(-1!==["li","p"].indexOf(e.name)||!(e.name===t||e.find(t).length>0))switch(e.name){case"li":if(n){let t=e.first();t?.isCursor()&&(t=t.next()),i=i&&r.isCustomize(e)&&(t?.attributes(ci)||"")===n}else i=i&&!r.isCustomize(e);break;case"p":e.parent()&&"li"!==e.parent()?.name&&(i=!1);break;default:i=!1}}),i}getPlugins(){const e=[],t=this.editor.plugin;return Object.keys(t.components).forEach(n=>{const r=t.components[n];r.isCurrent&&e.push(r)}),e}getPluginNameByNode(e){const t=e.name,n=e=>{let t="";return this.getPlugins().some(n=>!!n.isCurrent(e)&&(t=n.constructor.pluginName,!0)),t};return this.editor.node.isCustomize(e)?n(e):"li"===t&&e.parent()?n(e.parent()):""}getPluginNameByNodes(e){let t="";for(let n=0;n<e.length;n++){const r=e[n],i=r.parent();let s="";switch(r.name){case"li":case"ul":case"ol":s=this.getPluginNameByNode(e[n]);break;case"p":if(!i||"li"!==i.name)return"";s=this.getPluginNameByNode(i);break;default:if(this.editor.node.isBlock(r)&&r.find("ul,ol").length>0)break;return""}if(t&&s&&t!==s)return"";t=s}return t}unwrapCustomize(e){const t=this.editor.node;if(t.isCustomize(e))switch(e.name){case"li":if(t.isCustomize(e)){const t=e.first();t?.isCard()&&t.remove()}return e.removeAttributes("class"),e;case"ul":return e.removeAttributes("class"),e;default:return e}return e}unwrap(e,t=Ss("<p />")){let n=0;const{node:r,schema:i}=this.editor,s=i.data.globals.block||{},o=s.style||{};e.forEach(e=>{if(this.unwrapCustomize(e),r.isList(e)&&(n=parseInt(e.attributes(this.INDENT_KEY),10)||0,r.unwrap(e)),"li"===e.name){const i=r.clone(t,!1,!1);0!==n&&i.css("text-indent",2*n+"em"),e.removeAttributes(this.INDENT_KEY);const a=e.attributes();Object.keys(a).forEach(e=>{e!==Fr&&"id"!==e&&s[e]&&i.attributes(e,a[e])});const l=e.css();l["text-align"]&&this.addAlign(i,l["text-align"]),delete l["text-align"],l[this.STYLE_POSITION_NAME]="",Object.keys(l).forEach(e=>{o[e]||(l[e]="")}),i.css(l),r.replace(e,i)}})}normalize(e){const t=this.editor;if(!Es(t))return[];const{change:n,block:r,node:i}=t;e=e||n.range.get();const s=r.getBlocks(e),o=[];s.forEach((e,t)=>{const n=e.parent();if("p"===e.name){if("li"===n?.name)return 0===t&&o.push(n),void i.unwrap(e);if(n&&["ul","ol"].indexOf(n.name)>-1)return e=i.replace(e,Ss("<li />")),void o.push(e)}if("li"===e.name&&"li"===n?.name)return 0===t&&o.push(n),void i.unwrap(e);["ul","ol"].indexOf(e.name)>-1&&"li"===n?.name?i.unwrap(e):o.push(e)});const a=e.endNode.closest("li");return o.some(e=>e[0]===a[0])||o.push(a),o}split(e){const t=this.editor;if(!Es(t))return;const{change:n,node:r}=t,i=e||n.range.toTrusty(),s=this.normalize(e);if(s.length>0&&("li"===s[0].name||"li"===s[s.length-1].name)){const e=i.createSelection(),t=s[0],n=s[s.length-1],o=[],a=[];let l,c,d,h;if(t.prev()){l=t.parent();let e=0;for(;s[e]&&"li"===s[e].name;)o.push(s[e]),e+=1}if(n.next()){c=n.parent();let e=n.next();for(;e&&"li"===e.name;)a.push(e),e=e.next()}if(a.length>0&&c&&(d=r.clone(c,!1,!1),a.forEach(e=>{d?.append(e[0])}),c.after(d)),o.length>0&&l&&(h=r.clone(l,!1,!1),o.forEach(e=>{h?.append(e[0])}),l.after(h)),l&&c&&c.equal(l)&&"ol"===l.name){const e=(parseInt(l.attributes("start"),10)||1)+l.find("li").length;d.attributes("start",e)}e.move()}e||n.apply(i)}merge(e,t){const n=this.editor;if(!Es(n))return;const{change:r,block:i,node:s,schema:o}=n,a=o.getCanMergeTags();if(0===a.length)return;const l=t||r.range.toTrusty(),c=l.cloneRange(),d=e?void 0:c.shrinkToElementNode().createSelection();e=e||i.getBlocks(l);let h=!1;if(e.forEach(e=>{if(e=e.closest("ul,ol"),!s.isList(e)||-1===a.indexOf(e.name))return;const t=e.prev(),n=e.next();t&&this.isSame(t,e)&&(s.merge(t,e),e=t,h=!0),n&&this.isSame(n,e)&&(s.merge(e,n),h=!0)}),h&&(e=i.getBlocks(l)).length>0){const t=e[0].closest("ul,ol");this.addStart(t)}d?.move(),t||void 0===d||r.apply(c)}addStart(e){const t=this.editor;if(!Es(t))return;const{change:n,node:r}=t;if(!e){const r=t.block.getBlocks(n.range.get());if(0===r.length)return;e=r[0].closest("ul,ol")}if(!e||!r.isList(e))return;let i=[],s=parseInt(e.attributes(this.INDENT_KEY),10)||0,o=e.prev();for(;o&&r.isList(o);){if("ol"===o.name){const e=parseInt(o.attributes(this.INDENT_KEY),10)||0,t=parseInt(o.attributes("start"),10)||1,n=o.find("li").length;if(0===e){i[e]=t+n;break}e<=s&&(s=e,i[e]=i[e]||t+n)}else s=parseInt(o.attributes(this.INDENT_KEY),10)||0;o=o.prev()}let a=e;for(;a;){if(r.isList(a)){const e=parseInt(a.attributes(this.INDENT_KEY),10)||0,t=parseInt(a.attributes("start"),10),n=a.find("li").length;if("ol"===a.name){let r=i[e];e>0?(r=r||1,r>1?a.attributes("start",r):a.removeAttributes("start"),i[e]=r+n):r&&r!==t?(r>1?a.attributes("start",r):a.removeAttributes("start"),i[e]=r+n):(i[e]=(t||1)+n,i=i.slice(0,e+1))}}else i=[];const e=a.next();if(!e)break;a=e}}addIndent(e,t,n){if(this.editor.node.isList(e)){t=this.getIndent(e)+(t<0?-1:1),n&&t>n&&(t=n),t<1?e.removeAttributes(this.INDENT_KEY):e.attributes(this.INDENT_KEY,t)}}getIndent(e){return this.editor.node.isList(e)&&parseInt(e.attributes(this.INDENT_KEY),10)||0}addAlign(e,t){"li"===e.name&&(t&&"left"!==t?(["center","right"].indexOf(t)>-1&&e.css({[this.STYLE_POSITION_NAME]:this.STYLE_POSITION_VALUE}),e.css({"text-align":t})):e.css({[this.STYLE_POSITION_NAME]:"","text-align":""}))}addCardToCustomize(e,t,n){if(Mi(e)&&(e=Ss(e)),"li"!==e.name)return;const r=e.first();if(r?.isBlockCard()||r?.isCard()&&r.attributes(ci)===t)return;const i=this.editor,{card:s}=i,o=s.create(t,{value:n}),a=gc.create(i),l=Ss("<br />");(e.get()?.childNodes.length??0)>0?e.first()?.before(l):e.append(l),a.select(l,!0),s.insertNode(a,o);const c=e.last();return"br"===c?.name&&c.remove(),o}addReadyCardToCustomize(e,t,n){if(Mi(e)&&(e=Ss(e)),"li"!==e.name)return;const r=e.first();if(r?.isBlockCard()||r?.isCard()&&r.attributes(ci)===t)return;const i=Ss("<span />");return e.prepend(i),this.editor.card.replaceNode(i,t,n),i}addBr(e){const t=this.editor.node;if(t.isList(e))e.find("li").each(e=>{this.addBr(Ss(e))});else if(t.isCustomize(e)){let n=e.last();for(;n?.isCursor();)n=n.prev();if(n){const r=e.children();if(1===r.length&&n.isCard())return void e.append(Ss("<br />"));if(r.length>2&&"br"===n.name)return void("br"!==n.prev()?.name&&n.remove());for(;n;){if(n.equal(e.first())&&(n.isCard()||""===n.text()))return void e.append(Ss("<br />"));if(n.type===Node.TEXT_NODE){if(""!==n.text())return;n=n.prev()}else if(n.type===Node.ELEMENT_NODE){if(!t.isMark(n)||""!==n.text())return;n=e.prev()}else n=n.prev()}}else e.append(Ss("<br />"))}}insert(e,t){const n=this.editor;if(!Es(n)||0===e.childNodes.length)return;const{change:r,node:i,block:s}=n,o=t||r.range.toTrusty();o.collapsed||r.delete(o,!0,!0);const a=o.cloneRange().shrinkToElementNode(),{startNode:l,startOffset:c}=a;let d=l;if(i.isList(l)&&(d=l.children().eq(c)),d=d?.closest("li",e=>i.isBlock(e)&&"LI"!==e.nodeName?void 0:e.parentElement||void 0),0===d?.length||"li"!==d?.name)return;o.shrinkToElementNode().shrinkToTextNode(),s.split(o);const h=o.createSelection("list-insert");this.split(o);const u=e=>{s.merge(e),this.merge(void 0,e),h?.move(),t||r.apply(e)};let f=Ss(e).toArray().some(e=>i.isBlock(e))?Ss(e.childNodes[0]):Ss("<p></p>").append(Ss(e));const g=o.startNode.closest("ul,ol");if(!g||!i.isList(g))return void u(o);const p=o.startNode.closest("li");if(i.isCustomize(g)){const e=g.prev()?.first()?.first();if(e){const t=n.card.find(e);t&&this.addCardToCustomize(p,t.name,t.getValue())}}const m=!i.isList(f)||this.isSame(g,f);if(m){for(;i.isBlock(f);){const e=f.first();if(!e||!i.isBlock(e))break;f=e}const e=p.parent()?.prev()?.last();if("li"===e?.name){const t=e?.children();t?.each((e,n)=>{"BR"===e.nodeName&&t.eq(n)?.remove()}),i.isCustomize(f)&&f.first()?.remove(),f.isBlockCard()?e.parent()?.after(f):(e?.append(i.isBlock(f)?f.children():f),e&&this.addBr(e),i.isBlock(f)&&f.remove())}}else{const e=p.parent()?.prev()?.last();e&&(i.isEmpty(e)||this.isEmptyItem(e))&&(e.remove(),0===e.parent()?.get()?.childNodes.length&&e.parent()?.remove())}if(0===e.childNodes.length||1===e.childNodes.length&&i.isList(e.childNodes[0])&&0===e.childNodes[0].childNodes.length){const e=p.parent();if(f.isBlockCard()){if(e){this.isEmptyItem(p)&&1===e.get()?.childNodes.length&&e.remove();const t=[e],n=f.prev();n&&i.isList(n)&&t.push(n),this.merge(t)}}else i.isCustomize(p)&&p.first()?.remove(),p.find("br").remove(),e?.prev()?.last()?.append(p.children()),e?.remove();return void u(o)}const b=o.startNode.closest("li").parent();if(!b)return void u(o);const v=e.childNodes.length;let y=Ss(e.childNodes[v-1]);const w=(!i.isList(y)||this.isSame(g,y))&&!y.isBlockCard();let N=!1;for(let t=0;t<e.childNodes.length;t++){const n=Ss(e.childNodes[t]);if(i.isList(e.childNodes[t])&&!this.isSame(g,n)||n.isBlockCard()){N=!0;break}}const x=b.prev(),E=x?[x]:[];for(let t=0;t<(w&&!N?v-1:v);t++){const t=Ss(e.childNodes[0]);if(i.isList(t)){if(0===t.get()?.childNodes.length){t.remove();continue}b.before(t),E.push(t)}else{if(N){b?.before(t);continue}if(i.isBlock(t)&&t.allChildren().forEach(e=>{e.type!==ii().TEXT_NODE&&i.isBlock(e)&&i.unwrap(e)}),i.isCustomize(b)){const e=b.first()?.first();if(e&&e.isCard()){const n=e.attributes(ci)||e.attributes("name"),r=this.toCustomize(t,n);r&&(Array.isArray(r)?r:[r]).forEach(e=>{b?.before(e)})}}else{const e=this.toNormal(t,b.name);(Array.isArray(e)?e:[e]).forEach(e=>{n.node.isList(e)&&b?.before(e)})}}}if(E.length>0&&this.merge(E),!m&&i.isEmptyWidthChild(b)&&b.remove(),0===e.childNodes.length){if(i.isEmpty(p)||this.isEmptyItem(p)){const e=p.parent()?.prev();p.find("br").remove(),i.isCustomize(p)&&p.first()?.remove(),e&&i.isList(e)?e.last()?.append(p.children()):e&&e.append(p.children()),p.parent()?.remove()}return void u(o)}for(;i.isBlock(y);){const e=y.last();if(!e||!i.isBlock(e))break;y=e}const C=p;if(C){if(!y.parent()?.fragment){let e=C,t=y.prev();for(;t&&t.length>0;){const n=t.prev();e.before(t),e=t,t=n}}if("br"===y.name)y.remove();else{const e=y.children();if(e.each((t,n)=>{"BR"===t.nodeName&&e.eq(n)?.remove()}),i.isCustomize(C)){if(i.isCustomize(y)){const e=y.first();e?.isCard()&&e.remove()}C.first()?.after(i.isBlock(y)?y.children():y)}else C.prepend(i.isBlock(y)?y.children():y);this.addBr(C),i.isBlock(y)&&y.remove()}}u(o)}blockToItem(e,t,n,r){const i=Ss("<li></li>"),{node:s,schema:o}=this.editor;if(!s.isList(t))return t;const a=gs(e.css("text-indent"))/2,l=o.data.globals.block||{},c=e.attributes();Object.keys(c).forEach(e=>{e!==Fr&&"id"!==e&&l.name&&i.attributes(e,c[e])});const d=l.style||{},h=e.css();return h["text-align"]&&this.addAlign(i,h["text-align"]),delete h["text-align"],delete h[this.STYLE_POSITION_NAME],Object.keys(h).forEach(e=>{d[e]||delete h[e]}),i.css(h),e=s.replace(e,i),n&&(e.addClass(this.CUSTOMZIE_LI_CLASS),this.addCardToCustomize(e,n,r)),a&&t.attributes(this.INDENT_KEY,a),s.wrap(e,t)}toCustomize(e,t,n,r="ul"){const{node:i}=this.editor;if(Array.isArray(e)){let s=[];return e.forEach(e=>{i.isCustomize(e)&&this.unwrapCustomize(e),s=s.concat(this.toCustomize(e,t,n,r))}),s}{const s=Ss(`<${r} class="${this.CUSTOMZIE_UL_CLASS}"/>`);switch(e.name){case"li":return e.addClass(this.CUSTOMZIE_LI_CLASS),this.addCardToCustomize(e,t,n),e;case"ul":case"ol":return s.attributes(e.attributes()),e=i.replace(e,s);default:if("p"===e.name||i.isNestedBlock(e)&&!e.isBlockCard()){if("li"===e.parent()?.name)return i.unwrap(e),e;e=this.blockToItem(e,s,t,n)}return e}}}toNormal(e,t="ul",n){const{node:r}=this.editor;if(Array.isArray(e)){let r=[];return e.forEach(e=>{const i=this.toNormal(e,t,n);r=r.concat(i)}),r}{this.unwrapCustomize(e);const i=Ss("<".concat(t," />"));switch(e.name){case"li":case t:return e;case"ol":case"ul":return i.attributes(e.attributes()),"ul"===i.name&&i.removeAttributes("start"),e=r.replace(e,i);default:if("p"===e.name||r.isNestedBlock(e)&&!e.isBlockCard()){if("li"===e.parent()?.name)return r.unwrap(e),e;e=this.blockToItem(e,i),n&&e.attributes("start",n)}return e}}}isFirst(e){const{startNode:t,startOffset:n}=e,r=e.cloneRange(),i="li"===t.name?t:t.closest("li");if(!i[0])return!1;r.select(i,!0),r.setEnd(t[0],n);const s=r.cloneContents();if(!s.firstChild)return!0;const o=Ss(s.firstChild),a=Ss(s.lastChild||[]);if(1===s.childNodes.length&&"br"===o.name)return!0;if(1===s.childNodes.length&&i.hasClass(this.CUSTOMZIE_LI_CLASS)&&o.isCard())return!0;const l=this.editor.node;if(2===s.childNodes.length&&i.hasClass(this.CUSTOMZIE_LI_CLASS)&&o.isCard()&&l.isEmpty(a))return!0;const c=Ss("<div />");return c.append(s),l.isEmpty(c)}isLast(e){const{endNode:t,endOffset:n}=e,r=e.cloneRange(),i="li"===t.name?t:t.closest("li");if(!i[0])return!1;r.select(i,!0),r.setStart(t,n);const s=r.cloneContents();if(!s.firstChild)return!0;const o=Ss(s.firstChild),a=Ss(s.lastChild||[]);if(1===s.childNodes.length&&"br"===o.name)return!0;if(1===s.childNodes.length&&i.hasClass(this.CUSTOMZIE_LI_CLASS)&&o.isCard())return!0;const l=this.editor.node;if(2===s.childNodes.length&&i.hasClass(this.CUSTOMZIE_LI_CLASS)&&o.isCard()&&l.isEmpty(a))return!0;const c=Ss("<div />");return c.append(s),l.isEmpty(c)}}let Cc=class{constructor(e){this.engine=e}trigger(){const{change:e,node:t,block:n}=this.engine,r=e.range.get(),{collapsed:i,endNode:s,startNode:o,startOffset:a,endOffset:l}=r.cloneRange().shrinkToTextNode();if(i){const e=n.closest(o);if(e.length>0&&t.isEmpty(e))return}if(s.type===Node.TEXT_NODE||o.type===Node.TEXT_NODE){if(!i){const e=s.parent();if(e&&s.type===Node.TEXT_NODE&&t.isMark(e)){const e=s.text().substr(l);if(!/^\u200b$/.test(e))return!0;r.setEnd(s,l+1)}return!0}let e=o.parent();if(e&&o.type===Node.TEXT_NODE&&t.isMark(e)){if(a<1)return!0;const n=o.text().substr(a-1,1);if(!/^\u200b$/.test(n))return!0;if(1===a){const n=e.prev();if(n&&!t.isEmpty(n)){const{startNode:e,startOffset:t}=r.cloneRange().select(n,!0).shrinkToTextNode().collapse(!1);r.setStart(e,t-1)}else if(!n&&t.isEmpty(e)){const t=e.parent(),n=e.getIndex();e.remove(),t&&r.setStart(t,n<=0?0:n-1)}}else r.setStart(o,a-1);return!0}if(e=o.prev()||void 0,e&&o.type===Node.TEXT_NODE&&t.isMark(e)){const t=o.text().substr(a-1,1);if(!/^\u200b$/.test(t))return!0;if(1===a){const{startNode:t,startOffset:n}=r.cloneRange().select(e,!0).shrinkToTextNode().collapse(!1);r.setStart(t,n-1)}else r.setStart(o,a>0?a-1:0)}}return!0}};class kc{constructor(e){this.pluginCaches=new Map,this.findSameParent=(e,t)=>{const{node:n}=this.editor;if(n.isMark(e)){let n;if(this.compare(e,t,!0))return!0;if(n=e.parent())return this.findSameParent(n,t)}return!1},this.editor=e}init(){const e=this.editor;if(Es(e)){const t=new Cc(e);e.typing.getHandleListener("backspace","keydown")?.on(()=>t.trigger()),e.on("keydown:space",e=>this.triggerMarkdown(e)),e.on("keydown:enter",e=>this.triggerMarkdown(e))}}triggerMarkdown(e){const t=this.editor;if(!Es(t)||!1===t.options.markdown?.mode)return;const{change:n}=t,r=n.range.get();if(!r.collapsed||n.isComposing())return;const{startNode:i,startOffset:s}=r.cloneRange().shrinkToTextNode(),o=i.type===Node.TEXT_NODE?i:i.children().eq(s-1);if(!o)return;const a=r.toPath(),l=o.type===Node.TEXT_NODE?o.text().substr(0,s):o.text(),c=ks(t,"zero"),{renderer:d,options:h}=c,u=c.parseInline(l,{});if(0===u.length)return;let f=!1,g="";if(u.forEach(e=>{let n="";const r=e.children||[];r.forEach((i,s)=>{const{type:o}=i;!1!==t.trigger("markdown-it-token",{token:e,markdown:c,callback:e=>{n+=e}})?(f||"text"===o||(f=!0),void 0!==d.rules[o]?n+=d.rules[o](r,s,h,{},d):n+=d.renderToken(r,s,h)):f=!0}),g+=n}),f){const i=t.node;e.preventDefault(),r.setStart(o[0],0),r.setEnd(o[0],s),n.paste(g,r),n.rangePathBeforeCommand=a,r.collapse(!1),r.enlargeToElementNode();const l=Ss(g),c=l.last(),d=l.eq(l.length-1);(i.isMark(l)||c&&i.isMark(c)||d&&i.isMark(d))&&i.insertText(" ",r),n.range.select(r)}return!f}findPlugin(e){const{node:t,plugin:n,schema:r}=this.editor;if(0===e.length||!t.isMark(e))return;const i=e.get().cloneNode().outerHTML,s=this.pluginCaches.get(i);if(s)return s;for(const t in n.components){const s=n.components[t];if(Ys(s)&&e.name===s.tagName){const t=s.schema();if(Array.isArray(t)?t.find(t=>r.checkNode(e,t.attributes)):r.checkNode(e,t.attributes))return this.pluginCaches.set(i,s),s}}return s}closest(e){const t=this.editor.node;let n=e.parent();for(;n&&!n.isEditable()&&!t.isBlock(n);){if(t.isMark(n))return n;const e=n.parent();if(!e)break;n=e}return e}closestNotMark(e){for(;(this.editor.node.isMark(e)||e.isText())&&!e.isEditable();){const t=e.parent();if(!t)break;e=t}return e}compare(e,t,n){if(e.name!==t.name)return!1;const r=e.attributes();delete r.style,delete r[Fr];const i=t.attributes();delete i.style,delete i[Fr];const s=e.css(),o=t.css();delete r.class,delete i.class;const a=e.get().className.trim(),l=t.get().className.trim();let c=""!==a?a.split(/\s+/):[],d=""!==l?l.split(/\s+/):[];const{schema:h}=this.editor,u=h.find(t=>t.name===e.name),f=e=>{for(let t=0;t<u.length;t++){const n=u[t];if(n.attributes&&"class"in n.attributes&&n.attributes.class&&h.checkValue(n.attributes,"class",e.join(" ").trim()))return n.attributes.class.toString()}return e.join(" ").trim()};return n||(c=c.length>0?[f(c)]:[],d=d.length>0?[f(d)]:[]),Object.keys(r).length===Object.keys(i).length&&(!!Object.keys(r).every(e=>n?r[e]===i[e]:!!i[e])&&(Object.keys(s).length===Object.keys(o).length&&(!!Object.keys(s).every(e=>n?s[e]===o[e]:!!o[e])&&(c.length===d.length&&!!c.every(e=>-1!==d.indexOf(e))))))}contain(e,t){const n=t.attributes(),r=n.style||{};delete n.style;const i=e.attributes(),s=i.style||{};return delete i.style,Object.keys(n).every(e=>!!i[e])&&Object.keys(r).every(e=>!s[e])}unwrapEmptyMarks(e,t){const{node:n}=this.editor;e.allChildren().forEach(e=>{if(n.isEmpty(e)&&n.isMark(e)&&(!t||t(e))){const t=e.children();1===t.length&&t.isText()?e.remove():n.unwrap(e)}})}splitOnCollapsed(e,t,n){if(!e.collapsed)return;e.enlargeFromTextNode(),e.shrinkToElementNode();const{startNode:r}=e,i=r.parent(),s=r.isCard()?r:r.closest(mi),{node:o}=this.editor;if((0===s.length||"inline"!==s.attributes(hi))&&(o.isMark(r)||i&&o.isMark(i))){const i=this.closestNotMark(r),s=e.createSelection(),a=s.getNode(i,"left");let l,c,d=[];if(n){Mi(n)&&(n=Ss(n));const e=n.getPath(i.get()),t=i.clone(!0);d=e.slice(1),c=Ss(t.getChildByPath(e.slice(0,1))),l=s.getNode(t,"right",!1)}else l=s.getNode(i,"right");this.unwrapEmptyMarks(a,e=>!e.isCursor()),this.unwrapEmptyMarks(l,e=>{t&&!Array.isArray(t)&&(t=[t]);return!t||0===t.length||!e.isCard()&&t.some(t=>this.compare(e,t))});const h=i.children();let u;h.each((e,t)=>{const n=h.eq(t);n?.isCard()||n?.remove()});const f=e=>{e.each((t,n)=>{const r=e.eq(n);if(r?.isCard())return u=u?u.next():i.first(),void(u&&(e[n]=u[0]));u?(u.after(t),u=r):(u=r,i.prepend(t))})},g=a.children(),p=g.toArray();f(g);const m=l.children();let b=m.toArray();c&&(n=b.find(e=>e.equal(c))?.getChildByPath(d)),f(m),b=m.toArray();let v=Ss("​",null);if(1===p.length&&"br"===p[0].name&&(p[0].remove(),p.splice(0,1)),1===b.length&&"br"===b[0].name&&(b[0].remove(),b.splice(0,1)),b.filter(e=>!e.isCursor()).length>0){let n=b[0];for(let e=0;e<b.length-1&&(n=b[e],n.isCursor());e++);if(o.isEmpty(n)){let e=n.first();for(;e&&!e.isText();)n=e,e=e.first();n.isText()?n.before(v):n.prepend(v)}else{let e=o.isMark(r)?r:r.parent(),i=v;if(t&&!Array.isArray(t)&&(t=[t]),t&&t.length>0&&e&&o.isMark(e))for(;;){const n=e.clone();if(!t.some(e=>this.compare(n,e))){const e=v.equal(i);i=o.wrap(i,n),e&&(v=i.first())}if(e=e.parent(),!e)break}n.before(i)}e.select(v).collapse(!1)}else if(p.filter(e=>!e.isCursor()).length>0){p[p.length-1].after(v),e.select(v).collapse(!1)}else e.select(i,!0).collapse(!0);let y=!1;i.children().each(e=>{const t=Ss(e);if(t.isText()){const{textContent:n}=e;let r=n?.replace(/\u200b+/g,"​")||"";if(n!==r&&(e.textContent=r),y){const n=t.next(),i=t.parent();(!n&&i&&!o.isInline(i)||n&&!o.isInline(n))&&r.startsWith("​")?(r=r.substring(1),r?e.textContent=r:t.remove()):y=!1}r.endsWith("​")&&(y=!0)}else y=!1});const w=o;if(v[0].parentElement??v[0].parentNode){const e=v[0];let t=null,n=0;const r=(r,i)=>{const s=e=>i?e.previousSibling:e.nextSibling;for(;r;){if(r.nodeType!==e.nodeType)return;const o=s(r);if(r.textContent===t){const e=r.parentElement??r.parentNode;if(o&&w.isInline(o)||!o&&e&&w.isInline(e))break;e?.removeChild(r),r=o}else{if(i)for(;t&&r.textContent?.endsWith(t);){const e=r.parentElement??r.parentNode;if(o&&w.isInline(o)||!o&&e&&w.isInline(e))break;r.textContent=r.textContent.substring(0,r.textContent.length-n)}else for(;t&&r.textContent?.startsWith(t);){const e=r.parentElement??r.parentNode;if(o&&w.isInline(o)||!o&&e&&w.isInline(e))break;r.textContent=r.textContent.substring(t.length)}if(0!==r.textContent?.length)return;const e=r.parentElement??r.parentNode;e?.removeChild(r),r=o}}};if(e.nodeType===Node.TEXT_NODE){const{textContent:i}=e;t=i,n=t.length,r(e.previousSibling,!0),r(e.nextSibling,!1)}}}return n}splitOnExpanded(e,t){if(e.collapsed)return;e.enlargeToElementNode(),e.shrinkToElementNode();const{startNode:n,endNode:r}=e,i=n.isCard()?n:n.closest(mi),s=r.isCard()?r:r.closest(mi);if(!(i.length>0&&"inline"===i.attributes(hi)||s.length>0&&"inline"===s.attributes(hi))){const i=this.closestNotMark(n),s=this.closestNotMark(r);if(!i.equal(s)){const n=e.cloneRange();n.collapse(!0);const r=e.cloneRange();let o;r.collapse(!1);const a=n.startOffset,l=r.endOffset;return void(i.contains(s)?(o=this.splitOnCollapsed(n,t,r.endNode),e.setStart(n.startContainer,n.startOffset),o&&r.setOffset(o,l,l),this.splitOnCollapsed(r,t),e.setEnd(r.startContainer,r.startOffset)):(o=this.splitOnCollapsed(r,t,n.startNode),e.setEnd(r.startContainer,r.startOffset),o&&n.setOffset(o,a,a),this.splitOnCollapsed(n,t),e.setStart(n.startContainer,n.startOffset)))}const{node:o}=this.editor,a=n.parent(),l=o.isMark(n)||a&&o.isMark(a),c=r.parent(),d=o.isMark(r)||c&&o.isMark(c);if(!l&&!d)return;let{commonAncestorNode:h}=e;h.isText()&&(h=h.parent());const u=this.closestNotMark(h),f=e.createSelection(),g=f.getNode(u,"left"),p=f.getNode(u),m=f.getNode(u,"right");this.unwrapEmptyMarks(g),this.unwrapEmptyMarks(m);const b=u.children();let v;b.each((e,t)=>{const n=b.eq(t);n?.isCard()||n?.remove()});const y=e=>{e.each((t,n)=>{const r=e.eq(n);if(r?.isCard())return v=v?v.next():u.first(),void(v&&(e[n]=v[0]));v?(v.after(t),v=r):(v=r,u.prepend(t))})};y(g.children());const w=p.children(),N=w.toArray();y(w);y(m.children()),e.setStartBefore(N[0][0]),e.setEndAfter(N[N.length-1][0])}}split(e,t){const n=this.editor;if(!Es(n))return;const{change:r}=n,i=e||r.range.toTrusty(),s=ii(i.startContainer),o=i.collapsed;if(("string"==typeof t||!Array.isArray(t)&&t&&Mi(t))&&(t=Ss(t,s)),o)this.splitOnCollapsed(i,t);else{const e=i.createSelection("mark-split");this.splitOnExpanded(i,t),e.move()}e||r.apply(i)}wrapByNode(e,t,n=this.findPlugin(t),r){const i=this.editor.node;if(i.isMark(e)){0===e.get()?.childNodes.length&&e.html("&#8203;");let r=e,s=r.children().toArray(),o=this.findPlugin(r),a=!1;for(;i.isMark(r)&&1===s.filter(e=>!e.isCursor()).length&&n&&o&&n.mergeLeval<=o.mergeLeval;){const e=s.find(e=>!e.isCursor());if(i.isMark(e))r=e,s=r.children().toArray();else{if(!e.isText())break;r=e}if(n.name===o.name){a=!0;break}o=this.findPlugin(r)}i.removeZeroWidthSpace(r);let l=r.parent();if(r.isText()||a){let e=!1;for(;l&&i.isMark(l);){if(this.compare(l.clone(),t,!0)){e=!0;break}if(1===l.children().toArray().filter(e=>!e.isCursor()).length){const r=this.findPlugin(l);if(n&&n===r&&!0===n.combineValueByWrap){i.wrap(l,t,!0),e=!0;break}if(n&&n===r){i.unwrap(l),e=!1;break}}l=l.parent()}if(e)return!1}return r.allChildren().forEach(e=>{if(e.type!==ii().TEXT_NODE&&i.isMark(e)){this.findPlugin(e)!==n||n?.combineValueByWrap||i.unwrap(e)}}),i.wrap(r,t)}if("br"===e.name){const n=e.parent();if(n&&i.isBlock(n)){const n=t.clone(!0);return n.html("&#8203;"),i.replace(e,n),n}}else if(e.isCard()){const n=this.editor.card.find(e);if(n&&n.executeMark)return n.executeMark(t,!0)}else if(e.isText()&&!i.isEmpty(e)){i.removeZeroWidthSpace(e);let s=e.parent(),o=!1;for(;s&&i.isMark(s);){if(this.compare(s.clone(),t,!0)){o=!0;break}if(1===s.children().toArray().filter(e=>!e.isCursor()).length||r&&r.equal(s)){const e=this.findPlugin(s);if(n&&n===e&&!0===n.combineValueByWrap){i.wrap(s,t,!0),o=!0;break}if(n&&n===e){const e=i.unwrap(s),t=e.find(e=>!e.isCursor()&&i.isMark(e));t?s=t:e.length>0&&(s=e[0].parent()),o=!1;break}}const e=s.parent();if(!e||!i.isMark(s))break;s=e}if(o)return!1;let a=e.parent();const l=a?this.findPlugin(a):void 0;let c=!1;for(;a&&i.isMark(a)&&n&&l&&n.mergeLeval>l.mergeLeval;){c=!0;const n=a.children().toArray(),r=a.clone();n.forEach(n=>{n.isCursor()||3===n.type&&/^\u200b$/.test(n.text()||"")||(e.equal(n)||n.contains(e)?e=i.wrap(i.replace(e,r),t):(n=i.wrap(n,r),i.wrap(n,t)))}),i.unwrap(a),a=this.closest(e)}return c||i.wrap(e,t),e}}wrap(e,t){const n=this.editor,r=Es(n)?n.change:void 0;if(!t&&!r)return;const{node:i}=n,s=t||r.range.toTrusty(),o=ii(s.startContainer);if(("string"==typeof e||Mi(e))&&(e=Ss(e,o)),!i.isMark(e))return;let{commonAncestorNode:a}=s;a.type===Node.TEXT_NODE&&(a=a.parent());const l=n.card.find(a,!0);let c=l?.isEditable;const d=c?l?.getSelectionNodes?l.getSelectionNodes():[]:[a];0===d.length&&(c=!1,d.push(a));const h=i,u=this.findPlugin(e);if(s.collapsed&&(!c||!l?.getSelectionNodes||1===d.length)){0===e.children().toArray().filter(e=>!e.isCursor()).length&&e.append(o.createTextNode("​"));const{startNode:n}=s.shrinkToTextNode();let i=n.parent();const a=[];let l=!1;if(n.isText()){let t=!1;for(;i&&h.isMark(i);){if(this.compare(i.clone(),e,!0)){t=!0;break}const n=this.findPlugin(i);if(1===i.get()?.childNodes.length){if(u&&u===n&&!0===u.combineValueByWrap){h.wrap(i,e,!0),t=!0;break}if(u&&u===n){if(this.split(s),s.collapsed){let t=i.parent();for(;t&&h.isMark(t);)e=h.wrap(e,t),t=t.parent()}t=!1;break}}u&&(!n||u.mergeLeval>n.mergeLeval)?a.push(i.clone(!1)):!l&&a.length>0&&(a.push(e.clone(!1)),l=!0),i=i.parent()}if(t)return}if(a.length>0){let t=a[0];t.append(e.children());for(let e=1;e<a.length;e++)t=h.wrap(t,a[e]);e=l?t:h.wrap(t,e),this.split(s)}return h.insert(e,s),this.merge(s),s.handleBr(),void(t||r?.apply(s))}c||(this.split(s),a=s.commonAncestorNode,a.type===Node.TEXT_NODE&&(a=a.parent()),d[0]=a);const f=c?void 0:s.createSelection();if(f&&!f.anchor&&!f.focus)return void(t||r?.apply(s));let g=!!c;if(d.forEach(t=>{t.traverse(n=>{if(!c&&f?.anchor&&n.equal(f.anchor))g=!0;else if(g){if(!c&&f?.focus&&n.equal(f.focus))return g=!1,!1;const r=h.isMark(n),i=this.wrapByNode(n,e,u,t);if(i&&"boolean"!=typeof i&&r){if(!c&&f?.focus&&i.find(`[${Hr}="${f.focus.attributes(Hr)}"]`).equal(f.focus))return g=!1,!1;if(f?.focus&&i.next()?.equal(f.focus))return g=!1,!1}if(void 0!==i)return!0}},!0,"editable")}),f?.move(),c){const e=[];d.forEach(t=>{t.allChildren().forEach(t=>{t.isElement()&&i.isMark(t)&&e.push(t)})}),this.mergeMarks(e)}else this.merge(s);t||r?.apply(s)}mergeMarks(e){const{node:t}=this.editor;e.forEach(e=>{const n=e.prev(),r=e.next(),i=e.parent();if(i&&this.findSameParent(i,e))return void t.unwrap(e);n&&this.compare(n,e,!0)&&(t.merge(n,e),e=n),r&&this.compare(r,e,!0)&&t.merge(e,r);const s=[],o=e.children();o.each((e,n)=>{const r=o.eq(n);r&&!r.isCursor()&&t.isMark(r)&&s.push(r)}),s.length>0&&this.mergeMarks(s)})}merge(e){const t=this.editor;if(!Es(t))return;const{change:n}=t,r=e||n.range.toTrusty(),i=this.findMarks(r);if(0===i.length)return;const s=r.shrinkToElementNode().createSelection();this.mergeMarks(i),s.move(),r.handleBr(),e||n.apply(r)}unwrapByNodes(e,t){const n=this.editor,r=n.node;e.forEach(e=>{!t||!e.isCard()&&(Array.isArray(t)?t:[t]).some(t=>this.compare(e,t))?r.unwrap(e):t?(Array.isArray(t)?t:[t]).forEach(t=>{const r=t.css();Object.keys(r).forEach(t=>{e.css(t,"")});const i=t.get()?.className.split(/\s+/);if(i){const{schema:t}=n,r=t.find(t=>t.name===e.name);for(let n=0;n<r.length;n++){const s=r[n];i.forEach(n=>{""!==(n=n.trim())&&s.attributes&&t.checkValue(s.attributes,"class",n)&&e.removeClass(n)})}}}):(e.removeAttributes("class"),e.removeAttributes("style"))})}unwrap(e,t){const n=this.editor;if(!Es(n))return;const{change:r,node:i}=n,s=t||r.range.toTrusty(),o=ii(s.startContainer)||document;void 0===e||Array.isArray(e)||"string"!=typeof e&&!Mi(e)||(e=Ss(e,o));let{commonAncestorNode:a}=s;a.type===Node.TEXT_NODE&&(a=a.parent());const l=n.card.find(a,!0);let c=l?.isEditable;const d=c?l?.getSelectionNodes?l.getSelectionNodes():[]:[a];if(0===d.length&&(c=!1,d.push(a)),c||(this.split(s,s.collapsed?e:void 0),a=s.commonAncestorNode,a.type===Node.TEXT_NODE&&(a=a.parent()),d[0]=a),s.collapsed&&(!c||!l?.getSelectionNodes||1===d.length))return void(t||r.apply(s));const h=c?void 0:s.createSelection("mark-unwrap");if(h&&!h.has())return this.merge(s),void(t||r.apply(s));const u=[];let f=!!c;if(d.forEach(t=>{t.traverse(t=>{if(c||!t.isText()&&h?.anchor)if(c||h?.anchor&&!t.equal(h.anchor)){if(f&&(c||!h?.focus||!t.equal(h.focus)))if(i.isMark(t)&&!t.isCard()&&(c||s.isPointInRange(t,0)))u.push(t);else if(t.isCard()){const r=n.card.find(t);r&&r.executeMark&&(Array.isArray(e)?e:[e]).forEach(e=>{r.executeMark(e,!1)})}}else if(!c&&(f=!0,h?.anchor&&t.equal(h.anchor)&&!h.anchor.prev())){let e=h.anchor.parent();for(;e&&!e.isCard()&&i.isMark(e)&&(u.push(e),e=e.parent(),!(e&&(e.get()?.childNodes.length??0)>1)););}},!0,"editable")}),this.unwrapByNodes(u,e),h?.move(),c){const e=[];d.forEach(t=>{t.allChildren().forEach(t=>{t.isElement()&&i.isMark(t)&&e.push(t)})}),this.mergeMarks(e)}else this.merge(s);t||r.apply(s)}insert(e,t){const n=this.editor;if(!Es(n))return;const{change:r,node:i}=n,s=t||r.range.toTrusty();if("string"==typeof e||Mi(e)){const t=ii(s.startContainer);e=Ss(e,t)}s.collapsed||r.delete(s),i.insert(e,s)?.handleBr().select(e).collapse(!1),t||r.apply(s)}findMarks(e){const t=this.editor,n=e.cloneRange();if(n.startNode.isRoot()&&n.shrinkToElementNode(),!n.startNode.inEditor()||t.card.find(n.startNode))return[];const{node:r}=t,i=(e,t,n=!1)=>{if(!t.collapsed)return;const{startNode:i,startOffset:s}=t,o=i.findParent();if(!o)return;const a=t.cloneRange();if(a.select(o,!0),n){a.setEnd(i,s),a.enlargeFromTextNode(),a.enlargeToElementNode(!0);const n=i.get().childNodes,{endNode:l,endOffset:c}=a,d=l.get().childNodes.item(c),h=n.item(s)||n.item(s-1);if(!e&&l.type===Node.ELEMENT_NODE&&d&&r.isBlock(d)&&(i.type!==Node.ELEMENT_NODE||h&&!r.isBlock(h)))return;a.select(o,!0),a.setStart(l,c),a.shrinkToElementNode(),a.shrinkToTextNode(),t.setStart(a.startContainer,a.startOffset),t.collapse(!0)}else{a.setStart(i,s),a.enlargeFromTextNode(),a.enlargeToElementNode(!0);const n=i.get().childNodes,l=a.startNode,c=a.startOffset,d=l.get().childNodes.item(c),h=n.item(s)||n.item(s-1);if(!e&&l.type===Node.ELEMENT_NODE&&d&&r.isBlock(d)&&(i.type!==Node.ELEMENT_NODE||h&&!r.isBlock(h)))return;a.select(o,!0),a.setEnd(l,c),a.shrinkToElementNode(),a.shrinkToTextNode(),t.setEnd(a.endContainer,a.endOffset),t.collapse(!1)}};if(!n.collapsed){const e=n.cloneRange(),t=n.cloneRange();e.collapse(!0),t.collapse(!1),i(!0,e,!0),i(!0,t),n.setStart(e.startContainer,e.startOffset),n.setEnd(t.startContainer,t.startOffset)}i(!1,n);const s=n.startContainer,o=n.startOffset,a=n.endContainer,l=n.endOffset;let c=s,d=a;s.nodeType===Node.ELEMENT_NODE&&s.childNodes[o]&&(c=s.childNodes[o]||s),a.nodeType===Node.ELEMENT_NODE&&l>0&&a.childNodes[l-1]&&(d=a.childNodes[l-1]||s),n.collapsed&&(c=d);const h=(e,t)=>{e.push(t)},u=r,f=e=>{const n=[];for(;e&&(e.type!==Node.ELEMENT_NODE||!e.isEditable());){if(!u.isMark(e)||e.attributes(ci)||e.attributes(fi)){if(e.isCard()){const r=t.card.find(e);r?.queryMarks&&n.push(...r.queryMarks())}}else n.push(e);const r=e.parent();if(!r)break;e=r}return n},g=f(Ss(c)),{commonAncestorNode:p}=n,m=t.card.find(p,!0);let b=m?.isEditable;const v=b?m?.getSelectionNodes?m.getSelectionNodes():[]:[p];if(0===v.length&&(b=!1,v.push(p)),(!n.collapsed||b)&&(f(Ss(d)).forEach(e=>h(g,e)),s!==a||b)){let e=!1,n=!1;v.forEach(r=>{r.traverse(r=>{if(n)return!1;if(r[0]!==s){if(e){if(r[0]===a)return n=!0,!1;if(!u.isMark(r)||r.attributes(ci)||r.attributes(fi)){if(r.isCard()){const e=t.card.find(r);e?.queryMarks&&e.queryMarks().forEach(e=>{h(g,e)})}}else h(g,r)}}else e=!0},!0,"editable")})}for(let e=0;e<g.length;e++)for(let t=e+1;t<g.length;t++)g[e][0]===g[t][0]&&(g.splice(t,1),t--);return g}removeEmptyMarks(e,t){if(0===e.length||e.isEditable()||e.isCard()||e.attributes(Hr))return;const n=this.editor.node;if(!e.attributes(Hr)){const r=e.parent();if(1===e.get()?.childNodes.length&&e.first()?.attributes(Hr))return void(n.isMark(e)?(e.before(e.first()),e.remove(),r&&this.removeEmptyMarks(r,!0)):t&&n.isBlock(e)&&e.prepend("<br />"));const i=n.html(e);""!==i&&"​"!==i||(n.isMark(e)?(e.remove(),r&&this.removeEmptyMarks(r,!0)):t&&n.isBlock(e)&&n.html(e,"<br />"))}}repairCursor(e){const{node:t}=this.editor;e=Mi(e)?Ss(e):e;if(t.isMark(e)&&!e.isCursor()){const n=e.children();n.each((e,t)=>{const r=n.eq(t);if(r?.isText()&&!r.next()?.isCursor()){const e=r.text();if(1===e.length&&/\u200b/.test(e))return void r.remove();r.text(e.replace(/\u200b/g,""))}});const r=e.children().toArray().filter(e=>!e.isCursor());r.length<2&&(0===r.length||1===r.length&&r[0].isText()&&0===r[0].text().length)&&(r.length>0&&r[0].remove(),e.prepend(Ss("​",null)));const i=e.next(),s=i?.next();i&&s&&i.isText()&&/^\u200b$/g.test(i.text())&&!t.isInline(s)&&i.remove();const o=e.prev(),a=o?.prev();o&&a&&o.isText()&&/^\u200b$/g.test(o.text())&&!t.isInline(a)&&o.remove()}}}let Tc=class{constructor(e){this.engine=e}trigger(e){const{change:t,inline:n,node:r}=this.engine,i=t.range.get(),{collapsed:s,endNode:o,startNode:a,startOffset:l}=i.cloneRange().shrinkToTextNode();if(o.type===Node.TEXT_NODE||a.type===Node.TEXT_NODE){if(!s){const e=n.closest(o);if(r.isInline(e)&&!e.isCard()&&r.isEmpty(e)){if(l>1)return!0;const t=o.prev(),n=o.parent();if(n&&r.isInline(n)){if(t)return!0;const n=o.text().substr(0,l);if(!/^\u200b$/.test(n))return!0;const r=e.next(),s=r?.text();if(r&&r.isText()&&s&&/^\u200b/.test(s))return i.setEnd(r,1),!1}}return r.isInline(e)&&!e.isCard()&&setTimeout(()=>{n.repairCursor(e)},100),!0}const c=n.closest(a);if(r.isInline(c)){if(c.isCard())return!0;if(l>1)return!0;let e=a.prev(),n=a.parent();if(n&&r.isInline(n)){if(e)return!0;const t=a.text().substr(0,l);if(!/\u200b$/.test(t))return!0}else{if(0!==l)return!0;for(;!e&&n&&!r.isInline(n);)e=n.prev(),n=n?.parent();if(e&&!e.isText())return!0;if(e&&!/\u200b$/.test(e.text()))return!0}const s=c.prev(),o=s?.text();if(s&&s.isText()&&o&&/\u200b$/.test(o)){if(i.setStart(s,o.length-1),r.isEmpty(c)){const e=c.next(),t=e?.text();e&&e.isText()&&t&&/^\u200b/.test(t)&&i.setEnd(e,1)}else i.collapse(!0);return t.range.select(i),!1}return!0}{let n,s=a.prev(),o=a.parent();if(s){if(r.isInline(s)&&!s.isCard()){const e=a.text().substr(0,l);if(!/^\u200b$/.test(e))return!0;n=s}}else{if(0!==l)return!0;for(;!s&&o&&!r.isBlock(o);)s=o.prev(),o=o?.parent();if(s&&!s.isText())return!0;if(s){if(!/^\u200b$/.test(s.text()))return!0;if(s=s.prev(),!s||!r.isInline(s))return!0;n=s}}if(n){const r=n.last(),s=r?.text();if(r&&r.isText()&&s&&/\u200b$/.test(s))return e.preventDefault(),i.setStart(r,s.length-1),i.collapse(!0),t.range.select(i),!1}}}return!0}},Oc=class{constructor(e){this.engine=e}trigger(e){const{change:t,inline:r,node:i}=this.engine,s=t.range.get().cloneRange().shrinkToTextNode(),{startNode:o,startOffset:a}=s;if(!this.engine.card.getSingleCard(s)&&o.type===Node.TEXT_NODE){const l=r.closest(o);if(i.isInline(l)){if(l.isCard())return;if(a>1)return!0;let n=o.prev(),r=o.parent();if(r&&i.isInline(r)){if(n)return!0;const e=o.text().substr(0,a);if(!/^\u200b$/.test(e))return!0}else{if(0!==a)return!0;for(;!n&&r&&!i.isInline(r);)n=r.prev(),r=r?.parent();if(n&&!n.isText())return!0;if(n&&!/^\u200b$/.test(n.text()))return!0}const c=l.prev(),d=c?.text();if(c&&c.isText()&&d&&/\u200b$/.test(d)){e.preventDefault();const{collapsed:n}=s.cloneRange();return s.setStart(c,d.length-1),n&&s.collapse(!0),t.range.select(s),!1}return!0}{let r,l=o.prev(),c=o.parent();if(l){if(i.isInline(l)&&!l.isCard()){const e=o.text().substr(0,a);if(!/^\u200b$/.test(e))return!0;r=l}}else{if(0!==a)return!0;for(;!l&&c&&!i.isBlock(c);)l=c.prev(),c=c?.parent();if(l&&!l.isText())return!0;if(l){if(!/^\u200b$/.test(l.text()))return!0;if(l=l.prev(),!l||!i.isInline(l))return!0;r=l}}if(r){e.preventDefault();const i=r.last(),o=i?.text();if(i&&i.isText()&&o&&/\u200b$/.test(o)){const{collapsed:r}=s.cloneRange();return s.setStart(i,o.length-1),r&&!n("shift+left",e)&&s.collapse(!0),t.range.select(s),!1}}}}return!0}},Sc=class{constructor(e){this.engine=e}trigger(e){const{change:t,inline:r,node:i}=this.engine,s=t.range.get().cloneRange().shrinkToTextNode(),{endNode:o,endOffset:a}=s;if(!this.engine.card.getSingleCard(s)&&o.type===Node.TEXT_NODE){const l=r.closest(o),c=o.text();if(i.isInline(l)){if(l.isCard())return;if(a<c.length-1)return!0;let n=o.next(),r=o.parent();if(r&&i.isInline(r)){if(n)return!0;const e=c.substr(a);if(!/^\u200b$/.test(e))return!0}else{if(a!==c.length&&a!==c.length-1)return!0;for(;!n&&r&&!i.isInline(r);)n=r.next(),r=r?.parent();if(n&&!n.isText())return!0;if(n){if(!/^\u200b$/.test(n.text()))return!0;if(a===c.length-1){e.preventDefault();const{collapsed:r}=s.cloneRange();return s.setEnd(n,0),r&&s.collapse(!1),t.range.select(s),!1}}}const d=l.next(),h=d?.text();if(d&&d.isText()&&h&&/^\u200b/.test(h)){e.preventDefault();const{collapsed:n}=s.cloneRange();return s.setEnd(d,1),n&&s.collapse(!1),t.range.select(s),!1}return!0}{let r,l=o.next(),d=o.parent();if(l){if(i.isInline(l)&&!l.isCard()){const e=c.substr(a);if(!/^\u200b$/.test(e))return!0;r=l}}else{if(a!==c.length)return!0;for(;!l&&d&&!i.isBlock(d);)l=d.next(),d=d?.parent();if(l&&!l.isText())return!0;if(l){if(!/^\u200b$/.test(l.text()))return!0;if(l=l.next(),!l||!i.isInline(l))return!0;r=l}}if(r){e.preventDefault();const i=r.first(),o=i?.text();if(i&&i.isText()&&o&&/^\u200b/.test(o)){const{collapsed:r}=s.cloneRange();return s.setEnd(i,1),r&&!n("shift+right",e)&&s.collapse(!1),t.range.select(s),!1}}}}return!0}};class Ac{constructor(e){this.editor=e}init(){const e=this.editor;if(Es(e)){const{typing:t,event:n}=e,r=new Tc(e);t.getHandleListener("backspace","keydown")?.on(e=>r.trigger(e));const i=new Oc(e);t.getHandleListener("left","keydown")?.on(e=>i.trigger(e));const s=new Sc(e);t.getHandleListener("right","keydown")?.on(e=>s.trigger(e))}}repairRange(e){const{change:t,node:n}=this.editor;e=e||t.range.get();const{startNode:r,startOffset:i,endNode:s,endOffset:o,collapsed:a}=e;if(a)return e;const l=this.closest(r);if(l&&n.isInline(l)&&i<=1){let t=!0,n=r;for(;n&&!n.equal(l);){if(n.prev()){t=!1;break}n=n.parent()}if(t){const t=l.prev(),n=t?.text()||"";t&&t.isText()&&/\u200B$/g.test(n)&&e.setStart(t,n.length-1)}}const c=this.closest(s),d=c.last();if(c&&n.isInline(c)&&d&&s.equal(d)&&o>=d.text().length-1){let t=!0,n=r;for(;n&&!n.equal(c);){if(n.next()){t=!1;break}n=n.parent()}if(t){const t=c.next(),n=t?.text()||"";t&&t.isText()&&/^\u200B/g.test(n)&&e.setEnd(t,1)}}return e}closest(e){const t=this.editor.node;let n=e.parent();for(;n&&!n.isEditable()&&!t.isBlock(n);){if(t.isInline(n))return n;const e=n.parent();if(!e)break;n=e}return e}closestNotInline(e){const t=this.editor.node;for(;(t.isInline(e)||t.isMark(e)||e.isText())&&!e.isEditable();){const t=e.parent();if(!t)break;e=t}return e}wrap(e,t){const n=this.editor;if(!Es(n))return;const{change:r,mark:i,node:s}=n,o=t||r.range.toTrusty(),a=ii(o.startContainer);if(("string"==typeof e||Mi(e))&&(e=Ss(e,a)),!s.isInline(e))return;if(o.collapsed)return this.insert(e,o),void(t||r.apply(o));i.split(o),this.split(o);let{commonAncestorNode:l}=o;if(l.type===Node.TEXT_NODE||s.isMark(l))for(l=l.parent();s.isMark(l);)l=l.parent();const c=o.enlargeToElementNode().createSelection();if(!c.has())return void(t||r.apply(o));let d=!1,h=s.clone(e,!1);const u=[];l.traverse(e=>{if(e.equal(c.anchor))d=!0;else if(d){if(e.equal(c.focus))return d=!1,!1;if(s.isInline(e))if(e.isCard())u.push(e);else{const t=e.children();s.unwrap(e),e=t}if(s.isMark(e)&&!e.isCard()||e.isText())return s.isEmpty(e)?(e.remove(),!0):(h.parent()||e.before(h),h.append(e),this.repairCursor(h),u.push(h),!0);0!==h[0].childNodes.length&&h.parent()&&(h=s.clone(h,!1,!1))}});const{anchor:f,focus:g}=c,p=f?.parent();if(p&&s.isRootBlock(p)&&!f.prev()&&!f.next()&&f.after("<br />"),!f.equal(g)){const e=g?.parent();e&&s.isRootBlock(e)&&!g.prev()&&!g.next()&&g.before("<br />")}if(c.move(),u.length>0){const e=u[0];if(!e.isCard()){const t=e.first();o.setStart(t,1)}const t=u[u.length-1];if(!t.isCard()){const e=t.last();o.setEnd(e,e.text().length-1)}}t||r.apply(o)}unwrap(e){const t=this.editor;if(!Es(t))return;const{change:n,mark:r}=t,i=e&&bc(e)?e:n.range.toTrusty();this.repairRange(i),r.split(i);const s=e&&!bc(e)?[e]:this.findInlines(i),o=i.createSelection();s.forEach(e=>{let n=e.prev();n&&n.isCursor()&&(n=n.prev());let r=e.next();r&&r.isCursor()&&(r=r.prev());let i=e.first();i&&i.isCursor()&&(i=i.next());const s=n?.text()||"",o=r?.text()||"",a=i?.text()||"";n&&n.isText()&&/\u200B$/g.test(s)&&(/^\u200B$/g.test(s)?n.remove():n.text(s.substr(0,s.length-1))),r&&r.isText()&&/^\u200B/g.test(o)&&(/^\u200B$/g.test(o)?r.remove():r.text(o.substr(1))),i&&i.isText()&&/^\u200B/g.test(a)&&(/^\u200B$/g.test(a)||i.get().splitText(1),i.remove());let l=e.last();l&&l.isCursor()&&(l=l.prev());const c=l?.text()||"";l&&l.isText()&&/\u200B$/g.test(c)&&(/^\u200B$/g.test(c)?l.remove():l.get().splitText(c.length-1).remove()),t.node.unwrap(e)}),o.move(),r.merge(i),e||n.apply(i)}insert(e,t){const n=this.editor;if(!Es(n))return;const{change:r,node:i,mark:s}=n,o=t||r.range.toTrusty(),a=ii(o.startContainer);if(("string"==typeof e||Mi(e))&&(e=Ss(e,a)),!i.isInline(e))return;o.collapsed||r.delete(o),s.split(o),this.split(o),i.insert(e,o)?.select(e).collapse(!1),"br"!==e.name&&o.handleBr();const l=0!==e.get()?.childNodes.length;if(this.repairCursor(e),!e.isCard()&&!i.isVoid(e))if(l){const t=e.next();o.setStart(t,1),o.setEnd(t,1)}else{const t=e.last(),n=t.text();o.setStart(t,n.length-1),o.setEnd(t,n.length-1)}t||r.apply(o)}unwrapEmptyInlines(e,t){const{node:n}=this.editor;e.allChildren().forEach(e=>{n.isEmpty(e)&&n.isInline(e)&&(!t||t(e))&&n.unwrap(e)})}splitOnCollapsed(e,t){if(!e.collapsed)return;e.enlargeFromTextNode(),e.shrinkToElementNode();const{startNode:n}=e,r=n.parent(),{node:i}=this.editor,s=n.isCard()?n:n.closest(mi);if((0===s.length||"inline"!==s.attributes(hi))&&(i.isInline(n)||r&&i.isInline(r))){const r=this.closestNotInline(n),s=e.createSelection(),o=s.getNode(r,"left");let a,l,c=[];if(t){Mi(t)&&(t=Ss(t));const e=t.getPath(r.get()),n=r.clone(!0);c=e.slice(1),l=Ss(n.getChildByPath(e.slice(0,1))),a=s.getNode(n,"right",!1)}else a=s.getNode(r,"right");this.unwrapEmptyInlines(o),this.unwrapEmptyInlines(a);const d=r.children();let h;d.each((e,t)=>{d.eq(t)?.isCard()||d.eq(t)?.remove()});const u=e=>{e.each((t,n)=>{const i=e.eq(n);if(i?.isCard())return h=h?h.next():r.first(),void(h&&(e[n]=h[0]));h?(h.after(t),h=i):(h=i,r.prepend(t))})},f=o.children(),g=f.toArray();u(f);const p=a.children();let m=p.toArray();if(l&&(t=m.find(e=>e.equal(l))?.getChildByPath(c)),u(p),m=p.toArray(),1===g.length&&"br"===g[0].name&&(g[0].remove(),g.splice(0,1)),1===m.length&&"br"===m[0].name&&(m[0].remove(),m.splice(0,1)),m.filter(e=>!e.isCursor()).length>0){let t=m[0];for(let e=0;e<m.length-1&&(t=m[e],t.isCursor());e++);e.setStartBefore(t),e.collapse(!0)}else if(g.filter(e=>!e.isCursor()).length>0){let t=g[g.length-1];for(let e=g.length-1;e>=0&&(t=g[e],t.isCursor());e--);e.setStartAfter(t),e.collapse(!0)}else e.select(r,!0).collapse(!0);r.traverse(e=>{i.isInline(e)&&this.repairCursor(e)})}return e.enlargeToElementNode(!i.isBlock(e.startNode),!1),t}splitOnExpanded(e){if(e.collapsed)return;e.enlargeToElementNode(),e.shrinkToElementNode();const{startNode:t,endNode:n}=e,r=t.isCard()?t:t.closest(mi),i=n.isCard()?n:n.closest(mi);if(!(r.length>0&&"inline"===r.attributes(hi)||i.length>0&&"inline"===i.attributes(hi))){const r=this.closestNotInline(t),i=this.closestNotInline(n);if(!r.equal(i)){const t=e.cloneRange();t.collapse(!0);const n=e.cloneRange();let s;n.collapse(!1);const o=t.startOffset,a=n.endOffset;return void(r.contains(i)?(s=this.splitOnCollapsed(t,n.endNode),e.setStart(t.startContainer,t.startOffset),s&&n.setOffset(s,a,a),this.splitOnCollapsed(n),e.setEnd(n.startContainer,n.startOffset)):(s=this.splitOnCollapsed(n,t.startNode),e.setEnd(n.startContainer,n.startOffset),s&&t.setOffset(s,o,o),this.splitOnCollapsed(t),e.setStart(t.startContainer,t.startOffset)))}const{node:s}=this.editor,o=t.parent(),a=s.isInline(t)||o&&s.isInline(o),l=n.parent(),c=s.isInline(n)||l&&s.isInline(l);if(!a&&!c)return;let{commonAncestorNode:d}=e;d.isText()&&(d=d.parent());const h=this.closestNotInline(d),u=e.createSelection(),f=u.getNode(h,"left"),g=u.getNode(h),p=u.getNode(h,"right");this.unwrapEmptyInlines(f),this.unwrapEmptyInlines(p);const m=h.children();let b;m.each((e,t)=>{m.eq(t)?.isCard()||m.eq(t)?.remove()});const v=e=>{e.each((t,n)=>{if(e.eq(n)?.isCard())return b=b?b.next():h.first(),void(b&&(e[n]=b[0]));b?(b.after(t),b=e.eq(n)):(b=e.eq(n),h.prepend(t))})};v(f.children());const y=g.children(),w=y.toArray();v(y),v(p.children()),h.traverse(e=>{s.isInline(e)&&this.repairCursor(e)}),e.setStartBefore(w[0][0]),e.setEndAfter(w[w.length-1][0])}}split(e){const t=this.editor;if(!Es(t))return;const{change:n}=t,r=e||n.range.toTrusty();r.collapsed?this.splitOnCollapsed(r):this.splitOnExpanded(r),e||n.apply(r)}findInlines(e){const t=this.editor,n=e.cloneRange();if(n.startNode.isRoot()&&n.shrinkToElementNode(),!n.startNode.inEditor()||t.card.find(n.startNode))return[];const r=t.node,i=(e,t,n=!1)=>{if(!t.collapsed)return;const{startNode:i,startOffset:s}=t,o=i.findParent();if(!o)return;const a=t.cloneRange();if(a.select(o,!0),n){a.setEnd(i,s),a.enlargeFromTextNode(),a.enlargeToElementNode(!0);const n=i.children(),{endNode:l,endOffset:c}=a,d=l.children().eq(c),h=n.eq(s)||n.eq(s-1);if(!e&&l.type===Node.ELEMENT_NODE&&d&&r.isBlock(d)&&(i.type!==Node.ELEMENT_NODE||h&&!r.isBlock(h)))return;a.select(o,!0),a.setStart(l,c),a.shrinkToElementNode(),a.shrinkToTextNode(),t.setStart(a.startContainer,a.startOffset),t.collapse(!0)}else{a.setStart(i,s),a.enlargeFromTextNode(),a.enlargeToElementNode(!0);const n=i.children(),l=a.startNode,c=a.startOffset,d=l.children().eq(c),h=n.eq(s)||n.eq(s-1);if(!e&&l.type===Node.ELEMENT_NODE&&d&&r.isBlock(d)&&(i.type!==Node.ELEMENT_NODE||h&&!r.isBlock(h)))return;a.select(o,!0),a.setEnd(l,c),a.shrinkToElementNode(),a.shrinkToTextNode(),t.setEnd(a.endContainer,a.endOffset),t.collapse(!1)}};if(!n.collapsed){const e=n.cloneRange(),t=n.cloneRange();e.collapse(!0),t.collapse(!1),i(!0,e,!0),i(!0,t),n.setStart(e.startContainer,e.startOffset),n.setEnd(t.startContainer,t.startOffset)}i(!1,n);const s=n.startContainer,o=n.startOffset,a=n.endContainer,l=n.endOffset;let c=s,d=a;s.nodeType===Node.ELEMENT_NODE&&s.childNodes[o]&&(c=s.childNodes[o]||s),a.nodeType===Node.ELEMENT_NODE&&l>0&&a.childNodes[l-1]&&(d=a.childNodes[l-1]||s),n.collapsed&&(c=d);const h=(e,t)=>{e.some(e=>e[0]===t[0])||e.push(t)},u=e=>{const t=[];for(;e&&!e.isEditable();){r.isInline(e)&&t.push(e);const n=e.parent();if(!n)break;e=n}return t},f=u(Ss(c)),{commonAncestorNode:g}=n,p=t.card.find(g,!0);let m=p?.isEditable;const b=m?p?.getSelectionNodes?p.getSelectionNodes():[]:[g];if(0===b.length&&(m=!1,b.push(g)),(!n.collapsed||m)&&(u(Ss(d)).forEach(e=>h(f,e)),s!==a||m)){let e=!1,t=!1;b.forEach(n=>{n.traverse(n=>{if(t)return!1;if(n.equal(s))e=!0;else if(e){if(n.equal(a))return t=!0,!1;!r.isInline(n)||n.attributes(ci)||n.attributes(fi)||h(f,n)}})})}return f}repairCursor(e){const t=this.editor.node;if(Mi(e)&&(e=Ss(e)),!t.isInline(e)||"false"===e.closest(mi).attributes(pi)||t.isVoid(e)||e.isCard()){const n=e.prev(),r=n?.isText()?n.text():void 0;if(r&&/\u200b$/.test(r)){const e=n?.prev();e&&t.isInline(e)||(1===r.length?n?.remove():n?.text(r.slice(0,-1)))}const i=e.next(),s=i?.isText()?i.text():void 0;if(s&&/^\u200b/.test(s)){const e=i?.next();e&&t.isInline(e)||(1===s.length?i?.remove():i?.text(s.slice(1)))}return}const n=e.children();n.each((e,t)=>{const r=n.eq(t);if(r?.isText()){const e=r.text();if(1===e.length&&/\u200b/.test(e))return void r.remove();r.text(e.replace(/\u200b/g,""))}}),this.repairBoth(e);let r=e.first();r?.isCursor()&&(r=r.next()),r&&r.type===Node.TEXT_NODE&&/^\u200B/g.test(r.text())||(r?r.isText()?r.text("​"+r.text()):r.before(Ss("​",null)):e.append(Ss("​",null)));let i=e.last();i?.isCursor()&&(i=i.prev()),!i||!/^\u200B$/g.test(e.text())&&i.type===Node.TEXT_NODE&&/\u200B$/g.test(i.text())||(i.isText()?i.text(i.text()+"​"):i.after(Ss("​",null)))}repairBoth(e){const t=this.editor.node;Mi(e)&&(e=Ss(e));const n=e.get();if((n?.parentElement??n?.parentNode)&&!t.isVoid(e)){const n=Ss("​",null),r=e.prev(),i=r?.prev(),s=r?.text()||"";!r||!r.isText()||!/\u200B$/g.test(s)||i&&t.isInline(i)&&!/\u200B.*\u200B$/g.test(s)?r&&r.isText()?r.text(s+"​"):e.before(t.clone(n,!0,!1)):r&&r.isText()&&/\u200B\u200B$/g.test(s)&&i&&!t.isInline(i)&&r.text(s.substr(0,s.length-1));const o=e.next(),a=o?.text()||"",l=o?.next();!o||!o.isText()||!/^\u200B/g.test(a)||l&&t.isInline(l)&&!/^\u200B\u200B/g.test(a)?o&&o.isText()?o.text("​"+o.text()):(e.after(t.clone(n,!0,!1)),"br"===o?.name&&o.remove()):o&&o.isText()&&/\u200B\u200B$/g.test(a)&&l&&!t.isInline(l)&&o.text(a.substr(0,a.length-1))}}flat(e,t){const n=this.editor;if(bc(e)){const t=e.cloneRange().shrinkToElementNode().createSelection(),r=this.findInlines(e),i=[];r.forEach(e=>{if(e.isCard())return;const t=this.flat(e);t&&i.push(t)}),t.move();const s=n.node;return void i.forEach(e=>{const t=e.prev()?.prev(),n=e.next()?.next();t&&s.isMark(t)&&0===t.get().childNodes.length&&t.remove(),n&&s.isMark(n)&&0===n.get().childNodes.length&&n.remove()})}if(e.isCard())return;const r=n.node,i=n.mark;if(r.isInline(e,t)&&"br"!==e.name){const n=this.closest(e);if(n.equal(e)||!r.isInline(n,t)){let n=i.closest(e),s=e;for(;n&&!n.equal(e)&&r.isMark(n,t);){const t=n.clone(),o=e.clone();n.children().each(e=>{if(3===e.nodeType&&/^\u200b$/.test(e.textContent||""))return;const n=Ss(e);s.equal(n)||n.contains(s)?(s=r.wrap(r.replace(s,t),o),this.repairBoth(s)):r.wrap(n,t)}),r.unwrap(n),n=i.closest(s)}return s}r.unwrap(e)}}}let Mc=class{constructor(e){this.engine=e}trigger(e){const{change:t,node:n}=this.engine,r=t.range.get().shrinkToElementNode().shrinkToTextNode(),i=this.engine.block;let s=i.closest(r.endNode);const o=s.parent();if(o&&o.inEditor()&&n.isBlock(o)){if("li"===o.name&&"p"===s.name){1===s.get()?.childNodes.length&&"br"===s.first()?.name&&s.first().remove();const e=r.createSelection();t.unwrap(s),e.move(),s=i.closest(r.endNode)}if(r.collapsed&&(1===r.startContainer.childNodes.length&&"BR"===r.startContainer.firstChild?.nodeName||i.isLastOffset(r,"end")&&i.isFirstOffset(r,"end")))return e.preventDefault(),["li"].indexOf(o.name)>=0?(i.unwrap("<".concat(o.name," />")),i.setBlocks("<".concat(o.name," />"))):(i.unwrap("<".concat(o.name," />")),i.setBlocks("<p />")),!1}return!n.isBlock(s)||o&&n.isList(o)||s.isCard()?"li"!==s.name||void 0:(e.preventDefault(),i.insertOrSplit(r,s),!1)}},_c=class{constructor(e){this.engine=e}trigger(e){const{change:t,node:n,block:r,card:i}=this.engine,s=t.range.get();if(!s.collapsed)return;const o=s.getPrevNode();if(o&&n.isBlock(o)&&n.isEmptyWithTrim(o)){e.preventDefault();const n=o.parent();return o.remove(),n&&this.engine.node.isEmpty(n)&&(n.isEditable()?(this.engine.node.html(n,"<p><br /></p>"),s.select(n,!0).shrinkToElementNode().collapse(!1)):(this.engine.node.html(n,"<br />"),s.select(n,!0).collapse(!1)),t.apply(s)),!1}const a=!!i.closest(s.startNode);if(!a&&!r.isFirstOffset(s,"start")){const r=s.cloneRange().shrinkToElementNode().shrinkToTextNode();return void(r.startContainer.nodeType===Node.TEXT_NODE&&function(e){const{commonAncestorContainer:r,commonAncestorNode:i}=e,s=i.parent(),o=s?.attributes();if(e.collapsed&&1===e.startOffset&&e.startContainer===r&&r.nodeType===Node.TEXT_NODE&&(!o||!["left","right"].includes(o[fi]))&&(e=e.cloneRange(),((r.parentElement??r.parentNode)?.childNodes?.length||0)<=1&&1===r.textContent?.length)){const{startNode:i,startOffset:s}=e,o=i.parent();if(o&&n.isMark(o)&&s>0){const t=i.text().substring(s-1,1);if(/^\u200b$/.test(t))if(1===s){const t=o.prev();if(t&&!n.isEmpty(t)){const{startNode:n,startOffset:r}=e.cloneRange().select(t,!0).shrinkToTextNode().collapse(!1);e.setStart(n,r-1)}}else e.setStart(i,s-1)}return e.collapsed&&e.select(r,!0),t.delete(e,!0),t.apply(e),!0}return!1}(r)&&(e.preventDefault(),e.isDelete=!0,t.change()))}const l=r.closest(s.startNode);return!(!a&&n.isRootBlock(l))||(e.preventDefault(),n.isEmpty(l)&&l.html("<br />"),t.mergeAfterDelete(l),t.change(!1),!1)}};class Bc{constructor(e){this.pluginCaches=new Map,this.editor=e}init(){const e=this.editor;if(Es(e)){const{typing:t,event:n}=e,r=new Mc(e);t.getHandleListener("enter","keydown")?.on(e=>r.trigger(e));const i=new _c(e);t.getHandleListener("backspace","keydown")?.on(e=>i.trigger(e)),n.on("keyup:space",e=>this.triggerMarkdown(e)),n.on("keydown:enter",e=>this.triggerMarkdown(e))}}triggerMarkdown(e){const t=this.editor;if(!Es(t)||!1===t.options.markdown?.mode)return;const{change:n}=t,r=n.range.get();if(!r.collapsed||n.isComposing())return;const{startNode:i,startOffset:s}=r,o=i.type===Node.TEXT_NODE?i:i.children().eq(s-1);if(!o)return;const a=this.closest(o);if(!t.node.isRootBlock(a))return;const l=o.text().trim();if(""===l.replace(/\s|\t|\n|\r\n|\u200b/g,""))return;const c=r.toPath(),d=ks(t,"zero"),h=d.parse(l,{});if(0===h.length)return;const u=Ts(t,d,h,!1);if(u){const t=a.children();e.preventDefault(),r.select(a,!0),n.paste(u,r);const i=this.closest(r.startNode);return i.isRoot()||i.isCard()||t.each((e,t)=>{t>0&&i.append(e)}),n.rangePathBeforeCommand=c,n.range.select(r),!1}return!0}findPlugin(e){const{node:t,schema:n,plugin:r}=this.editor;if(0===e.length||!t.isBlock(e))return;const i=e.get().cloneNode().outerHTML,s=this.pluginCaches.get(i);if(s)return s;for(const t in r.components){const s=r.components[t];if(Ws(s)&&(s.tagName&&"string"!=typeof s.tagName?s.tagName.indexOf(e.name)>-1:e.name===s.tagName)){const t=s.schema();if(Array.isArray(t)?t.find(t=>n.checkNode(e,t.attributes)):n.checkNode(e,t.attributes))return this.pluginCaches.set(i,s),s}}return s}findTop(e,t){const{schema:n,node:r,list:i}=this.editor,s=n.closest(e.name),o=n.closest(t.name);if(s===parent.name||o===t.name)return t;if(n.isAllowIn(e.name,t.name))return e;if(r.isList(e)&&r.isList(t)){const n=parseInt(t.attributes(i.INDENT_KEY),10)||0,r=parseInt(e.attributes(i.INDENT_KEY),10)||0;t.attributes(i.INDENT_KEY,r?r+1:n+1)}return t}closest(e,t=()=>!0){const n=e;for(;e;){if((e.isEditable()||this.editor.node.isBlock(e))&&t(e))return e;const n=e.parent();if(!n)break;e=n}return n}wrap(e,t){const n=this.editor;if(!Es(n))return;const{change:r,node:i,schema:s,list:o,mark:a}=n,l=t||r.range.toTrusty(),c=ii(l.startContainer);if(("string"==typeof e||Mi(e))&&(e=Ss(e,c)),!i.isBlock(e))return;let d=this.getBlocks(l);const h=this.findPlugin(e);if(d=d.map(t=>{if(!t||t.isCard())return null;const n=e;let r=t?.parent();for(;r&&!r.isEditable();){t=r;const e=r.parent();if(!e||!i.isBlock(e))break;r=e}return s.isAllowIn(n.name,t.name)?t:this.findPlugin(t)===h?t.children():null}).filter(e=>null!==e),0===d.length){const t=this.closest(l.startNode);if(t.isCard()||t.isEditable()||!s.isAllowIn(e.name,t.name))return;const n=l.createSelection();return t.children().each(t=>{e.append(t)}),t.append(e),void n.move()}const u=l.createSelection();d[0]?.before(e),d.forEach(t=>{t&&(h&&t.allChildren().forEach(e=>{if(i.isMark(e)){const t=a.findPlugin(e);if(!t)return;h.disableMark?.indexOf(t.constructor.pluginName)&&i.unwrap(e)}}),e.append(t))}),u.move(),this.merge(l),o.merge(void 0,l),t||r.apply(l)}unwrap(e,t){const n=this.editor;if(!Es(n))return;const{change:r,node:i}=n,s=t||r.range.toTrusty(),o=ii(s.startContainer);if(("string"==typeof e||Mi(e))&&(e=Ss(e,o)),!i.isBlock(e))return;const a=this.getSiblings(s,e);if(0===a.length)return;const l=a[0].node.parent();if(!l?.inEditor())return;const c=a.some(e=>"left"===e.position),d=a.some(e=>"right"===e.position);let h,u;if(c){const e=l;h=i.clone(e,!1,!1),e.before(h)}if(d){const e=a[a.length-1].node.parent();e&&(u=i.clone(e,!1,!1),e?.after(u))}const f=s.createSelection(),g=i;a.forEach(t=>{const n=t.position,r=t.node,i=r.parent();"left"===n&&h?.append(r),"center"===n&&i?.name===e?.name&&i?.inEditor()&&g.unwrap(i),"right"===n&&u?.append(r)}),h&&"ol"===h.name&&u&&"ol"===u.name&&u.attributes("start",(parseInt(h.attributes("start"),10)||1)+h.find("li").length),f.move(),t||r.apply(s)}getSiblings(e,t){const n=[],r=this.editor.node;if(!r.isBlock(t))return n;const i=(e,t)=>{let n=this.closest(e);for(;n;){const e=n.parent();if(!e)break;if(!n.inEditor())break;if(n.text().trim()!==e.text().trim())break;if(e.name===t)break;n=e}return n},s=i(e.startNode,t.name),o=i(e.endNode,t.name),a=s.parent();let l="left",c=a?.first();for(;c;){if(c=Ss(c),!r.isBlock(c))return n;if(!c.inEditor())return n;c[0]===s[0]&&(l="center"),n.push({position:l,node:c}),c[0]===o[0]&&(l="right"),c=c.next()}return n}split(e){const t=this.editor;if(!Es(t))return;const{change:n,mark:r,nodeId:i}=t,s=e||n.range.toTrusty();s.collapsed||n.delete(s);const o=this.closest(s.startNode);if(!o.isEditable()&&!o.inEditor())return;if(o.isEditable()){const t=s.getStartOffsetNode();return t&&s.select(t,!0).shrinkToElementNode().collapse(!1),void(e||n.apply(s))}const a=s.cloneRange();a.shrinkToElementNode().shrinkToTextNode().collapse(!0);const l=r.findMarks(a).filter(e=>{const n=t.mark.findPlugin(e);return!1!==n?.copyOnEnter&&!1!==n?.followStyle}),c=this.getBlockByRange({block:o[0],range:s,isLeft:!1,keepDataId:!0}),d=t.node;c.traverse(e=>{!d.isVoid(e)&&(d.isInline(e)||d.isMark(e))&&d.isEmpty(e)&&e.remove()},!0);const h=e=>d.isBlock(e)&&(0===e.childNodes.length||""===e.innerText);return h(o[0])&&!h(c[0])?i.generate(o,!0):i.generate(c,!0),o.after(c),d.isEmpty(o)&&d.html(o,d.getBatchAppendHTML(l,l.length>0?"&#8203;":"<br />")),d.isEmpty(c)&&d.html(c,d.getBatchAppendHTML(l,l.length>0?"&#8203;":"<br />")),o.children().each(e=>{d.isInline(e)&&t.inline.repairCursor(e)}),c.children().each(e=>{d.isInline(e)&&t.inline.repairCursor(e)}),s.select(c,!0).shrinkToElementNode(),1===c.get()?.childNodes.length&&"br"===c.first()?.name?s.collapse(!1):s.collapse(!0),e||n.apply(s),c}insert(e,t,n,r=!1){const i=this.editor;if(!Es(i))return;const{change:s,node:o,list:a,inline:l}=i,c=t||s.range.toTrusty(),d=ii(c.startContainer);if(("string"==typeof e||Mi(e))&&(e=Ss(e,d)),!o.isBlock(e))return;c.collapsed||s.delete(c);let h=this.closest(c.startNode);if(!h.isEditable()&&!h.inEditor())return void(t||s.apply(c));if(h.isEditable())return o.insert(e,c,r),c.collapse(!1),void(t||s.apply(c));if(o.isList(c.startNode)||c.startNode.closest("li").length>0){const n=d.createDocumentFragment();return n.appendChild(e[0]),a.insert(n,c),void(t||s.apply(c))}1===h.get()?.childNodes.length&&"br"===h.first()?.name&&c.select(h,!0).collapse(!1);const u=c.enlargeToElementNode().createSelection();if(!u.has())return void(t||s.apply(c));h=n?n(h):h;const f=u.getNode(h,"left");f.traverse(e=>{e.equal(f)||o.isBlock(e)&&(o.isEmpty(e)||a.isEmptyItem(e))&&e.remove()});let g=u.getNode(h,"right",!0,e=>{if(e.isCard()){const t=e.parent();if(t&&o.isCustomize(t))return!1}return!0});const p=h.children();if(o.isEmpty(h)||p.each((e,t)=>{const n=p.eq(t);n?.isCard()||p.eq(t)?.remove()}),g.traverse(e=>{e.equal(g)&&(o.isBlock(e)&&(o.isEmpty(e)||a.isEmptyItem(e))?e.remove():o.isList(e)&&a.addBr(e))}),g.length>0&&!o.isEmpty(g)&&!a.isEmptyItem(g)){const e=g.clone(!1);i.nodeId.generate(e,!0);const t=g.children();t.each((n,r)=>{if(t.eq(r)?.isCard()){const t=i.card.find(n);t&&e.append(t.root)}else e.append(n)}),g=e,h.after(e)}if(f.length>0&&!o.isEmpty(f)&&!a.isEmptyItem(f)){let e;(t=>{t.each((n,r)=>{const i=t.eq(r);if(i&&o.isInline(i)&&l.repairCursor(i),i?.isCard())return e=e?e.next():h.first(),void(e&&(t[r]=e[0]));e?(e.after(n),e=i):(e=i,h.prepend(n))})})(f.children())}h&&h.length>0&&(c.select(h,!0),c.collapse(!1)),u.focus&&u.focus.remove(),u.anchor&&u.anchor.remove(),o.insert(e,c,r),t||s.apply(c)}setBlocks(e,t){const n=this.editor;if(!Es(n))return;const{node:r,schema:i,mark:s}=n,{change:o}=n,a=t||o.range.toTrusty(),l=ii(a.startContainer);let c=null,d={};"string"==typeof e?(c=Ss(e,l),d=c.attributes(),d.style=c.css()):d=e;const h=this.getBlocks(a),{startNode:u}=a;if(u.isEditable()&&0===h.length){if(u.isCard()||u.isEditable())return;const e=c||Ss("<p></p>");if(!i.isAllowIn(e.name,u.name))return;r.setAttributes(e,d);const n=a.createSelection();u.children().each(t=>{e.append(t)});const s=i.data.globals.block||{},l=u.attributes();Object.keys(l).forEach(t=>{t!==Fr&&"id"!==t&&s.name&&e.attributes(t,l[t])});const h=s.style||{},f=u.css();return Object.keys(f).forEach(e=>{h[e]||delete f[e]}),e.css(f),u.append(e),n.move(),void(t||o.apply(a))}const f=c?this.findPlugin(c):void 0,g=a.createSelection();h.forEach(e=>{if(e.attributes(ci))return;if(c){const t=i.data.globals.block||{},n=e.attributes();Object.keys(n).forEach(e=>{e!==Fr&&"id"!==e&&t.name&&c?.attributes(e,n[e])});const r=t.style||{},s=e.css();Object.keys(s).forEach(e=>{r[e]||delete s[e]}),c.css(s)}if(!c||this.findPlugin(e)===f&&e.name===c.name)return c&&(d=c.attributes()),void r.setAttributes(e,d);if("p"!==c.name&&i.isAllowIn(e.name,c.name))return;f&&e.allChildren().forEach(e=>{if(r.isMark(e)){const t=s.findPlugin(e);if(!t)return;f.disableMark&&f.disableMark.indexOf(t.constructor.pluginName)>-1&&r.unwrap(e)}});const t=r.replace(e,c),n=t.parent();!n||n.isEditable()||i.isAllowIn(n.name,t.name)||r.unwrap(n)}),g.move(),t||o.apply(a)}merge(e){const t=this.editor;if(!Es(t))return;const{change:n,schema:r}=t,i=e||n.range.toTrusty(),s=this.getBlocks(i);if(0===s.length)return;const o=s[0].closest(Ur),a=r.getCanMergeTags();if(0===a.length)return;const l=o.find(a.join(","));if(l.length>0){const e=i.createSelection();let n=l.next();for(;n&&a.indexOf(n.name)>0;){const e=n.prev(),r=n.attributes(),i=e?.attributes();n.name===e?.name&&r.class===(i?i.class:void 0)&&Object.keys(r).join(",")===Object.keys(i||{}).join(",")&&t.node.merge(e,n),n=n.next()}e.move()}e||n.apply(i)}findBlocks(e){const t=this.editor;if((e=e.cloneRange()).startNode.isRoot()&&e.shrinkToElementNode(),!e.startNode.inEditor()||t.card.find(e.startNode)?.type===Yl.BLOCK)return[];const n=e.startContainer,r=e.startOffset,i=e.endContainer,s=e.endOffset;let o=n,a=i;n.nodeType===Node.ELEMENT_NODE&&n.childNodes[r]&&(o=n.childNodes[r]||n),i.nodeType===Node.ELEMENT_NODE&&s>0&&i.childNodes[s-1]&&(a=i.childNodes[s-1]||n),e.collapsed&&(o=a);const l=(e,t,n)=>{e.some(e=>e[0]===t[0])||(n?e.unshift(t):e.push(t))},c=e=>{const n=[];for(;e&&!e.isEditable();){t.node.isBlock(e)&&n.push(e);const r=e.parent();if(!r)break;e=r}return n},d=this.getBlocks(e);c(Ss(o)).forEach(e=>l(d,e,!0));const{commonAncestorNode:h}=e,u=t.card.find(h,!0);let f=u?.isEditable;const g=f&&u?.getSelectionNodes?u.getSelectionNodes():[];return 0===g.length&&(f=!1),e.collapsed&&!f||(c(Ss(a)).forEach(e=>l(d,e)),g.forEach(e=>{e.traverse(e=>{e.isElement()&&!e.isCard()&&t.node.isBlock(e)&&l(d,e)},!0,"editable")})),d}isFirstOffset(e,t){const{startNode:n,endNode:r,startOffset:i,endOffset:s}=e,o="start"===t?n:r,a="start"===t?i:s;e=e.cloneRange();const l=this.closest(o);e.select(l,!0),e.setEnd(o[0],a);const c=this.editor;c.node.isBlock(o)||e.enlargeToElementNode();const d=e.cloneContents();if(!d.firstChild)return!0;const{node:h}=c;if(1===d.childNodes.length&&"br"===Ss(d.firstChild).name)return!0;const u=Ss("<div />");return u.append(d),h.isEmpty(u)}isLastOffset(e,t){const{startNode:n,endNode:r,startOffset:i,endOffset:s}=e,o="start"===t?n:r,a="start"===t?i:s;e=e.cloneRange();const l=this.closest(o);e.select(l,!0),e.setStart(o,a);const{node:c}=this.editor;c.isBlock(o)||e.enlargeToElementNode();const d=e.cloneContents();if(!d.firstChild)return!0;const h=Ss("<div />");return h.append(d),h.find("br").length<=0&&c.isEmpty(h)}getBlocks(e){(e=e.cloneRange()).shrinkToElementNode(),e.shrinkToTextNode();const t=this.editor,{node:n}=t;let r=this.closest(e.startNode);e.startNode.isRoot()&&(r=Ss(e.getStartOffsetNode()));let i=this.closest(e.endNode);e.endNode.isRoot()&&(i=Ss(e.getEndOffsetNode()));const s=this.closest(e.commonAncestorNode),o=[];let a=!1;const{commonAncestorNode:l}=e,c=t.card.find(l,!0);let d=c?.isEditable;const h=d?c?.getSelectionNodes?c.getSelectionNodes():[]:[s];return 0===h.length&&(d=!1,h.push(s)),h.forEach(e=>{e.traverse(e=>{const n=Ss(e);if(n.equal(r)&&(a=!0),(a||d)&&t.node.isBlock(n)&&!n.isCard()&&n.inEditor()&&o.push(n),n.equal(i))return a=!1,!1},!0,"editable")}),o.length>1&&this.isFirstOffset(e,"end")&&!n.isEmpty(i)&&o.pop(),o}getBlockByRange({block:e,range:t,isLeft:n,clone:r=!1,keepDataId:i=!1}){Mi(e)&&(e=Ss(e));const s=this.editor,o=gc.create(s,e.document);n?(o.select(e,!0),o.setEnd(t.startContainer,t.startOffset)):(o.select(e,!0),o.setStart(t.endContainer,t.endOffset));const a=r?o.cloneContents():o.extractContents(),l=i?e.clone(!1):s.node.clone(e,!1,!1);return l.append(a),r&&l.find(mi).each(e=>{const t=Ss(e),n=t.attributes(ci);t.attributes(di,n),t.removeAttributes(ci)}),l}getLeftText(e,t){const n=this.editor;if(!Es(n))return"";t=t||n.change.range.get();return this.getBlockByRange({block:e,range:t,isLeft:!0,clone:!0}).text().replace(/\u200B/g,"")}removeLeftText(e,t){const n=this.editor;if(!Es(n))return;t=t||n.change.range.get(),Mi(e)&&(e=Ss(e)),t.createSelection();const r=e.find(Oi);let i=!1;e.traverse(e=>{const t=Ss(e);if(t.equal(r))return r.remove(),void(i=!0);i&&t.isText()&&t.remove()},!1)}flat(e,t){const n=this.editor;if(!Es(n))return;const{schema:r,node:i}=n,s=r.getCanMergeTags();let o=e.parent();const a=t.fragment?t[0].parentNode:t.get();for(;o&&a&&o.get()!==a&&o.inEditor();){if(e.isCard())o.before(e);else if(i.isList(o)&&"li"===e.name||s.indexOf(o.name)>-1&&i.isBlock(e)&&o.name!==e.name){const t=i.clone(o,!1,!1);t.append(e),e=t,o.before(e)}else e=i.replace(e,i.clone(this.findTop(o,e),!1,!1)),o.before(e);o.first()||o.remove(),o=e.parent()}}insertEmptyBlock(e,t){const n=this.editor;if(!Es(n))return;const{change:r}=n,{blocks:i,marks:s}=r,o=n.node;if(this.insert(t),i[0]){const e=i[0].css();t.css(e)}let a=t.find("br");s.forEach(e=>{const t=n.mark.findPlugin(e);e=o.clone(e,!1,!1),!1!==t?.copyOnEnter&&!1!==t?.followStyle&&(e=o.clone(e,!1,!1),a.before(e),e.append(a),a=e)}),a=t.find("br");const l=a.parent();l&&o.isMark(l)&&(a=o.replace(a,Ss("​",null))),e.select(a).shrinkToTextNode(),e.collapse(!1),e.scrollIntoView(),r.range.select(e)}insertOrSplit(e,t){const n=e.cloneRange();if(n.enlargeFromTextNode(),this.isLastOffset(e,"end")||n.endNode.type===Node.ELEMENT_NODE&&(t.get()?.childNodes.length||0)>0&&n.endContainer.childNodes[n.endOffset]===t.last()?.get()&&"br"===t.first()?.name){const n=Ss("<p><br /></p>");if("p"===t.name){const e=t.attributes();Object.keys(e).forEach(t=>{t!==Fr&&n.attributes(t,e[t])})}this.insertEmptyBlock(e,n)}else this.split()}}class Rc{get scrollNode(){if(this._scrollNode)return this._scrollNode;const{scrollNode:e}=this.options;let t=e?"function"==typeof e?e():e:null;const n=["auto","scroll"];let r=this.container.parent();for(;!t&&r&&r.length>0&&"body"!==r.name;){if(n.includes(r.css("overflow"))||n.includes(r.css("overflow-y"))){t=r.get();break}r=r.parent()}return null===t&&(t=document.documentElement),this._scrollNode=t?Ss(t):null,this._scrollNode}constructor(e,t){this.kind="editor",this.options={lang:"zh-CN",locale:{},plugins:[],cards:[],config:{},iconFonts:"url('//at.alicdn.com/t/font_1456030_lnqmc6a6ca.woff2?t=1638071536645') format('woff2'), url('//at.alicdn.com/t/font_1456030_lnqmc6a6ca.woff?t=1638071536645') format('woff'), url('//at.alicdn.com/t/font_1456030_lnqmc6a6ca.ttf?t=1638071536645') format('truetype')"},this._scrollNode=null,this.options={...this.options,...t};let{iconFonts:n}=this.options,r=document.querySelector("#am-iconfont");if(!r&&!1!==n){r=document.createElement("style"),r.setAttribute("type","text/css"),r.setAttribute("id","am-iconfont");let e='@font-face { font-family: "data-icon";';Array.isArray(n)&&(n=n.map(e=>`url('${e.url}') format('${e.format}')`).join(",")),e+=`src: ${n};}`,r.innerHTML=e,document.head.appendChild(r)}this.container=Ss(e),this.container.attributes(Hr,Xr),this.language=new Wr(this.options.lang||"zh-CN",qr(Vr,t?.locale)),this.event=new ri,this.command=new Zs(this),this.schema=new Hl,this.schema.add(Ms),this.conversion=new Ul(this),As.forEach(e=>this.conversion.add(e.from,e.to)),this.card=new sc(this,this.options.lazyRender),this.clipboard=new wc(this),this.plugin=new Ks(this),this.node=new Ps(this),this.nodeId=new oc(this.schema),this.list=new Ec(this),this.mark=new kc(this),this.inline=new Ac(this),this.block=new Bc(this),this.root=Ss(this.options.root||this.container.parent()||document.body);const i=this.root.css("position");i&&"static"!==i||this.root.css("position","relative")}init(){this.mark.init(),this.inline.init(),this.block.init(),this.list.init();const{plugins:e,cards:t,config:n}=this.options;this.card.init(t??[]);const r="function"==typeof n?n(this):n??{};this.plugin.init(e??[],r),this.nodeId.init()}setScrollNode(e){this._scrollNode=e?Ss(e):null}on(e,t,n){return this.event.on(e,t,n),this}off(e,t){return this.event.off(e,t),this}trigger(e,...t){return this.event.trigger(e,...t)}messageSuccess(e,t,...n){}messageError(e,t,...n){}messageConfirm(e,t,...n){return Promise.reject(new Error(""))}getSelectionData(e){if(e||(e=gc.from(this)??void 0),!e)return;let t=(e=e.cloneRange()).startNode.closest(`[${ci}]`,e=>Ss(e).isEditable()?void 0:(e.parentElement??e.parentNode)||void 0);if(t.length>0&&!e.collapsed&&0===e.endOffset&&(e.endContainer.previousSibling&&e.setEndAfter(e.endContainer.previousSibling),!e.collapsed&&e.endOffset>0&&e.endContainer.childNodes[e.endOffset-1]===t[0])){const n=e.startNode.closest(`[${fi}="center"]`,e=>Ss(e).isEditable()?void 0:(e.parentElement??e.parentNode)||void 0);n.length>0?e.setEnd(n[0],n[0].childNodes.length):e.setEnd(t[0],t[0].childNodes.length)}let n=e.commonAncestorNode;if(t=n.closest(`[${ci}]`,e=>Ss(e).isEditable()?void 0:(e.parentElement??e.parentNode)||void 0),t.length>0){const r=n.closest(`[${fi}="center"]`,e=>Ss(e).isEditable()?void 0:(e.parentElement??e.parentNode)||void 0);0===r.length&&(e.select(t),n=e.commonAncestorNode)}if(!n.inEditor()&&!n.isRoot())return;if(e.collapsed)return;const r=e=>{if(0===e.length)return{};for(let t=e.length-1;t>0;t--){e[t].appendChild(e[t-1])}return{inner:e[0],outter:e[e.length-1]}};if(t=n.closest(`[${ci}]`,e=>(e.parentElement??e.parentNode)||void 0),t.length>0){const e=this.card.find(t);if(e&&e.getSelectionNodes){const t=e.getSelectionNodes();if(t.length>0){const{inner:e,outter:n}=r(t.map(e=>e[0]));let i=t.map(e=>e.html()).join("");i=new yc(`<div>${i}</div>`,this).toHTML(e,n);return{html:i,text:new yc(i,this).toText(this.schema,!0)}}}else if(!e?.isEditable)return}const{node:i,list:s}=this;let o;const a=e.startNode.closest("li");if(a&&i.isCustomize(a)){const t=e.endNode.closest("li");if(!a.equal(t)||s.isLast(e)&&s.isFirst(e))if(s.isFirst(e)){const t=a.parent(),n=a.getIndex();t&&e.setStart(t,n<0?0:n)}else{const t=a.parent(),n=e.createSelection(),r=n.getNode(a,"center",!0);if(n.anchor?.remove(),n.focus?.remove(),Es(this)&&this.change.combinText(),r.length>0){let e=!1;r.each((t,n)=>{const i=r.eq(n);e||"li"!==i?.name?e&&i?.remove():e=!0});const n=a.first(),s=n?this.card.find(n):void 0;s&&(o=r,this.list.addCardToCustomize(o,s.name,s.getValue()),t&&i.wrap(o,t?.clone()))}}}const l=e.enlargeToElementNode(!0).cloneContents(),c=[];if(n.isText()&&1===l.childNodes.length&&l.firstChild?.nodeType===Node.TEXT_NODE){let e=n.parent();for(;e&&(i.isMark(e)||i.isInline(e));)c.push(e.clone(!1).get()),e=e.parent()}l.querySelectorAll("li").forEach(e=>{const t=Ss(e),n=t.attributes(Fr);if(!n)return;const r=this.container.get()?.querySelector(`[${Fr}=${n}]`);i.isCustomize(t)&&!t.first()?.isCard()&&r?.firstChild&&t.prepend(i.clone(Ss(r.firstChild),!0,!1));let s=r?.parentElement;s=s?Ss(s.cloneNode(!1)):null;const o=e.parentElement;!(r&&s&&i.isList(s))||o&&i.isList(o)||("ol"===s.name&&s.removeAttributes("start"),i.wrap(e,s))});const{inner:d,outter:h}=r(c),u=[];l.childNodes.forEach(e=>{const t=Ss(e);(i.isList(t)||"li"===t.name)&&u.push(t)}),this.nodeId.generateAll(Ss(l),!0),this.list.merge(u);const f=new yc(l,this).toHTML(d,h);return{html:f,text:new yc(f,this).toText(this.schema,!0)}}destroy(){this.container.removeAttributes(Hr),this.event.destroy(),this.plugin.destroy(),this.card.destroy(),this.container.empty()}}var Ic,Lc,Dc;Fs(".data-drop-cursor {\r\n    position: absolute;\r\n    width: 2px;\r\n    background-color: #347EFF;\r\n}\r\n\r\ndiv.data-drag-image {\r\n    background-color: #f9f9f9;\r\n}\r\n");class zc{constructor(e,t){this.x=0,this.y=0,this.doc=document,this.isCardLeftRange=!1,this.options={className:"data-drop-cursor"},this.engine=e,this.options={...this.options,...t}}getRangeForPoint(){const{doc:e,x:t,y:n}=this;if(void 0!==e.caretRangeFromPoint){const r=gc.create(this.engine,e,{x:t,y:n});if(r)return r}if(event&&void 0!==event.rangeParent){const t=gc.create(this.engine,e);return t.setStart(event.rangeParent,event.rangeOffset),t.collapse(!0),t}const r=e.getSelection();if(r&&r.rangeCount>0){const t=gc.create(this.engine,e);return t.select(r.anchorNode,Boolean(r.anchorOffset)),t.collapse(!0),t}}getCard(){return this.targetCard||this.caretCard}parseEvent(e){e.preventDefault(),e.stopPropagation(),e.dataTransfer&&(e.dataTransfer.dropEffect="move");const{card:t}=this.engine;this.x=e.clientX,this.y=e.clientY;const n=Ss(e.target||[]);this.doc=n.document||document,this.targetCard=t.find(n),this.caretRange=this.getRangeForPoint(),this.caretCard=this.caretRange?t.find(this.caretRange.commonAncestorContainer):void 0}getRange(){const{caretRange:e,doc:t,x:n}=this,r=this.getCard();let i;if(r&&r.root.length>0){i=gc.create(this.engine,t);const{left:e,right:s}=r.root.getBoundingClientRect()||{left:0,right:0},o=(e+s)/2;i.select(r.root.get()),o<n?(i.collapse(!1),this.isCardLeftRange=!1):(i.collapse(!0),this.isCardLeftRange=!0)}return this.range=i||e,this.range}getRect(e=2){const{isCardLeftRange:t,range:n}=this,r=this.getCard();if(r&&r.root.length>0&&n){if(t){n.setEnd(n.commonAncestorContainer,n.endOffset+1);const{left:t,bottom:r,top:i}=n.getBoundingClientRect();return n.setEnd(n.commonAncestorContainer,n.endOffset-1),{x:t-e,y:i,height:r-i}}n.setStart(n.commonAncestorContainer,n.startOffset-1);const{right:r,top:i,bottom:s}=n.getBoundingClientRect();return n.setStart(n.commonAncestorContainer,n.startOffset+1),{x:r-e,y:i,height:s-i}}let i=this.range?.getBoundingClientRect();if(0===i?.height){const e=this.range?.startContainer;i=e.getBoundingClientRect()}const{left:s,top:o,bottom:a}=i||{};return{x:s,y:o,height:(a||0)-(o||0)}}getCursor(){const{className:e}=this.options;return Ss(`body > div.${e}`)}removeCursor(){this.getCursor().remove()}setCursor(){this.removeCursor();const{className:e}=this.options,t=Ss(`<div class="${e}" />`);Ss(document.body).append(t)}}class Pc{constructor(e,t={}){this.events={},this.globalEvents={},this.keydownRange=null,this.engine=e,this.isComposing=!1,this.isSelecting=!1,this.dragoverHelper=new zc(e),this.options=t}isCardInput(e){let t=e.target?Ss(e.target):null;for(;t;){if(t.isEditable())return!1;if("center"===t.attributes(fi))return!0;if(t.attributes(Hr)===Yr)return!0;const e=t.parent();if(!e)break;t=e}return!1}onInput(e){const{bindInput:t}=this.options;if(t&&!t())return;let n=null;this.onContainer("compositionstart",e=>{if(this.engine.readonly)return;this.isCardInput(e)||this.engine.model.mutation.startCache();const{change:t,node:n,block:r,list:i}=this.engine,s=t.range.get().cloneRange().shrinkToTextNode().enlargeToElementNode();if(!s.collapsed){const e=r.closest(s.startNode),t=r.closest(s.endNode);!n.isCustomize(e)&&!n.isCustomize(t)||e.equal(t)||i.backspaceEvent?.trigger(new KeyboardEvent(""))}this.isComposing=!0});const r=t=>{if(!this.isComposing){if(Ji&&n){const e=n.first(),t=e?.next();if(t?.isText()){const e=t.text();if(/^\u200b/.test(e)){const e=t.get();e?.splitText(1),e?.remove()}}const r=this.engine.change.range.get(),{startNode:i,startOffset:s}=r;if(r.collapsed&&i?.isText()){const e=i.text(),t=e.substring(s);/^\u200b/.test(t)&&(i.text(e.substring(0,s)+t.substring(1)),r.setOffset(i,s,s),this.engine.change.range.select(r))}n=null}e(t),this.engine.model.mutation.submitCache()}};this.onContainer("compositionend",e=>{this.engine.readonly||(this.isComposing=!1,setTimeout(()=>{this.engine.model.mutation.isCache&&r(e)},40))}),this.onContainer("beforeinput",e=>{if(this.engine.readonly)return;const{change:t,card:r,node:i,block:s,list:o}=this.engine;if("@"===e.data&&!this.isCardInput(e)){!1===this.engine.trigger("keydown:at",e)&&(this.engine.model.mutation.submitCache(),e.preventDefault())}t.rangePathBeforeCommand||t.cacheRangeBeforeCommand();const a=t.range.get().cloneRange().shrinkToTextNode().enlargeToElementNode(),{startNode:l}=a;if(Ki&&"deleteCompositionText"===e.inputType&&"li"===l.name&&l.length>0&&!i.isCustomize(l)){const e=l[0].childNodes;1===e.length&&"BR"!==e[0].nodeName&&(l.prepend("<br />"),setTimeout(()=>{const e=l[0].childNodes;2===e.length&&"BR"===e[0].nodeName&&"BR"===e[1].nodeName&&e[0].remove()},0))}if(Ji&&"li"===l.name&&1===a.startOffset&&i.isCustomize(l)&&this.isComposing){const e=l.first(),r=e?.next(),i=()=>{const r=Ss("​",null);e?.after(r),a.setOffset(r,1,1),t.range.select(a),n=l};if(r?.isText()){const e=r.text();/^\u200b/.test(e)||i()}else"br"===r?.name&&r.remove(),i()}if(a.collapsed||("body"===a.commonAncestorNode.attributes(fi)?r.remove(a.commonAncestorNode):("body"===a.startNode.attributes(fi)&&r.remove(a.startNode),"body"===a.endNode.attributes(fi)&&r.remove(a.endNode))),a.startNode.isRoot()){const e=a.getStartOffsetNode();if(e instanceof Element&&Bi(e)&&!e.querySelector(yi)&&r.remove(e),!a.collapsed&&a.endNode.isRoot()){const e=a.getEndOffsetNode();e instanceof Element&&Bi(e)&&!e.querySelector(yi)&&r.remove(e)}}if(!a.collapsed&&!this.isComposing){const t=s.closest(a.startNode),n=s.closest(a.endNode);!i.isCustomize(t)&&!i.isCustomize(n)||t.equal(n)||(o.backspaceEvent?.trigger(new KeyboardEvent("")),i.insertText(e.data||""))}const{inputType:c}=e;!this.isComposing||c&&c.includes("Composition")||this.engine.model.mutation.submitCache();c&&["format","history"].forEach(t=>{if(0===c.indexOf(t)){e.preventDefault();const n=c.substring(t.length).toLowerCase();this.engine.command.queryEnabled(n)&&this.engine.command.execute(n)}})});let i=null;this.onContainer("input",e=>{if(this.engine.readonly)return;if(this.isCardInput(e))return;this.engine.isEmpty()?this.engine.showPlaceholder():this.engine.hidePlaceholder();const{change:t,card:n}=this.engine;if(e.target instanceof Element&&zi(e.target)&&n.active&&n.active.root.isBlockCard()&&!n.active.isEditable&&n.active.root.get()?.isContentEditable){const e=t.range.get(),r=Ss("<p><br /></p>");return n.active.root.before(r),n.remove(n.active.root),e.select(r,!0),void t.range.select(e)}i&&clearTimeout(i),i=setTimeout(()=>{r(e)},10)})}onSelect(e,t,r){const{bindSelect:i}=this.options;i&&!i()||(this.onContainer(Zi?"touchstart":"mousedown",e=>{this.isCardInput(e)||(this.isSelecting=!0,t&&t(e))}),this.onDocument(Zi?"touchend":"mouseup",t=>{this.isSelecting&&(this.isSelecting=!1,window.setTimeout(()=>{e(t),r&&r(t)},10))}),this.onContainer("keydown",()=>{this.keydownRange=gc.from(this.engine)}),this.onContainer("keyup",t=>{if(!this.engine.readonly&&!this.isCardInput(t)&&(n("left",t)||n("right",t)||n("up",t)||n("down",t)||"Meta"===t.key||n("shift+left",t)||n("shift+right",t)||n("shift+up",t)||n("shift+down",t)||n("ctrl+b",t)||n("ctrl+f",t)||n("ctrl+n",t)||n("ctrl+p",t)||n("ctrl+a",t)||n("ctrl+e",t)||n("home",t)||n("end",t))){const n=gc.from(this.engine);if(this.keydownRange&&n&&n.equal(this.keydownRange))return;this.isComposing||e(t)}}))}onPaste(e){const{bindPaste:t}=this.options;if(t&&!t())return;let r=!1;this.onContainer("keydown",e=>{this.engine.readonly||(n("mod",e)&&n("shift",e)&&n("v",e)||(r=!0),(n("mod+shift+v",e)||n("mod+alt+shift+v",e))&&(r=!0))}),this.onDocument("paste",t=>{const n=this.engine.change.range.get();if(!this.engine.container.contains(n.commonAncestorNode))return;if(this.engine.readonly)return;if(this.isCardInput(t))return;t.preventDefault();const i=this.engine.clipboard.getData(t),s=r;r=!1;const o={...i,isPasteText:s};e(o)})}onDrop(e){const{bindDrop:t}=this.options;if(t&&!t())return;let n,r,i;const s=e=>{if(!e.target||this.engine.readonly)return;e.stopPropagation(),this.dragoverHelper.setCursor();const t=Ss(e.target),i=t.attributes("drag-card-trigger");if(n=this.engine.card.find(i||t),n){if(n.toolbarModel?.hideCardToolbar(),r=n.find("img.data-drag-image"),r.length>0)r=this.engine.node.clone(r);else{r=Ss('<div class="data-drag-image" />');const e=n.root.get();e&&r.css({width:e.clientWidth+"px",height:e.clientHeight+"px"})}r.css({position:"absolute",top:"-99999px",right:"-99999px"}),Ss(document.body).append(r),e.dataTransfer?.setDragImage(r[0],0,0)}};this.onRoot("dragstart",s),this.onContainer("dragstart",s),this.onContainer("dragover",e=>{if(this.engine.readonly)return;const{dragoverHelper:t}=this,n=t.getCursor();if(0!==n.length){t.parseEvent(e),i=t.getRange();const r=t.getRect();n.css({height:r.height+"px",top:Math.round(window.scrollY+(r.y||0))+"px",left:Math.round(window.scrollX+(r.x||0))+"px"})}else this.dragoverHelper.setCursor()}),this.onContainer("dragleave",()=>{this.dragoverHelper.removeCursor()}),this.onContainer("dragend",()=>{this.dragoverHelper.removeCursor(),r&&(r.remove(),r=void 0)}),this.onContainer("drop",t=>{if(this.engine.readonly)return;t.preventDefault(),this.dragoverHelper.removeCursor(),r&&(r.remove(),r=void 0);const s=t.dataTransfer;let o=[];try{s&&s.items&&s.items.length>0?Array.from(s.items).forEach(e=>{if("file"===e.kind){const t=e.getAsFile();t&&o.push(t)}}):s&&s.files&&s.files.length>0&&(o=Array.from(s.files))}catch(e){s&&s.files&&s.files.length>0&&(o=Array.from(s.files))}e({event:t,range:i,card:n,files:o}),n=void 0})}onDocument(e,t,n){this.addEvent("document",e,t,n)}onWindow(e,t,n){this.addEvent("window",e,t,n)}onContainer(e,t,n){this.addEvent("container",e,t,n)}onRoot(e,t,n){this.addEvent("root",e,t,n)}addEvent(e,t,n,r){if(this.globalEvents[e]||(this.globalEvents[e]=[]),!this.globalEvents[e].find(e=>e.type===t)){const n=(...n)=>{const r=this.events[e].filter(e=>e.type===t);let i;for(let e=0;e<r.length&&(i=r[e].listener(...n),!1!==i);e++);return i};switch(e){case"container":this.engine.container.on(t,n);break;case"root":this.engine.root.on(t,n);break;case"document":document.addEventListener(t,n);break;case"window":window.addEventListener(t,n)}this.globalEvents[e].push({type:t,listener:n})}this.events[e]||(this.events[e]=[]),void 0!==r?this.events[e].splice(r,0,{type:t,listener:n}):this.events[e].push({type:t,listener:n})}destroy(){Object.keys(this.globalEvents).forEach(e=>{this.globalEvents[e].forEach(t=>{"window"===e?window.removeEventListener(t.type,t.listener):"document"===e?document.removeEventListener(t.type,t.listener):"container"===e?this.engine.container.off(t.type,t.listener):"root"===e&&this.engine.root.off(t.type,t.listener)})})}}function $c(e,t,n,r){if("a"===n&&!r)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!r:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===n?r:"a"===n?r.call(e):r?r.value:t.get(e)}function jc(e,t,n,r,i){if("m"===r)throw new TypeError("Private method is not writable");if("a"===r&&!i)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!i:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===r?i.call(e,n):i?i.value=n:t.set(e,n),n}"function"==typeof SuppressedError&&SuppressedError;class qc{constructor(e,t){this.source=e,this.engine=t,this.schema=this.engine.schema.clone()}parser(){const e=this.engine.conversion.clone();this.engine.trigger("paste:schema",this.schema);const t=new yc(this.source,this.engine,e=>{this.engine.trigger("paste:origin",e)});return t.toDOM(this.schema,e)}getDefaultStyle(e=this.engine.container){return{color:t(e.css("color")).toHex(),"background-color":t(e.css("background-color")).toHex(),"font-size":e.css("font-size")}}elementNormalize(e){const n=this.getDefaultStyle(),{inline:r,list:i}=this.engine,s=this.engine.node,o=this.engine.mark,a=this.engine.block,l=[];Ss(e).traverse(c=>{let d=c.parent();if(!d||c.isCard()||c.fragment===e)return;if(c.isText()){let e=c.text();if(/\u200b/.test(e)){let t=!0;const n=c.next(),r=c.prev(),i=c.parent();(i&&s.isMark(i,this.schema)||i&&s.isInline(i,this.schema)||n&&s.isInline(n,this.schema)||r&&s.isInline(r,this.schema))&&(t=!1),t&&(e=e.replace(/\u200b/g,""),c.text(e))}else{if(/^\n(\t)[0,]$/.test(e))return c.remove(),void(0===d.get()?.childNodes.length&&(d.after("<p><br /></p>"),d.remove()));if(/^\n$/.test(e)){if(s.isList(d))return void c.remove();const e=c.next();e&&s.isBlock(e)&&c.remove()}}if(s.isList(d)){const e=c.next(),t=c.prev(),n=(e,t)=>{if(s.isCustomize(e)){const n=e.first();if(n&&n.isCard()){const e=n.attributes(ci)||n.attributes(di);e&&i.addCardToCustomize(t,e)}}};let r=null;return"li"===e?.name?(r=e.clone(),n(e,r)):"li"===t?.name?(r=t.clone(),n(t,r)):r=Ss("<li></li>"),c.before(r),r.append(c),r}return}const h=c.css();for(const e in n){let r=h[e];r&&(e.endsWith("color")&&(r=t(r).toHex()),r.toLowerCase()===n[e].toLowerCase()&&c.css(e,""))}let u=this.schema.getType(c);if(!u){const e=c.first();return s.unwrap(c),e}s.removeMinusStyle(c,"text-indent"),s.isList(c)&&c.css("padding-left","");let f=c.attributes();for(f.style&&""===f.style.trim()&&c.removeAttributes("style");"span"===c.name&&s.isEmpty(c);){if(c.children().length>0)break;if(d=c.parent(),c.remove(),!d)return;if(d=(c=d).parent(),!d)return;u=void 0,f=void 0}if(f||(f=c.attributes()),f[di])return;const g=u?"block"===u:s.isBlock(c,this.schema),p=s.isVoid(c,this.schema);let m=s.isBlock(d,this.schema);if(g&&"p"!==f["data-type"]&&!p&&!m&&
//! node.isSolid() &&
""===s.html(c))return void c.remove();"p"===f["data-type"]&&c.removeAttributes("data-type"),g&&"p"===d?.name&&(s.unwrap(d),d=c.parent(),d?.fragment===e&&(d=void 0),m=!!d&&s.isBlock(d,this.schema));const b=!!d&&s.isList(d);if("li"===c.name&&d&&!b){const e=Ss("<ul />");return c.before(e),void e.append(c)}if(s.isList(c)&&d&&s.isList(d)){const e=[],t=[];let n=!0;const r=d.children().toArray();let s=d.clone();const o=()=>(s.get()?.childNodes.length??0)>0&&(n?e.push(s):t.push(s),s=d.clone(),!0);r.forEach((i,a)=>{if(i)return n&&i.equal(c)?(r.length-1===a?(o(),t.push(c)):(0===a||o(),e.push(c)),void(n=!1)):void("li"!==i.name?(o(),n?e.push(i):t.push(i)):s.append(i))}),o();const a=d.attributes(i.INDENT_KEY)||"0";c.attributes(i.INDENT_KEY,a),i.addIndent(c,1);let l=d;return e.forEach(e=>{const t=Ss(e);t&&0!==t.get()?.childNodes.length&&(l.after(t),l=t)}),t.forEach(e=>{const t=Ss(e);t&&0!==t.get()?.childNodes.length&&(l.after(t),l=t)}),d.remove(),c||void 0}if("li"!==c.name&&b){if("br"===c.name)return void c.remove();const e=Ss("<li />");return c.before(e),void e.append(c)}if(s.isList(c)&&"li"===d?.name){const e=d?.parent();if(!e)return void s.unwrap(d);const t=e.clone(),n=e.clone();let r=!0;e.children().toArray().forEach(e=>{e&&(r&&e.equal(d)?r=!1:r?t.append(e):n.append(e))});const o=d?.parent()?.hasClass("data-list"),a=d?.children();let l=null,c=null;a.each((e,n)=>{const r=a.eq(n);if(!r||s.isEmptyWithTrim(r)&&!s.isVoid(r))return;const d=s.isList(r),h=t[t.length-1];if(d){const e=Ss(h)?.attributes(i.INDENT_KEY)||"0";return r.attributes(i.INDENT_KEY,e),i.addIndent(r,1),t[t.length]=r[0],void(l=null)}if(s.isBlock(e,this.schema)){const e=t.length;return t[e]=r[0],t[e+1]=t.clone()[0],void(l=null)}if(!l){l=Ss(o?`<li class="${i.CUSTOMZIE_LI_CLASS}" />`:"<li />");const e=Ss(h)?.last();e?e?.after(l):Ss(h).append(l)}l.append(e),c||(c=l)}),d?.remove();let h=e;return t.each(e=>{const t=Ss(e);t&&0!==t.get()?.childNodes.length&&(h.after(t),h=t)}),n.each(e=>{const t=Ss(e);t&&0!==t.get()?.childNodes.length&&(h.after(t),h=t)}),e.remove(),c?.next()||t.next()||void 0}if("p"===c.name&&b){const e=Ss("<li />");return s.replace(c,e),e}if(g&&!p&&""===s.html(c).trim()&&(s.isRootBlock(c,this.schema)||"li"===c.name)&&s.html(c,"<br />"),g&&"li"===d?.name){const e=c.get()?.childNodes??[];if("p"===c.name){const t=c.next();0!==e.length||t||c.append("<br />");const n=c.first();return t&&"p"===t.name&&c.append("<br />"),s.unwrap(c),n}{const e=d.parent();if(!e)return;const t=e.clone(),n=e.clone();let r=d.prev();for(;r;)t.prepend(r),r=d.prev();let i=d.next();for(;i;)n.append(i),i=d.next();const s=d.clone(),o=d.clone();let a=c.prev();for(;a;)s.prepend(a),a=c.prev();let l=c.next();for(;l;)o.append(l),l=c.next();return e.after(c),s.first()&&t.append(s),o.first()&&n.prepend(o),t.first()&&e.before(t),n.first()&&c.after(n),void e.remove()}}if(!g&&s.isInline(c)&&!c.isCard()&&!p){const e=c.allChildren().some(e=>s.isVoid(e,this.schema));s.isEmptyWithTrim(c)&&!e?c.remove():r.repairCursor(c)}s.removeSide(c);let v=d;const y=e=>{if(v&&!v.fragment&&s.isBlock(e,this.schema)&&s.isBlock(v,this.schema)&&!this.schema.isAllowIn(v.name,e.name)){const t=e.children();s.unwrap(e),t.each((e,n)=>{y(t.eq(n))})}};for(y(c);c.length>0&&v&&!v.fragment&&s.isBlock(c,this.schema)&&!s.isBlock(v,this.schema);){const e=c.clone();s.unwrap(c),v.before(e),e.append(v),v=(c=e).parent()}const w=s.isMark(c,this.schema);if(c.length>0&&w){const e=a.closest(c);if(!e.equal(c)){const t=o.findPlugin(c),n=a.findPlugin(e);if(t&&n?.disableMark?.includes(t.name)){const e=c.first();return s.unwrap(c),e||void 0}}}if(w){const e=o.findPlugin(c),t=l.concat();if(t.pop(),e){const n=t.find(t=>t.plugin?.name===e.name&&t.node.length>0&&!t.node.equal(c));if(n)return void(1===n.node.get()?.childNodes.length?s.unwrap(n.node):s.unwrap(c))}}if(v=d,c.length>0&&v&&s.isMark(v,this.schema)&&w){const e=o.findPlugin(v),t=l[l.length-1]?.plugin;if(e&&t&&t.mergeLeval>e.mergeLeval){const e=v.clone(!1),t=v.children().toArray(),n=e.clone(),r=e.clone();let i=!0,s=-1;if(t.forEach((t,o)=>{if(t.equal(c)){const t=c.children();e.append(t),c.append(e),i=!1,s=o}else i?n.append(t):r.append(t)}),s>0&&v.before(n),s<t.length-1&&v.after(r),s>-1)return v.before(c),v.remove(),l.splice(l.length-2,1),c}}},void 0,void 0,e=>{if(s.isMark(e)){const t=o.findPlugin(e);e.is_mark=!0,l.push({plugin:t,node:e})}},e=>{e.is_mark&&l.pop()})}normalize(e=!0){const t=this.engine.node;let n=this.parser();this.elementNormalize(n);const r=this.engine.change.range.get(),i=r.commonAncestorNode,s=this.engine.inline.closest(i);if(i.inEditor()&&!s.isCard()&&t.isInline(s,this.schema))return this.removeElementNodes(Ss(n)),n;if(i.inEditor()&&i.isText()&&r.startContainer===r.endContainer){const e=i[0].nodeValue,t=e?.substr(0,r.startOffset),s=e?.substr(r.endOffset);if(/\[.*?]\($/.test(t||"")&&/^\)/.test(s||""))return this.removeElementNodes(Ss(n)),n}Ss(n).traverse(e=>{if(e.fragment===n)return;const r=e.get()?.firstChild;if(e.length>0&&e[0].parentNode&&this.engine.trigger("paste:each",e),e.isText()){let n=e.text();if(/^([\r\n])+$/.test(n)){const n=e.prev(),r=e.next();(n&&!t.isBlock(n)||r&&!t.isBlock(r)||n&&t.isBlock(n)&&r&&t.isBlock(r)||"p"===e.parent()?.name)&&e.remove()}let r=/((\n)+)/.exec(n),i=e;for(;r&&r.index>0&&r.index<n.length-1;){const e=i.get().splitText(r.index),t=e.splitText(r[0].length);i.after(e),e.after(t),i.text()||i.remove();const s=Ss(t);i=s,n=s.text(),r=/((\n)+)/.exec(n)}}else"pre"===e.name&&e.find(bi).length>0&&t.unwrap(e);return 0===e.length&&r?Ss(r):void 0}),this.engine.trigger("paste:each-after",Ss(n));const o=t.normalize(Ss(n));o.fragment&&(n=o.fragment),n.normalize();const a=Ss(n).find("ul,ol");return a.each((e,n)=>{const r=a.eq(n);r&&t.isList(r)&&this.engine.list.addStart(r)}),this.engine.nodeId.generateAll(Ss(n),e),n}removeElementNodes(e){e.allChildren().forEach(e=>{e.isElement()&&this.engine.node.unwrap(e)})}}class Wc{constructor(e){Ic.set(this,void 0),this.prevSelection=null,this.engine=e}repairInput(e,t){const{commonAncestorNode:n}=t,r=this.engine.card.find(n),{node:i,mark:s,change:o}=this.engine;if(r&&r.type===Yl.INLINE)if(r.isLeftCursor(n)){const e=n.closest(vi);let s=e.text().replace(/\u200B/g,"");s&&(s=cs(s),t.setStartBefore(r.root),t.collapse(!0),i.html(e,"&#8203;"),i.insertText(s,t),o.apply(t))}else if(r.isRightCursor(n)){const e=n.closest(wi);let s=e.text().replace(/\u200B/g,"");if(s){s=cs(s);const n=r.root.next(),a=r.queryMarks?r.queryMarks(!0):[];if(a.length>0){let e=a[a.length-1];e.append(s);for(let t=a.length-2;t>=0;t--)e=a[t].append(e);r.root.after(e),t.select(e,!0).collapse(!1)}else n&&(n.isText()||i.isMark(n))?(t.select(n,!0).collapse(!0),i.insertText(s,t)):(t.setEndAfter(r.root),t.collapse(!1),i.insertText(s,t));i.html(e,"&#8203;"),o.apply(t)}}else o.range.toTrusty(t);let{startNode:a,startOffset:l}=t.cloneRange().shrinkToTextNode();const c=a.parent();if(a.isText()&&c&&i.isMark(c)){let n=a.get(),r=a.text();const{inputType:d}=e;if(l===r.length&&e.data&&d&&0===d.indexOf("insert")){let d=c;const h=[];for(;d&&i.isMark(d);){const e=s.findPlugin(d);e&&!e.followStyle&&h.push(d),d=d.parent();const t=d?.parent();if(d?.next()&&t&&i.isMark(t))break}const u=a.next();if(h.forEach((e,t)=>{if(c.equal(e)&&u)return void h.splice(t,1);let n=e.next(),r=e;for(;!n&&r;){const e=r.parent();if(e&&i.isBlock(e))break;n=e?.next()||null,r=e}let o=n;for(;o&&!o.isText();){if(i.isMark(o)&&s.compare(o,e)){h.splice(t,1);break}o=o.first()}}),h.length>0){n.splitText(r.length-e.data.length).remove(),i.isEmpty(c)&&c.remove(),s.unwrap(h.map(e=>e.clone())),i.insertText(r.substr(r.length-e.data.length)),s.merge(),a=(t=o.range.get().cloneRange().shrinkToTextNode()).startNode,l=t.startOffset,n=a.get(),r=a.text()}}else if(e.data&&l===e.data.length&&d&&0===d.indexOf("insert")){let d=c;const h=[];for(;d&&i.isMark(d);){const e=s.findPlugin(d);e&&!e.followStyle&&h.push(d),d=d.parent();const t=d?.parent();if(d?.prev()&&t&&i.isMark(t))break}const u=a.prev();h.forEach((e,t)=>{if(c.equal(e)&&u)return void h.splice(t,1);let n=e.prev(),r=e;for(;!n&&r;){const e=r.parent();if(e&&i.isBlock(e))break;n=e?.prev()||null,r=e}let o=n;for(;o&&!o.isText();){if(i.isMark(o)&&s.compare(o,e)){h.splice(t,1);break}o=o.last()}}),h.length>0&&(n.splitText(e.data.length),n.remove(),i.isEmpty(c)&&c.remove(),s.unwrap(h.map(e=>e.clone())),i.insertText(""===e.data?" ":e.data),s.merge(),a=(t=o.range.get().cloneRange().shrinkToTextNode()).startNode,l=t.startOffset,n=a.get(),r=a.text())}r.length>0&&/^\u200B$/g.test(r.substr(0,1))&&(n.splitText(1),n.remove())}const d=a.prev();if(a.isText()&&d&&i.isMark(d)){const e=a.get(),t=a.text();t.length>0&&/^\u200B$/g.test(t.substr(0,1))&&(e.splitText(1),e.remove())}}handleSelectionChange(){const{change:e,container:t,card:n}=this.engine;if(e.isComposing())return;const{window:r}=t,i=r?.getSelection();if((this.prevSelection?.anchorNode!==i?.anchorNode||this.prevSelection?.anchorOffset!==i?.anchorOffset||this.prevSelection?.focusNode!==i?.focusNode||this.prevSelection?.focusOffset!==i?.focusOffset)&&(this.prevSelection=i?{anchorNode:i.anchorNode,anchorOffset:i.anchorOffset,focusNode:i.focusNode,focusOffset:i.focusOffset}:null,i&&i.anchorNode)){const r=gc.from(this.engine,i);if(!r.commonAncestorNode.inEditor(t))return;e.onSelect();let s=r.containsCard()||r.commonAncestorNode.closest(mi).length>0&&0===r.startNode.closest(`${vi},${wi},${Kr}`).length,o=r.collapsed;if(!o){const{startNode:e,endNode:t,startOffset:n,endOffset:i}=r,s=e.isElement()&&!e.isCard()?e.children().eq(n):e,a=t.isElement()&&!t.isCard()?t.children().eq(i-1):t;s&&a&&s.isCard()&&s.equal(a)&&(o=!0)}n.each(e=>{const t=e.getCenter();if(t&&t.length>0){let n=!!i.containsNode&&i.containsNode(t[0]);if(!n&&s&&i.focusNode){const t=this.engine.card.find(i.focusNode);t&&(o=!i.anchorNode||t.root.contains(i.anchorNode),o&&e.root.equal(t.root)&&(n=!0)),n&&o&&(s=!1)}const{autoSelected:r}=e.constructor;e.select(n&&(!o||!1!==r))}})}}init(){const{change:e,card:t,clipboard:n}=this.engine;e.event.onInput(t=>{const n=e.range.get();this.repairInput(t,n),e.range.select(n),e.onSelect(n),e.change()}),e.event.onDocument("selectionchange",()=>{this.handleSelectionChange()}),e.event.onSelect(n=>{const i=e.range.get();0!==i.startNode.closest(Ur).length&&(i.collapsed&&i.containsCard()&&e.range.toTrusty(i),e.range.select(i),r("shift+left",n)||r("shift+right",n)||r("shift+up",n)||r("shift+down",n)||t.activate(i.commonAncestorNode),e.onSelect(i))},()=>{e.onSelectStart()},()=>{e.onSelectEnd()}),e.event.onDocument("mousedown",e=>{if(!e.target)return;const n=Ss(e.target);if(0===n.closest("body").length)return;if(n.closest(".am-view").length>0)return;let r=n;for(;r;){const e=r.attributes(Hr);if(e&&[Xr,Zr].indexOf(e)<0)return;r=r.parent()}t.activate(n,Kl.MOUSE_DOWN,e)}),e.event.onDocument("copy",t=>{const r=e.range.get();this.engine.container.contains(r.commonAncestorNode)&&n.write(t)}),e.event.onDocument("cut",t=>{const r=e.range.get();if(!this.engine.container.contains(r.commonAncestorNode)||this.engine.readonly)return;n.write(t,void 0)&&(t.stopPropagation(),n.cut(),e.change())});const i=t=>{e.cacheRangeBeforeCommand();const n=ks(this.engine,"zero");n.enable(["paragraph","html_inline","newline"]);const r=n.parse(t,{});if(0!==r.length)return Ts(this.engine,n,r)},s=async t=>{const n=i(t);if(null===n)return;const r=()=>{this.engine.history.saveOp(),e.cacheRangeBeforeCommand(),this.paste(n,$c(this,Ic,"f"),void 0,!1)};"confirm"===this.engine.options.markdown?.mode?this.engine.messageConfirm("markdown",this.engine.language.get("checkMarkdown","title")).then(()=>{r()}).catch(e=>{e&&this.engine.messageError("markdown",e)}):r()};e.event.onPaste(t=>{const{html:n,text:r,files:i,isPasteText:o}=t;let a="";if(0===i.length)if(o){let e="";r?e=r:n&&(e=new yc(n,this.engine).toText()),a=new vc(e).toHTML()}else n&&n.indexOf('<meta name="source" content="aomao" />')>-1||n?a=n:r&&(a=new vc(r).toHTML());if(!1!==this.engine.trigger("paste:event",t,a)&&0===i.length){e.cacheRangeBeforeCommand(),this.paste(a);const t=this.engine.options.markdown||{};if(!1!==t.mode)if(t.check||!r||/^https?:\/\/\S+$/i.test(r.trim()))t.check&&t.check(r??"",n??"").then(e=>{e&&s(e)});else{if(!r)return;if(!n)return void setTimeout(()=>{s(r)},0);const e=r.split(/\r\n|\n/)||"";let t=0,i=0,o=!1;const a=(new DOMParser).parseFromString(n,"text/html").querySelectorAll("li"),l=[];a.forEach(e=>{const t=e.textContent??"";("OL"===e.parentElement?.nodeName||/\d\.\s+/.test(t))&&l.push(t)});for(let n=0;n<e.length;n++){const r=e[n];r.trim()&&(r.startsWith("```")?o?o=!1:(o=!0,i++,t++):o||(t++,/^(#|\*|-|\+|\[ \]|\[x\]|>){1,}\s+/.test(r)?i++:/^\d\.\s+/.test(r)?l.includes(r)||l.includes(r.replace(/^\d\./,"").trim())||i++:(/^(---|\*\*\*|\+\+\+)/.test(r)||/(\*|~|\^|_|`|\]\(https?:\/\/)/.test(r))&&i++))}i>0&&(0===t||i/t>.5)&&setTimeout(()=>{s(r)},0)}}});const o=e=>!e||t.closest(e.commonAncestorContainer);e.event.onDrop(({event:t,range:n,card:r,files:i})=>{if(r){if(t.preventDefault(),o(n))return;const i=r.constructor.cardName,s=r.getValue();this.engine.card.remove(r.root),e.range.select(n),this.engine.card.insert(i,s)}if(i.length>0){if(t.preventDefault(),o(n))return;e.range.select(n),this.engine.trigger("drop:files",i)}})}paste(e,t,n,r=!0,i,s=!0){const{change:o}=this.engine,a=new qc(e,this.engine).normalize(s);this.engine.trigger("paste:before",a),i?i(a,t,void 0,r):o.insert(a,t,e=>{this.engine.trigger("paste:insert",e);const t=e.cloneRange(),{endNode:r}=t;let i="";r.isCard()&&0===r.get()?.childNodes.length&&(t.setEndAfter(r),i=r.attributes(Fr)),jc(this,Ic,t,"f"),e.collapse(!1);const s=e.startNode.closest(`${mi},${bi}`);if(s.length>0){const t=s.attributes();(t[gi]||t[di])&&e.setStartAfter(s)}const a=e.createSelection();this.engine.card.render(void 0,r=>{if(a.move(),i){const e=this.engine.container.find(`[data-id="${i}"]`);e.length>0&&(t.setEndAfter(e),jc(this,Ic,t,"f"))}e.scrollRangeIntoView(),o.range.select(e),n&&n(r),this.engine.trigger("paste:after")})},r)}}Ic=new WeakMap;class Vc{constructor(e,t={}){Lc.set(this,void 0),Dc.set(this,void 0),this.engine=e,jc(this,Dc,t,"f")}setLastBlurRange(e){e?.commonAncestorNode.inEditor()?jc(this,Lc,e,"f"):jc(this,Lc,void 0,"f")}toTrusty(e=this.get()){const{commonAncestorNode:t}=e;t.isEditable()||t.inEditor()||e.select(this.engine.container,!0).shrinkToElementNode().collapse(!1);let n=e.cloneRange();if(n.collapse(!0),this.setCardRang(n),e.startNode.equal(n.startNode)&&e.startOffset===n.startOffset||e.setStart(n.startContainer,n.startOffset),n=e.cloneRange(),n.collapse(!1),this.setCardRang(n),e.endNode.equal(n.endNode)&&e.endOffset===n.endOffset||e.setEnd(n.endContainer,n.endOffset),e.collapsed){n=e.cloneRange(),n.enlargeFromTextNode();const t=Ss(n.startContainer),r=n.startOffset;this.engine.node.isInline(t)&&0===r&&e.setStartBefore(t[0]),this.engine.node.isInline(t)&&r===t[0].childNodes.length&&e.setStartAfter(t[0]),e.collapse(!0)}return e}setCardRang(e){const{startNode:t,startOffset:n}=e,{card:r}=this.engine,i=r.find(t);if(i){const s=i.getCenter().get();if(s&&(!t.isElement()||(t[0].parentElement??t[0].parentNode)!==i.root[0]||t.attributes(fi))){const o=()=>{const e=gc.create(this.engine);return e.select(s,!0),e.comparePoint(t,n)<0};if("inline"===i.type)return e.select(i.root),void e.collapse(o());o()?r.focusPrevBlock(i,e,!0):r.focusNextBlock(i,e,!0)}}}get(){const{container:e}=this.engine,{window:t}=e;let n=gc.from(this.engine,t,!1);return n||(n=gc.create(this.engine,t.document).select(e,!0).shrinkToElementNode().collapse(!1)),n}select(e,t=!0){const{container:n,inline:r,node:i,change:s}=this.engine,{window:o}=n,a=o?.getSelection();if(s.isComposing())return;if(e.collapsed){const{startNode:t,startOffset:n}=e;if((t.isElement()&&1===n&&1===t.get()?.childNodes.length||2===n&&2===t.get()?.childNodes.length&&t.first()?.isCard())&&"br"===t.last()?.name&&(e.setStart(t,n-1),e.collapse(!0)),t.isText()){const r=t.parent();"right"===r?.attributes(fi)&&0===n?(e.setStart(t,1),e.collapse(!0)):"left"===r?.attributes(fi)&&1===n&&(e.setStart(t,0),e.collapse(!0))}}let{startNode:l,endNode:c,startOffset:d,endOffset:h}=e.cloneRange().shrinkToTextNode();const u=l.prev(),f=c.next();if(u&&!u.isCard()&&!i.isVoid(u)&&i.isInline(u)){const t=l.text();/^\u200B/g.test(t)&&0===d&&(e.setStart(c,d+1),e.collapsed&&e.collapse(!0))}if(f&&!f.isCard()&&!i.isVoid(f)&&i.isInline(f)){const t=c.text();/\u200B$/g.test(t)&&h===t.length&&(e.setEnd(c,h-1),e.collapsed&&e.collapse(!1))}const g=r.closest(l);if(!g.isCard()&&i.isInline(g)&&!i.isVoid(g)){if(l.isText()&&!l.prev()&&l.parent()?.equal(g)&&0===d){const t=l.text();/^\u200B/g.test(t)&&(e.setStart(l,d+1),e.collapsed&&e.collapse(!0))}if(c.isText()&&!c.next()&&c.parent()?.equal(g)){const t=c.text();h===t.length&&/\u200B$/g.test(t)&&(e.setEnd(c,h-1),e.collapsed&&e.collapse(!1))}}if(l=e.startNode,c=e.endNode,l.isText()||c.isText()){const t=e.cloneRange().enlargeFromTextNode();l=t.startNode,c=t.endNode}const p=l.children();i.isCustomize(l)&&0===d&&e.setStart(l,1),i.isCustomize(c)&&0===h&&e.setEnd(c,1);const m=this.engine.model.mutation.isStopped;if("p"===l.name&&!m)if(0===p.length)l.append("<br />");else if(!Yi&&p.length>1&&"BR"!==p[p.length-2].nodeName&&"BR"===p[p.length-1].nodeName){const e=l.last();e?.remove()}e.collapsed||m||"p"!==c.name||0!==c.get()?.childNodes.length||c.append("<br />");const b=l.children();if(i.isList(l)&&!m&&(0===b.length||"BR"===b[0].nodeName)){const e=Ss("<p><br /></p>");this.engine.nodeId.create(e),l.before(e),l.remove(),l=e}if("li"===l.name&&!m){if(i.isCustomize(l)&&!l.first()?.isCard()){const e=l.parent()?.children().toArray().find(e=>e.first()?.isCard()),t=e?.first()?.attributes(ci);t?this.engine.list.addCardToCustomize(l,t):this.engine.list.unwrapCustomize(l)}0===p.length?l.append("<br />"):!i.isCustomize(l)&&p.length>1&&"BR"!==p[p.length-2].nodeName&&"BR"===p[p.length-1].nodeName?l.last()?.remove():i.isCustomize(l)&&1===p.length?l.append("<br />"):i.isCustomize(l)&&p.length>2&&"BR"!==p[p.length-2].nodeName&&"BR"===p[p.length-1].nodeName&&l.last()?.remove()}if(!e.collapsed&&"li"===c.name&&!m){const e=c.children();0===e.length?c.append("<br />"):!i.isCustomize(c)&&e.length>1&&"BR"!==e[e.length-2].nodeName&&"BR"===e[e.length-1].nodeName?l.last()?.remove():i.isCustomize(c)&&1===e.length?c.append("<br />"):i.isCustomize(c)&&e.length>2&&"BR"!==e[e.length-2].nodeName&&"BR"===e[e.length-1].nodeName&&l.last()?.remove()}!l.isEditable()||m||0!==l.get()?.childNodes.length||this.engine.model.mutation.isStopped||l.html("<p><br /></p>"),a&&(e.collapsed||a.rangeCount>0&&!e.equal(a.getRangeAt(0)))&&e.startNode.get()?.isConnected&&(a.removeAllRanges(),a.addRange(e.toRange()));const{onSelect:v}=$c(this,Dc,"f");v&&t&&v(e)}focus(e){const t=$c(this,Lc,"f")||this.get();void 0!==e&&t.select(this.engine.container,!0).shrinkToElementNode().collapse(e),this.select(t);const n=t.commonAncestorNode.closest(Gr);if(n?.get()?.focus(),n.length>0&&!this.engine.container.equal(n)){const e=new MouseEvent("mousedown");this.engine.container.get()?.dispatchEvent(e),setTimeout(()=>{const e=new MouseEvent("mouseup");this.engine.container.get()?.dispatchEvent(e)},0)}}blur(){const e=this.get();e.commonAncestorNode.closest(Gr).get()?.blur(),this.engine.container.get()?.blur(),this.engine.trigger("blur")}}Lc=new WeakMap,Dc=new WeakMap;const Hc=new WeakMap,Fc=new WeakMap;class Xc{constructor(e,t={}){this.valueCached=null,this.marks=[],this.blocks=[],this.inlines=[],this.changeTrigger=[],this.options=t,this.engine=e,this.event=new Pc(e,{}),this.onChange=this.options.onChange||function(){},this.onRealtimeChange=this.options.onRealtimeChange||function(){};let n=null;this.onSelect=t=>{const{mark:r,block:i,inline:s}=e;t=t||this.range.get(),this.marks=r.findMarks(t),this.blocks=i.findBlocks(t),this.inlines=s.findInlines(t),n?.startContainer===t.startContainer&&n?.startOffset===t.startOffset&&n?.endContainer===t.endContainer&&n?.endOffset===t.endOffset||(n={startContainer:t.startContainer,startOffset:t.startOffset,endContainer:t.endContainer,endOffset:t.endOffset},Fc.get(this.engine)||(Fc.set(this.engine,!0),Promise.resolve().then(()=>{Fc.set(this.engine,!1),this.options.onSelect&&this.options.onSelect()})))},this.onSelectStart=()=>{this.options.onSelectStart&&this.options.onSelectStart()},this.onSelectEnd=()=>{this.options.onSelectEnd&&this.options.onSelectEnd()},this.onSetValue=this.options.onSetValue||function(){},this.range=new Vc(e,{onSelect:e=>{this.onSelect(e)}}),this.nativeEvent=new Wc(e)}init(){this.nativeEvent.init()}_change(){if(!this.isComposing()){this.engine.card.gc();const e=2===this.changeTrigger.length?"both":"remote"===this.changeTrigger[0]?"remote":"local";this.onChange(e),this.changeTrigger=[]}}change(e,t){const n=e?"remote":"local";let r;if(e)t?.forEach(e=>{if(r=e.closest(Gr),r&&r.length>0){const e=this.engine.card.find(r,!0);e?.onChange&&e?.onChange(n,r)}});else{const e=this.range.get(),{startNode:i}=e;if(i.inEditor())r=i.closest(Gr);else{const e=i.closest(Kr).attributes(Ni);e&&(r=this.engine.card.find(e)?.root.closest(Gr))}if(r&&r.length>0){const e=this.engine.card.find(r,!0);e?.onChange&&e?.onChange(n,r)}else t?.forEach(e=>{if(r=e.closest(Gr),r&&r.length>0){const e=this.engine.card.find(r,!0);e?.onChange&&e?.onChange(n,r)}})}this.onRealtimeChange(n),this.changeTrigger.indexOf(n)<0&&this.changeTrigger.push(n),Hc.get(this.engine)||(Hc.set(this.engine,!0),Promise.resolve().then(()=>{Hc.set(this.engine,!1),this._change()}))}isComposing(){return this.event.isComposing}isSelecting(){return this.event.isSelecting}initValue(e,t=!0,n=this.engine.container){const r=n.html(),i="<p><br /></p>";if(r===i||(n.get()?.childNodes.length||0)>0)return;const s=Ss(r||i);0===s.get()?.childNodes.length&&s.html("<br />"),n.empty().append(s);const o=e||this.range.get();!e&&t&&(o.select(s,!0).collapse(!1),this.apply(o))}setValue(e,t,n){const r=this.range.get(),{schema:i,conversion:s,container:o,history:a,mark:l,card:c}=this.engine;if(""===e)this.engine.container.html(e),this.initValue(void 0,!1),n&&n(0);else{const d=new yc(e,this.engine,e=>{l.removeEmptyMarks(e),e.allChildren("editable").forEach(e=>{t&&t(e)})},!1);o.html(d.toValue(i,s,!1,!0)),c.render(void 0,e=>{n&&n(e)});const h=o.find(Oi),u=new ac(this.engine,r);h.length>0&&(u.anchor=h,u.focus=h);const f=o.find(ki),g=o.find(Ti);f.length>0&&g.length>0&&(u.anchor=f,u.focus=g),u.anchor&&u.focus&&(u.move(),this.range.select(r),this.onSelect()),this.onSetValue(),a.clear()}this.change()}setHtml(e,t){const{card:n,container:r}=this.engine;this.nativeEvent.paste(e,void 0,t,!0,e=>{r.empty().append(e),n.render(void 0,e=>{this.initValue(void 0,!1),this.engine.trigger("paste:after"),t&&t(e)}),this.change()},!1)}setMarkdown(e,t){const n=ks(this.engine,"zero");n.enable(["paragraph","html_inline","newline"]);const r=n.parse(e,{});if(0===r.length)return;let i=Ts(this.engine,n,r);i||(i=e);const{card:s,container:o}=this.engine;this.nativeEvent.paste(i,void 0,t,!0,e=>{o.empty().append(e),s.render(void 0,e=>{this.initValue(void 0,!1),this.engine.trigger("paste:after"),t&&t(e)}),this.change()})}getOriginValue(e=this.engine.container,t=!0){const{schema:n,conversion:r}=this.engine;return new yc(t?e.clone(!0):e,this.engine,void 0,!1).toValue(n,r)}getValue(e={}){let t;if(e.ignoreCursor||this.isComposing())t=this.getOriginValue();else{let e=this.range.get();const n=this.engine.container.clone(!0);if(!e.inCard()){const t=e.toPath(!0);if(!t)return this.getOriginValue(n,!1);e=gc.fromPath(this.engine,t,!0,n),e.createSelection()}t=this.getOriginValue(n,!1)}return t}cacheRangeBeforeCommand(){this.rangePathBeforeCommand=this.range.get().toPath()}getRangePathBeforeCommand(){const e=this.rangePathBeforeCommand;return this.rangePathBeforeCommand=void 0,e}isEmpty(){const{container:e,node:t,schema:n}=this.engine,r=n.getAllowInTags(),i=e.children();return 0===i.length||1===i.length&&t.isEmpty(e)&&!e.allChildren().some(e=>r.includes(e.name))}combinText(){si(this.engine.container)}apply(e){this.combinText();const{inline:t,mark:n,nodeId:r}=this.engine;if(e){const r=e.createSelection("change-apply");t.findInlines(e).forEach(e=>t.repairCursor(e)),n.findMarks(e).forEach(e=>n.repairCursor(e)),r.move(),e.shrinkToTextNode(),this.range.select(e)}this.change(),r.generateAll(this.engine.container)}insert(e,t,n=()=>{},r=!0){const{block:i,list:s,schema:o,mark:a,inline:l}=this.engine,c=this.engine.node;t=t||this.range.toTrusty();const d=i.closest(t.startNode),h=i.closest(t.endNode)[0]===d[0],u=i.isLastOffset(t,"end"),f=o.getCanMergeTags(),g=o.getAllowInTags(),p=d.closest(f.join(",")),m=t.collapsed,b=e.childNodes,v=Ss(e.firstChild||[]),y=()=>{const n=Ss(e).first(),r=t.cloneRange().shrinkToElementNode().shrinkToTextNode(),{startNode:i}=r;if(i.inEditor()&&n&&"p"===n.name&&(1!==n.length||"br"!==n.first()?.name)){if("p"===i.name&&c.isEmptyWidthChild(i)){const e=n.css();i.css(e)}c.unwrap(n)}};if(m){if(y(),t.startNode.isText()){const e=l.closest(t.startNode),n=t.startNode.text();0===e.length&&!e.equal(t.startNode)&&/^\u200B/.test(n)&&t.startNode.text(n.substr(1))}}else this.delete(t,h||!u,r),c.isEmptyWidthChild(t.startNode)&&t.shrinkToElementNode().shrinkToTextNode(),y();let w;const N=e=>{w&&w.node[0].isConnected&&(e.shrinkToElementNode().setStart(w.node,w.offset),e.enlargeToElementNode()),i.merge(e),s.merge(void 0,e),a.merge(e),l.flat(e),n&&n(e),this.apply(e)};if(c.isList(t.startNode)||t.startNode.closest("li").length>0){const n=t.startNode.children();return w={node:t.startNode,offset:1===n.length&&"BR"===n[0].nodeName?0:t.startOffset},s.insert(e,t),void N(t)}if(!v[0])return void N(t);if(!c.isBlock(v)){if(t.shrinkToElementNode(),b.length>0){const e=t.startNode.children();w={node:t.startNode,offset:1===e.length&&"BR"===e[0].nodeName?0:t.startOffset}}let e=v.next(),n=v;const r=c.insert(v,t);for(r&&(t=r);e&&!c.isBlock(e);){t.startContainer.nodeType===Node.TEXT_NODE&&t.enlargeToElementNode().collapse(!1);const r=e.next();n.after(e),n=e,e=r}if(n!==v&&t.select(n,!0).collapse(!1),0===b.length)return void N(t)}const x=t.cloneRange().enlargeToElementNode(!0).collapse(!1),E=x.startContainer.childNodes[0===t.startOffset?0:t.startOffset-1],C=x.startContainer.childNodes[t.startOffset];if(0!==b.length){let e=Ss(b[b.length-1]);if("br"===e.name&&(e.remove(),e=Ss(b[b.length-1])),!w){const e=t.startNode.children();w={node:t.startNode,offset:1===e.length&&"BR"===e[0].nodeName?0:t.startOffset}}let n=Ss(b[0]),r=null;const i=[];for(;n&&n.length>0;){c.removeSide(n);const s=n.next();if(s||(e=n),r?r.after(n):(c.isInline(t.startNode)&&(t.setStartAfter(t.startNode),t.collapse(!0)),c.insert(n,t,!0),c.isInline(n)&&(t.setEndAfter(n),t.collapse(!1))),n.get()?.isConnected&&i.push(n),c.isBlock(n)||s?.isText()?r=n:(r&&t.select(n,!0).collapse(!1),r=null),s||!n.get()?.isConnected||c.isInline(n)||t.select(n,!0).collapse(!1),w&&!w.node[0].isConnected){const e=n.parent();e&&(w={node:e,offset:n.index()})}n=s}p[0]&&i.forEach(e=>{f.indexOf(e.name)<0&&0===e.closest(p.name).length&&c.wrap(e,c.clone(p,!1,!1))})}const k=e=>{let t=e.first();if(!t||!c.isBlock(t))return e;for(;g.indexOf(t?t.name:"")>-1;)t=t.first();return t},T=e=>{let t=e.last();if(!t||!c.isBlock(t))return e;for(;g.indexOf(t?t.name:"")>-1;)t=t.last();return t},O=(e,t)=>{if(e.isCard()||v.isCard())return;const n=t.parent(),r=e.parent(),i=n&&!n.isEditable()&&r&&!r.isEditable()&&n.name===r.name;return"p"===t.name&&i||e.name===t.name&&i&&!("li"===e.name&&!s.isSame(e.parent(),t.parent()))},S=e=>{for(;!e.isEditable();){const t=e.parent();if(e.remove(),!t||!c.isEmpty(t))break;e=t}};if(E){const e=k(Ss(E.nextSibling||[])),t=T(Ss(E));"p"===t.name&&e.name!==t.name&&O(t,e)&&(((e,t)=>{if(e.name===t.name&&"p"===e.name){const n=t.attributes();n[Fr]&&delete n[Fr],e.attributes(n)}c.isEmptyWidthChild(e)&&!c.isEmptyWidthChild(t)&&(e.get().innerHTML=""),c.isCustomize(e)===c.isCustomize(t)&&s.unwrapCustomize(t)})(t,e),c.merge(t,e,!1),S(e))}if(C){const e=T(Ss(C.previousSibling||[])),t=k(Ss(C));e&&O(e,t)&&(c.merge(e,t,!1),S(t))}N(t)}paste(e,t,n){this.nativeEvent.paste(e,t,n,!0)}delete(e,t,n=!0){const r=e||this.range.toTrusty();if(r.collapsed)return this.isEmpty()&&this.initValue(r),void(e||this.apply(r));const{mark:i,inline:s,card:o}=this.engine,a=this.engine.node,l=this.engine.block;let c=r.cloneRange();c.collapse(!0);const d=n?i.findMarks(c):[];r.enlargeToElementNode();let h=l.closest(r.cloneRange().shrinkToElementNode().shrinkToTextNode().enlargeToElementNode().startNode);if(!h.inEditor()&&!h.isRoot())return this.isEmpty()&&this.initValue(r),void(e||this.apply(r));if(h.isRoot()){let t=h.children().eq(r.startOffset);for(;t?.isCard();){const e=t.equal(r.endNode)||t.contains(r.endNode),n=t.next()||void 0,i=o.find(t);if(i?o.removeNode(i):t.remove(),e){t=void 0;break}t=n}if(!t)return this.isEmpty()&&this.initValue(r),void(e||this.apply(r));h=t}const{endNode:u,endOffset:f}=r,g=!l.closest(r.startNode).equal(l.closest(u)),p=s.closest(u);if(p.length>0&&u.parent()?.equal(p)&&u.isText()){f===u.text().length-1&&r.setEndAfter(p)}const m=r.cloneRange().shrinkToElementNode().shrinkToTextNode().getEndOffsetNode();r.extractContents();let{startNode:b}=r;if(b.isEditable()&&0===b.get()?.childNodes.length&&(b.html("<p><br /></p>"),this.engine.nodeId.generate(b)),b=r.shrinkToElementNode().shrinkToTextNode().enlargeToElementNode().startNode,b.isCard()&&0===b.find(yi).length&&o.remove(b),r.collapse(!0),b=r.shrinkToElementNode().shrinkToTextNode().enlargeToElementNode().startNode,h.isElement()&&!h.equal(b)&&0===h.get().childNodes.length&&h.remove(),b.isText()||!h.inEditor())return this.isEmpty()&&this.initValue(r),void(e||this.apply(r));let v=!1;if(g&&0===b.get()?.childNodes.length){const e=r.createSelection();b.remove(),e.anchor?.get()?.isConnected&&e.focus?.get()?.isConnected&&e.move(),v=!0,b=r.startNode}const y=h,w=m&&m.isConnected?b:null;let N=0===b.get()?.childNodes.length;if(!N&&b.length>0&&b.inEditor()&&1===b[0].childNodes.length&&b[0].firstChild?.nodeType===Node.ELEMENT_NODE&&a.isCustomize(b)&&b.first()?.isCard()&&(N=!0),N&&a.isBlock(b)&&b.inEditor()){if(a.isList(b))b.remove();else{let e=a.getBatchAppendHTML(d,"<br />");b.isEditable()&&(e=`<p>${e}</p>`),b.append(Ss(e));const t=b.find("br"),n=t.parent();n&&a.isMark(n)&&a.replace(t,Ss("​",null)),r.select(b,!0)}return r.shrinkToElementNode().shrinkToTextNode(),r.collapse(!1),this.isEmpty()&&this.initValue(r),void(e||this.apply(r))}const x=(e,t,n,r,i=!1)=>{if(a.isBlock(t)&&!a.isVoid(t)&&!t.isCard()){e.select(t,!0),e.collapse(!1);const s=e.shrinkToElementNode().shrinkToTextNode().createSelection();let o=n.parent();for(a.merge(t,n);o&&a.isBlock(o)&&a.isEmpty(o);)o.remove(),o=o.parent();s.move(),e.enlargeToElementNode(!0);const l=e.getPrevNode(),c=e.getNextNode(),{startNode:d}=e;l||c||!a.isBlock(d)||(d.append(Ss(a.getBatchAppendHTML(r,"<br />"))),e.select(d.find("br"),!0),e.collapse(!1)),l&&c&&!l.isCard()&&!c.isCard()&&i&&x(e,l,c,r)}};if(y&&w&&w.length>0&&a.isBlock(y)&&a.isBlock(w)&&!y.equal(w)&&!y.parent()?.equal(w)&&w.inEditor()&&x(r,y,w,d,t),b.children().each(e=>{const t=Ss(e);!a.isVoid(t)&&t.isElement()&&""===a.html(t)&&t.remove(),a.isInline(t)&&s.repairCursor(t)}),a.isList(b)&&a.isEmpty(b)&&b.remove(),c=r.cloneRange().shrinkToTextNode(),c.startNode.isText()&&/^\u200B/g.test(c.startNode.text())&&0===c.startOffset){const e=c.startNode.prev();e&&this.engine.node.isInline(e)&&(r.select(e,!0),r.collapse(!1))}a.isBlock(b)&&0===b.get()?.childNodes.length&&b.html("<br />"),v&&(a.isBlock(y)&&0===y.get()?.childNodes.length&&y.html("<br />"),y.inEditor()&&r.select(y,!0).collapse(!1)),this.isEmpty()&&this.initValue(r),e||this.apply(r)}unwrap(e){const{block:t}=this.engine,n=this.range.get();if(!(e=e||t.closest(n.startNode)).inEditor())return;const r=n.createSelection();this.engine.node.unwrap(e),r.move(),this.range.select(n)}mergeAfterDelete(e){const{block:t,card:n,list:r,mark:i}=this.engine,s=this.engine.node,o=this.range.get(),a=(e=e||t.closest(o.startNode)).children();if(0===a.length)return e.append(Ss("<br />")),void this.apply(o);const l=e.first();if(a.length>1&&"br"===l?.name)return void l?.remove();let c=e.prev();if(!c){const t=e.parent();return void(t?.inEditor()&&!t?.isEditable()&&this.unwrap(e))}if(c.isCard()){(1===a.length&&"br"===l?.name||s.isEmpty(e))&&e.remove();const t=n.find(c);if(t)return void n.focus(t)}if(s.isVoid(c))return c.remove(),void this.apply(o);if(s.isRootBlock(c)&&s.isEmpty(c))return c.remove(),void this.apply(o);if(c.isText()){const e=Ss("<p />");c.before(e),e.append(c),c=e}if(s.isList(c)&&(c=c.last()),1===a.length&&"br"===l?.name?l?.remove():c&&1===c.get()?.childNodes.length&&"br"===c.first()?.name&&c.first()?.remove(),!c||c.isText())this.unwrap(e);else{const t=o.createSelection();s.merge(c,e),t.move(),this.range.select(o),i.merge(),r.merge()}}destroy(){this.event.destroy()}}var Uc=P,Yc=/\s/;var Kc=function(e){for(var t=e.length;t--&&Yc.test(e.charAt(t)););return t},Zc=/^\s+/;var Gc=Z,Jc=zt;var Qc=function(e){return"symbol"==typeof e||Jc(e)&&"[object Symbol]"==Gc(e)},ed=function(e){return e?e.slice(0,Kc(e)+1).replace(Zc,""):e},td=G,nd=Qc,rd=/^[-+]0x[0-9a-f]+$/i,id=/^0b[01]+$/i,sd=/^0o[0-7]+$/i,od=parseInt;var ad=function(e){if("number"==typeof e)return e;if(nd(e))return NaN;if(td(e)){var t="function"==typeof e.valueOf?e.valueOf():e;e=td(t)?t+"":t}if("string"!=typeof e)return 0===e?e:+e;e=ed(e);var n=id.test(e);return n||sd.test(e)?od(e.slice(2),n?2:8):rd.test(e)?NaN:+e},ld=G,cd=function(){return Uc.Date.now()},dd=ad,hd=Math.max,ud=Math.min;var fd=function(e,t,n){var r,i,s,o,a,l,c=0,d=!1,h=!1,u=!0;if("function"!=typeof e)throw new TypeError("Expected a function");function f(t){var n=r,s=i;return r=i=void 0,c=t,o=e.apply(s,n)}function g(e){var n=e-l;return void 0===l||n>=t||n<0||h&&e-c>=s}function p(){var e=cd();if(g(e))return m(e);a=setTimeout(p,function(e){var n=t-(e-l);return h?ud(n,s-(e-c)):n}(e))}function m(e){return a=void 0,u&&r?f(e):(r=i=void 0,o)}function b(){var e=cd(),n=g(e);if(r=arguments,i=this,l=e,n){if(void 0===a)return function(e){return c=e,a=setTimeout(p,t),d?f(e):o}(l);if(h)return clearTimeout(a),a=setTimeout(p,t),f(l)}return void 0===a&&(a=setTimeout(p,t)),o}return t=dd(t)||0,ld(n)&&(d=!!n.leading,s=(h="maxWait"in n)?hd(dd(n.maxWait)||0,t):s,u="trailing"in n?!!n.trailing:u),b.cancel=function(){void 0!==a&&clearTimeout(a),c=0,r=l=i=a=void 0},b.flush=function(){return void 0===a?o:m(cd())},b},gd=f(fd);var pd=function(e,t,n,r){for(var i=e.length,s=n+(r?1:-1);r?s--:++s<i;)if(t(e[s],s,e))return s;return-1},md=ct,bd=jl;var vd=G;var yd=function(e){return e==e&&!vd(e)},wd=yd,Nd=so;var xd=function(e,t){return function(n){return null!=n&&(n[e]===t&&(void 0!==t||e in Object(n)))}},Ed=function(e,t,n,r){var i=n.length,s=i,o=!r;if(null==e)return!s;for(e=Object(e);i--;){var a=n[i];if(o&&a[2]?a[1]!==e[a[0]]:!(a[0]in e))return!1}for(;++i<s;){var l=(a=n[i])[0],c=e[l],d=a[1];if(o&&a[2]){if(void 0===c&&!(l in e))return!1}else{var h=new md;if(r)var u=r(c,d,l,e,t,h);if(!(void 0===u?bd(d,c,3,r,h):u))return!1}}return!0},Cd=function(e){for(var t=Nd(e),n=t.length;n--;){var r=t[n],i=e[r];t[n]=[r,i,wd(i)]}return t},kd=xd;var Td=function(e){var t=Cd(e);return 1==t.length&&t[0][2]?kd(t[0][0],t[0][1]):function(n){return n===e||Ed(n,e,t)}},Od=Xt,Sd=Qc,Ad=/\.|\[(?:[^[\]]*|(["'])(?:(?!\1)[^\\]|\\.)*?\1)\]/,Md=/^\w*$/;var _d=function(e,t){if(Od(e))return!1;var n=typeof e;return!("number"!=n&&"symbol"!=n&&"boolean"!=n&&null!=e&&!Sd(e))||(Md.test(e)||!Ad.test(e)||null!=t&&e in Object(t))},Bd=Je;function Rd(e,t){if("function"!=typeof e||null!=t&&"function"!=typeof t)throw new TypeError("Expected a function");var n=function(){var r=arguments,i=t?t.apply(this,r):r[0],s=n.cache;if(s.has(i))return s.get(i);var o=e.apply(this,r);return n.cache=s.set(i,o)||s,o};return n.cache=new(Rd.Cache||Bd),n}Rd.Cache=Bd;var Id=Rd;var Ld=/[^.[\]]+|\[(?:(-?\d+(?:\.\d+)?)|(["'])((?:(?!\2)[^\\]|\\.)*?)\2)\]|(?=(?:\.|\[\])(?:\.|\[\]|$))/g,Dd=/\\(\\)?/g,zd=function(e){var t=Id(e,function(e){return 500===n.size&&n.clear(),e}),n=t.cache;return t}(function(e){var t=[];return 46===e.charCodeAt(0)&&t.push(""),e.replace(Ld,function(e,n,r,i){t.push(r?i.replace(Dd,"$1"):n||e)}),t});var Pd=function(e,t){for(var n=-1,r=null==e?0:e.length,i=Array(r);++n<r;)i[n]=t(e[n],n,e);return i},$d=Xt,jd=Qc,qd=$?$.prototype:void 0,Wd=qd?qd.toString:void 0;var Vd=function e(t){if("string"==typeof t)return t;if($d(t))return Pd(t,e)+"";if(jd(t))return Wd?Wd.call(t):"";var n=t+"";return"0"==n&&1/t==-1/0?"-0":n},Hd=Vd;var Fd=Xt,Xd=_d,Ud=zd,Yd=function(e){return null==e?"":Hd(e)};var Kd=function(e,t){return Fd(e)?e:Xd(e,t)?[e]:Ud(Yd(e))},Zd=Qc;var Gd=function(e){if("string"==typeof e||Zd(e))return e;var t=e+"";return"0"==t&&1/e==-1/0?"-0":t},Jd=Kd,Qd=Gd;var eh=function(e,t){for(var n=0,r=(t=Jd(t,e)).length;null!=e&&n<r;)e=e[Qd(t[n++])];return n&&n==r?e:void 0},th=eh;var nh=Kd,rh=Ft,ih=Xt,sh=In,oh=Ut,ah=Gd;var lh=function(e,t){return null!=e&&t in Object(e)},ch=function(e,t,n){for(var r=-1,i=(t=nh(t,e)).length,s=!1;++r<i;){var o=ah(t[r]);if(!(s=null!=e&&n(e,o)))break;e=e[o]}return s||++r!=i?s:!!(i=null==e?0:e.length)&&oh(i)&&sh(o,i)&&(ih(e)||rh(e))};var dh=jl,hh=function(e,t,n){var r=null==e?void 0:th(e,t);return void 0===r?n:r},uh=function(e,t){return null!=e&&ch(e,t,lh)},fh=_d,gh=yd,ph=xd,mh=Gd;var bh=eh;var vh=function(e){return function(t){return null==t?void 0:t[e]}},yh=function(e){return function(t){return bh(t,e)}},wh=_d,Nh=Gd;var xh=Td,Eh=function(e,t){return fh(e)&&gh(t)?ph(mh(e),t):function(n){var r=hh(n,e);return void 0===r&&r===t?uh(n,e):dh(t,r,3)}},Ch=xr,kh=Xt,Th=function(e){return wh(e)?vh(Nh(e)):yh(e)};var Oh=ad,Sh=1/0;var Ah=function(e){return e?(e=Oh(e))===Sh||e===-1/0?17976931348623157e292*(e<0?-1:1):e==e?e:0:0===e?e:0};var Mh=pd,_h=function(e){return"function"==typeof e?e:null==e?Ch:"object"==typeof e?kh(e)?Eh(e[0],e[1]):xh(e):Th(e)},Bh=function(e){var t=Ah(e),n=t%1;return t==t?n?t-n:t:0},Rh=Math.max,Ih=Math.min;var Lh=f(function(e,t,n){var r=null==e?0:e.length;if(!r)return-1;var i=r-1;return void 0!==n&&(i=Bh(n),i=n<0?Rh(r+i,0):Ih(i,r-1)),Mh(e,_h(t),i,!0)});const Dh=e=>Ph(e)&&1===e.nodeType,zh=e=>!!Dh(e)&&("undefined"!=typeof HTMLElement?e instanceof HTMLElement:e.style instanceof CSSStyleDeclaration),Ph=e=>{const t=(e=>e&&e.ownerDocument&&e.ownerDocument.defaultView||null)(e)??globalThis.window;return!!t&&e instanceof t.Node},$h=e=>Ph(e)&&3===e.nodeType,jh={isText:e=>cc(e)&&"string"==typeof e.text,create:e=>({text:e})},qh={isElement:e=>cc(e)&&Array.isArray(e.children),create:(e,t={},n=[])=>({type:e,...t,children:n})},Wh=e=>{if(jh.isText(e))return document.createTextNode(e.text);if(qh.isElement(e)){const{type:t,children:n}=e;let r=null;try{r=document.createElement(t.replace(/[-_[\]\s]/g,""))}catch(e){r=document.createElement("span")}for(const[t,n]of Object.entries(e))"type"!==t&&"children"!==t&&r.setAttribute(t,n);e[ci]&&!e[di]&&(r.setAttribute(di,e[ci]),r.removeAttribute(ci));for(const e of n)r.appendChild(Wh(e));return r}throw new Error("Cannot convert node to DOM")},Vh=(e,t,n,r=!0)=>{if(r&&Dh(t)&&t.hasAttribute(gi)){const{card:n}=e,r=n.find(t);r&&(r.getCenter().empty(),n.renderComponent(r))}const i=n[0];let s=0;for(const r of t.childNodes)if(!hc(r)){if(i===s)return 1===n.length?{parent:t,node:r,offset:-1}:Vh(e,r,n.slice(1));s++}if(n.length>1)throw new Error("Cannot find element");return{parent:t,node:t,offset:i}},Hh=(e,t,n)=>{const{card:r}=e,{path:i}=t,{parent:s,node:o,offset:a}=Vh(e,e.container[0],i);if("insert_node"===t.type){const{node:r}=t,i=Wh(r),a=Ss(i);s!==o?s.insertBefore(i,o):s.appendChild(i),Dh(i)&&Bi(i)&&i.setAttribute(gi,n?"remote":"true");const l=r[Fr];if(e.card.render(a),a[0].isConnected||!l)return a;const c=s.querySelector(`[${Fr}="${l}"]`);return c?Ss(c):a}if("remove_node"===t.type)return-1===a?(Dh(o)&&Bi(o)?n?r.removeRemote(o):r.remove(o,!1):s.removeChild(o),Di(s)?void 0:Ss(s)):void 0;if("set_node"!==t.type){if("insert_text"===t.type){const{offset:e,text:n}=t;if(-1===a&&$h(o)){const t=o.nodeValue??"";return o.nodeValue=t.slice(0,e)+n+t.slice(e),Ss(o)}return}if("remove_text"===t.type){const{offset:e,text:n}=t;if(-1===a&&$h(o)){const t=o.nodeValue??"";return o.nodeValue=t.slice(0,e)+t.slice(e+n.length),Ss(o)}return}}else if(-1===a&&Dh(o)){const{properties:e,newProperties:i}=t;for(const[t]of Object.entries(e))o.removeAttribute(t);for(const[e,t]of Object.entries(i))null===t?o.removeAttribute(e):o.setAttribute(e,t);const s=Ss(o);if(Bi(o)){const e=r.find(o);if(!e)return;e.isEditable||r.reRender(e),e.isEditable&&e.onChange&&e.onChange(n?"remote":"local",s)}return s}},Fh=new WeakMap,Xh={fromEngine:e=>{let t=Fh.get(e);return t||(t=(()=>{let e=null;const t=[];return{getMembers:()=>t,add(e){t.push(e)},remove(e){const n=t.findIndex(t=>t.uuid===e);-1!==n&&t.splice(n,1)},getCurrent:()=>e,setCurrent(n){const r="string"==typeof n?t.find(e=>e.uuid===n):n;r&&(e=r)}}})(),Fh.set(e,t)),t}},Uh={childList:!0,subtree:!0,attributes:!0,characterData:!0,attributeOldValue:!0,characterDataOldValue:!0},Yh=new WeakMap,Kh=e=>{let t=Yh.get(e);return t||(t=(e=>{let t=!1,n=!0,r=[];const i=new o,s=new MutationObserver(e=>{t&&r.push(...e),n||t||i.emit("change",e)}),a={get isStopped(){return n},get isCache(){return t},onChange:e=>{i.on("change",e)},offChange:e=>{i.off("change",e)},start:()=>{const t=e.container[0];n&&(s.observe(t,Uh),n=!1)},stop:()=>{n||(s.disconnect(),n=!0)},startCache:()=>{t||(r=[],t=!0)},submitCache:()=>{t&&setTimeout(()=>{e.change.isComposing()||(t=!1,r=r.map(e=>("characterData"===e.type&&e.target.nodeType===document.TEXT_NODE&&(e["text-data"]=e.target.textContent),e)),r.length>0&&i.emit("change",r),r=[])},20)},destroyCache:()=>{t&&setTimeout(()=>{t=!1,r=[]},20)},getCaches:()=>r,destroy:()=>{i.removeAllListeners(),a.stop()}};return a})(e),Yh.set(e,t)),t},Zh=new WeakMap,Gh=new WeakMap,Jh={isPath:e=>Array.isArray(e)&&e.every(e=>"number"==typeof e),setPath(e,t,n){Zh.set(e,n),Gh.set(e,t)},getPath(e){const t=[];let n=e;for(;n;){const e=Gh.get(n);if(!e)break;const r=Zh.get(n);if(void 0===r)throw new Error(`Invalid index in ${JSON.stringify(n)}`);t.unshift(r),n=e}return t},getIndex(e){const t=Zh.get(e);if(void 0===t)throw new Error(`Invalid index in ${e}`);return t},isEqual:(e,t)=>e.length===t.length&&e.every((e,n)=>e===t[n]),isReverse(e,t,n=1){if(e.length!==t.length)return!1;const r=e.length-1,i=t.slice();return i[r]=i[r]-n,Jh.isEqual(e,i)},commonLength(e,t){let n=e.length,r=t.length;if(0===n)return-1;if(0===r)return null;n--,r--;for(let i=0;i<n;i++){const n=e[i];if(i>=r||n!==t[i])return null}return n},next(e){if(0===e.length)throw new Error(`Cannot get the next path of a root path [${e}], because it has no next index.`);const t=e[e.length-1];return e.slice(0,-1).concat(t+1)}},Qh=new WeakMap,eu=new WeakMap,tu=new WeakMap,nu={createFromDOM:(e,t)=>{if(hc(e))return;const{nodeName:n,nodeValue:r}=e;if(Dh(e)){const{attributes:r,childNodes:i}=e,s={};for(const{name:t,value:n}of r)fc(e,t)||("style"===t&&zh(e)?s.style=is(e.style.cssText||n):s[t]=String(n));const o=[];for(const e of i){const n=nu.createFromDOM(e,t);n&&o.push(n)}const a=qh.create(n.toLowerCase(),s,o);for(let e=0;e<o.length;e++){const t=o[e];Jh.setPath(t,a,e)}return nu.setDOM(a,e,t),a}const i=jh.create(String(r));return nu.setDOM(i,e),i},findNode:e=>Qh.get(e),setDOM:(e,t,n)=>{Qh.set(t,e),n&&qh.isElement(e)&&nu.setSchemaType(e,t,n)},setSchemaType:(e,t,n)=>{const r=n.getType(t);r&&eu.set(e,r);const i=n.find(t=>t.name===e.type&&!0===t.isVoid).length>0;tu.set(e,i)},isBlock:e=>!!qh.isElement(e)&&"block"===eu.get(e),isInline:e=>!!qh.isElement(e)&&"inline"===eu.get(e),isMark:e=>!!qh.isElement(e)&&"mark"===eu.get(e),isVoid:e=>!!qh.isElement(e)&&(!0===tu.get(e)||~["img","br","area","col","embed","hr","input","link","meta","param","source","track","wbr"].indexOf(e.type)),get:(e,t)=>{let n=e;for(const e of t){if(!qh.isElement(n))throw new Error("Cannot find element");n=n.children[e]}return n}},ru=(e,t,n=null)=>{if(t&&t.isConnected||(t=n),!t)return n;for(;t.parentNode!==e;){const r=t.parentNode;if(!r||!e.contains(r))return n;t=r}return t},iu=(e,t,n,r,i=0,s=!1)=>{const o=Math.max(t.length,n.length),a=[];for(let l=0;l<o;l++){const o=t[l],c=n[l],d=r.concat(l+i);if(o)if(c){const t=qh.isElement(o),n=t?o:null,r=t?null:o,i=qh.isElement(c),l=i?c:null,h=i?null:c;if(s=s||!!l&&ou(e,l),t!==i||n&&l&&n.type!==l.type){a.unshift({type:"remove_node",path:d,node:o,undoable:s}),a.push({type:"insert_node",path:d,node:c,undoable:s});continue}let u=!1;const f=e=>{const t={};for(const n in e)~["children","text","type"].indexOf(n)||(t[n]=e[n]);return t},g=f(o),p=Object.keys(g).length,m=f(c);if(p!==Object.keys(m).length)u=!0;else for(const e in g)if(g[e]!==m[e]){u=!0;break}if(u){const t=m[ui],n={type:"set_node",path:d,properties:g,newProperties:m,undoable:s};if(t){const r=ms(t),i=e.card.find(r.id);i?.writeHistoryOnValueChange&&!1===i.writeHistoryOnValueChange(r)&&(n.undoable=!0)}a.push(n)}n&&l?a.push(...iu(e,n.children,l.children,d,0,s)):r&&h&&r.text!==h.text&&a.push(...su(r.text,h.text,d,s))}else a.unshift({type:"remove_node",path:r.concat(l+i),node:o});else a.push({type:"insert_node",path:d,node:c})}return a},su=(e,t,n,r=!1)=>{const i=[],s=(new a).patch_make(e,t);return Object.keys(s).forEach(e=>{const t=s[e];if(null===t.start1)return;let o=t.start1;t.diffs.forEach(e=>{const[t,s]=e;t!==l?t!==c?t===d&&(o+=s.length):i.push({type:"insert_text",text:s,path:n,offset:o,undoable:r}):i.unshift({type:"remove_text",text:s,path:n,offset:o,undoable:r})})}),i},ou=(e,t)=>{const n=t[ci],r=t[hi],i=t[Fr];if(n&&r&&i){const t=e.container.get()?.querySelector(`[${Fr}="${i}"]`);if(t?.getAttribute(gi))return!0}return!1},au={transform:(e,t)=>{const n=[],r=(e,t,n,r)=>{const{previousSibling:i,nextSibling:s}=e;(n&&(!i||i.compareDocumentPosition(n)&globalThis.Node.DOCUMENT_POSITION_PRECEDING)||i?.parentNode!==e.node)&&(e.previousSibling=ru(e.node,n,i)),(r&&(!s||s.compareDocumentPosition(r)&globalThis.Node.DOCUMENT_POSITION_FOLLOWING)||s?.parentNode!==e.node)&&(e.nextSibling=ru(e.node,r,s)),e.previousSibling===t&&(e.previousSibling=t.previousSibling),e.nextSibling===t&&(e.nextSibling=t.nextSibling),e.previousSibling!==n&&e.previousSibling?.contains(n)&&(e.previousSibling=e.previousSibling.previousSibling),e.nextSibling!==r&&e.nextSibling?.contains(r)&&(e.nextSibling=e.nextSibling.nextSibling)},i=(e,t,i)=>{let s=!1;for(const o of n){const{node:n}=o;if(e===n||n.contains(e))s=!0,r(o,n,t,i);else if(e.contains(n)){s=!0,o.node=e;const{previousSibling:a,nextSibling:l}=o;o.previousSibling=ru(e,t,a),o.nextSibling=ru(e,i,l),r(o,n,a,l)}}return s};for(const e of t){const{type:t,attributeName:r}=e;let s=e.target,o=!1;if(Dh(s)&&Di(s)&&(o=!0),!s.isConnected||hc(s)||"attributes"===t&&(o||r&&fc(s,r)))continue;let{previousSibling:a,nextSibling:l}=e;if("childList"===t){const{addedNodes:t}=e;t.length>0&&(a||(a=t[0].previousSibling),l||(l=t[t.length-1].nextSibling)),!a&&l&&(a=l.previousSibling),!l&&a&&(l=a.nextSibling)}else if(("characterData"===t||"attributes"===t)&&(a||(a=s.previousSibling),l||(l=s.nextSibling),"attributes"===t||!Dh(s))){const e=s.parentElement;if(!e||hc(e))continue;s=e}i(s,a,l)||n.push({node:s,previousSibling:ru(s,a),nextSibling:ru(s,l)})}const s=[];for(const t of n){const{node:n}=t;let{previousSibling:r,nextSibling:i}=t;const o=nu.findNode(n);if(!o)continue;if(!qh.isElement(o))throw new Error("parentNode is not an element");const a=Jh.getPath(o);if(r)for(;(hc(r)||r===n.firstChild)&&(r=r.previousSibling,r););if(i)for(;(hc(i)||i===n.lastChild)&&(i=i.nextSibling,i););const l=r?nu.findNode(r):null,c=i?nu.findNode(i):null;let d=l?Jh.getIndex(l):-1;const h=c?Jh.getIndex(c):o.children.length,u=[];let f=l?r?.nextSibling:null;for(f||(f=n.firstChild,d=-1);f&&f!==i;){const t=nu.createFromDOM(f,e.schema);t&&u.push(t),f=f.nextSibling}const g=d+1,p=o.children.slice(g,h);s.push(...iu(e,p,u,a,g)),o.children.splice(g,p.length,...u);for(let e=g;e<o.children.length;e++)Jh.setPath(o.children[e],o,e)}return s},diff:iu,inverse:e=>{if("insert_node"===e.type)return{...e,type:"remove_node"};if("remove_node"===e.type)return{...e,type:"insert_node"};if("insert_text"===e.type)return{...e,type:"remove_text"};if("remove_text"===e.type)return{...e,type:"insert_text"};if("set_node"===e.type){const{properties:t,newProperties:n}=e;return{...e,type:"set_node",properties:n,newProperties:t}}},isReverse:(e,t)=>{if("insert_node"===e.type&&"remove_node"===t.type||"remove_node"===e.type&&"insert_node"===t.type)return Wl(e.node,t.node)&&Jh.isEqual(e.path,t.path);if("insert_text"===e.type&&"remove_text"===t.type){const n=e.path.concat(e.offset),r=t.path.concat(t.offset);return Wl(e.text,t.text)&&(Wl(n,r)||Jh.isReverse(n,r,e.text.length)||Jh.isReverse(r,n,e.text.length))}if("remove_text"===e.type&&"insert_text"===t.type){const n=e.path.concat(e.offset),r=t.path.concat(t.offset);return Wl(e.text,t.text)&&Wl(n,r)}return!1},canOpAffectPath:(e,t)=>null!==Jh.commonLength(t,e.path)},lu={adjustX:!0,adjustY:!0},cu=[0,0];var du={left:{points:["cr","cl"],overflow:lu,offset:[-4,0],targetOffset:cu},right:{points:["cl","cr"],overflow:lu,offset:[4,0],targetOffset:cu},top:{points:["bc","tc"],overflow:lu,offset:[0,-4],targetOffset:cu},bottom:{points:["tc","bc"],overflow:lu,offset:[0,4],targetOffset:cu},topLeft:{points:["bl","tl"],overflow:lu,offset:[0,-4],targetOffset:cu},leftTop:{points:["tr","tl"],overflow:lu,offset:[-4,0],targetOffset:cu},topRight:{points:["br","tr"],overflow:lu,offset:[0,-4],targetOffset:cu},rightTop:{points:["tl","tr"],overflow:lu,offset:[4,0],targetOffset:cu},bottomRight:{points:["tr","br"],overflow:lu,offset:[0,4],targetOffset:cu},rightBottom:{points:["bl","br"],overflow:lu,offset:[4,0],targetOffset:cu},bottomLeft:{points:["tl","bl"],overflow:lu,offset:[0,4],targetOffset:cu},leftBottom:{points:["br","bl"],overflow:lu,offset:[-4,0],targetOffset:cu}};Fs(".data-tooltip {\r\n    font-size: 14px;\r\n    font-variant: tabular-nums;\r\n    line-height: 1.5;\r\n    color: rgba(0, 0, 0, 0.65);\r\n    -webkit-box-sizing: border-box;\r\n    box-sizing: border-box;\r\n    margin: 0;\r\n    padding: 0;\r\n    list-style: none;\r\n    position: absolute;\r\n    z-index: 1060;\r\n    display: block;\r\n    visibility: visible;\r\n    max-width: 320px;\r\n    word-wrap: break-word;\r\n    top: 0;\r\n}\r\n\r\n.data-tooltip-hidden {\r\n    opacity: 0;\r\n    visibility: hidden;\r\n    transition: opacity 0.3s ease-in-out;\r\n}\r\n\r\n.data-tooltip-active {\r\n    opacity: 1;\r\n    visibility: visible;\r\n}\r\n\r\n.data-tooltip-placement-top, .data-tooltip-placement-topLeft, .data-tooltip-placement-topRight {\r\n    padding-bottom: 8px;\r\n}\r\n\r\n.data-tooltip-placement-right, .data-tooltip-placement-rightTop, .data-tooltip-placement-rightBottom {\r\n    padding-left: 8px;\r\n}\r\n\r\n.data-tooltip-placement-bottom, .data-tooltip-placement-bottomLeft, .data-tooltip-placement-bottomRight {\r\n    padding-top: 8px;\r\n}\r\n\r\n.data-tooltip-placement-left, .data-tooltip-placement-leftTop, .data-tooltip-placement-leftBottom {\r\n    padding-right: 8px;\r\n}\r\n\r\n.data-tooltip-inner {\r\n    padding: 6px 8px;\r\n    color: #fff;\r\n    text-align: left;\r\n    text-decoration: none;\r\n    background-color: rgba(0, 0, 0, 0.75);\r\n    border-radius: 4px;\r\n    -webkit-box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);\r\n    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);\r\n    word-wrap: break-word;\r\n}\r\n\r\n.data-tooltip-arrow {\r\n    position: absolute;\r\n    width: 0;\r\n    height: 0;\r\n    border-color: transparent;\r\n    border-style: solid;\r\n}\r\n\r\n.data-tooltip-placement-top .data-tooltip-arrow, .data-tooltip-placement-topLeft .data-tooltip-arrow, .data-tooltip-placement-topRight .data-tooltip-arrow {\r\n    bottom: 3px;\r\n    border-width: 5px 5px 0;\r\n    border-top-color: rgba(0, 0, 0, 0.75);\r\n}\r\n\r\n.data-tooltip-placement-top .data-tooltip-arrow {\r\n    left: 50%;\r\n    margin-left: -5px;\r\n}\r\n\r\n.data-tooltip-placement-topLeft .data-tooltip-arrow {\r\n    left: 16px;\r\n}\r\n\r\n.data-tooltip-placement-topRight .data-tooltip-arrow {\r\n    right: 16px;\r\n}\r\n\r\n.data-tooltip-placement-right .data-tooltip-arrow, .data-tooltip-placement-rightTop .data-tooltip-arrow, .data-tooltip-placement-rightBottom .data-tooltip-arrow {\r\n    left: 3px;\r\n    border-width: 5px 5px 5px 0;\r\n    border-right-color: rgba(0, 0, 0, 0.75);\r\n}\r\n\r\n.data-tooltip-placement-right .data-tooltip-arrow {\r\n    top: 50%;\r\n    margin-top: -5px;\r\n}\r\n\r\n.data-tooltip-placement-rightTop .data-tooltip-arrow {\r\n    top: 8px;\r\n}\r\n\r\n.data-tooltip-placement-rightBottom .data-tooltip-arrow {\r\n    bottom: 8px;\r\n}\r\n\r\n.data-tooltip-placement-left .data-tooltip-arrow, .data-tooltip-placement-leftTop .data-tooltip-arrow, .data-tooltip-placement-leftBottom .data-tooltip-arrow {\r\n    right: 3px;\r\n    border-width: 5px 0 5px 5px;\r\n    border-left-color: rgba(0, 0, 0, 0.75);\r\n}\r\n\r\n.data-tooltip-placement-left .data-tooltip-arrow {\r\n    top: 50%;\r\n    margin-top: -5px;\r\n}\r\n\r\n.data-tooltip-placement-leftTop .data-tooltip-arrow {\r\n    top: 8px;\r\n}\r\n\r\n.data-tooltip-placement-leftBottom .data-tooltip-arrow {\r\n    bottom: 8px;\r\n}\r\n\r\n.data-tooltip-placement-bottom .data-tooltip-arrow, .data-tooltip-placement-bottomLeft .data-tooltip-arrow, .data-tooltip-placement-bottomRight .data-tooltip-arrow {\r\n    top: 3px;\r\n    border-width: 0 5px 5px;\r\n    border-bottom-color: rgba(0, 0, 0, 0.75);\r\n}\r\n\r\n.data-tooltip-placement-bottom .data-tooltip-arrow {\r\n    left: 50%;\r\n    margin-left: -5px;\r\n}\r\n\r\n.data-tooltip-placement-bottomLeft .data-tooltip-arrow {\r\n    left: 16px;\r\n}\r\n\r\n.data-tooltip-placement-bottomRight .data-tooltip-arrow {\r\n    right: 16px;\r\n}\r\n");class hu{static show(e,t,n={placement:"top"}){hu.hide();const r=Ss((e=>`\n    <div ${Hr}="tooltip" class="data-tooltip data-tooltip-placement-${e.placement} data-tooltip-hidden" style="transform-origin: 50% 45px 0px;">\n        <div class="data-tooltip-content">\n            <div class="data-tooltip-arrow"></div>\n            <div class="data-tooltip-inner" data-role="tooltip"></div>\n        </div>\n    </div>`)(n));"string"==typeof t?r.find("[data-role=tooltip]").html(t):r.find("[data-role=tooltip]").append(t);const i=ii();Ss(i.body).append(r);const s=h(r.get(),e.get(),{...du[n.placement]}),o=Object.keys(du).find(e=>{const t=du[e].points;return t[0]===s.points[0]&&t[1]===s.points[1]});o!==n.placement&&r.removeClass(`data-tooltip-placement-${n.placement}`).addClass(`data-tooltip-placement-${o}`),r.addClass("data-tooltip-active")}static hide(){const e=ii();Ss(e.body).find(`div[${Hr}=tooltip]`).remove()}}let uu=class{constructor(e){this.options=e,this.root=Ss((e=>`\n    <span class="data-toolbar-item">\n        <a class="data-toolbar-btn"${e.disabled?' disabled="disabled"':""} ${e.link?' href="'+e.link+'" target="_blank"':""}>\n            ${e.content}\n        </a>\n    </span>`)(e)),e.style&&this.root.attributes("style",e.style),e.class&&this.root.addClass(e.class)}getPlacement(){return(this.root.closest(".data-toolbar").attributes("data-placement")||"top").startsWith("top")?"top":"bottom"}render(e){const{title:t,didMount:n,onClick:r,link:i}=this.options;e.append(this.root),t&&(this.root.on("mouseenter",()=>{const e=this.getPlacement();hu.show(this.root,"function"==typeof t?t():t,{placement:e})}),this.root.on("mouseleave",()=>{hu.hide()}),this.root.on("mousedown",()=>{hu.hide()})),!i&&r&&this.root.find("a").on("click",e=>{e.preventDefault(),e.stopPropagation(),r(e,this.root)}),n&&n(this.root)}};class fu{constructor(e){this.options=e}renderTo(e){this.root=Ss((e=>{let t=!!e.checked;return e.getState&&(t=e.getState()),`\n    <div class="data-toolbar-item data-toolbar-dropdown-item data-toolbar-dropdown-switch">\n        <span class="data-toolbar-dropdown-item-content"${e.disabled?' disabled="disabled"':""}>${e.content}</span>\n        <button type="button"${e.disabled?' disabled="disabled"':""} role="switch" aria-checked="true" class="switch-btn ${t?" switch-checked":""}">\n            <div class="switch-handle"></div>\n            <span class="switch-inner"></span>\n        </button>\n    </div>`})(this.options)),this.switch=this.root.find(".switch-btn"),e.append(this.root),this.root.on("mousedown",e=>e.preventDefault());const{onClick:t}=this.options;this.root.on("click",e=>{e.stopPropagation(),t&&(t(e,this.root),this.updateSwitch())})}updateSwitch(){this.options.getState&&(this.options.getState()?this.switch?.addClass("switch-checked"):this.switch?.removeClass("switch-checked"))}}class gu{constructor(e){this.options=e}renderTo(e){var t;this.root=Ss(`\n    <div class="data-toolbar-item data-toolbar-dropdown-item data-toolbar-dropdown-btn">\n        <span class="data-toolbar-dropdown-item-content"${(t=this.options).disabled?' disabled="disabled"':""}>\n            ${t.content}\n        </span>\n    </div>`),e.append(this.root);const{onClick:n}=this.options;n&&this.root.on("click",e=>n(e,this.root))}}class pu{constructor(e){this.documentMouseDown=e=>{this.root&&!this.root[0].contains(e.target)&&this.dropdown?.hasClass("show")&&this.hideDropdown()},this.options=e}initToggleEvent(){if(!this.root)return;const e=this.root.find(".data-toolbar-dropdown");e.on("mousedown",e=>{e.preventDefault(),e.stopPropagation()}),e.on("click",e=>{e.stopPropagation(),this.toggleDropdown()}),document.addEventListener("mousedown",this.documentMouseDown,!0)}toggleDropdown(){this.dropdown?.hasClass("show")?this.hideDropdown():this.showDropdown()}showDropdown(){this.dropdown?.addClass("show")}hideDropdown(){this.dropdown?.removeClass("show")}getPlacement(){return(this.root&&this.root.closest(".data-toolbar").attributes("data-placement")||"top").startsWith("top")?"top":"bottom"}renderTooltip(){const{title:e}=this.options;e&&this.root&&(this.root.on("mouseenter",()=>{const t=this.getPlacement();this.root&&hu.show(this.root,"function"==typeof e?e():e,{placement:t})}),this.root.on("mouseleave",()=>{hu.hide()}),this.root.on("mousedown",()=>{hu.hide()}))}renderDropdown(){if(!this.root)return;this.dropdown=this.root.find(".dropdown-container");const{items:e}=this.options;e.forEach(e=>{if(this.dropdown)switch(e.type){case"switch":return new fu(e).renderTo(this.dropdown);case"button":return new gu(e).renderTo(this.dropdown)}}),this.dropdown.on("click",e=>{e.stopPropagation(),this.hideDropdown()})}render(e){var t;this.root=Ss(`\n    <span class="data-toolbar-item data-toolbar-item-dropdown">\n        <a class="data-toolbar-btn data-toolbar-dropdown"${(t=this.options).disabled?' disabled="disabled"':""}>${t.content}</a>\n        <div class="dropdown-container"></div>\n    </span>`),e.append(this.root),this.initToggleEvent(),this.renderTooltip(),this.renderDropdown();const{didMount:n}=this.options;n&&n(this.root)}destroy(){document.removeEventListener("mousedown",this.documentMouseDown,!0)}}class mu{constructor(e){this.options=e,this.root=Ss((e=>`\n    <span class="data-toolbar-item data-toolbar-item-input">\n        ${e.prefix?"<span class='data-toolbar-input-prefix'>"+cs(e.prefix)+"</span>":""}<input data-role="input" placeholder="${cs(e.placeholder)}" class="data-toolbar-input" type="input" value="${cs(e.value.toString())}" />${e.suffix?"<span class='data-toolbar-input-suffix'>"+cs(e.suffix)+"</span>":""}\n    </span>`)(e)),this.onEnter=e.onEnter||(()=>{}),this.onInput=e.onInput||(()=>{}),this.onChange=e.onChange||(()=>{})}find(e){const t="[data-role=".concat(e,"]");return this.root.find(t)}render(e){const{value:t,didMount:r}=this.options,i=this.find("input"),s=i.get();s&&(s.value=(void 0!==t?t:"").toString(),i.on("keydown",e=>{e.stopPropagation(),n("enter",e)&&(e.preventDefault(),s.blur(),this.onEnter(s.value))}),i.on("input",()=>{this.onInput(s.value)}),i.on("change",()=>{setTimeout(()=>{this.onChange(s.value)},10)}),e.append(this.root),r&&r(this.root))}}class bu{constructor(e){this.options=e,this.root=Ss((e=>{let t=!!e.checked;return e.getState&&(t=e.getState()),`\n    <div class="data-toolbar-switch">\n        <span class="switch-content"${e.disabled?' disabled="disabled"':""}>${e.content}</span>\n        <button type="button" role="switch" aria-checked="true" class="switch-btn ${t?" switch-checked":""}"${e.disabled?' disabled="disabled"':""}>\n            <div class="switch-handle"></div>\n            <span class="switch-inner"></span>\n        </button>\n    </div>`})(e)),this.switch=this.root.find(".switch-btn"),e.class&&this.root.addClass(e.class)}render(e){const{didMount:t,onClick:n}=this.options;e.append(this.root),this.root.on("mousedown",e=>e.preventDefault()),this.root.on("click",e=>{e.stopPropagation(),n&&(n(e,this.root),this.updateSwitch())}),t&&t(this.root)}updateSwitch(){this.options.getState&&(this.options.getState()?this.switch?.addClass("switch-checked"):this.switch?.removeClass("switch-checked"))}}Fs('.data-toolbar {\r\n    position: absolute;\r\n    opacity: 0;\r\n    visibility: hidden;\r\n    width: auto;\r\n    line-height: 26px;\r\n    display: flex;\r\n    flex-direction: row;\r\n    font-size: 14px;\r\n    font-weight: normal;\r\n    text-indent: 0;\r\n    -webkit-user-select: none;\r\n    user-select: none;\r\n    z-index: 127;\r\n}\r\n\r\n.data-toolbar-active {\r\n    opacity: 1;\r\n    visibility: visible;\r\n}\r\n\r\n.data-toolbar-block {\r\n    top: auto;\r\n    bottom: -46px;\r\n    left: -1px;\r\n    right: auto;\r\n    height: 40px;\r\n}\r\n\r\n.data-toolbar-btn {\r\n    line-height: 26px;\r\n    min-width: 28px;\r\n    display: inline-block;\r\n    text-align: center;\r\n    color: #595959;\r\n    transition: background-color 0.3s ease-in-out;\r\n    cursor: pointer;\r\n}\r\n\r\n.data-toolbar-btn-disabled, .data-toolbar-btn-disabled:hover {\r\n    background-color: transparent;\r\n    box-shadow: none;\r\n    cursor: not-allowed;\r\n}\r\n\r\n.data-toolbar-group {\r\n    border: 1px solid rgba(226, 226, 226, 0.84);\r\n    border-radius: 4px;\r\n    box-shadow: 0px 2px 4px 0px rgb(225 225 225 / 50%);\r\n    background: #fff;\r\n    position: relative;\r\n    display: inline-flex;\r\n    padding: 5px;\r\n    align-items: center;\r\n}\r\n\r\n.data-toolbar-item {\r\n    position: relative;\r\n    display: inline-block;\r\n    line-height: 26px;\r\n    text-align: left;\r\n    color: #595959;\r\n    flex: 0 0 auto;\r\n    font-size: 12px;\r\n    cursor: pointer;\r\n}\r\n\r\n.data-toolbar-item:not(.data-toolbar-item-input):hover, .data-toolbar-item.active:not(.data-toolbar-item-input) {\r\n    background-color: #f4f4f4;\r\n    border-radius: 2px;\r\n}\r\n\r\n.data-toolbar-item > * {\r\n    font-size: 12px !important;\r\n}\r\n\r\n.data-toolbar-item[disabled] {\r\n    opacity: 0.5;\r\n    cursor: not-allowed;\r\n}\r\n\r\n.data-toolbar-item-split {\r\n    width: 1px;\r\n    height: 16px;\r\n    line-height: 16px;\r\n    margin: 6px 4px;\r\n    border-left: 1px solid #e8e8e8;\r\n    display: inline-block;\r\n}\r\n\r\n.data-toolbar-item-dropdown-active {\r\n    opacity: 1;\r\n    visibility: visible;\r\n    transform: translateY(0px);\r\n}\r\n\r\n.data-toolbar-item-input {\r\n    display: flex;\r\n    margin: 0 4px;\r\n}\r\n\r\n.data-toolbar-item-input .data-toolbar-input {\r\n    width: 46px;\r\n    line-height: 12px;\r\n    font-size: 12px;\r\n    outline: none;\r\n    border: 1px solid #dadada;\r\n    border-radius: 4px;\r\n}\r\n\r\n.data-toolbar-item-input .data-toolbar-input::selection {\r\n    color: inherit;\r\n    background: transparent\r\n}\r\n\r\n.data-toolbar-item-input .data-toolbar-input:focus::selection {\r\n    color: #fff;\r\n    background: #1890ff;\r\n}\r\n\r\n.data-toolbar-item-dropdown .dropdown-container {\r\n    display: none;\r\n    position: absolute;\r\n    padding: 8px 0;\r\n    top: 100%;\r\n    margin-top: 6px;\r\n    border-radius: 2px;\r\n    background-color: #fff;\r\n    box-shadow: 0 1px 4px -2px rgba(0, 0, 0, 0.13), 0 2px 8px 0 rgba(0, 0, 0, 0.08), 0 8px 16px 4px rgba(0, 0, 0, 0.04);\r\n    z-index: 99999;\r\n}\r\n\r\n.data-toolbar-item-dropdown .dropdown-container.show {\r\n    display: block;\r\n}\r\n\r\n.data-toolbar-dropdown-item {\r\n    padding: 2px 16px;\r\n    margin: 0;\r\n    white-space: nowrap;\r\n    line-height: 26px;\r\n    color: #404040;\r\n    cursor: pointer;\r\n    display: block;\r\n}\r\n\r\n.data-toolbar-dropdown-item:hover {\r\n    background-color: #f5f5f5;\r\n}\r\n\r\n.data-toolbar-dropdown-switch {\r\n    display: flex;\r\n    align-items: center;\r\n}\r\n\r\n.data-toolbar-dropdown-switch .data-toolbar-dropdown-item-content {\r\n    flex: 1;\r\n    margin-right: 4px;\r\n}\r\n\r\n.data-toolbar-dropdown-switch .switch-btn {\r\n    margin: 0;\r\n    padding: 0;\r\n    color: #595959;\r\n    font-size: 14px;\r\n    font-variant: tabular-nums;\r\n    line-height: 1.5;\r\n    list-style: none;\r\n    -webkit-font-feature-settings: "tnum";\r\n    font-feature-settings: "tnum";\r\n    position: relative;\r\n    display: inline-block;\r\n    -webkit-box-sizing: border-box;\r\n    box-sizing: border-box;\r\n    vertical-align: middle;\r\n    background-color: rgba(0, 0, 0, .25);\r\n    border: 0;\r\n    border-radius: 100px;\r\n    cursor: pointer;\r\n    -webkit-transition: all .2s;\r\n    transition: all .2s;\r\n    -webkit-user-select: none;\r\n    -moz-user-select: none;\r\n    -ms-user-select: none;\r\n    user-select: none;\r\n    min-width: 28px;\r\n    height: 16px;\r\n    line-height: 16px;\r\n}\r\n\r\n.data-toolbar-dropdown-switch .switch-btn.switch-checked {\r\n    background-color: #347EFF\r\n}\r\n\r\n.data-toolbar-dropdown-switch .switch-btn .switch-handle {\r\n    top: 2px;\r\n    left: 2px;\r\n    width: 12px;\r\n    height: 12px;\r\n}\r\n\r\n.data-toolbar-dropdown-switch .switch-btn .switch-handle, .data-toolbar-dropdown-switch .switch-btn .switch-handle:before {\r\n    position: absolute;\r\n    -webkit-transition: all .2s ease-in-out;\r\n    transition: all .2s ease-in-out;\r\n}\r\n\r\n.data-toolbar-dropdown-switch .switch-btn.switch-checked .switch-handle {\r\n    left: calc(100% - 14px);\r\n}\r\n\r\n.data-toolbar-dropdown-switch .switch-btn .switch-handle:before {\r\n    top: 0;\r\n    right: 0;\r\n    bottom: 0;\r\n    left: 0;\r\n    background-color: #fff;\r\n    border-radius: 9px;\r\n    -webkit-box-shadow: 0 2px 4px 0 rgb(0 35 11 / 20%);\r\n    box-shadow: 0 2px 4px 0 rgb(0 35 11 / 20%);\r\n    content: "";\r\n}\r\n\r\n.data-toolbar-dropdown-switch .switch-btn .switch-inner {\r\n    display: block;\r\n    margin: 0 5px 0 18px;\r\n    font-size: 12px;\r\n    color: #fff;\r\n    -webkit-transition: margin .2s;\r\n    transition: margin .2s;\r\n}\r\n\r\n.data-toolbar-dropdown-switch .switch-btn.switch-checked .switch-inner {\r\n    margin: 0 18px 0 5px;\r\n}\r\n\r\n.data-toolbar-switch {\r\n    display: flex;\r\n    align-items: center;\r\n    padding: 0 4px;\r\n    cursor: pointer;\r\n    width: max-content;\r\n}\r\n\r\n.data-toolbar-switch:hover {\r\n    background-color: #f4f4f4;\r\n    border-radius: 2px;\r\n}\r\n\r\n.data-toolbar-switch .switch-content {\r\n    flex: 1;\r\n    margin-right: 4px;\r\n}\r\n\r\n.data-toolbar-switch .switch-btn {\r\n    margin: 0;\r\n    padding: 0;\r\n    color: #595959;\r\n    font-size: 14px;\r\n    font-variant: tabular-nums;\r\n    line-height: 1.5;\r\n    list-style: none;\r\n    -webkit-font-feature-settings: "tnum";\r\n    font-feature-settings: "tnum";\r\n    position: relative;\r\n    display: inline-block;\r\n    -webkit-box-sizing: border-box;\r\n    box-sizing: border-box;\r\n    vertical-align: middle;\r\n    background-color: rgba(0, 0, 0, .25);\r\n    border: 0;\r\n    border-radius: 100px;\r\n    cursor: pointer;\r\n    -webkit-transition: all .2s;\r\n    transition: all .2s;\r\n    -webkit-user-select: none;\r\n    -moz-user-select: none;\r\n    -ms-user-select: none;\r\n    user-select: none;\r\n    min-width: 28px;\r\n    height: 16px;\r\n    line-height: 16px;\r\n}\r\n\r\n.data-toolbar-switch .switch-btn.switch-checked {\r\n    background-color: #347EFF\r\n}\r\n\r\n.data-toolbar-switch .switch-btn .switch-handle {\r\n    top: 2px;\r\n    left: 2px;\r\n    width: 12px;\r\n    height: 12px;\r\n}\r\n\r\n.data-toolbar-switch .switch-btn .switch-handle, .data-toolbar-switch .switch-btn .switch-handle:before {\r\n    position: absolute;\r\n    -webkit-transition: all .2s ease-in-out;\r\n    transition: all .2s ease-in-out;\r\n}\r\n\r\n.data-toolbar-switch .switch-btn.switch-checked .switch-handle {\r\n    left: calc(100% - 14px);\r\n}\r\n\r\n.data-toolbar-switch .switch-btn .switch-handle:before {\r\n    top: 0;\r\n    right: 0;\r\n    bottom: 0;\r\n    left: 0;\r\n    background-color: #fff;\r\n    border-radius: 9px;\r\n    -webkit-box-shadow: 0 2px 4px 0 rgb(0 35 11 / 20%);\r\n    box-shadow: 0 2px 4px 0 rgb(0 35 11 / 20%);\r\n    content: "";\r\n}\r\n\r\n.data-toolbar-switch .switch-btn .switch-inner {\r\n    display: block;\r\n    margin: 0 5px 0 18px;\r\n    font-size: 12px;\r\n    color: #fff;\r\n    -webkit-transition: margin .2s;\r\n    transition: margin .2s;\r\n}\r\n\r\n.data-toolbar-switch .switch-btn.switch-checked .switch-inner {\r\n    margin: 0 18px 0 5px;\r\n}\r\n');class vu{constructor(e){this.items=[],this.options={...e},this.root=Ss(`<div ${Hr}="ui" class="data-toolbar data-toolbar-active" ${Rs}="false"></div>`)}getPlacement(){return(this.root.attributes("data-placement")||"top").startsWith("top")?"top":"bottom"}addItems(e){this.options.items.forEach(t=>{let n;if("button"===t.type&&(n=new uu(t),n.render(e)),"switch"===t.type&&(n=new bu(t),n.render(e)),"input"===t.type){n=new mu(t),n.render(e)}if("dropdown"===t.type&&(n=new pu(t),n.render(e)),"node"===t.type){const n=t,r=n.node;r.addClass("data-toolbar-item");const{title:i}=n;i&&(r.on("mouseenter",()=>{const e=this.getPlacement();hu.show(r,"function"==typeof i?i():i,{placement:e})}),r.on("mouseleave",()=>{hu.hide()}),r.on("mousedown",()=>{hu.hide()})),e.append(r),t.didMount&&t.didMount(r)}n&&this.items.push(n)})}find(e){const t="[data-role=".concat(e,"]");return this.root.find(t)}destroy(){this.root.remove()}hide(){this.root.removeClass("data-toolbar-active")}show(){this.root.addClass("data-toolbar-active")}renderGroup(){return Ss('<div class="data-toolbar-group"></div>')}render(e){const t=this.renderGroup();return this.root.append(t),this.addItems(t),e&&e.append(this.root),this.root.addClass("data-toolbar-block"),this.root}update(e){this.options=e,this.root.empty();const t=this.renderGroup();this.root.append(t),this.addItems(t)}}const yu="ot-user-cursor-card",wu="ot-card-mask",Nu="ot-user-cursor-trigger",xu="ot-user-cursor-trigger-active",Eu=new Map,Cu=new Map,ku=new Map;class Tu{constructor(e){this.engine=e,this.root=e.root,this.hideCursorInfoTimeoutMap={}}destroy(){for(const[e,t]of Eu)t.remove(),Eu.delete(e);for(const[e,t]of Cu)t.remove(),Cu.delete(e);for(const[e,t]of ku)t.remove(),ku.delete(e)}getRectWithRange(e,t){const n=t.getClientRect(),r=e.get()?.getBoundingClientRect();return new DOMRect(n.left-(r?.left||0),n.top-(r?.top||0),n.right-n.left,n.bottom-n.top)}isWrapByRange(e){const t=e.cloneRange().collapse(!0).getClientRect(),n=e.cloneRange().collapse(!1).getClientRect();return t.bottom!==n.bottom}drawSubRang(e,t,n,r){const{startOffset:i,startNode:s,endNode:o}=n;let a=n.startOffset;const l=n.endOffset;let c=n.getClientRect().top,d=i;for(;a<l;){n.setStart(n.commonAncestorContainer,a),n.setEnd(n.commonAncestorContainer,a+1);const i=n.getClientRect();if(i.top>c||a===l-1){n.setStart(n.commonAncestorContainer,d),d=a,c=i.top;const s=this.getRectWithRange(e,n);t.clearRect(s),t.drawRect({...s.toJSON(),...r})}a++}n.setStart(s,i),n.setEnd(o,l)}drawBackground(e,n){const{card:r}=this.engine,{uuid:i,color:s}=n;let o,a=Eu.get(i);const l=this.engine.scrollNode??this.root,c=()=>{if(a&&a.length>0){a.attributes(Bs,s.toString());const e=a[0].__canvas;return a[0].__clear||(e.clear(),a[0].__clear=!0),e}};if(e.collapsed)return c(),[e];a&&a.length>0?o=c():(a=Ss(`<div class="ot-user-background" ${_s}="${i}" ${Bs}="${s}" />`),l.append(a),Eu.set(i,a),o=new Vi({container:a.get()}),a[0].__canvas=o),a.get().style.cssText="position: absolute; top: 0; left: 0; transform: translateX(0) translateY(0); will-change: transform; pointer-events: none;",a[0].__range=e.cloneRange();const d=l.get()?.clientWidth||l.width(),h=this.root.height();o.resize(d,h),a[0].__clear=!1;let u=r.find(e.commonAncestorNode,!0);u&&!u.isCenter(e.commonAncestorNode)&&(u=void 0);const f={fill:t(s).alpha(.3).toRgbString()};let g=e.getSubRanges();if(u?.isEditable&&u.drawBackground){const t=u.drawBackground(a,e,o);if(!1===t)return[e];if(t){if(!Array.isArray(t))return t.x<0&&(o.resize(d-t.x,h),a.css("transform",`translateX(${t.x}px) translateY(0)`),t.x=0),o.clearRect(t),o.drawRect({...t.toJSON(),...f}),[e];g=t}}else if(u)return[e];return g.forEach(e=>{if(this.isWrapByRange(e))this.drawSubRang(a,o,e,f);else{const t=this.getRectWithRange(a,e);o.clearRect(t),o.drawRect(Object.assign({},t.toJSON(),f))}}),g}getNodeRect(e,t){const n=e.parent();if(e.isCard()&&n?.hasClass(this.engine.list.CUSTOMZIE_LI_CLASS)&&n?.first()?.equal(e)&&e.next()&&(e=e.next()),e.isElement()&&(t=e.get().getBoundingClientRect()),e.isText()){const n=gc.create(this.engine).cloneRange();n.select(e,!0),t=n.getClientRect()}return t}getCursorRect(e,t=2){const n=this.root.get()?.getBoundingClientRect()||{top:0,left:0};if(bc(e)){const r=e,{startNode:i}=r;r.shrinkToElementNode();let s=r.getClientRect();if(i.isElement()&&0===s.height){let e=Ss(i[0].childNodes[r.startOffset]);e&&e.length>0?s=this.getNodeRect(e,s):(e=i.first(),e&&e.length>0&&(s=this.getNodeRect(e,s)))}const o=s.top-(n.top||0),a=s.left-(n.left||0)-t,l=s.height;return{top:o+"px",left:a+"px",height:l>0?l+"px":-1,elementHeight:s.height||0}}const r=e,i=gs(r.css("outline-width")),s=r.get()?.getBoundingClientRect()||{top:0,left:0,height:0};let o=s.top-n.top-1,a=s.left-n.left;return i&&(o-=i+1,a-=2),{left:a+"px",top:o+"px",height:0,elementHeight:s.height||0}}setCursorRect(e,t,n){const r=t.get();if(r)if(-1!==n.height){if(r.style.cssText+=`top: 0; left: 0; height: ${n.height}; transform: translateX(${n.left}) translateY(${n.top}); will-change: transform, height;`,0===n.height)return void t.addClass(yu);t.removeClass(yu)}else t.remove(),Cu.delete(e)}showCursorInfo(e,t){const{uuid:n,color:r}=t;this.hideCursorInfoTimeoutMap[n]&&clearTimeout(this.hideCursorInfoTimeoutMap[n]);const i=e.find(`.${Nu}`),s=e.css("background-color");e.attributes("data-old-background-color",s),i.addClass(`${xu}`),e.css("background-color",r),i.css("background-color",r)}hideCursorInfo(e){const t=e.find(`.${Nu}`),n=e.attributes("data-old-background-color");t.removeClass(`${xu}`),e.css("background-color",n),t.css("background-color",n)}drawCursor(e,t,n){const{uuid:r,name:i,color:s}=t;let o=this.getCursorRect(e),a=Cu.get(r);if(a&&a.length>0)this.setCursorRect(r,a,o);else{const n=`\n            <div class="ot-user-cursor" ${_s}="${r}">\n                <div class="${Nu}">${cs(i||"")}</div>\n            </div>`;a=Ss(n),Cu.set(r,a);const l=a.find(`.${Nu}`);if(0===o.elementHeight){let t=0;const n=()=>{t++,o=this.getCursorRect(e),o.elementHeight<20&&t<=50?setTimeout(()=>{n()},20):this.setCursorRect(r,a,o)};n()}else this.setCursorRect(r,a,o);a.on("mouseenter",()=>this.showCursorInfo(a,t));let c=!0;a.on("transitionstart",()=>{c=!1}),a.on("transitionend",()=>{c=!0}),a.on("mouseleave",()=>{c&&this.hideCursorInfo(a)}),a.css("background-color",s),l.css("background-color",s),this.root.append(a)}if(a&&a[0]){a.css("z-index","");const i=this.engine.card.components.find(e=>e.isMaximize);if(i){const t=this.engine.card.closest(bc(e)?e.startNode:e,!0);t&&i.root.equal(t)||a.css("z-index",120)}return a[0].__target=bc(e)?e.toPath(!0):e,!1===n?a:(this.showCursorInfo(a,t),this.hideCursorInfoTimeoutMap[r]&&clearTimeout(this.hideCursorInfoTimeoutMap[r]),this.hideCursorInfoTimeoutMap[r]=setTimeout(()=>{this.hideCursorInfo(a)},2e3),a)}}drawCard(e,t,n){const{language:r}=this.engine,i=this.root.get()?.getBoundingClientRect()||{left:0,top:0,width:0,height:0};let s=e.get()?.getBoundingClientRect()||{left:0,top:0,width:0,height:0};const o=`top: 0; left: 0; transform: translateX(${s.left-i.left}px) translateY(${s.top-i.top}px); will-change: transform;`;let a=ku.get(n.uuid);if(a&&a.length>0)return a[0].__node=e[0],void(a.get().style.cssText=o);if(a=Ss(`<div class="${wu}" ${_s}="${n.uuid}" />`),ku.set(n.uuid,a),a[0].__node=e[0],0===s.height){let t=0;const n=()=>{t++,s=e.get()?.getBoundingClientRect()||{left:0,top:0,width:0,height:0},s.height<20&&t<=50?setTimeout(()=>{n()},20):a&&a.length>0&&(a.get().style.cssText=o+`height: ${s.height}px; width: ${s.width}px;`)};n()}else a.get().style.cssText=o+`height: ${s.height}px; width: ${s.width}px;`;a.on("mouseenter",()=>{this.showCursorInfo(t,n),a&&a.length>0&&hu.show(a,r.get("card","lockAlert").toString(),{placement:"bottomLeft"})}),a.on("mousemove",e=>{const t=Ss(`div[${Hr}=tooltip]`).get();t&&(t.style.cssText=`left: 0; top: 0; transform: translateX(${e.pageX-16}px) translateY(${e.pageY+32}px); will-change: transform;`)}),a.on("mouseleave",()=>{this.hideCursorInfo(t),hu.hide()}),a.on("click",e=>{e.preventDefault(),e.stopPropagation()}),a.on("mousedown",e=>{e.preventDefault(),e.stopPropagation()}),this.root.append(a)}setCardSelectedByOther(e,n){const{uuid:r,color:i}=n||{};if(i){const n=t(i).alpha(.3).toRgbString();let s;return e.selectedByOther||(s=e.onSelectByOther(!0,{color:i,rgb:n})),e.selectedByOther=r,s}e.selectedByOther&&e.onSelectByOther(!1),e.selectedByOther=!1}setCardActivatedByOther(e,n){if(e.isEditable)return;const{uuid:r,color:i}=n||{};if(i){const n=t(i).alpha(.3).toRgbString();let s;return e.activatedByOther||(s=e.onActivateByOther(!0,{color:i,rgb:n})),e.activatedByOther=r,s}e.activatedByOther&&e.onActivateByOther(!1),e.activatedByOther=!1}drawRange(e,t,n){const{card:r}=this.engine,{uuid:i}=t,{commonAncestorNode:s}=e;let o=r.find(s);o&&!o.isCenter(s)&&(o=void 0);const a=[];if(r.each(e=>{e.isEditable||o&&e.root.equal(o.root)||(e.activatedByOther===i&&this.setCardActivatedByOther(e),a.push(i))}),a.length>0){for(let e=0;e<a.length;e++){const t=a[e],n=ku.get(t);n?.remove(),ku.delete(t)}hu.hide()}if(o&&!o.isEditable){const r=this.setCardActivatedByOther(o,t)||o.root;Cu.get(i)?.remove(),Cu.delete(i);const s=o.constructor.collab;if(void 0===s||!0===s){const i=this.drawCursor(r,t,n);i&&this.drawCard(r,i,t),this.drawBackground(e,t)}}else{if(o)return this.drawBackground(e,t),Cu.get(i)?.remove(),void Cu.delete(i);r.each(n=>{const r=n.getCenter();if(r&&r.length>0){if(n.isEditable&&r.contains(e.startNode)&&r.contains(e.endNode)&&(e.startNode.closest(Gr).length>0||e.endNode.closest(Gr).length>0))return void this.setCardSelectedByOther(n);e.isPointInRange(r.get(),0)?this.setCardSelectedByOther(n,t):n.selectedByOther===i&&this.setCardSelectedByOther(n)}});const s=r.getSingleSelectedCard(e);if(s){if(s.isEditable){const t=s.getCenter();if(t.contains(e.startNode)&&t.contains(e.endNode)&&(e.startNode.closest(Gr).length>0||e.endNode.closest(Gr).length>0))return}const r=this.setCardSelectedByOther(s,t)||s.root;this.drawCursor(r,t,n)}else{e.shrinkToElementNode();const r=this.drawBackground(e,t);e.collapsed||(r.forEach(t=>{t.collapsed||(e=t)}),e.shrinkToElementNode(),e.collapse(!1)),this.drawCursor(e,t,n)}}}updateBackgroundPosition(){for(const e of Eu.values()){const t=e.get();if(!t)continue;const n=t.__range,r=e.attributes(_s),i=e.attributes(Bs);this.drawBackground(n,{uuid:r,color:i})}}updateCursorPosition(){for(const[e,t]of Cu){const n=t.get();if(!(n&&n instanceof HTMLElement))continue;let r=n.__target;if(!r)return t.remove(),void Cu.delete(e);if(r.name||(r=gc.fromPath(this.engine,r,!0)),r.startContainer||r.length>0&&r[0].isConnected){const n=this.getCursorRect(r);this.setCursorRect(e,t,n)}else t.remove(),Cu.delete(e)}}updateCardPosition(){const e=this.root.get()?.getBoundingClientRect()||{left:0,top:0};for(const[t,n]of ku){const r=n.get();if(!(r&&r instanceof HTMLElement))continue;const i=r.__node;if(i?.isConnected){const t=i.getBoundingClientRect();r.style.left=t.left-e.left+"px",r.style.top=t.top-e.top+"px"}else(r.parentElement??r.parentNode)?.removeChild(r),ku.delete(t)}}updatePosition(){this.updateBackgroundPosition(),this.updateCursorPosition(),this.updateCardPosition()}updateBackgroundAlpha(e){const n=this.getCursorRect(e);for(const e of Cu.values()){const r=e.get();if(!(r&&r instanceof HTMLElement))continue;const i=r.querySelector(`.${Nu}`),s=r.style.left,o=r.style.top,a=t(r.style.backgroundColor);n.left===s&&n.top===o?a.alpha(.3):a.alpha(1);const l=a.toRgbString();r.style.backgroundColor=l,i&&(i.style.backgroundColor=l)}}render(e,t,n){const{path:r,uuid:i,active:s}=e;if(r){const e=gc.fromPath(this.engine,r,!0);this.drawRange(e,t,s||n)}else this.remove(i)}remove(e){(this.engine.scrollNode?.get()??this.root.get())?.querySelectorAll(`[${_s}="${e}"]`).forEach(t=>{if(t.classList.contains(wu)){const n=t.__node,r=n?this.engine.card.find(n):null;r&&!r.isEditable&&r.activatedByOther===e&&this.setCardActivatedByOther(r)}(t.parentElement??t.parentNode)?.removeChild(t)}),this.engine.card.each(t=>{t.isEditable||t.selectedByOther!==e||this.setCardSelectedByOther(t)})}}const Ou=new WeakMap;class Su extends o{constructor(e){super(),this.data=new Map,this.handleResize=()=>{this.rangeColoring.updatePosition()},this.handleScroll=e=>{const t=this.engine.container.get()?.childNodes;if(t)for(const[n,r]of this.data)if(n!==this.member.getCurrent()?.uuid&&r.path?.start.id){const n=r.path.start.path[0],i=t.item(n);if(i&&e.equal(i)){this.rangeColoring.updatePosition();break}}},this.handleMouseDown=()=>{const e=this.engine.container;e.off("mouseup",this.handleMouseUp),e.off("mousemove",this.emitSelectChange),e.on("mouseup",this.handleMouseUp),e.on("mousemove",this.emitSelectChange)},this.mouseUpTimeout=null,this.handleMouseUp=()=>{const e=this.engine.container;e.off("mouseup",this.handleMouseUp),e.off("mousemove",this.emitSelectChange),this.mouseUpTimeout&&clearTimeout(this.mouseUpTimeout),this.mouseUpTimeout=setTimeout(()=>{this.emitSelectChange()},10)},this.observer=null,this.emitSelectChange=(e=!1)=>{if(this.engine.change.isComposing())return;let t=this.engine.change.range.get();this.observer?.disconnect();const n=this.engine.card.find(t.commonAncestorContainer,!0);if(n?.getSelectionNodes){let r=this.getCardResizeRange(n);r&&(t=r.cloneRange(),this.observer=new ResizeObserver(()=>{r=this.getCardResizeRange(n),r?this.onSelectionChange(r,!0,e):this.observer?.disconnect()}),this.observer.observe(n.root.get()))}if(t.commonAncestorNode.isRoot()||t.commonAncestorNode.inEditor())this.onSelectionChange(t,!0,e,!1);else{const e=this.member.getCurrent();e&&this.removeAttirbute(e.uuid)}},this.engine=e,this.member=Xh.fromEngine(e),this.rangeColoring=new Tu(e),e.container.on("keyup",this.emitSelectChange),e.container.on("mousedown",this.handleMouseDown),e.on("scroll",this.handleScroll,{passive:!0}),window.addEventListener("resize",this.handleResize,{passive:!0})}getCardResizeRange(e){if(e?.getSelectionNodes){const t=e.getSelectionNodes();if(t.length>0){const e=gc.create(this.engine);e.setStart(t[0],0);const n=t[t.length-1];return e.setEnd(n,n.isText()?n.text().length:n.get()?.childNodes.length||0),e}}return null}setAttribute(e,t,n=!1,r=!1){const i=this.data.get(e.uuid);if(e.force||!Wl(i||{},e)){this.data.set(e.uuid,Object.assign({},e,{active:!i}));const s=this.member.getCurrent();e.uuid===s?.uuid?Ou.get(this.engine)||(Ou.set(this.engine,!0),Promise.resolve().then(()=>{Ou.set(this.engine,!1),!0===n&&this.rangeColoring.updatePosition(),this.emit("change",e)})):this.rangeColoring.render(e,t,r)}}removeAttirbute(e){if(!this.data.has(e))return;this.data.delete(e);const t=this.member.getCurrent();e===t?.uuid?this.emit("change",{uuid:e,remove:!0}):this.rangeColoring.remove(e)}getAttribute(e){return this.data.get(e)}onSelectionChange(e,t=!1,n=!1,r=!1){const i=this.member.getCurrent();if(!i)return;const{card:s}=this.engine;e=e.cloneRange();const o=s.active;if(o&&!o.isEditable){const t=o.getCenter();if(hc(o.root)){const t=o.root.prev();t?e.select(t,!0).collapse(!1):(e.setStartBefore(o.root),e.collapse(!0))}else t&&t.length>0&&e.select(t.get(),!0)}if(!o&&!e.collapsed){const t=this.engine.card.find(e.startNode,!0);t&&t.type===Yl.BLOCK&&e.setStart(t.getCenter().parent(),1);const n=this.engine.card.find(e.endNode,!0);n&&n.type===Yl.BLOCK&&e.setEnd(n.getCenter().parent(),1)}const a=e.toPath(!0);this.currentRangePath=e.toPath();const l=this.getAttribute(i.uuid);this.setAttribute(Object.assign({},l,{path:a,uuid:i.uuid,force:t}),i,n,r),this.rangeColoring.updateBackgroundAlpha(e)}refreshAttributes(...e){e.forEach(e=>{const t=this.getAttribute(e.uuid);t&&this.rangeColoring.render(t,e)})}destroy(){const e=this.engine.container;e.off("mouseup",this.handleMouseUp),e.off("mousemove",this.emitSelectChange),e.off("keyup",this.emitSelectChange),e.off("mousedown",this.handleMouseDown),this.engine.off("scroll",this.handleScroll),window.removeEventListener("resize",this.handleResize)}}Fs(".ot-user-cursor {\r\n    position: absolute;\r\n    z-index: 125;\r\n    width: 2px;\r\n}\r\n\r\n.ot-user-cursor-trigger {\r\n    position: absolute;\r\n    top: -5px;\r\n    left: -2px;\r\n    border-radius: 100%;\r\n    color: #ffffff;\r\n    width: 6px;\r\n    height: 6px;\r\n    font-size: 0;\r\n    overflow: hidden;\r\n    transition: all 0.1s linear;\r\n}\r\n\r\n.ot-user-cursor-trigger-active {\r\n    top: -17px;\r\n    border-radius: 2px;\r\n    color: #ffffff;\r\n    font-size: 10px;\r\n    line-height: 18px;\r\n    height: 18px;\r\n    width: auto;\r\n    padding: 0 3px;\r\n    white-space: nowrap;\r\n}\r\n\r\n.ot-card-mask {\r\n    position: absolute;\r\n    z-index: 10;\r\n    background: transparent;\r\n    cursor: not-allowed;\r\n}\r\n\r\n.ot-user-background {\r\n    z-index: 120;\r\n}\r\n\r\n.ot-user-cursor-card {\r\n    position: absolute;\r\n}\r\n\r\n.ot-user-cursor-card .ot-user-cursor-trigger {\r\n    display: none;\r\n}\r\n\r\n.ot-user-cursor-card .ot-user-cursor-trigger-active {\r\n    position: absolute;\r\n    display: block;\r\n    top: -19px;\r\n    left: 0;\r\n    border-radius: 2px;\r\n    color: #ffffff;\r\n    font-size: 10px;\r\n    line-height: 18px;\r\n    height: 18px;\r\n    width: auto;\r\n    padding: 0 3px;\r\n    white-space: nowrap;\r\n}\r\n");const Au=(e,t,n)=>{const r=e.block.closest(t);if(r.length>0){const i=r.attributes(Fr),s=gc.create(e),o=gc.create(e);return s.setStart(r[0],0),s.setEnd(t[0],n),o.setStart(t[0],n),o.setEnd(r[0],r[0].childNodes.length),{id:i,leftText:s.toString(),rightText:o.toString()}}},Mu=(e,t)=>{if(!t)return;const{id:n,leftText:r,rightText:i}=t,s=e.container.get()?.querySelector(`[${Fr}="${n}"]`);if(!s)return;const o=s.textContent||"";if(""===o)return{container:s,offset:0};if(o?.startsWith(r)){let e=s.firstChild,t=r.length;for(;e&&(3!==e.nodeType||(e.textContent?.length||0)<t);)(e.textContent?.length||0)<t?(t-=e.textContent?.length||0,e=e.nextSibling):e=e.firstChild;return{container:e,offset:t}}if(o?.endsWith(i)){let e=i.length,t=s.lastChild;for(;t&&(3!==t.nodeType||(t.textContent?.length||0)<e);)t.textContent?.length||e>0?(e-=t?.textContent?.length||0,t=t.previousSibling):t=t.lastChild;return{container:t,offset:t?.textContent?.length||0-e}}let a=0;for(;o[a]===r[a];)a++;let l=s.firstChild;for(;l&&(3!==l.nodeType||(l.textContent?.length||0)<a);)l.textContent?.length||a>0?(a-=l.textContent?.length||0,l=l.nextSibling):l=l.firstChild;return{container:l,offset:a}},_u=e=>{if(jh.isText(e)){const{text:t}=e;return ds(t).replace(/\u00a0/g," ").replace(/\u200b/g,"")}if(qh.isElement(e)){const{type:t,children:n}=e;let r=`<${t}`;for(const[t,n]of Object.entries(e))"type"!==t&&"children"!==t&&(r+=` ${t}="${cs(n)}"`);const i=nu.isVoid(e);r+=i?"":">";for(const e of n)r+=_u(e);return r+=i?" />":`</${t}>`,r.replace(/\u200b/g,"")}throw new Error("Cannot convert node to value")},Bu=(e,t)=>{if(jh.isText(e)){const{text:t}=e;return ds(t).replace(/\u00a0/g," ").replace(/\u200b/g,"")}if(qh.isElement(e)){const{type:n,children:r}=e;if(t&&!1===t(e))return"";if(e[ci])return(e=>{const t=e[hi];if(!t)return"";const n={type:t,value:e[ui],name:(e[ci]||e[di]).toLowerCase(),editable:e[pi],[Fr]:e[Fr]};for(const t in e)t!==di&&0===t.indexOf("data-")&&0!==t.indexOf("data-card")&&(n[t]=e[t]);let r="<card ";for(const e in n)void 0!==n[e]&&(r+=`${e}="${cs(n[e])}" `);return r+="></card>",r})(e);let i=`<${n}`;for(const[t,n]of Object.entries(e))"type"!==t&&"children"!==t&&(i+=` ${t}="${cs(n)}"`);if(nu.isVoid(e))return i+" />";i+=">";for(const e of r)i+=Bu(e);return i+=`</${n}>`,i}throw new Error("Cannot convert node to value")},Ru=e=>{let t=e["data-indent"];if(!t){const n=e.style;if(!n)return 0;const r=n.match(/text-indent: (\d+)(px|em|rem);/);if(!r)return 0;t=r[1]}return t?parseInt(t):0},Iu=e=>{const t=Ru(e);return" ".repeat(2*t)},Lu=(e,t=!1)=>{const{children:n}=e;let r=Iu(e),i=!nu.isBlock(e)||0===n.length;if("checkbox"===e[ci]){return ms(e[ui]).checked?"✅":"🔲"}if(t||!e[ci]||"true"===e[pi])for(const e of n)r+=Du(e),!i&&qh.isElement(e)&&("br"===e.type||nu.isBlock(e))&&(i=!0);return r+(i?"":"\n")},Du=(e,t=!1)=>{if(jh.isText(e)){const{text:t}=e;return ds(t).replace(/\u00a0/g," ").replace(/\u200b/g,"")}if(qh.isElement(e)){const{type:n}=e;return"br"===n?"\n":"ol"===n||"ul"===n?(e=>{const t=e.start,n=e.class;if(n&&n.includes("data-list-task"))return Lu(e);const r=Ru(e),i=((e,t)=>"ol"===e?t%3==1?"lower-alpha":t%3==2?"lower-roman":"decimal":t%3==1?"circle":t%3==2?"square":"disc")(e.type,r),s=Iu(e);let o=Iu(e);const a="ol"===e.type,l=t?parseInt(t):1;a||(o=`${xs(i)} `);let c="";return e.children.forEach((e,t)=>{qh.isElement(e)?"li"===e.type?(a&&(o=`${xs(i,l+t)}. `),c+=s+o+Lu(e)):c+=s+Lu(e):c+=Du(e)}),c})(e):Lu(e,t)}throw new Error("Cannot convert node to text")},zu=new WeakMap,Pu=new WeakMap,$u=(e,t)=>{const n=new s,{history:r,change:i}=e,o=Kh(e);o.onChange(t=>{const s=al(e.model.root),o=au.transform(e,t);0!==o.length&&(n.emit("change",o,s),r.handleSelfOps(o.filter(e=>(!0===e.undoable&&"set_node"===e.type&&e.newProperties[ui]&&r.handleNLCardValue(e),!(e.undoable||"set_node"===e.type&&e.newProperties[di])))),e.trigger("operations",o),o.find(e=>"set_node"===e.type&&e.newProperties[ui])&&i.change(!1))}),e.readonly||o.start();const a=new Su(e);a.on("change",e=>{n.emit("selection-change",e)});const l=Xh.fromEngine(e),c=t=>{const n=[];for(const r of t){const t=Hh(e,r,!1);if(t&&t.length>0&&n.push(t),"insert_node"===r.type||"remove_node"===r.type){const{path:n,node:i}=r,s=nu.get(d.root,n.slice(0,n.length-1));if(qh.isElement(s)){const o="insert_node"===r.type,a=n[n.length-1];if(o?s.children.splice(a,0,i):s.children.splice(a,1),o&&t&&t.length>0){const n=(t,r,i,s)=>{if(nu.setDOM(t,s,e.schema),Jh.setPath(t,r,i),qh.isElement(t))for(let r=0;r<t.children.length;r++){const i=t.children[r],{node:o}=Vh(e,s,[r],!1);n(i,t,r,o)}};n(i,s,a,t[0])}for(let e=n[n.length-1];e<s.children.length;e++){const t=s.children[e];Jh.setPath(t,s,e)}}}else if("set_node"===r.type){const{path:e,properties:t,newProperties:n}=r,i=nu.get(d.root,e);if(i){for(const e in t)delete i[e];for(const e in n)i[e]=n[e]}}else if("insert_text"===r.type||"remove_text"===r.type){const{path:e,offset:t,text:n}=r,i=nu.get(d.root,e);jh.isText(i)&&("insert_text"===r.type?i.text=i.text.slice(0,t)+n+i.text.slice(t):i.text=i.text.slice(0,t)+i.text.slice(t+n.length))}}return n},d={root:t,mutation:o,selection:a,member:l,resetRoot:()=>{const t=nu.createFromDOM(e.container[0],e.schema);qh.isElement(t)&&(d.root=t)},onChange:e=>{n.on("change",e)},offChange:e=>{n.off("change",e)},emitChange:t=>{n.emit("change",t,al(e.model.root))},onSelectionChange:e=>{n.on("selection-change",e)},offSelectionChange:e=>{n.off("selection-change",e)},findNode:e=>{let t=d.root;for(const n of e){if(!qh.isElement(t))return;t=t.children[n]}return t},apply:t=>{const n=c(t);return e.change.change(!1,n),n},applyRemote:t=>{o.stop();const n=(e=>{try{if(0===window.getSelection()?.rangeCount)return;const t=gc.from(e);if(!t||t.inCard())return;t.startNode.isRoot()&&t.shrinkToElementNode();const{startNode:n,startOffset:r,endNode:i,endOffset:s}=t;return{start:Au(e,n,r),end:Au(e,i,s)}}catch(t){return void e.messageError("apply-remote-path",t)}})(e),r=c(t);return Promise.resolve().then(()=>{o.start()}),n&&e.isFocus()&&((e,t,n)=>{try{const r=window.getSelection(),i=r?gc.from(e,r)?.cloneRange():void 0;if(!i)return;const{start:s,end:o}=t;let a,l;s&&(a=Mu(e,s)),o&&(l=Mu(e,o)),a&&a.container&&i.setStart(a.container,a.offset),l&&l.container&&i.setEnd(l.container,l.offset),e.change.range.select(i,!1),n?.()}catch(t){e.messageError("apply-remote-path",t)}})(e,n,a.emitSelectChange),e.change.change(!0,r),r},drawCursor(t){Pu.get(e)||(Pu.set(e,!0),Promise.resolve().then(()=>{Pu.set(e,!1),Array.isArray(t)||(t=[t]);const n=l.getCurrent(),r=l.getMembers();t.forEach(e=>{if(n&&e.uuid===n.uuid)return;const t=r.find(t=>t.uuid===e.uuid);"remove"in e||!t?a.removeAttirbute(e.uuid):a.setAttribute(e,t)})}))},toDOM:e=>Wh(e??d.root),toHTML:t=>{const n=_u(t||d.root),r=Ss(n);if(!t){const t=e.container.css();r.css(t)}return e.trigger("parse:html-before",r),e.trigger("parse:html",r),e.trigger("parse:html-after",r),r.html().replace(/\u200b/g,"")},toValue:t=>{const n=t=>e.trigger("parse:node",t);return t?Bu(t,n):d.root.children.map(e=>Bu(e,n)).join("")},toValueAsync:(t,n)=>new Promise((r,i)=>{(async()=>{for(const t in e.plugin.components){const r=e.plugin.components[t],i=await new Promise(e=>{r.waiting?r.waiting(n).then(()=>e(!0)).catch(e):e(!0)});if("object"==typeof i)throw i}return d.toValue(t)})().then(r).catch(i)}),toText:(e,t)=>e?Du(e,t):d.root.children.map(e=>Du(e,t)).join(""),destroy:()=>{o.destroy(),a.destroy(),zu.delete(e)}};return d},ju={from:(e,t={type:"div",children:[]})=>{let n=zu.get(e);return n||(n=$u(e,t),zu.set(e,n)),n},destroy:e=>{const t=zu.get(e);t?.destroy()}};var qu;const Wu=(e,t)=>{if(t){const{start:n,end:r}=t;if(n&&r){const t=n.path[n.path.length-1],i=r.path[r.path.length-1],s=n.path.slice(),o=r.path.slice();s.pop(),o.pop();const{container:a,change:l}=e,c=a.getChildByPath(s,e=>!hc(Ss(e)));if(!c)return;const d=a.getChildByPath(o,e=>!hc(Ss(e)));if(!d)return;const h=(e,t)=>{if(e.nodeType===ii().TEXT_NODE){const n=e.textContent||"";return n.length<t?n.length:t}{const n=e.childNodes;return n.length<t?n.length:t}};try{const n=l.range.get();if("BR"===c.nodeName||e.node.isVoid(c)?n.select(c).collapse(!1):(n.setStart(c,h(c,t)),n.setEnd(d,h(d,i))),!n.collapsed){const t=e.card.find(n.startNode,!0),r=e.card.find(n.endNode,!0);if(t&&r&&t?.root.equal(r.root)){let e=n.startNode.closest(Gr);0===e.length&&(e=n.startNode.find(Gr));let t=n.endNode.closest(Gr);0===t.length&&(t=n.endNode.find(Gr)),e.length>0&&t.length>0&&!e.equal(t)&&n.collapse(!0)}}l.range.select(n),n.scrollRangeIntoView()}catch(t){e.messageError("history setRangeByPath",t)}}}};class Vu{constructor(e){this.actionOps=[],this.currentAction={ops:[]},this.currentActionIndex=0,this.filterEvents=[],this.selfEvents=[],qu.set(this,void 0),this.lazySave=gd(()=>{this.saveOp()},200),this.handlePath=(e,t,n,r=!0,i=e=>!hc(Ss(e)))=>{const s=this.engine.container.find(`[${Fr}="${t}"]`);if(s.length>0&&s.inEditor()){const t=s.getPath(this.engine.container,s.parent()?.isRoot()?void 0:i);return(r?t.map(e=>e+2):t).concat(e.slice(n))}return e},this.engine=e}resetCurrentAction(){this.currentAction={ops:[]}}reset(){this.actionOps=[],this.currentActionIndex=0}onFilter(e){this.filterEvents.push(e)}onSelf(e){this.selfEvents.push(e)}hasUndo(){return!!this.getUndoOp()}hasRedo(){return!!this.getRedoOp()}undo(){this.saveOp();const e=this.getUndoOp();if(e){let t=!1;const n=this.engine,r=n.change,i=n.model;i.mutation.stop();try{i.emitChange(e.ops),i.apply(e.ops),this.currentActionIndex--,t=!0}catch(e){this.reset(),n.messageError("history-undo",e)}n.isEmpty()&&r.initValue(),t&&(r.getRangePathBeforeCommand(),e.startRangePath&&Wu(n,e.startRangePath),r.change(),n.trigger("undo")),Promise.resolve().then(()=>{i.mutation.start()})}}redo(){this.saveOp();const e=this.getRedoOp();if(e){let t=!1;const n=this.engine,r=n.change,i=n.model;try{i.mutation.stop(),i.emitChange(e.ops),i.apply(e.ops),this.currentActionIndex++,t=!0}catch(e){this.reset(),n.messageError("history-redo",e)}t&&(r.getRangePathBeforeCommand(),e.rangePath&&Wu(this.engine,e.rangePath),r.change(),n.trigger("redo")),Promise.resolve().then(()=>{i.mutation.start()})}}clear(){setTimeout(()=>{this.reset()},10)}saveOp(){this.currentAction&&this.currentAction.ops&&this.currentAction.ops.length>0&&(this.currentAction.self&&(this.currentAction.rangePath=this.getCurrentRangePath(),this.currentAction.id=ts(8),this.actionOps.splice(this.currentActionIndex),this.actionOps.push(this.currentAction),this.currentActionIndex=this.actionOps.length,this.engine.trigger("historyChange")),this.resetCurrentAction(),this.engine.change.getRangePathBeforeCommand())}handleSelfOps(e){this.currentAction?.self||this.saveOp();let t=!1;if(e.forEach(e=>{if(t=!0,this.filterEvents.some(t=>t(e)))this.actionOps.length>0&&!e.undoable&&this.actionOps[this.actionOps.length-1].ops?.push(e);else{this.currentAction.self=!0,this.currentAction.ops||(this.currentAction.ops=[]),this.currentAction.startRangePath||(this.currentAction.startRangePath=this.getRangePathBeforeCommand());const t=this.currentAction.ops[this.currentAction.ops.length-1];t&&au.isReverse(e,t)?this.currentAction.ops.pop():this.currentAction.ops.push(e)}}),t){let t;if(this.selfEvents.some(n=>(t=n(e),void 0!==t)),$c(this,qu,"f"))return;"boolean"==typeof t?t?this.saveOp():this.resetCurrentAction():"object"==typeof t?(jc(this,qu,t,"f"),t.then(e=>{e?this.saveOp():this.resetCurrentAction()}).finally(()=>jc(this,qu,void 0,"f"))):void 0===t&&this.lazySave()}}handleNLCardValue(e){if(!0===e.undoable&&"set_node"===e.type){const{newProperties:t}=e,n=t[ui];if(!n)return;const r=ms(n);this.actionOps.forEach(e=>{e.ops.forEach(e=>{if("set_node"===e.type){const{newProperties:t}=e,n=t[ui],i=ms(n);r.id===i.id&&(t[ui]=r)}else if("insert_node"===e.type){const{node:t}=e,n=t[ui];if(!n)return;const i=ms(n);r.id===i.id&&(t[ui]=r)}})})}}handleRemoteOps(e){this.currentAction.self&&!$c(this,qu,"f")&&this.saveOp();const t=this.engine.change.range.get();this.actionOps.forEach(e=>{if(e.rangePath){const{start:n,end:r}=e.rangePath;n.id&&void 0!==n.bi&&(n.path=this.handlePath(n.path,n.id,n.bi,!1,t.filterPath(!0))),r.id&&void 0!==r.bi&&(r.path=this.handlePath(r.path,r.id,r.bi,!1,t.filterPath(!0)))}if(e.startRangePath){const{start:n,end:r}=e.startRangePath;n.id&&void 0!==n.bi&&(n.path=this.handlePath(n.path,n.id,n.bi,!1,t.filterPath(!0))),r.id&&void 0!==r.bi&&(r.path=this.handlePath(r.path,r.id,r.bi,!1,t.filterPath(!0)))}}),e.forEach(e=>{this.currentAction.ops||(this.currentAction.ops=[]);const t=this.currentAction.ops[this.currentAction.ops.length-1];t&&au.isReverse(e,t)?this.currentAction.ops.pop():this.currentAction.ops.push(e),this.actionOps.some((t,n)=>{const r=t.ops?.some(t=>au.canOpAffectPath(e,t.path));if(r){const e=[t];for(let r=n+1;r<this.actionOps.length;r++){const n=this.actionOps[r],i=n.ops?.some(e=>t.ops?.some(t=>au.canOpAffectPath(e,t.path)));if(i){e.push(n);const t=r+1,i=this.actionOps[t];i&&i.ops?.some(e=>n.ops?.some(t=>au.canOpAffectPath(e,t.path)))&&e.push(i)}}const i=this.actionOps.filter(t=>void 0===e.find(e=>e.id===t.id));return this.actionOps=i,this.currentActionIndex=this.actionOps.length,r}return!1})})}getUndoOp(){const e=this.currentActionIndex-1;if(this.actionOps[e]){let t=al(this.actionOps[e]),n=Lh(this.actionOps,e=>e.id===t.id);-1!==n?t=this.actionOps[n]:n=e;const r=t.ops.map(e=>au.inverse(e)).reverse();try{return{self:!0,ops:r,id:t.id,type:"undo",rangePath:t.rangePath,startRangePath:t.startRangePath}}catch(e){return void this.engine.messageError("history-undo-op",e)}}}getRedoOp(){const e=this.currentActionIndex;if(this.actionOps[e]){const t=al(this.actionOps[e]);let n=[];n="undo"===t.type?t.ops.map(e=>au.inverse(e)).reverse():t.ops;try{return{self:!0,ops:n,id:t.id,type:"redo",rangePath:t.rangePath,startRangePath:t.startRangePath}}catch(e){return void this.engine.messageError("history-redo-op",e)}}}getCurrentRangePath(){const{model:e,change:t}=this.engine;return e.selection.currentRangePath||t.range.get().toPath()}getRangePathBeforeCommand(){return this.engine.change.getRangePathBeforeCommand()||this.getCurrentRangePath()}}qu=new WeakMap;class Hu{constructor(e){this.disabled=!1,this.engine=e,this.engine.container.on("keydown",e=>this.trigger(e))}match(e){Object.keys(this.engine.plugin.components).every(t=>{const r=this.engine.plugin.components[t];if(r.hotkey){const i=r.hotkey(e);let s=!1,o=[];if("string"==typeof i&&n(i,e)?s=!0:Array.isArray(i)?i.some(t=>{if("string"==typeof t){if(n(t,e))return s=!0,o=[],!0}else{const{key:r,args:i}=t;if(n(r,e))return s=!0,o=Array.isArray(i)?i:[i],!0}return!1}):"object"==typeof i&&n(i.key,e)&&(s=!0,o=Array.isArray(i.args)?i.args:[i.args]),s)return e.preventDefault(),this.engine.command.execute(t,...o),!1}return!0})}trigger(e){this.disabled||this.match(e)}enable(){this.disabled=!1}disable(){this.disabled=!0}destroy(){this.engine.container.off("keydown",this.trigger)}}class Fu{constructor(e){this.type="keydown",this.hotkey="",this.listeners=[],this.engine=e}on(e){this.listeners.push(e)}unshiftOn(e){this.listeners.unshift(e)}off(e){for(let t=0;t<this.listeners.length;t++)if(this.listeners[t]===e){this.listeners.splice(t,1);break}}trigger(e){for(let t=0;t<this.listeners.length;t++){if(!1===(0,this.listeners[t])(e))break}}destroy(){this.listeners=[]}}const Xu=[{name:"default",handle:Fu},{name:"enter",handle:class extends Fu{constructor(){super(...arguments),this.type="keydown",this.hotkey="enter"}trigger(e){const{change:t}=this.engine;t.cacheRangeBeforeCommand();const n=t.range.get();this.engine.block.closest(n.endNode).isEditable()&&this.engine.block.wrap("<p />");for(let t=0;t<this.listeners.length;t++){if(!1===(0,this.listeners[t])(e))break}this.engine.scrollNode&&this.engine.change.range.get().scrollIntoViewIfNeeded(this.engine.container,this.engine.scrollNode),this.engine.trigger("select")}},triggerName:"keydown:enter"},{name:"backspace",handle:class extends Fu{constructor(){super(...arguments),this.type="keydown",this.hotkey="backspace"}trigger(e){const{change:t,container:n}=this.engine,r=t.range.get();if(t.cacheRangeBeforeCommand(),t.isEmpty())return e.preventDefault(),n.empty(),void t.initValue();const{commonAncestorNode:i}=r,s=this.engine.card.find(i,!0),o=s?.isEditable&&s?.getSelectionNodes?s.getSelectionNodes():[];if(o.length>0)return o.forEach(e=>{e.html("<p></br ></p>")}),void t.apply(r.cloneRange().select(o[0],!0).collapse(!0));const{startNode:a,startOffset:l}=r;if(a.isEditable()){const n=a[0].childNodes[l-1],i=Ss(n);if("br"===i.name)return e.preventDefault(),i.remove(),void t.apply(r)}let c=!0;for(let t=0;t<this.listeners.length;t++){if(c=(0,this.listeners[t])(e),!1===c)break}if(!1!==c)if(r.collapsed){let n;if(this.engine.node.isBlock(a)){const e=a[0].childNodes[l-1];n=Ss(e)}else"br"===a.name&&(n=a);if("br"===n?.name){const i=n.prev(),s=n.next(),o=s?.next(),a=i?.prev();"br"!==i?.name&&"br"===s?.name&&"br"!==o?.name?(e.preventDefault(),n.remove(),s.remove(),t.apply(r.shrinkToTextNode())):"br"!==s?.name&&"br"===i?.name&&"br"!==a?.name&&(e.preventDefault(),n.remove(),i.remove(),t.apply(r.shrinkToTextNode()))}}else{e.preventDefault();const n=a.prev();"br"===n?.name&&n.remove(),t.delete(r);const i=r.startNode.prev();i?.isCard()&&0===i.find(yi).length&&i.remove(),t.apply(r),this.engine.scrollNode&&r.scrollIntoViewIfNeeded(this.engine.container,this.engine.scrollNode)}else this.engine.scrollNode&&r.scrollIntoViewIfNeeded(this.engine.container,this.engine.scrollNode)}},triggerName:"keydown:backspace"},{name:"delete",handle:class extends Fu{constructor(){super(...arguments),this.type="keydown",this.hotkey="delete"}getNext(e){const t=e.parentElement??e.parentNode;return Ss(e).isEditable()?null:e.nextSibling?e.nextSibling:null===t?null:this.getNext(t)}getRange(e,t=!1){if(Ss(e).isEditable())return null;if(!t){const t=this.getNext(e);if(!t)return null;e=t}for(;e;){const t=Ss(e);if(t.attributes(ci)){if(!e.ownerDocument)return null;const t=gc.create(this.engine,e.ownerDocument);return t.setStartAfter(e),t.collapse(!0),t}if(this.engine.node.isBlock(t)){if(!e.ownerDocument)return null;const n=gc.create(this.engine,e.ownerDocument);return n.select(t,!0).collapse(!0),n}if("br"===t.name){if(1===(e.parentElement??e.parentNode)?.childNodes.length)return null;if(!e.ownerDocument)return null;const t=gc.create(this.engine,e.ownerDocument);return t.setStartAfter(e),t.collapse(!0),t}if(e.nodeType===Node.TEXT_NODE){if(0===e.data.length)return this.getRange(e);if(!e.ownerDocument)return null;const t=gc.create(this.engine,e.ownerDocument);return t.setStart(e,1),t.collapse(!0),t}if(0===e.childNodes.length)return this.getRange(e);e=e.childNodes[0]}return null}trigger(e){const{change:t}=this.engine;t.cacheRangeBeforeCommand();const n=t.range.get();if(!n.collapsed)return e.preventDefault(),void t.delete();const r=this.engine.card.find(n.startNode);let i,s=!1;if(r){if(r.isLeftCursor(n.startNode))return e.preventDefault(),this.engine.card.select(r),void t.delete();if(!r.isRightCursor(n.startNode))return;i=r.root[0]}else if(n.endContainer.nodeType===Node.TEXT_NODE){if(n.endContainer.data.length>n.endOffset){e.preventDefault();const r=n.cloneRange();return r.setEnd(n.endContainer,n.endOffset+1),t.range.select(r),t.delete(),void t.range.select(t.range.get().shrinkToTextNode())}i=n.endContainer}else{if(n.endContainer.nodeType!==Node.ELEMENT_NODE)return;0===n.endContainer.childNodes.length?i=n.endContainer:0===n.endOffset?(1===n.endContainer.childNodes.length&&"BR"===n.endContainer.firstChild?.nodeName||(s=!0),i=n.endContainer.childNodes[n.endOffset]):i=n.endContainer.childNodes[n.endOffset-1]}const o=this.getRange(i,s);if(o){e.preventDefault();let{startOffset:r}=n;1===r&&1===n.startContainer.childNodes.length&&"BR"===n.startContainer.childNodes[0].nodeName&&(r=0),o.setStart(n.startContainer,r),t.range.select(o),t.delete()}for(let t=0;t<this.listeners.length;t++){if(!1===(0,this.listeners[t])(e))break}}},triggerName:"keydown:delete"},{name:"tab",handle:class extends Fu{constructor(){super(...arguments),this.type="keydown",this.hotkey="tab"}trigger(e){const{node:t}=this.engine;e.preventDefault(),t.insertText("    ")}},triggerName:"keydown:tab"},{name:"shift-tab",handle:class extends Fu{constructor(){super(...arguments),this.hotkey="shift+tab"}},triggerName:"keydown:shift-tab"},{name:"shift-enter",handle:class extends Fu{constructor(){super(...arguments),this.type="keydown",this.hotkey="shift+enter"}trigger(e){const{change:t,inline:n,block:r}=this.engine;e.preventDefault(),t.cacheRangeBeforeCommand();const i=t.range.get();if(0!==i.startNode.closest("li").length){{const e=Ss("<br />");if(n.insert(e,i),r.isLastOffset(i,"end")&&!(e.next()&&"br"===e.next()?.name||e.prev()&&"br"===e.prev()?.name)){const t=e.clone();e.after(t),i.select(t).collapse(!1)}}for(let t=0;t<this.listeners.length;t++){if(!1===(0,this.listeners[t])(e))break}t.apply(i),this.engine.scrollNode&&this.engine.change.range.get().scrollIntoViewIfNeeded(this.engine.container,this.engine.scrollNode)}else this.engine.typing.getHandleListener("enter","keydown")?.trigger(e)}},triggerName:"keydown:shift-enter"},{name:"space",handle:class extends Fu{constructor(){super(...arguments),this.hotkey=e=>" "===e.key}},triggerName:"keydown:space"},{name:"slash",handle:class extends Fu{constructor(){super(...arguments),this.hotkey=e=>"/"===e.key||n("/",e)||229===e.keyCode&&"Slash"===e.code}},triggerName:"keydown:slash"},{name:"all",handle:class extends Fu{constructor(){super(...arguments),this.hotkey="mod+a"}},triggerName:"keydown:all"},{name:"left",handle:class extends Fu{constructor(){super(...arguments),this.type="keydown",this.hotkey=e=>n("left",e)||n("shift+left",e)||n("ctrl+a",e)||n("ctrl+b",e)}},triggerName:"keydown:left"},{name:"right",handle:class extends Fu{constructor(){super(...arguments),this.type="keydown",this.hotkey=e=>n("right",e)||n("shift+right",e)||n("ctrl+e",e)||n("ctrl+f",e)}},triggerName:"keydown:right"},{name:"up",handle:class extends Fu{constructor(){super(...arguments),this.hotkey=e=>n("up",e)||n("ctrl+p",e)}},triggerName:"keydown:up"},{name:"down",handle:class extends Fu{constructor(){super(...arguments),this.hotkey=e=>n("down",e)||n("ctrl+n",e)}},triggerName:"keydown:down"}];class Uu extends Fu{constructor(){super(...arguments),this.type="keyup"}}const Yu=[{name:"default",handle:Uu},{name:"enter",handle:class extends Uu{constructor(){super(...arguments),this.hotkey="enter"}},triggerName:"keyup:enter"},{name:"backspace",handle:class extends Uu{constructor(){super(...arguments),this.type="keyup",this.hotkey="backspace"}trigger(e){const{change:t}=this.engine;if(t.isEmpty())return void e.preventDefault();let n=!0;for(let t=0;t<this.listeners.length;t++){if(n=(0,this.listeners[t])(e),!1===n)break}}},triggerName:"keyup:backspace"},{name:"tab",handle:class extends Uu{constructor(){super(...arguments),this.hotkey="tab"}},triggerName:"keyup:tab"},{name:"space",handle:class extends Uu{constructor(){super(...arguments),this.hotkey=e=>" "===e.key}},triggerName:"keyup:space"}];class Ku{constructor(e){this.handleListeners=[],this.bindKeydown=e=>{const{readonly:t,card:r}=this.engine;t?n("mod+a",e)&&e.preventDefault():e.target&&r.find(Ss(e.target))||this.trigger("keydown",e)},this.bindKeyup=e=>{const{readonly:t,card:n}=this.engine;t||e.target&&n.find(Ss(e.target))||this.trigger("keyup",e)},this.engine=e,Xu.concat(Yu).forEach(e=>{this.addHandleListener(e.name,e.handle,e.triggerName)});const{container:t}=e;t.on("keydown",this.bindKeydown),t.on("keyup",this.bindKeyup)}addHandleListener(e,t,n,r){this.handleListeners.push({name:e,handle:new t(this.engine),triggerName:n,triggerParams:r})}getHandleListener(e,t){return this.handleListeners.find(n=>n.name===e&&n.handle.type===t)?.handle}removeHandleListener(e,t){for(let n=0;n<this.handleListeners.length;n++)if(this.handleListeners[n].name===e&&this.handleListeners[n].handle.type===t){this.handleListeners[n].handle.destroy(),this.handleListeners.splice(n,1);break}}trigger(e,t){!1===this.handleListeners.filter(({handle:t})=>t.type===e).some(e=>{const{name:r,handle:i,triggerName:s,triggerParams:o}=e;if("default"===r||!i.hotkey)return!1;if("function"==typeof i.hotkey?i.hotkey(t):n(i.hotkey,t)){let e=[t];return"function"==typeof o&&(e=o(this.engine,t)),s&&!1===this.engine.trigger(s,...e)||i.trigger(t),!0}return!1})&&!1!==this.engine.trigger(e+":default",t)&&this.getHandleListener("default",e)?.trigger(t)}destroy(){const{container:e}=this.engine;this.handleListeners=[],e.off("keydown",this.bindKeydown),e.off("keyup",this.bindKeyup)}}const Zu="data-placeholder",Gu="am-engine-placeholder";class Ju{constructor(e,t){this._focused=!1,this._setFocus=()=>{this._focused=!0},this._setBlur=()=>{this._focused=!1},this.handleClick=e=>{const{engine:t,autoAppend:n,autoPrepend:r}=this.options;if(e.target&&!t.readonly&&Es(t)){const i=Ss(e.target);if(!i.isEditable())return;const s=Ss("<p><br /></p>"),o=i.closest(`${Gr},${Ur}`),a=o.first();a||t.change.initValue(void 0,!0,i);const l=o.last();let c=!1;if(!1!==r&&a&&e.offsetY<(a.get()?.offsetTop||0)&&!t.node.isEmptyWidthChild(a)?(o.prepend(s),c=!0):!1!==n&&l&&e.offsetY>(l.get()?.offsetTop||0)+(l.get()?.clientHeight||0)&&!t.node.isEmptyWidthChild(l)&&(o.append(s),c=!0),c){const e=t.change.range.get();e.select(s,!0).collapse(!1),t.change.apply(e)}}},this.handleFocus=()=>{const{engine:e}=this.options;this.triggerFoucs(),!e.model.mutation.isStopped&&e.isEmpty()&&e.change.initValue()},this.focusTimeout=null,this.triggerFoucs=()=>{const{engine:e}=this.options;this.focusTimeout&&clearTimeout(this.focusTimeout),this.focusTimeout=setTimeout(()=>{if(this._focused)return;const t=e.change.range.get();(t.commonAncestorNode.isRoot(e.container)||t.commonAncestorNode.inEditor(e.container))&&(e.change.range.setLastBlurRange(),e.trigger("focus"))},0)},this.onInput=e=>{const{engine:t}=this.options;if(t.readonly)return;if(e.target&&t.card.find(Ss(e.target)))return;t.change.range.get().handleBr(!0)},this.onRealtimeChange=()=>{const{engine:e}=this.options;e.isEmpty()?e.showPlaceholder():e.hidePlaceholder()},this.blurTimeout=null,this.docMouseDown=e=>{if(!e.target)return;const t=Ss(e.target),{engine:n}=this.options;if(this._focused&&0===t.closest(Kr).length&&!t.inEditor(n.container)){this.blurTimeout&&clearTimeout(this.blurTimeout);const e=n.change.range.get();this.blurTimeout=setTimeout(()=>{n.change.range.get().commonAncestorNode.inEditor(n.container)||(n.change.range.setLastBlurRange(e),n.trigger("blur"))},0)}},this.node=Ss(e),this.options=t,this._init(),this._focused=null!==document.activeElement&&this.node.equal(document.activeElement);const{engine:n}=t;n.on("blur",this._setBlur),n.on("focus",this._setFocus)}_init(){const{lang:e,tabIndex:t,className:n}=this.options;this.node.attributes({[Rs]:"true",role:"textbox",autocorrect:"en-US"===e?"on":"off",autocomplete:"off",spellcheck:"en-US"===e?"true":"false","data-gramm":"false"}),void 0!==t&&this.node.attributes("tabindex",t),this.node.hasClass(ei)||this.node.addClass(ei),Zi&&this.node.addClass(ti),void 0!==n&&(Array.isArray(n)?n:n.split(/\s+/)).forEach(e=>{""!==e.trim()&&this.node.addClass(e)})}init(){const{engine:e}=this.options;this.node.on("input",this.onInput),e.on("realtimeChange",this.onRealtimeChange),this.node.on("click",this.handleClick),document.addEventListener("mousedown",this.docMouseDown),this.node.on(Zi?"touchstart":"mousedown",this.triggerFoucs,{passive:!0}),this.node.on("focus",this.handleFocus)}isFocus(){return this._focused}getNode(){return this.node}setReadonly(e){this.node.attributes(Rs,e?"false":"true")}showPlaceholder(){const{placeholder:e}=this.options;e&&(this.node.attributes({[Zu]:e}),this.node.addClass(Gu))}hidePlaceholder(){this.node.removeAttributes(Zu),this.node.removeClass(Gu)}destroy(){const{className:e,engine:t}=this.options;t.on("blur",this._setBlur),t.on("focus",this._setFocus),t.off("realtimeChange",this.onRealtimeChange),document.removeEventListener("mousedown",this.docMouseDown),this.node.removeAttributes(Rs),this.node.removeAttributes("role"),this.node.removeAttributes("autocorrect"),this.node.removeAttributes("autocomplete"),this.node.removeAttributes("spellcheck"),this.node.removeAttributes("data-gramm"),this.node.removeAttributes("tabindex"),this.node.removeAttributes(Zu),this.options.className&&(Array.isArray(e)?e:(e||"").split(/\s+/)).forEach(e=>{""!==e.trim()&&this.node.removeClass(e)}),t.card.closest(this.node)&&this.node.removeClass(ei),this.node.removeAllEvents()}}Fs('.data-icon {\r\n    font-family: "data-icon" !important;\r\n    font-size: 16px;\r\n    font-style: normal;\r\n    -webkit-font-smoothing: antialiased;\r\n    -moz-osx-font-smoothing: grayscale;\r\n}\r\n\r\n.data-icon-block-image:before {\r\n    content: "\\ea20";\r\n}\r\n\r\n.data-icon-inline-image:before {\r\n    content: "\\e601";\r\n}\r\n\r\n.data-icon-no-border:before {\r\n    content: "\\e608";\r\n}\r\n\r\n.data-icon-line-height:before {\r\n    content: "\\e697";\r\n}\r\n\r\n.data-icon-text:before {\r\n    content: "\\e600";\r\n}\r\n\r\n.data-icon-comment:before {\r\n    content: "\\e73e";\r\n}\r\n\r\n.data-icon-huanyuan:before {\r\n    content: "\\e60a";\r\n}\r\n\r\n.data-icon-label:before {\r\n    content: "\\e714";\r\n}\r\n\r\n.data-icon-video:before {\r\n    content: "\\e741";\r\n}\r\n\r\n.data-icon-table:before {\r\n    content: "\\e6a8";\r\n}\r\n\r\n.data-icon-h:before {\r\n    content: "\\e7a0";\r\n}\r\n\r\n.data-icon-collapse-subtree:before {\r\n    content: "\\e754";\r\n}\r\n\r\n.data-icon-expand-subtree:before {\r\n    content: "\\e792";\r\n}\r\n\r\n.data-icon-sub-node:before {\r\n    content: "\\e78e";\r\n}\r\n\r\n.data-icon-sister-node:before {\r\n    content: "\\e784";\r\n}\r\n\r\n.data-icon-sup:before {\r\n    content: "\\e790";\r\n}\r\n\r\n.data-icon-sub:before {\r\n    content: "\\e75a";\r\n}\r\n\r\n.data-icon-maximize:before {\r\n    content: "\\e752";\r\n}\r\n\r\n.data-icon-codeblock:before {\r\n    content: "\\e709";\r\n}\r\n\r\n.data-icon-emoji:before {\r\n    content: "\\e73a";\r\n}\r\n\r\n.data-icon-h4:before {\r\n    content: "\\e759";\r\n}\r\n\r\n.data-icon-h1:before {\r\n    content: "\\e75b";\r\n}\r\n\r\n.data-icon-h5:before {\r\n    content: "\\e75c";\r\n}\r\n\r\n.data-icon-h2:before {\r\n    content: "\\e75d";\r\n}\r\n\r\n.data-icon-h3:before {\r\n    content: "\\e760";\r\n}\r\n\r\n.data-icon-h6:before {\r\n    content: "\\e761";\r\n}\r\n\r\n.data-icon-liuchengtu:before {\r\n    content: "\\e61c";\r\n}\r\n\r\n.data-icon-website:before {\r\n    content: "\\e694";\r\n}\r\n\r\n.data-icon-preferences:before {\r\n    content: "\\e788";\r\n}\r\n\r\n.data-icon-hr:before {\r\n    content: "\\e76a";\r\n}\r\n\r\n.data-icon-task-list:before {\r\n    content: "\\e79f";\r\n}\r\n\r\n.data-icon-unordered-list:before {\r\n    content: "\\e777";\r\n}\r\n\r\n.data-icon-ordered-list:before {\r\n    content: "\\e795";\r\n}\r\n\r\n.data-icon-arrow-left:before {\r\n    content: "\\e748";\r\n}\r\n\r\n.data-icon-arrow-up:before {\r\n    content: "\\e769";\r\n}\r\n\r\n.data-icon-arrow-right:before {\r\n    content: "\\e779";\r\n}\r\n\r\n.data-icon-arrow-down:before {\r\n    content: "\\e79a";\r\n}\r\n\r\n.data-icon-moremark:before {\r\n    content: "\\e772";\r\n}\r\n\r\n.data-icon-clean:before {\r\n    content: "\\e74d";\r\n}\r\n\r\n.data-icon-paintformat:before {\r\n    content: "\\e756";\r\n}\r\n\r\n.data-icon-lock:before {\r\n    content: "\\e768";\r\n}\r\n\r\n.data-icon-loading:before {\r\n    content: "\\e76b";\r\n}\r\n\r\n.data-icon-unlock:before {\r\n    content: "\\e796";\r\n}\r\n\r\n.data-icon-collapse:before {\r\n    content: "\\e79e";\r\n}\r\n\r\n.data-icon-align-bottom:before {\r\n    content: "\\e72b";\r\n}\r\n\r\n.data-icon-attachment:before {\r\n    content: "\\e72c";\r\n}\r\n\r\n.data-icon-bold:before {\r\n    content: "\\e72d";\r\n}\r\n\r\n.data-icon-border-color:before {\r\n    content: "\\e72e";\r\n}\r\n\r\n.data-icon-border-all:before {\r\n    content: "\\e72f";\r\n}\r\n\r\n.data-icon-border-inner:before {\r\n    content: "\\e730";\r\n}\r\n\r\n.data-icon-border-left:before {\r\n    content: "\\e731";\r\n}\r\n\r\n.data-icon-border-bottom:before {\r\n    content: "\\e732";\r\n}\r\n\r\n.data-icon-border-none:before {\r\n    content: "\\e733";\r\n}\r\n\r\n.data-icon-box:before {\r\n    content: "\\e734";\r\n}\r\n\r\n.data-icon-border-outer:before {\r\n    content: "\\e735";\r\n}\r\n\r\n.data-icon-border-right:before {\r\n    content: "\\e736";\r\n}\r\n\r\n.data-icon-clear:before {\r\n    content: "\\e737";\r\n}\r\n\r\n.data-icon-close:before {\r\n    content: "\\e738";\r\n}\r\n\r\n.data-icon-code-example:before {\r\n    content: "\\e739";\r\n}\r\n\r\n.data-icon-clip:before {\r\n    content: "\\e73b";\r\n}\r\n\r\n.data-icon-border-up:before {\r\n    content: "\\e73c";\r\n}\r\n\r\n.data-icon-code:before {\r\n    content: "\\e73d";\r\n}\r\n\r\n.data-icon-command:before {\r\n    content: "\\e73f";\r\n}\r\n\r\n.data-icon-compact-display:before {\r\n    content: "\\e740";\r\n}\r\n\r\n.data-icon-copy:before {\r\n    content: "\\e742";\r\n}\r\n\r\n.data-icon-download:before {\r\n    content: "\\e743";\r\n}\r\n\r\n.data-icon-deletecolumn:before {\r\n    content: "\\e744";\r\n}\r\n\r\n.data-icon-cut:before {\r\n    content: "\\e745";\r\n}\r\n\r\n.data-icon-decreasedecimalplace:before {\r\n    content: "\\e746";\r\n}\r\n\r\n.data-icon-drag:before {\r\n    content: "\\e747";\r\n}\r\n\r\n.data-icon-delete:before {\r\n    content: "\\e749";\r\n}\r\n\r\n.data-icon-drag-circle:before {\r\n    content: "\\e74a";\r\n}\r\n\r\n.data-icon-deleterow:before {\r\n    content: "\\e74b";\r\n}\r\n\r\n.data-icon-edit:before {\r\n    content: "\\e74c";\r\n}\r\n\r\n.data-icon-filter:before {\r\n    content: "\\e74e";\r\n}\r\n\r\n.data-icon-expand:before {\r\n    content: "\\e74f";\r\n}\r\n\r\n.data-icon-error:before {\r\n    content: "\\e750";\r\n}\r\n\r\n.data-icon-freezerowcoloum:before {\r\n    content: "\\e751";\r\n}\r\n\r\n.data-icon-freezefirstrow:before {\r\n    content: "\\e753";\r\n}\r\n\r\n.data-icon-freezzecolumn:before {\r\n    content: "\\e755";\r\n}\r\n\r\n.data-icon-border-style:before {\r\n    content: "\\e757";\r\n}\r\n\r\n.data-icon-gotolink:before {\r\n    content: "\\e758";\r\n}\r\n\r\n.data-icon-increasedecimalplace:before {\r\n    content: "\\e75e";\r\n}\r\n\r\n.data-icon-insertrowbelow:before {\r\n    content: "\\e75f";\r\n}\r\n\r\n.data-icon-image:before {\r\n    content: "\\e762";\r\n}\r\n\r\n.data-icon-italic:before {\r\n    content: "\\e763";\r\n}\r\n\r\n.data-icon-indent:before {\r\n    content: "\\e764";\r\n}\r\n\r\n.data-icon-insertrowabove:before {\r\n    content: "\\e765";\r\n}\r\n\r\n.data-icon-insertrowright:before {\r\n    content: "\\e766";\r\n}\r\n\r\n.data-icon-left-circle-fill:before {\r\n    content: "\\e767";\r\n}\r\n\r\n.data-icon-link:before {\r\n    content: "\\e76c";\r\n}\r\n\r\n.data-icon-keyboard:before {\r\n    content: "\\e76d";\r\n}\r\n\r\n.data-icon-more:before {\r\n    content: "\\e76e";\r\n}\r\n\r\n.data-icon-merge-cells:before {\r\n    content: "\\e76f";\r\n}\r\n\r\n.data-icon-outdent:before {\r\n    content: "\\e770";\r\n}\r\n\r\n.data-icon-mention:before {\r\n    content: "\\e771";\r\n}\r\n\r\n.data-icon-plus:before {\r\n    content: "\\e773";\r\n}\r\n\r\n.data-icon-minus-circle-o:before {\r\n    content: "\\e774";\r\n}\r\n\r\n.data-icon-highlight:before {\r\n    content: "\\e775";\r\n}\r\n\r\n.data-icon-paste:before {\r\n    content: "\\e776";\r\n}\r\n\r\n.data-icon-insertrowleft:before {\r\n    content: "\\e778";\r\n}\r\n\r\n.data-icon-quote:before {\r\n    content: "\\e77a";\r\n}\r\n\r\n.data-icon-plus-circle-o:before {\r\n    content: "\\e77b";\r\n}\r\n\r\n.data-icon-right-circle-fill:before {\r\n    content: "\\e77c";\r\n}\r\n\r\n.data-icon-question-circle-o:before {\r\n    content: "\\e77d";\r\n}\r\n\r\n.data-icon-preview:before {\r\n    content: "\\e77e";\r\n}\r\n\r\n.data-icon-reload:before {\r\n    content: "\\e77f";\r\n}\r\n\r\n.data-icon-rotate-left:before {\r\n    content: "\\e780";\r\n}\r\n\r\n.data-icon-math:before {\r\n    content: "\\e781";\r\n}\r\n\r\n.data-icon-overflow:before {\r\n    content: "\\e782";\r\n}\r\n\r\n.data-icon-redo:before {\r\n    content: "\\e783";\r\n}\r\n\r\n.data-icon-searchreplace:before {\r\n    content: "\\e785";\r\n}\r\n\r\n.data-icon-save:before {\r\n    content: "\\e786";\r\n}\r\n\r\n.data-icon-singleselect:before {\r\n    content: "\\e787";\r\n}\r\n\r\n.data-icon-rotate-right:before {\r\n    content: "\\e789";\r\n}\r\n\r\n.data-icon-sort-ascending:before {\r\n    content: "\\e78a";\r\n}\r\n\r\n.data-icon-sort-descending:before {\r\n    content: "\\e78b";\r\n}\r\n\r\n.data-icon-toc:before {\r\n    content: "\\e78c";\r\n}\r\n\r\n.data-icon-solit-cells:before {\r\n    content: "\\e78d";\r\n}\r\n\r\n.data-icon-translate:before {\r\n    content: "\\e78f";\r\n}\r\n\r\n.data-icon-successful:before {\r\n    content: "\\e791";\r\n}\r\n\r\n.data-icon-strikethrough:before {\r\n    content: "\\e793";\r\n}\r\n\r\n.data-icon-undo:before {\r\n    content: "\\e794";\r\n}\r\n\r\n.data-icon-underline:before {\r\n    content: "\\e797";\r\n}\r\n\r\n.data-icon-unlink:before {\r\n    content: "\\e798";\r\n}\r\n\r\n.data-icon-wrap:before {\r\n    content: "\\e799";\r\n}\r\n\r\n.data-icon-upload:before {\r\n    content: "\\e79b";\r\n}\r\n\r\n.data-icon-zoom-out:before {\r\n    content: "\\e79c";\r\n}\r\n\r\n.data-icon-zoom-in:before {\r\n    content: "\\e79d";\r\n}\r\n\r\n.data-icon-align-center:before {\r\n    content: "\\e725";\r\n}\r\n\r\n.data-icon-align-justify:before {\r\n    content: "\\e726";\r\n}\r\n\r\n.data-icon-align-left:before {\r\n    content: "\\e727";\r\n}\r\n\r\n.data-icon-align-top:before {\r\n    content: "\\e728";\r\n}\r\n\r\n.data-icon-align-right:before {\r\n    content: "\\e729";\r\n}\r\n\r\n.data-icon-align-middle:before {\r\n    content: "\\e72a";\r\n}\r\n\r\n.data-anticon {\r\n    display: inline-block;\r\n    font-style: normal;\r\n    vertical-align: -0.125em;\r\n    text-align: center;\r\n    text-transform: none;\r\n    line-height: 0;\r\n    text-rendering: optimizeLegibility;\r\n    -webkit-font-smoothing: antialiased;\r\n}\r\n\r\n.data-anticon svg {\r\n    display: inline-block;\r\n}\r\n\r\n@-webkit-keyframes loadingCircle {\r\n    100% {\r\n        transform: rotate(360deg);\r\n    }\r\n}\r\n\r\n@keyframes loadingCircle {\r\n    100% {\r\n        transform: rotate(360deg);\r\n    }\r\n}\r\n\r\n.data-anticon .data-anticon-spin {\r\n    display: inline-block;\r\n    -webkit-animation: loadingCircle 1s infinite linear;\r\n    animation: loadingCircle 1s infinite linear;\r\n}\r\n\r\n.data-anticon > * {\r\n    line-height: 1;\r\n}\r\n\r\n.am-engine {\r\n    position: relative;\r\n    background-color: #FFFFFF;\r\n}\r\n\r\n.am-engine.am-engine-placeholder:before {\r\n    content: attr(data-placeholder);\r\n    pointer-events: none;\r\n    position: absolute;\r\n    color: #bbbfc4;\r\n    height: 0;\r\n}\r\n\r\n.am-engine ::selection {\r\n    background: rgba(180, 213, 254, 0.5) !important;\r\n    color: inherit !important;\r\n}\r\n\r\n.am-engine, .am-engine-view {\r\n    font-family: \'Chinese Quote\', \'Segoe UI\', Roboto, \'PingFang SC\', \'Hiragino Sans GB\', \'Microsoft YaHei\', \'Helvetica Neue\', Helvetica, Arial, sans-serif, \'Apple Color Emoji\';\r\n    word-wrap: break-word;\r\n    outline-style: none;\r\n    white-space: pre-wrap;\r\n    user-select: auto;\r\n    font-size: 14px;\r\n    line-height: 1.74;\r\n    color: #262626;\r\n    letter-spacing: .05em;\r\n    /* pt / px 换算表：https://websemantics.uk/articles/font-size-conversion/ */\r\n}\r\n\r\n.am-engine > *:first-child, .am-engine-view > *:first-child {\r\n    margin-top: 0 !important;\r\n}\r\n\r\n.am-engine p, .am-engine-view p {\r\n    white-space: normal;\r\n    margin: 0;\r\n    line-height: 1.74;\r\n}\r\n\r\n.am-engine [contenteditable="true"], .am-engine-view [contenteditable="true"] {\r\n    outline-style: none;\r\n}\r\n\r\n.am-engine .selection-transparent::selection, .am-engine-view .selection-transparent::selection {\r\n    background: transparent;\r\n}\r\n\r\n/*---------------------------卡片 begin-----------------------*/\r\n\r\n.am-engine [data-card-type], .am-engine-view [data-card-type] {\r\n    white-space: normal;\r\n}\r\n\r\n.am-engine span[data-card-type="inline"], .am-engine-view span[data-card-type="inline"] {\r\n    display: inline-block;\r\n    text-indent: 0;\r\n    vertical-align: baseline;\r\n    white-space: initial;\r\n}\r\n\r\n.am-engine span[data-card-type="inline"] span[data-card-element], .am-engine-view span[data-card-type="inline"] span[data-card-element] {\r\n    display: inline-block;\r\n}\r\n\r\n.am-engine span[data-card-type="inline"] span[data-card-element="center"], .am-engine-view span[data-card-type="inline"] span[data-card-element="center"] {\r\n    vertical-align: bottom;\r\n    border-radius: 2px;\r\n}\r\n\r\n.am-engine span[data-card-type="inline"] span[data-card-element="left"],\r\n.am-engine-view span[data-card-type="inline"] span[data-card-element="left"],\r\n.am-engine span[data-card-type="inline"] span[data-card-element="right"], .am-engine-view span[data-card-type="inline"] span[data-card-element="right"] {\r\n    text-align: left;\r\n    user-select: text;\r\n    min-width: 1px;\r\n    background: transparent;\r\n    bottom: 0;\r\n}\r\n\r\n.am-engine span[data-card-type="inline"] span[data-card-element="left"],\r\n.am-engine-view span[data-card-type="inline"] span[data-card-element="left"] {\r\n    left: -1px;\r\n}\r\n\r\n.am-engine span[data-card-type="inline"] span[data-card-element="right"], .am-engine-view span[data-card-type="inline"] span[data-card-element="right"] {\r\n    right: -1px;\r\n}\r\n\r\n.am-engine span[data-card-type="inline"] span[data-card-element="left"]::selection,\r\n.am-engine-view span[data-card-type="inline"] span[data-card-element="left"]::selection,\r\n.am-engine span[data-card-type="inline"] span[data-card-element="right"]::selection, .am-engine-view span[data-card-type="inline"] span[data-card-element="right"]::selection {\r\n    background: transparent !important;\r\n}\r\n\r\n.am-engine div[data-card-type="block"], .am-engine-view div[data-card-type="block"], .am-engine span[data-card-type="inline"].data-card-block, .am-engine-view span[data-card-type="inline"].data-card-block {\r\n    display: block;\r\n}\r\n\r\n.am-engine div[data-card-type="block"] > div[data-card-element="body"] > span[data-card-element="left"], .am-engine-view div[data-card-type="block"] > div[data-card-element="body"] > span[data-card-element="left"], .am-engine span[data-card-type="inline"].data-card-block > div[data-card-element="body"] > span[data-card-element="left"], .am-engine-view span[data-card-type="inline"].data-card-block > div[data-card-element="body"] > span[data-card-element="left"], .am-engine div[data-card-type="block"] > div[data-card-element="body"] > span[data-card-element="right"], .am-engine-view div[data-card-type="block"] > div[data-card-element="body"] > span[data-card-element="right"], .am-engine span[data-card-type="inline"].data-card-block > div[data-card-element="body"] > span[data-card-element="right"], .am-engine-view span[data-card-type="inline"].data-card-block > div[data-card-element="body"] > span[data-card-element="right"] {\r\n    bottom: 0;\r\n    position: absolute;\r\n    width: 2px;\r\n    overflow: hidden;\r\n    outline: none;\r\n    text-align: left;\r\n    text-indent: 0;\r\n    -webkit-box-flex: 0;\r\n    flex: 0 0 auto;\r\n    -webkit-user-select: text;\r\n    user-select: text;\r\n}\r\n\r\n.am-engine div[data-card-type="block"] > div[data-card-element="body"] > span[data-card-element="left"], .am-engine-view div[data-card-type="block"] > div[data-card-element="body"] > span[data-card-element="left"], .am-engine span[data-card-type="inline"].data-card-block > div[data-card-element="body"] > span[data-card-element="left"], .am-engine-view span[data-card-type="inline"].data-card-block > div[data-card-element="body"] > span[data-card-element="left"] {\r\n    left: -2px;\r\n    text-align: left;\r\n}\r\n\r\n.am-engine div[data-card-type="block"] > div[data-card-element="body"] > span[data-card-element="right"], .am-engine-view div[data-card-type="block"] > div[data-card-element="body"] > span[data-card-element="right"], .am-engine span[data-card-type="inline"].data-card-block > div[data-card-element="body"] > span[data-card-element="right"], .am-engine-view span[data-card-type="inline"].data-card-block > div[data-card-element="body"] > span[data-card-element="right"] {\r\n    right: -2px;\r\n    text-align: right;\r\n}\r\n\r\n.am-engine div[data-card-type="block"] > div[data-card-element="body"] > span[data-card-element="left"]::selection,\r\n.am-engine-view div[data-card-type="block"] > div[data-card-element="body"] > span[data-card-element="left"]::selection,\r\n.am-engine span[data-card-type="inline"].data-card-block > div[data-card-element="body"] > span[data-card-element="left"]::selection,\r\n.am-engine-view span[data-card-type="inline"].data-card-block > div[data-card-element="body"] > span[data-card-element="left"]::selection {\r\n    background: transparent !important;\r\n}\r\n\r\n.am-engine div[data-card-type="block"] > div[data-card-element="body"] > span[data-card-element="right"]::selection,\r\n.am-engine-view div[data-card-type="block"] > div[data-card-element="body"] > span[data-card-element="right"]::selection,\r\n.am-engine span[data-card-type="inline"].data-card-block > div[data-card-element="body"] > span[data-card-element="right"]::selection,\r\n.am-engine-view span[data-card-type="inline"].data-card-block > div[data-card-element="body"] > span[data-card-element="right"]::selection {\r\n    background: transparent !important;\r\n}\r\n\r\n.am-engine span[data-card-element="body"], .am-engine-view span[data-card-element="body"], .am-engine div[data-card-element="body"], .am-engine-view div[data-card-element="body"] {\r\n    position: relative;\r\n}\r\n\r\n.am-engine span[data-card-element="body"] [data-card-element="center"], .am-engine-view span[data-card-element="body"] [data-card-element="center"], .am-engine div[data-card-element="body"] [data-card-element="center"], .am-engine-view div[data-card-element="body"] [data-card-element="center"] {\r\n    -webkit-user-select: text;\r\n    user-select: text;\r\n}\r\n\r\n.am-engine span[data-card-element="body"] [data-element="editable"], .am-engine div[data-card-element="body"] [data-element="editable"] {\r\n    cursor: text;\r\n}\r\n\r\n/*---------------------------卡片 end-----------------------*/\r\n');class Qu extends Rc{get readonly(){return this._readonly}set readonly(e){this.readonly!==e&&(e?(this.hotkey.disable(),this._container.setReadonly(!0),this.model.mutation.stop()):(this.hotkey.enable(),this._container.setReadonly(!1),this.model.mutation.start()),this._readonly=e,this.card.reRender(),this.trigger("readonly",e))}constructor(e,t){super(e,t),this._readonly=!1,this.kind="engine",this.options={...this.options,...t},this.history=new Vu(this),this._container=new Ju(this.container,{engine:this,lang:this.options.lang,className:this.options.className,tabIndex:this.options.tabIndex,placeholder:this.options.placeholder,autoPrepend:this.options.autoPrepend,autoAppend:this.options.autoAppend}),this.root=Ss(this.options.root||this.container.parent()||ii().body);const n=this.root.css("position");n&&"static"!==n||this.root.css("position","relative"),this._container.init(),this.change=new Xc(this,{onChange:e=>this.trigger("change",e),onSelect:()=>this.trigger("select"),onSelectStart:()=>this.trigger("selectStart"),onSelectEnd:()=>this.trigger("selectEnd"),onRealtimeChange:e=>{this.trigger("realtimeChange",e)},onSetValue:()=>this.trigger("afterSetValue")}),this.change.init(),this.typing=new Ku(this),this._readonly=void 0!==this.options.readonly&&this.options.readonly,this._container.setReadonly(this._readonly),this.hotkey=new Hu(this),this.init(),this.isEmpty()&&this._container.showPlaceholder(),this.model=ju.from(this),this.model.resetRoot()}isFocus(){return this._container.isFocus()}isEmpty(){return this.change.isEmpty()}focus(e){this.change.range.focus(e)}blur(){this.change.range.blur()}getValue(e=!1){const t=this.change.getValue({ignoreCursor:e});return e?ac.removeTags(t):t}async getValueAsync(e=!1,t){return(async()=>{for(const e in this.plugin.components){const n=this.plugin.components[e],r=await new Promise(e=>{n.waiting?n.waiting(t).then(()=>e(!0)).catch(e):e(!0)});if("object"==typeof r)throw r}return this.getValue(e)})()}getHtml(){const e=Ss(this.container[0].cloneNode(!0));return e.removeAttributes(Rs),e.removeAttributes("tabindex"),e.removeAttributes("autocorrect"),e.removeAttributes("autocomplete"),e.removeAttributes("spellcheck"),e.removeAttributes("data-gramm"),e.removeAttributes(Zu),e.removeClass(Gu),e.removeAttributes("role"),new yc(e,this).toHTML()}initDocOnReadonly(){this.readonly&&this.model.resetRoot()}setValue(e,t){return e=this.trigger("beforeSetValue",e)||e,this.change.setValue(e,void 0,t),this.normalize(),this.nodeId.generateAll(this.container),this.initDocOnReadonly(),this}setHtml(e,t){return this.change.setHtml(e,e=>{this.normalize(),this.container.allChildren("editable").forEach(e=>{this.node.isInline(e)?this.inline.repairCursor(e):this.node.isMark(e)&&this.mark.repairCursor(e)}),t&&t(e)}),this.nodeId.generateAll(this.container),this.initDocOnReadonly(),this}setMarkdown(e,t){return this.change.setMarkdown(e,e=>{this.normalize(),this.container.allChildren("editable").forEach(e=>{this.node.isInline(e)?this.inline.repairCursor(e):this.node.isMark(e)&&this.mark.repairCursor(e)}),t&&t(e)}),this.nodeId.generateAll(this.container),this.initDocOnReadonly(),this}setJsonValue(e,t){const n=this.model.toValue(e);return this.change.setValue(n,void 0,t),this.normalize(),this.nodeId.generateAll(this.container),this.initDocOnReadonly(),this}getJsonValue(){return al(this.model.root)}getText(e){return new yc(this.container,this).toText(this.schema,e)}normalize(e=this.container){let t=Ss("<p />"),n=e.children();n.each((e,r)=>{const i=n.eq(r);i&&(this.node.isBlock(i)?(t.get().childNodes.length>0&&i.before(t),t=Ss("<p />")):i.isCursor()||t.append(i))}),t.get().childNodes.length>0&&e.append(t),n=e.children(),n.each((e,t)=>{const r=n.eq(t);if(r&&(this.node.removeMinusStyle(r,"text-indent"),this.node.isRootBlock(r))){const e=r.get().childNodes.length;if(0===e)r.append(Ss("<br />"));else{const t=r.first();1===e&&"span"===t?.name&&[Ci,xi,Ei].indexOf(t.attributes(Hr))>=0&&r.prepend(Ss("<br />"))}}})}showPlaceholder(){this._container.showPlaceholder()}hidePlaceholder(){this._container.hidePlaceholder()}destroy(){this._container.destroy(),this.change.destroy(),this.hotkey.destroy(),this.typing.destroy(),this.model.destroy(),this.history.reset(),super.destroy()}}Fs('.card-maximize-header {\r\n    position: fixed !important;\r\n    top: 0;\r\n    right: 0;\r\n    left: 0;\r\n    z-index: 9999;\r\n    height: 56px;\r\n    background: #fff;\r\n    border-bottom: 1px solid #e8e8e8;\r\n    width: 100%;\r\n}\r\n\r\n.card-maximize-header .header-crumb {\r\n    float: left;\r\n    line-height: 32px;\r\n    display: flex;\r\n    height: 100%;\r\n    align-items: center;\r\n    -webkit-box-align: center;\r\n    -ms-flex-align: center;\r\n}\r\n\r\n.card-maximize-header .header-crumb a {\r\n    color: #595959 !important;\r\n    font-size: 14px;\r\n    cursor: pointer;\r\n}\r\n\r\n.card-maximize-header .header-crumb .split {\r\n    display: inline-block;\r\n    vertical-align: middle;\r\n    padding: 0 15px;\r\n    font-size: 20px;\r\n    padding-right: 8px;\r\n    font-weight: 200;\r\n    margin: 0 8px;\r\n}\r\n\r\n.card-maximize-header .header-crumb .split + a {\r\n    display: inline-block;\r\n    vertical-align: middle;\r\n}\r\n\r\n.card-maximize-header .header-crumb .split + a:hover {\r\n    color: #8C8C8C;\r\n}\r\n\r\n.data-card-block-max > [data-card-element="body"] > [data-card-element="center"], .data-card-block-max > [data-card-element="body"] > [data-card-element="center"].data-card-background-selected {\r\n    top: 96px;\r\n    background: #fafafa !important;\r\n    position: fixed !important;\r\n    right: 0;\r\n    bottom: 0;\r\n    left: 0;\r\n    z-index: 124;\r\n    overflow: auto;\r\n    padding: 20px;\r\n}\r\n\r\n.am-engine-mobile .data-card-block-max > [data-card-element="body"] > [data-card-element="center"], .am-engine-view .data-card-block-max > [data-card-element="body"] > [data-card-element="center"] {\r\n    top: 56px;\r\n}\r\n');class ef{constructor(e,t){this.editor=e,this.card=t}restore(){this.card.root.removeClass("data-card-block-max"),this.node&&(this.node.remove(),this.node=void 0);const e=this.editor;Es(e)&&(e.trigger("card:minimize",this.card),e.history.reset())}maximize(){if(this.node)return;const e=this.editor,{language:t}=e,n=t.get("maximize","back").toString(),r=Ss(`<div class="card-maximize-header" ${Qr}="true" ${Hr}="${Yr}">\n            <div class="header-crumb">\n                <a class="split">\n                    <span class="data-icon data-icon-arrow-left"></span>\n                </a>\n                <a>${n}</a>\n            </div>\n        </div>`);r.on("click",e=>{e.stopPropagation()}),this.card.root.addClass("data-card-block-max");r.find(".header-crumb").on("click",()=>{this.card.minimize()});const i=this.card.findByKey("body");i?.prepend(r),Es(e)&&(e.trigger("card:maximize",this.card),e.history.reset()),this.node=r}}var tf,nf,rf,sf,of,af,lf,cf,df;Fs(".data-card-resize {\r\n    position: absolute;\r\n    bottom: -3px;\r\n    right: 0;\r\n    left: 0;\r\n    margin: 0 auto;\r\n    z-index: 2;\r\n    display: flex;\r\n    align-items: center;\r\n    justify-content: center;\r\n}\r\n\r\n.data-card-resize-btn {\r\n    background: #d9dbdd;\r\n    border-radius: 3px;\r\n    height: 6px;\r\n    padding: 0 50px;\r\n    display: block;\r\n}\r\n\r\n.data-card-resize-btn svg {\r\n    display: block;\r\n    color: #999;\r\n}\r\n\r\n.data-card-resize-btn:hover {\r\n    cursor: row-resize;\r\n}\r\n");class hf{constructor(e,t){this.options={},this.start=!1,this.touchStart=e=>{e.preventDefault(),e.cancelBubble=!0,this.point={x:e.targetTouches[0].clientX,y:e.targetTouches[0].clientY};const{dragStart:t}=this.options;t&&t(this.point)},this.dragStart=e=>{e.preventDefault(),e.stopPropagation(),e.cancelBubble=!0,this.point={x:e.clientX,y:e.clientY};const{dragStart:t}=this.options;t&&t(this.point)},this.dragMove=e=>{if(this.point){const{dragMove:t}=this.options;t&&t(e.clientY-this.point.y)}},this.touchMove=e=>{if(e.preventDefault(),this.point){const{dragMove:t}=this.options;t&&t(e.targetTouches[0].clientY-this.point.y)}},this.dragEnd=()=>{this.point=void 0;const{dragEnd:e}=this.options;e&&e()},this.editor=e,this.card=t}create(e){this.options=e;const t=Ss(`<div class="data-card-resize" ${Hr}="${Yr}" draggable="true"><span class="data-card-resize-btn"><svg viewBox="0 0 3413 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" fill="currentColor" width="8px" height="6px"><path d="M341.333333 341.333333h2730.666667a170.666667 170.666667 0 0 0 0-341.333333H341.333333a170.666667 170.666667 0 1 0 0 341.333333zM341.333333 1024h2730.666667a170.666667 170.666667 0 0 0 0-341.333333H341.333333a170.666667 170.666667 0 0 0 0 341.333333z"></path></svg></span></div>`);Zi?(t.on("touchstart",this.touchStart),t.on("touchmove",this.touchMove),t.on("touchend",this.dragEnd),t.on("touchcancel",this.dragEnd)):(t.on("dragstart",this.dragStart),document.addEventListener("mousemove",this.dragMove),document.addEventListener("mouseup",this.dragEnd)),t.on("click",e=>{e.stopPropagation()}),this.component=t}render(e=this.card.root,t=80){this.start=!1;let n=0,r=0;const i=this.card;this.create({dragStart:()=>{n=e.height(),this.start=!0,i.onActivate(!1)},dragMove:i=>{this.start&&(r=n+i,r=r<t?t:r,e.css("height",`${r}px`))},dragEnd:()=>{this.start&&(i.setValue({height:e.height()}),this.start=!1,i.onActivate(!0))}});const s=this.component;if(!s)return;i.activated||s.hide(),e.append(s);const o=i.getValue()||{};o.height&&e.css("height",`${o.height}px`)}show(){this.component?.show()}hide(){this.start||this.component?.hide()}destroy(){const e=this.component;if(Zi){if(!e)return;e.off("touchstart",this.touchStart),e.off("touchmove",this.touchMove),e.off("touchend",this.dragEnd),e.off("touchcancel",this.dragEnd)}else e?.off("dragstart",this.dragStart),document.removeEventListener("mousemove",this.dragMove),document.removeEventListener("mouseup",this.dragEnd);e?.remove()}}class uf{constructor(e){tf.set(this,void 0),nf.set(this,void 0),rf.set(this,void 0),sf.set(this,"bottomLeft"),of.set(this,[0,0]),af.set(this,void 0),lf.set(this,void 0),cf.set(this,void 0),df.set(this,void 0),this.updateListener=()=>{$c(this,cf,"f")&&clearTimeout($c(this,cf,"f")),jc(this,cf,setTimeout(()=>{this.update()},50),"f")},this.update=(e=!0)=>{if(!$c(this,nf,"f")||0===$c(this,nf,"f").length||!$c(this,rf,"f")||0===$c(this,rf,"f").length)return;const t=h($c(this,nf,"f").get(),$c(this,rf,"f").get(),{...du[$c(this,sf,"f")],targetOffset:$c(this,of,"f")});if($c(this,lf,"f")&&e){const e=Object.keys(du).find(e=>{const n=du[e].points;return n[0]===t.points[0]&&n[1]===t.points[1]});$c(this,nf,"f").attributes("data-placement",e),$c(this,lf,"f").call(this,{...t,align:e})}},jc(this,tf,e,"f")}bind(e,t,n=$c(this,sf,"f"),r=$c(this,of,"f"),i){if(jc(this,nf,e,"f"),jc(this,rf,t,"f"),jc(this,sf,n,"f"),jc(this,of,r,"f"),jc(this,af,Ss('<div style="position: absolute; top: 0px; left: 0px; width: 100%;"></div>'),"f"),$c(this,af,"f").append($c(this,nf,"f")),$c(this,tf,"f").root.append($c(this,af,"f")),jc(this,lf,i,"f"),Zi||window.addEventListener("scroll",this.updateListener,{passive:!0}),window.addEventListener("resize",this.updateListener),Es($c(this,tf,"f"))&&!Zi&&$c(this,tf,"f").scrollNode?.on("scroll",this.updateListener,{passive:!0}),t&&t.length>0){let e={width:t.width(),height:t.height()};"undefined"!=typeof ResizeObserver&&(jc(this,df,new ResizeObserver(()=>{const n=t.width(),r=t.height();n===e.width&&r===e.height||(e={width:n,height:r},this.updateListener())}),"f"),$c(this,df,"f").observe(t.get()))}this.update()}setOffset(e){jc(this,of,e,"f")}destroy(){jc(this,lf,void 0,"f"),Zi||window.removeEventListener("scroll",this.updateListener),window.removeEventListener("resize",this.updateListener),Es($c(this,tf,"f"))&&!Zi&&$c(this,tf,"f").scrollNode?.off("scroll",this.updateListener),$c(this,df,"f")?.disconnect(),$c(this,af,"f")?.remove()}}tf=new WeakMap,nf=new WeakMap,rf=new WeakMap,sf=new WeakMap,of=new WeakMap,af=new WeakMap,lf=new WeakMap,cf=new WeakMap,df=new WeakMap;var ff,gf,pf,mf;Fs(".data-card-dnd {\r\n    position: absolute;\r\n    top: 0;\r\n    left: -21px;\r\n    right: auto;\r\n    bottom: auto;\r\n    width: 18px;\r\n    height: 24px;\r\n    line-height: 24px;\r\n    font-size: 14px;\r\n    font-weight: normal;\r\n    display: none;\r\n    opacity: 0;\r\n    z-index: 125;\r\n    transition: all 0.3s ease-in-out;\r\n    background: rgba(255, 255, 255, 0.9);\r\n}\r\n\r\n.data-card-dnd-active {\r\n    display: block;\r\n    opacity: 1;\r\n    cursor: pointer;\r\n}\r\n\r\n.data-card-dnd:hover {\r\n    background: #f4f4f4;\r\n    color: #595959;\r\n}\r\n\r\n.data-card-dnd-trigger {\r\n    width: 18px;\r\n    height: 24px;\r\n    text-align: center;\r\n    color: #BFBFBF;\r\n    font-size: 16px;\r\n    border-radius: 2px 2px;\r\n    cursor: move;\r\n    cursor: grab;\r\n    cursor: -moz-grab;\r\n    cursor: -webkit-grab;\r\n}\r\n\r\n.am-engine-view .data-toolbar-active {\r\n    min-width: 200px;\r\n}\r\n\r\n.data-card-toolbar.data-toolbar-block {\r\n    top: -48px;\r\n    bottom: auto;\r\n    display: none;\r\n}\r\n\r\n.data-card-toolbar.data-card-toolbar-active {\r\n    display: block;\r\n}\r\n\r\n.data-card-toolbar.data-toolbar-active {\r\n    display: block;\r\n}\r\n");const bf=e=>-1===["button","input","dropdown","node","switch"].indexOf(e.type);class vf{constructor(e,t){ff.set(this,null),gf.set(this,null),pf.set(this,"topLeft"),mf.set(this,null),this.clearHide=()=>{$c(this,ff,"f")&&clearTimeout($c(this,ff,"f")),jc(this,ff,null,"f")},this.clearShow=()=>{$c(this,gf,"f")&&clearTimeout($c(this,gf,"f")),jc(this,gf,null,"f")},this.enterHide=()=>{this.clearShow(),jc(this,ff,setTimeout(()=>{this.hide(),jc(this,ff,null,"f");const e=this.toolbar;e?.root?.off("mouseenter",this.clearHide),e?.root?.off("mouseleave",this.enterHide)},200),"f")},this.enterShow=()=>{this.clearHide(),jc(this,gf,setTimeout(()=>{jc(this,gf,null,"f"),this.show();const e=this.toolbar;e?.root?.on("mouseenter",this.clearHide),e?.root?.on("mouseleave",this.enterHide)},200),"f")},this.editor=e,this.card=t,this.position=new uf(e),this.dndPosition=new uf(e),this.unbindEnterShow(),Es(e)&&!e.readonly||this.bindEnterShow()}setDefaultAlign(e){jc(this,pf,e,"f")}bindEnterShow(){this.card.root.on("mouseenter",this.enterShow),this.card.root.on("mouseleave",this.enterHide)}unbindEnterShow(){this.card.root.off("mouseenter",this.enterShow),this.card.root.off("mouseleave",this.enterHide)}setOffset(e){this.offset=e}getContainer(){return this.toolbar?.root}getDefaultItem(e){const t=this.editor,{language:n,clipboard:r,card:i}=t;return"separator"===e.type?{key:"separator",type:"node",node:e.node||Ss('<span class="data-toolbar-item-split"></span>')}:"copy"===e.type?{key:"copy",type:"button",content:e.content||'<span class="data-icon data-icon-copy"></span>',title:e.title||n.get("copy","title"),onClick:(i,s)=>{if(e.onClick)return void e.onClick(i,s);r.copy(this.card.root[0],!0)?t.messageSuccess("copy",n.get("copy","success")):t.messageError("copy",n.get("copy","error"))}}:"delete"===e.type?{key:"delete",type:"button",content:e.content||'<span class="data-icon data-icon-delete"></span>',title:e.title||n.get("delete","title").toString(),onClick:(t,n)=>{e.onClick?e.onClick(t,n):i.remove(this.card.root)}}:"maximize"===e.type?{key:"maximize",type:"button",content:e.content||'<span class="data-icon data-icon-maximize"></span>',title:e.title||n.get("maximize","title").toString(),onClick:(t,n)=>{e.onClick?e.onClick(t,n):this.card.maximize()}}:"more"===e.type?{key:"more",type:"dropdown",content:e.content||'<span class="data-icon data-icon-more"></span>',title:e.title||n.get("more","title").toString(),items:e.items}:void 0}getItems(){if(!this.card.toolbar)return[[],[]];const e=this.card.toolbar(),t=[];return e.forEach(e=>{if(bf(e))if("dnd"===e.type);else{const n=this.getDefaultItem(e);n&&t.push(n)}else t.push(e)}),[t,e]}create(){this.hide();const[e,t]=this.getItems();if(e.length>0){const n=t.find(e=>bf(e)&&"dnd"===e.type);if(n&&!Zi&&"dnd"===n.type){const{root:e,language:t}=this.editor,r=this.createDnd(n.content||'<span class="data-icon data-icon-drag"></span>',n.title||t.get("dnd","title").toString());e.append(r),jc(this,mf,r,"f")}const r=new vu({items:e});r.root.addClass("data-card-toolbar"),r.root.attributes(Ni,this.card.id),r.render(Ss(document.body)),r.hide(),this.toolbar=r}}update(){const[e]=this.getItems();this.toolbar?.update({items:e})}hide(){$c(this,mf,"f")?.remove(),this.dndPosition.destroy(),this.hideCardToolbar()}show(){this.showCardToolbar()}hideCardToolbar(){this.toolbar?.destroy(),this.position.destroy()}showDnd(){$c(this,mf,"f")&&0!==$c(this,mf,"f").length&&(this.card.isMaximize?$c(this,mf,"f").removeClass("data-card-dnd-active"):$c(this,mf,"f").length>0&&($c(this,mf,"f").addClass("data-card-dnd-active"),setTimeout(()=>{this.dndPosition.bind($c(this,mf,"f"),this.card.root,"leftTop",this.offset)},10)))}showCardToolbar(){this.create();const e=this.getContainer();if(e&&e.length>0){this.showDnd();const t=this.card;e.addClass("data-toolbar-active"),e.attributes("toolbar-trigger-key",t.constructor.cardName),this.toolbar&&this.toolbar.show();let n=$c(this,pf,"f");const r=this.position;setTimeout(()=>{r.bind(e,t.isMaximize?t.getCenter().first():t.root,$c(this,pf,"f"),this.offset,e=>{this.offset&&4===this.offset.length&&"bottomLeft"===e.align&&e.align!==n?(r.setOffset([this.offset[2],this.offset[3]]),n=e.align,r.update(!1)):this.offset&&e.align===$c(this,pf,"f")&&e.align!==n&&(r.setOffset(this.offset),n=e.align,r.update(!1)),n=e.align})},10)}}createDnd(e,t){const n=Ss(`<div ${Hr}="${Yr}" class="data-card-dnd" draggable="true" dnd-trigger-key="${this.card.constructor.cardName}" drag-card-trigger="${this.card.id}" ${Rs}="false">\n                <div class="data-card-dnd-trigger">\n                    ${e}\n                </div>\n           </div>`);return n.on("mouseenter",()=>{hu.show(n,t)}),n.on("mouseleave",()=>{hu.hide()}),n.on("mousedown",e=>{e.stopPropagation(),hu.hide(),this.hideCardToolbar()}),n.on("mouseup",()=>{this.showCardToolbar()}),n}destroy(){this.unbindEnterShow(),this.dndPosition.destroy(),this.position.destroy()}}ff=new WeakMap,gf=new WeakMap,pf=new WeakMap,mf=new WeakMap;class yf{get isEditable(){return this.contenteditable.length>0}get activated(){return this.root.hasClass("card-activated")}setActivated(e){e?this.root.addClass("card-activated"):this.root.removeClass("card-activated")}get selected(){return this.root.hasClass("card-selected")}setSelected(e){e?this.root.addClass("card-selected"):this.root.removeClass("card-selected")}get id(){if(this._id)return this._id;const e=this.root.attributes(ui);if(!e)return{};const t=ms(e);return"object"==typeof t&&t?.id||""}get name(){return this.root.attributes(ci)}get type(){let e=this.root.attributes(hi);if(!e){const t=this.root.attributes(ui),n=ms(t||"{}");e=n?.type||this.constructor.cardType}return e}set type(e){if(!this.name||e===this.type)return;const t=this.editor.card,n=this.root.attributes(ui),r=ms(n||"{}"),i=t.replace(this,this.name,{...r,type:e});t.render(i.root),i.activate(!1),t.activate(i.root)}get loading(){return!!this.root.attributes(gi)}constructor({editor:e,value:t,root:n}){this.activatedByOther=!1,this.selectedByOther=!1,this.contenteditable=[],this.isMaximize=!1,this.editor=e;const r=t?.type||this.constructor.cardType,i="inline"===r?"span":"div";this.root=n||Ss("<".concat(i," />")),"string"==typeof t&&(t=ms(t)),(t=t||{}).id=this.getId(t.id),this._id=t.id,t.type=r,this.setValue(t),this.defaultMaximize=new ef(e,this)}init(){this.root.attributes(pi,this.isEditable?"true":"false");const e=this.toolbarModel;e?.hide(),e?.destroy();const t=this.editor;this.toolbar&&(this.toolbarModel=new vf(t,this)),this.resize&&(this.resizeModel=new hf(t,this))}getId(e){const t=[];if(this.editor.card.each(e=>{t.push(e.id)}),e&&t.indexOf(e)<0)return e;let n=ts();for(;t.indexOf(n)>=0;)n=ts();return n}setValue(e){if(null==e)return;const t=this.root.attributes(ui),n=ms(t||"{}");n?.id&&delete e.id,(e={...n,...e}).type&&n?.type!==e.type&&(this.type=e.type),this.root.attributes(ui,ps(e))}getValue(){const e=this.root.attributes(ui);return e?ms(e):{}}find(e){return this.root.find(e)}findByKey(e){const t=this.root.first()||Ss([]);if("body"===e||0===t.length)return t;const n=t.children();if(["left","center","right"].indexOf(e)>-1)return n.toArray().find(t=>t.attributes(fi)===e);const r=this.type===Yl.BLOCK?"div":"span",i=this.find(`${r}[${fi}=${e}]`);return i.name===r&&i.attributes(fi)===e?i:void 0}activate(e){e?this.activated||(this.setActivated(e),this.onActivate(e)):this.activated&&(this.setActivated(e),this.onActivate(!1))}select(e){Es(this.editor)&&!this.activatedByOther&&(e?this.selected||this.isMaximize||(this.setSelected(e),this.onSelect(e)):this.selected&&(this.setSelected(e),this.onSelect(!1)))}getCenter(){const e=this.findByKey("center");return e||Ss([])}isCenter(e){const t=e.closest(this.type===Yl.BLOCK?`div[${fi}=center]`:`span[${fi}=center]`);return t.length>0&&!!this.findByKey("center")?.equal(t)}isCursor(e){return this.isLeftCursor(e)||this.isRightCursor(e)}isLeftCursor(e){if(e.isElement()&&"left"!==e.attributes(fi))return!1;const t=e.closest(vi);return t.length>0&&!!this.findByKey("left")?.equal(t)}isRightCursor(e){if(e.isElement()&&"right"!==e.attributes(fi))return!1;const t=e.closest(wi);return t.length>0&&!!this.findByKey("right")?.equal(t)}focus(e,t){const n=this.findByKey("left"),r=this.findByKey("right");if(!n||0===n.length||!r||0===r.length)return;const i=t?n:r;e.select(i,!0).shrinkToTextNode();const s=i.first();s&&(e.setStart(s,t?0:1),e.collapse(!0),Es(this.editor)&&this.editor.change.range.select(e),this.onFocus&&this.onFocus())}maximize(){this.isMaximize=!0,this.defaultMaximize.maximize(),this.toolbarModel?.show()}minimize(){this.isMaximize=!1,this.defaultMaximize.restore(),this.toolbarModel?.show()}onSelect(e){const t=this.constructor.selectStyleType;if(t===Zl.NONE)return;const n=`data-card-${t}-selected`,r=this.getCenter();e?r.addClass(n):r.removeClass(n)}onSelectByOther(e,t){const n=this.getCenter();this.constructor.selectStyleType===Zl.BACKGROUND?n.css("background-color",e?t.rgb:""):n.css("outline",e?"2px solid "+t.color:"");const r="card-selected-other";return e?this.root.addClass(r):this.root.removeClass(r),n}onActivate(e){this.resize&&(e?this.resizeModel?.show():this.resizeModel?.hide())}onActivateByOther(e,t){return this.onSelectByOther(e,t)}initToolbar(){this.toolbar?(this.toolbarModel||(this.toolbarModel=new vf(this.editor,this)),this.activated&&this.toolbarModel.show()):(this.toolbarModel?.hide(),this.toolbarModel?.destroy(),this.toolbarModel=void 0)}initResize(){if(this.resize){this.resizeModel||(this.resizeModel=new hf(this.editor,this));const e="function"==typeof this.resize?this.resize():this.findByKey("body");e&&e.length>0&&this.resizeModel?.render(e)}}didUpdate(){this.initResize(),this.initToolbar()}beforeRender(){const e=this.getCenter(),t=Ss(`<${this.type===Yl.BLOCK?"div":"span"} class="${gi}" ${Hr}="${Yr}" />`);t.append('<svg viewBox="0 0 1024 1024" class="data-card-spin" data-icon="loading" width="1em" height="1em" fill="currentColor" aria-hidden="true"> <path d="M988 548c-19.9 0-36-16.1-36-36 0-59.4-11.6-117-34.6-171.3a440.45 440.45 0 0 0-94.3-139.9 437.71 437.71 0 0 0-139.9-94.3C629 83.6 571.4 72 512 72c-19.9 0-36-16.1-36-36s16.1-36 36-36c69.1 0 136.2 13.5 199.3 40.3C772.3 66 827 103 874 150c47 47 83.9 101.8 109.7 162.7 26.7 63.1 40.2 130.2 40.2 199.3.1 19.9-16 36-35.9 36z"></path></svg>'),e.empty().append(t)}didRender(){this.loading&&(this.find(`.${gi}`).remove(),setTimeout(()=>{this.root.removeAttributes(gi)},200)),this.initResize(),this.initToolbar(),this.isEditable&&this.editor.nodeId.generateAll(this.getCenter().get())}destroy(){this.toolbarModel?.hide(),this.toolbarModel?.destroy(),this.toolbarModel=void 0,this.resizeModel?.hide(),this.resizeModel?.destroy(),this.resizeModel=void 0}}yf.autoSelected=!0,yf.collab=!0,yf.selectStyleType=Zl.BORDER,yf.lazyRender=!1;class wf extends Rc{constructor(e,t){super(e,t),this.kind="view",this.init(),this.container.hasClass(ni)||this.container.addClass(ni)}render(e,t=!0){const n=new yc(e,this).toValue(this.schema,this.conversion,!1,!0);this.container.html(n),this.card.render(this.container,()=>{t&&this.trigger("render",this.container)})}}var Nf=fd,xf=G;var Ef,Cf,kf,Tf,Of,Sf,Af=f(function(e,t,n){var r=!0,i=!0;if("function"!=typeof e)throw new TypeError("Expected a function");return xf(n)&&(r="leading"in n?!!n.leading:r,i="trailing"in n?!!n.trailing:i),Nf(e,t,{leading:r,maxWait:t,trailing:i})});Fs(".data-scrollable::-webkit-scrollbar {\r\n    display: none;\r\n    overflow: hidden;\r\n}\r\n\r\n.data-scrollable.scroll-x {\r\n    padding-bottom: 10px;\r\n    overflow-x: hidden;\r\n}\r\n\r\n.data-scrollable.scroll-y {\r\n    padding-right: 10px;\r\n    overflow-y: hidden;\r\n}\r\n\r\n.data-scrollable:hover .data-scrollbar {\r\n    display: block;\r\n}\r\n\r\n.data-scrollable.scrolling {\r\n    -webkit-user-select: none;\r\n    -moz-user-select: none;\r\n    -ms-user-select: none;\r\n    user-select: none;\r\n}\r\n\r\n.data-scrollable.scrolling .data-scrollbar {\r\n    display: block;\r\n}\r\n\r\n.data-scrollable .data-scrollbar {\r\n    display: none;\r\n    position: absolute;\r\n    cursor: default;\r\n    transition: opacity 0.3s ease-in-out;\r\n}\r\n\r\n.data-scrollable .data-scrollbar .data-scrollbar-trigger {\r\n    position: absolute;\r\n    background: #c1c1c1;\r\n    border-radius: 10px;\r\n    cursor: pointer;\r\n}\r\n\r\n.data-scrollable .data-scrollbar .data-scrollbar-trigger:hover {\r\n    background: #888;\r\n}\r\n\r\n.data-scrollable .data-scrollbar.data-scrollbar-x {\r\n    height: 8px;\r\n    bottom: 0px;\r\n}\r\n\r\n.data-scrollable .data-scrollbar.data-scrollbar-x .data-scrollbar-trigger {\r\n    height: 8px;\r\n    min-width: 60px;\r\n}\r\n\r\n.data-scrollable .data-scrollbar.data-scrollbar-y {\r\n    top: 0;\r\n    width: 8px;\r\n    height: 100%;\r\n    right: 0px;\r\n}\r\n\r\n.data-scrollable .data-scrollbar.data-scrollbar-y .data-scrollbar-trigger {\r\n    width: 8px;\r\n    min-height: 60px;\r\n}\r\n\r\n.data-scrollable .scrollbar-shadow-left {\r\n    position: absolute;\r\n    z-index: 10;\r\n    left: 0;\r\n    top: 0;\r\n    bottom: 0;\r\n    width: 4px;\r\n    opacity: 0.8;\r\n    background: linear-gradient(270deg, rgba(99, 114, 130, 0) 0, rgba(99, 114, 130, 0.16));\r\n    background: -webkit-linear-gradient(right, rgba(99, 114, 130, 0), rgba(99, 114, 130, 0.16));\r\n    pointer-events: none;\r\n}\r\n\r\n.data-scrollable .scrollbar-shadow-right {\r\n    position: absolute;\r\n    z-index: 10;\r\n    left: 0;\r\n    top: 0;\r\n    bottom: 0;\r\n    width: 4px;\r\n    opacity: 0.8;\r\n    background: linear-gradient(90deg, rgba(99, 114, 130, 0) 0, rgba(99, 114, 130, 0.16));\r\n    background: -webkit-linear-gradient(left, rgba(99, 114, 130, 0), rgba(99, 114, 130, 0.16));\r\n    pointer-events: none;\r\n}\r\n");class Mf extends o{constructor(e,t=!0,n=!1,r=!0,i){super(),this.oWidth=0,this.oHeight=0,this.sWidth=0,this.sHeight=0,this.xWidth=0,this.yHeight=0,Ef.set(this,void 0),Cf.set(this,void 0),kf.set(this,void 0),Tf.set(this,!0),Of.set(this,void 0),Sf.set(this,!1),this.refresh=()=>{const e=this.container.get();if(e){const t=()=>{setTimeout(()=>{jc(this,Sf,!1,"f")},0)},{scrollTop:n}=e,r=$c(this,kf,"f")?.get(),i=gs(this.container.css("padding-left")),s=gs(this.container.css("padding-right")),o=gs(this.container.css("padding-top")),a=gs(this.container.css("padding-bottom")),l=r?$c(this,kf,"f").width()+i+s:e.scrollWidth,c=r?$c(this,kf,"f").height()+o+a:e.scrollHeight;if(this.oWidth=this.getWidth(),this.oHeight=this.container.height()-gs(this.container.css("border-top-width"))-gs(this.container.css("border-bottom-width")),this.sWidth=l,this.sHeight=c,this.xWidth=Math.floor(this.oWidth*this.oWidth/l),this.yHeight=Math.floor(this.oHeight*this.oHeight/c),this.x){this.slideX?.css("width",this.xWidth+"px");const e=Math.round(this.oWidth)-i-s===this.sWidth||r&&Math.round($c(this,kf,"f").width())<=Math.round(this.oWidth-i-s)?"none":"block";this.slideX?.css("display",e),this.emit("display",e),this.shadowLeft?.css("display",e),this.shadowRight?.css("display",e)}if(this.y){this.slideY?.css("height",this.yHeight+"px");const e=Math.round(this.oHeight)-o-a===this.sHeight||r&&Math.round($c(this,kf,"f").height())<=Math.round(this.oHeight-o-a)?"none":"block";this.slideY?.css("display",e),this.emit("display",e)}if(this.x&&r&&e.scrollWidth-i-s>$c(this,kf,"f").width()){jc(this,Sf,!0,"f");let n=e.scrollWidth-i-s-$c(this,kf,"f").width();if($c(this,Of,"f")){const{onScrollX:t,getScrollLeft:r}=$c(this,Of,"f");if(n=r?r(-0)+e.scrollLeft-n:e.scrollLeft-n,n<0&&(n=0),t){const r=t(n);e.scrollLeft=r>0?r:0}this.scroll({left:n})}else e.scrollLeft-=n,t();return}if(this.y&&r&&e.scrollHeight-o-a!==$c(this,kf,"f").height())return jc(this,Sf,!0,"f"),e.scrollTop-=e.scrollHeight-o-a-$c(this,kf,"f").height(),void t();const d=$c(this,Of,"f")?.getScrollLeft?$c(this,Of,"f").getScrollLeft(e.scrollLeft):e.scrollLeft;if($c(this,Of,"f")){const{onScrollX:n}=$c(this,Of,"f");if(n){jc(this,Sf,!0,"f");const r=n(d);e.scrollLeft=r>0?r:0,t()}this.scroll({left:d})}else this.reRenderX(d);this.reRenderY(n)}},this.scroll=e=>{let t=0,n=0;if(!$c(this,Of,"f")&&e instanceof Event){const{scrollTop:r,scrollLeft:i}=e.target;t=r,n=i}else{if(e instanceof Event)return $c(this,Sf,"f")?void 0:void this.refresh();void 0===e.top&&(e.top=this.container.get()?.scrollTop||0),void 0===e.left&&(e.left=this.container.get()?.scrollLeft||0),t=e.top,n=e.left}this.reRenderX(n),this.reRenderY(t)},this.wheelXScroll=Af(e=>{e.preventDefault();const t=(Qi?e.wheelDeltaX:e.wheelDelta/120||-e.detail)>0?"up":"down",n=this.container.get();if(!n)return;const r=this.container.width(),i=$c(this,Of,"f")?.getOffsetWidth?$c(this,Of,"f").getOffsetWidth(r):r,s=Math.max(i/(Qi?20-Math.abs(e.wheelDelta):8),20);let o=($c(this,Of,"f")?.getScrollLeft?$c(this,Of,"f").getScrollLeft(n.scrollLeft):n.scrollLeft)+("up"===t?-s:s);if(o="up"===t?Math.max(0,o):Math.min(o,this.sWidth-this.oWidth),$c(this,Of,"f")){const{onScrollX:e}=$c(this,Of,"f");if(e){const t=e(o);n.scrollLeft=t>0?t:0}this.scroll({left:o})}else n.scrollLeft=o},Qi?50:0,{trailing:!0}),this.wheelYScroll=Af(e=>{e.preventDefault();const t=(Qi?e.wheelDeltaX:e.wheelDelta/120||-e.detail)>0?"up":"down",n=this.container.get();if(!n)return;const r=this.container.height(),i=Math.max(r/(Qi?20-Math.abs(e.wheelDelta):8),20);let s=n.scrollTop+("up"===t?-i:i);s="up"===t?Math.max(0,s):Math.min(s,this.sHeight-this.oHeight),n.scrollTop=s},Qi?100:0,{trailing:!0}),this.bindWheelScroll=e=>{if(!$c(this,Tf,"f"))return;this.x&&e.wheelDeltaX!==e.wheelDeltaY&&Math.abs(e.wheelDeltaX)>Math.abs(e.wheelDeltaY)?this.slideX&&"none"!==this.slideX.css("display")&&this.wheelXScroll(e):this.y&&0!==e.wheelDeltaY&&this.slideY&&"none"!==this.slideY.css("display")&&this.wheelYScroll(e)},this.bindContainerTouchX=e=>{e.target&&$c(this,Tf,"f")&&(Ss(e.target).hasClass("data-scrollbar-trigger")||(jc(this,Cf,!0,"f"),this.scrollXStart(e)))},this.bindContainerTouchY=e=>{e.target&&$c(this,Tf,"f")&&(Ss(e.target).hasClass("data-scrollbar-trigger")||(jc(this,Cf,!0,"f"),this.scrollYStart(e)))},this.getEventClientOffset=e=>e instanceof MouseEvent?{x:e.clientX,y:e.clientY}:{x:e.touches[0].clientX,y:e.touches[0].clientY},this.scrollX=e=>{if(this.slideXDragging){const{point:t,position:n}=this.slideXDragging,r=this.getEventClientOffset(e);let i=$c(this,Cf,"f")?n-(r.x-t):n+(r.x-t);i=Math.max(0,Math.min(i,this.oWidth-this.xWidth)),this.slideX?.css("left",i+"px");let s=i/(this.oWidth-this.xWidth);s=Math.min(1,s);const o=this.container.get(),a=(this.sWidth-this.oWidth)*s;if($c(this,Of,"f")){const{onScrollX:e}=$c(this,Of,"f");if(e){const t=e(a);o.scrollLeft=t>0?t:0}this.scroll({left:a})}else o.scrollLeft=a}},this.scrollY=e=>{if(this.slideYDragging){const{point:t,position:n}=this.slideYDragging,r=this.getEventClientOffset(e);let i=$c(this,Cf,"f")?n-(r.y-t):n+(r.y-t);i=Math.max(0,Math.min(i,this.oHeight-this.yHeight)),this.slideY?.css("top",i+"px");let s=i/(this.oHeight-this.yHeight);s=Math.min(1,s),this.container.get().scrollTop=(this.sHeight-this.oHeight)*s}},this.scrollXEnd=()=>{this.slideXDragging=void 0,jc(this,Cf,!1,"f"),document.body.removeEventListener(Zi?"touchmove":"mousemove",this.scrollX),document.body.removeEventListener(Zi?"touchend":"mouseup",this.scrollXEnd),this.container.removeClass("scrolling")},this.scrollYEnd=()=>{this.slideYDragging=void 0,document.body.removeEventListener(Zi?"touchmove":"mousemove",this.scrollY),document.body.removeEventListener(Zi?"touchend":"mouseup",this.scrollYEnd),this.container.removeClass("scrolling")},this.scrollXStart=e=>{const t=this.getEventClientOffset(e);this.container.addClass("scrolling"),this.slideXDragging={point:t.x,position:parseInt(this.slideX?.css("left")||"0")},document.body.addEventListener(Zi?"touchmove":"mousemove",this.scrollX,{passive:!0}),document.body.addEventListener(Zi?"touchend":"mouseup",this.scrollXEnd,{passive:!0})},this.scrollYStart=e=>{const t=this.getEventClientOffset(e);this.container.addClass("scrolling"),this.slideYDragging={point:t.y,position:parseInt(this.slideY?.css("top")||"0")},document.body.addEventListener(Zi?"touchmove":"mousemove",this.scrollY,{passive:!0}),document.body.addEventListener(Zi?"touchend":"mouseup",this.scrollYEnd,{passive:!0})},this.bindXScrollEvent=()=>{this.x&&this.slideX?.on(Zi?"touchstart":"mousedown",this.scrollXStart,{passive:!0})},this.bindYScrollEvent=()=>{this.y&&this.slideY?.on(Zi?"touchstart":"mousedown",this.scrollYStart,{passive:!0})},this.reRenderShadow=e=>{if(this.shadow){const t=this.container.get();t&&this.shadowLeft?.css("left",($c(this,Of,"f")?t.scrollLeft:e)+"px"),this.shadowRight?.css("left",e+this.oWidth-4+"px")}},this.reRenderX=e=>{if(this.x){this.scrollBarX?.css("left",e+"px");const t=this.sWidth-this.oWidth;let n=t<=0?0:e/t;n=Math.min(1,n),this.slideX?.css("left",(this.oWidth-this.xWidth)*n+"px"),this.emit("change",{x:e,y:gs(this.scrollBarY?.css("top")||"0")}),this.oWidth=this.getWidth(),this.reRenderShadow(e)}},this.reRenderY=e=>{if(this.y){this.scrollBarY?.css("top",e+"px");const t=this.sHeight-this.oHeight;let n=t<=0?0:e/t;n=Math.min(1,n),this.slideY?.css("top",(this.oHeight-this.yHeight)*n+"px"),this.emit("change",{x:gs(this.scrollBarX?.css("left")||"0"),y:e})}},this.container=Mi(e)?Ss(e):e,this.x=t,this.y=n,this.shadow=r,jc(this,Of,i,"f"),this.init()}setContentNode(e){jc(this,kf,e&&Mi(e)?Ss(e):e,"f")}init(){const e=this.container.children();let t=!1;e.each(e=>{!t&&Ss(e).hasClass("data-scrollbar")&&(t=!0)}),t||(this.container.css("position","relative"),this.container.addClass("data-scrollable"),this.x&&(this.scrollBarX=Ss(`<div ${Hr}="${Yr}" class="data-scrollbar data-scrollbar-x"><div class="data-scrollbar-trigger"></div></div>`),this.slideX=this.scrollBarX.find(".data-scrollbar-trigger"),this.container.append(this.scrollBarX),this.container.addClass("scroll-x")),this.y&&(this.scrollBarY=Ss(`<div ${Hr}="${Yr}" class="data-scrollbar data-scrollbar-y"><div class="data-scrollbar-trigger"></div></div>`),this.slideY=this.scrollBarY.find(".data-scrollbar-trigger"),this.container.append(this.scrollBarY),this.container.addClass("scroll-y")),this.shadow&&(this.shadowLeft=Ss(`<div ${Hr}="${Yr}" class="scrollbar-shadow-left"></div>`),this.shadowRight=Ss(`<div ${Hr}="${Yr}" class="scrollbar-shadow-right"></div>`),this.container.append(this.shadowLeft),this.container.append(this.shadowRight)),this.refresh(),this.bindEvents())}getWidth(){if(!this.container.get())return 0;const e=this.container.width();return $c(this,Of,"f")?.getOffsetWidth?$c(this,Of,"f").getOffsetWidth(e):e}enableScroll(){jc(this,Tf,!0,"f")}disableScroll(){jc(this,Tf,!1,"f")}bindEvents(){Zi?(this.x&&this.container.on("touchstart",this.bindContainerTouchX,{passive:!0}),this.y&&this.container.on("touchstart",this.bindContainerTouchY,{passive:!0})):this.container.on(Yi?"DOMMouseScroll":"mousewheel",this.bindWheelScroll),this.container.on("scroll",this.scroll,{passive:!0});this.container.get()&&(window.addEventListener("resize",this.refresh),this.bindXScrollEvent(),this.bindYScrollEvent())}destroy(){this.slideX?.off(Zi?"touchstart":"mousedown",this.scrollXStart),this.slideY?.off(Zi?"touchstart":"mousedown",this.scrollYStart),Zi?(this.x&&this.container.off("touchstart",this.bindContainerTouchX),this.y&&this.container.off("touchstart",this.bindContainerTouchY)):this.container.off(Yi?"DOMMouseScroll":"mousewheel",this.bindWheelScroll),this.container.off("scroll",this.scroll),this.container.removeClass("data-scrollable"),this.x&&(this.scrollBarX?.remove(),this.container.removeClass("scroll-x")),this.y&&(this.scrollBarY?.remove(),this.container.removeClass("scroll-y")),this.shadow&&(this.shadowLeft?.remove(),this.shadowRight?.remove()),$c(this,Ef,"f")?.disconnect(),window.removeEventListener("resize",this.refresh),window.removeEventListener("scroll",this.refresh)}}Ef=new WeakMap,Cf=new WeakMap,kf=new WeakMap,Tf=new WeakMap,Of=new WeakMap,Sf=new WeakMap;Fs(".data-resizer {\r\n    position: absolute;\r\n    width: 100%;\r\n    height: 100%;\r\n    top: 0;\r\n    left: 0;\r\n    bottom: 0px;\r\n    right: 0;\r\n    z-index: 1;\r\n    outline: 2px solid #1890FF;\r\n    max-width: initial !important;\r\n}\r\n\r\n.data-resizer img {\r\n    position: absolute;\r\n    top: 0;\r\n    left: 0;\r\n    bottom: 0;\r\n    right: 0;\r\n    cursor: pointer;\r\n    width: 100%;\r\n    height: 100%;\r\n    opacity: 0.3;\r\n}\r\n\r\n.data-resizer-holder {\r\n    position: absolute;\r\n    width: 14px;\r\n    height: 14px;\r\n    border: 2px solid #fff;\r\n    border-radius: 50%;\r\n    background: #1890FF;\r\n    display: inline-block;\r\n}\r\n\r\n.data-resizer-holder-right-top {\r\n    top: -6px;\r\n    right: -6px;\r\n    cursor: nesw-resize;\r\n}\r\n\r\n.data-resizer-holder-right-bottom {\r\n    bottom: -6px;\r\n    right: -6px;\r\n    cursor: nwse-resize;\r\n}\r\n\r\n.data-resizer-holder-left-bottom {\r\n    bottom: -6px;\r\n    left: -6px;\r\n    cursor: nesw-resize;\r\n}\r\n\r\n.data-resizer-holder-left-top {\r\n    left: -6px;\r\n    top: -6px;\r\n    cursor: nwse-resize;\r\n}\r\n\r\n.data-resizer-number {\r\n    position: absolute;\r\n    display: inline-block;\r\n    line-height: 24px;\r\n    padding: 0 4px;\r\n    font-size: 12px;\r\n    border-radius: 3px 3px;\r\n    background: rgba(0, 0, 0, 0.86);\r\n    color: rgba(255, 255, 255, 0.96);\r\n    font-family: 'Lucida Console', Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;\r\n    opacity: 0;\r\n    visibility: hidden;\r\n    transition: opacity 0.3s ease-in-out;\r\n    transform: scale(0.8);\r\n}\r\n\r\n.data-resizer-number-right-top {\r\n    top: 0px;\r\n    right: -6px;\r\n    transform: translateX(100%) scale(0.8);\r\n}\r\n\r\n.data-resizer-number-right-bottom {\r\n    right: -6px;\r\n    bottom: 0px;\r\n    transform: translateX(100%) scale(0.8);\r\n}\r\n\r\n.data-resizer-number-left-bottom {\r\n    left: -6px;\r\n    bottom: 0px;\r\n    transform: translateX(-100%) scale(0.8);\r\n}\r\n\r\n.data-resizer-number-left-top {\r\n    left: -6px;\r\n    top: 0px;\r\n    transform: translateX(-100%) scale(0.8);\r\n}\r\n\r\n.data-resizer-number-active {\r\n    opacity: 1;\r\n    visibility: visible;\r\n}\r\n");class _f{constructor(e){this.point={x:0,y:0},this.resizing=!1,this.onMouseMove=e=>{e.preventDefault(),e.stopPropagation();const{clientX:t,clientY:n}=window.TouchEvent&&e instanceof TouchEvent?e.touches[0]:e;if(t!==this.point.x||n!==this.point.y){const e=this.point.x-t,r=this.point.y-n;this.updateSize(e,r)}this.resizing=!0},this.onMouseUp=e=>{e.preventDefault(),e.stopPropagation();const t=this.root.get();if(!t)return;const{clientWidth:n,clientHeight:r}=t;this.size={width:n,height:r},this.resizerNumber.removeClass(`data-resizer-number-${this.position}`),this.resizerNumber.removeClass("data-resizer-number-active"),this.position=void 0,this.resizing=!1,this.root.removeClass("data-resizing"),document.removeEventListener(Zi?"touchmove":"mousemove",this.onMouseMove),document.removeEventListener(Zi?"touchend":"mouseup",this.onMouseUp);const{onChange:i}=this.options;i&&i(this.size),this.image?.hide()},this.options=e,this.root=Ss(this.renderTemplate(e.imgUrl)),e.imgUrl&&(this.image=this.root.find("img")),this.image?.hide(),this.resizerNumber=this.root.find(".data-resizer-number");const{width:t,height:n}=this.options;this.size={width:t,height:n},this.maxWidth=this.options.maxWidth}renderTemplate(e){return`<span class="data-resizer">${e?`<img src="${e}">`:""}<span class="data-resizer-holder data-resizer-holder-right-top"></span><span class="data-resizer-holder data-resizer-holder-right-bottom"></span><span class="data-resizer-holder data-resizer-holder-left-bottom"></span><span class="data-resizer-holder data-resizer-holder-left-top"></span><span class="data-resizer-number"></span></span>`}onMouseDown(e,t){this.resizing||(e.preventDefault(),e.stopPropagation(),this.root.css("top",["right-top","left-top"].indexOf(t)>-1?"auto":0),this.root.css("left",["left-top","left-bottom"].indexOf(t)>-1?"auto":0),this.root.css("bottom",["right-bottom","left-bottom"].indexOf(t)>-1?"auto":0),this.root.css("right",["right-top","right-bottom"].indexOf(t)>-1?"auto":0),this.point={x:window.TouchEvent&&e instanceof TouchEvent?e.touches[0].clientX:e.clientX,y:window.TouchEvent&&e instanceof TouchEvent?e.touches[0].clientY:e.clientY},this.position=t,this.resizing=!0,this.root.addClass("data-resizing"),this.resizerNumber.addClass(`data-resizer-number-${this.position}`),this.resizerNumber.addClass("data-resizer-number-active"),this.image?.show(),document.addEventListener(Zi?"touchmove":"mousemove",this.onMouseMove),document.addEventListener(Zi?"touchend":"mouseup",this.onMouseUp))}updateSize(e,t){e=["right-top","right-bottom"].indexOf(this.position||"")>-1?this.size.width-e:this.size.width+e,this.setSize(e,t)}setSize(e,t){e<24&&(e=24);const{rate:n}=this.options;e>this.maxWidth&&(e=this.maxWidth),(t=e*n)<24&&(e=(t=24)/n),e=Math.round(e),t=Math.round(t),this.root.css({width:e+"px",height:t+"px"}),this.resizerNumber.html(`${e}·${t}`)}on(e,t){this.root.on(e,t)}off(e,t){this.root.off(e,t)}render(){const{width:e,height:t}=this.options;return this.setSize(e,t),this.root.find(".data-resizer-holder-right-top").on(Zi?"touchstart":"mousedown",e=>this.onMouseDown(e,"right-top")),this.root.find(".data-resizer-holder-right-bottom").on(Zi?"touchstart":"mousedown",e=>this.onMouseDown(e,"right-bottom")),this.root.find(".data-resizer-holder-left-bottom").on(Zi?"touchstart":"mousedown",e=>this.onMouseDown(e,"left-bottom")),this.root.find(".data-resizer-holder-left-top").on(Zi?"touchstart":"mousedown",e=>this.onMouseDown(e,"left-top")),this.root}destroy(){this.root.remove(),document.removeEventListener("mousemove",this.onMouseMove),document.removeEventListener("mouseup",this.onMouseUp)}}const Bf="markdown-it";class Rf extends Us{constructor(){super(...arguments),this.tagName="strong",this.markdownIt=e=>{!1!==this.options.markdown&&e.enable("emphasis")}}static get pluginName(){return"bold"}init(){super.init();const e=this.editor;Es(e)&&e.on(Bf,this.markdownIt)}hotkey(){return this.options.hotkey||"mod+b"}conversion(){return[{from:{span:{style:{"font-weight":["bold","700"]}}},to:this.tagName},{from:"b",to:this.tagName}]}destroy(){this.editor.off(Bf,this.markdownIt)}}class If extends $s{static get pluginName(){return"undo"}execute(){const e=this.editor;Es(e)&&(e.readonly||e.history.undo())}queryState(){const e=this.editor;if(Es(e)&&!e.readonly)return e.history.hasUndo()}hotkey(){return this.options.hotkey||["mod+z","shift+mod+z"]}init(){}}class Lf extends $s{static get pluginName(){return"redo"}execute(){const e=this.editor;Es(e)&&(e.readonly||e.history.redo())}queryState(){const e=this.editor;if(Es(e)&&!e.readonly)return e.history.hasRedo()}hotkey(){return this.options.hotkey||["mod+y","shift+mod+y"]}init(){}}export{Ss as $,xi as ANCHOR,ki as ANCHOR_SELECTOR,qs as BlockPlugin,Rf as Bold,yi as CARD_CENTER_SELECTOR,pi as CARD_EDITABLE_KEY,fi as CARD_ELEMENT_KEY,ci as CARD_KEY,vi as CARD_LEFT_SELECTOR,gi as CARD_LOADING_KEY,wi as CARD_RIGHT_SELECTOR,mi as CARD_SELECTOR,li as CARD_TAG,hi as CARD_TYPE_KEY,ui as CARD_VALUE_KEY,Ci as CURSOR,Oi as CURSOR_SELECTOR,ns as CamelCaseType,yf as Card,Kl as CardActiveTrigger,Yl as CardType,Xh as CollaborationMember,As as Conversion,Bs as DATA_COLOR,Rs as DATA_CONTENTEDITABLE_KEY,Hr as DATA_ELEMENT,Fr as DATA_ID,Jr as DATA_TRANSIENT_ATTRIBUTES,Qr as DATA_TRANSIENT_ELEMENT,_s as DATA_UUID,Zr as EDITABLE,Gr as EDITABLE_SELECTOR,ei as ENGINE_CLASS_NAME,ti as ENGINE_MOBILE_CLASS_NAME,Rc as Editor,qh as Element,js as ElementPlugin,Qu as Engine,Ei as FOCUS,Ti as FOCUS_SELECTOR,Vs as InlinePlugin,Xs as ListPlugin,Us as MarkPlugin,ju as Model,nu as Node,au as Operation,yc as Parser,Jh as Path,$s as Plugin,uf as Position,di as READY_CARD_KEY,bi as READY_CARD_SELECTOR,Xr as ROOT,Ur as ROOT_SELECTOR,Lf as Redo,_f as Resizer,Ms as Schema,Mf as Scrollbar,Zl as SelectStyleType,ac as Selection,Ni as TRIGGER_CARD_ID,jh as Text,Vi as TinyCanvas,vu as Toolbar,hu as Tooltip,Yr as UI,Kr as UI_SELECTOR,If as Undo,ni as VIEW_CLASS_NAME,wf as View,fs as addUnit,ji as closest,si as combinText,Ts as convertMarkdown,ks as createMarkdownIt,ms as decodeCardValue,Rc as default,ps as encodeCardValue,cs as escape,hs as escapeDots,ws as formatEngineValue,Ns as formatHotkey,ss as getAttrMap,ls as getComputedStyle,ii as getDocument,zs as getHashId,xs as getListStyle,ai as getParentInRoot,as as getStyleMap,oi as getTextNodes,Pi as inEditor,Ji as isAndroid,Ri as isBlockCard,Ws as isBlockPlugin,Bi as isCard,Ui as isChrome,$i as isCursor,Xi as isEdge,zi as isEditable,Li as isEditableCard,Es as isEngine,Yi as isFirefox,Ii as isInlineCard,Hs as isInlinePlugin,Gi as isIos,Qi as isMacos,Ys as isMarkPlugin,_i as isMatchesSelector,Zi as isMobile,Mi as isNode,Si as isNodeEntry,Ai as isNodeList,cc as isPlainObject,mc as isRange,bc as isRangeInterface,Di as isRoot,Ki as isSafari,pc as isSelection,Fi as isServer,fc as isTransientAttribute,uc as isTransientElement,hc as isTransientElementCache,Cs as isView,es as isWindows,ts as random,gs as removeUnit,ys as sanitizeUrl,rs as toCamelCase,is as toHex,bs as transformCustomTags,ds as unescape,us as unescapeDots,Ls as uuid,vs as validUrl};
//# sourceMappingURL=index.esm.js.map
